# üöÄ Azure CDN with .NET ‚Äî Developer Guide

## Which SDK should I use?

- **‚úÖ Modern (recommended):**

  - `Azure.ResourceManager` + `Azure.ResourceManager.Cdn` (+ `Azure.Identity` for auth)
  - ARM-first, consistent patterns, long-term support.

- **üü° Legacy (works, but older):**

  - `Microsoft.Azure.Management.Cdn` (+ `Microsoft.Rest` auth)
  - Matches your reference snippet; still fine for simple tasks (list/purge), but consider moving to the new SDK for new work.

---

## üì¶ Install (Modern SDK)

```bash
dotnet add package Azure.Identity
dotnet add package Azure.ResourceManager
dotnet add package Azure.ResourceManager.Cdn
```

---

## üîê Auth (Modern)

The modern SDK uses `TokenCredential` from `Azure.Identity`. In dev, the easiest is **DefaultAzureCredential** (VS/VS Code/Az CLI login, Managed Identity in Azure).

```csharp
using Azure;
using Azure.Identity;
using Azure.ResourceManager;
using Azure.ResourceManager.Cdn;
using Azure.ResourceManager.Cdn.Models;
using Azure.ResourceManager.Resources;

var subscriptionId = "<SUBSCRIPTION_ID>";
var credential = new DefaultAzureCredential();

// Entry point for ARM
ArmClient arm = new ArmClient(credential);

// Get a Subscription resource
SubscriptionResource subscription = arm.GetSubscriptionResource(
    SubscriptionResource.CreateResourceIdentifier(subscriptionId));
```

---

## üß± Resource model (Modern)

- **SubscriptionResource** ‚Üí `.GetResourceGroup()` ‚Üí **ResourceGroupResource**
- **ResourceGroupResource** ‚Üí `.GetCdnProfiles()` ‚Üí **CdnProfileCollection**
- **CdnProfileResource** ‚Üí `.GetCdnEndpoints()` ‚Üí **CdnEndpointCollection / CdnEndpointResource**

---

## ‚ú® Common Tasks (Modern SDK)

### 1) List CDN profiles & endpoints (like your reference)

```csharp
var rgName = "rg-az204-cdn";
ResourceGroupResource rg = await subscription.GetResourceGroupAsync(rgName);

// List profiles in a resource group
await foreach (CdnProfileResource profile in rg.GetCdnProfiles().GetAllAsync())
{
    Console.WriteLine($"CDN Profile: {profile.Data.Name}  (Sku: {profile.Data.Sku.Name})");

    // List endpoints in profile
    await foreach (CdnEndpointResource ep in profile.GetCdnEndpoints().GetAllAsync())
    {
        Console.WriteLine($" - Endpoint: {ep.Data.Name}  Host: {ep.Data.HostName}");
    }
}
```

### 2) Create a CDN profile

```csharp
var profiles = rg.GetCdnProfiles();
string profileName = "my-cdn-profile";

var profileData = new CdnProfileData(AzureLocation.WestEurope)
{
    Sku = new CdnSku(CdnSkuName.StandardMicrosoft) // or StandardAkamai, StandardVerizon, PremiumVerizon
};

CdnProfileResource profileResult =
    (await profiles.CreateOrUpdateAsync(WaitUntil.Completed, profileName, profileData)).Value;

Console.WriteLine($"Created profile: {profileResult.Data.Name}");
```

### 3) Create an endpoint (origin = Storage static site, Web App, or custom)

```csharp
var endpoints = profileResult.GetCdnEndpoints();
string endpointName = "my-cdn-endpoint";

var endpointData = new CdnEndpointData(AzureLocation.WestEurope)
{
    Origins =
    {
        new CdnDeepCreatedOrigin(
            name: "origin-1",
            hostName: "mystorage.z20.web.core.windows.net") // or myapp.azurewebsites.net, or custom
        {
            HttpPort = 80,
            HttpsPort = 443
        }
    },
    IsHttpAllowed = false,
    IsHttpsAllowed = true,
    // Optional: Default TTLs, compression, query string behavior via DeliveryPolicy for some SKUs
};

CdnEndpointResource endpoint =
    (await endpoints.CreateOrUpdateAsync(WaitUntil.Completed, endpointName, endpointData)).Value;

Console.WriteLine($"Endpoint host: {endpoint.Data.HostName}"); // e.g., my-cdn-endpoint.azureedge.net
```

### 4) Start/stop an endpoint

```csharp
await endpoint.StartAsync(WaitUntil.Completed);
// ...
await endpoint.StopAsync(WaitUntil.Completed);
```

### 5) Purge cached content (force refresh)

```csharp
await endpoint.PurgeContentAsync(
    WaitUntil.Completed,
    new List<string> { "/images/*", "/css/app.css" } // paths/globs relative to origin root
);
Console.WriteLine("Purge request submitted.");
```

> Tip: for **versioning**, publish `app.css?v=2.1`. The CDN treats it as a distinct cache object and pulls fresh content immediately.

---

## üß∞ Rules & caching knobs (Modern)

Some behaviors can be configured on `CdnEndpointData` (varies by SKU):

- **Compression**: `endpointData.IsCompressionEnabled = true;` & `ContentTypesToCompress`
- **Query string caching** & **cache TTLs**: through **DeliveryPolicy** / **Rules** (Premium Verizon offers the most advanced rules engine via policy objects)

Example (simple compression types):

```csharp
endpointData.IsCompressionEnabled = true;
endpointData.ContentTypesToCompress.Add("text/plain");
endpointData.ContentTypesToCompress.Add("text/css");
endpointData.ContentTypesToCompress.Add("application/javascript");
```

> For advanced rule authoring (path conditions, header/query controls, URL rewrite/redirect), prefer **Premium Verizon** profile (or consider **Azure Front Door** for modern rules/WAF).

---

## üß™ Complete ‚Äúlist & purge‚Äù console (Modern)

```csharp
using Azure;
using Azure.Identity;
using Azure.ResourceManager;
using Azure.ResourceManager.Cdn;
using Azure.ResourceManager.Cdn.Models;
using Azure.ResourceManager.Resources;

static async Task Main()
{
    var subscriptionId = "<SUBSCRIPTION_ID>";
    var rgName = "rg-az204-cdn";

    ArmClient arm = new ArmClient(new DefaultAzureCredential());
    SubscriptionResource sub = arm.GetSubscriptionResource(
        SubscriptionResource.CreateResourceIdentifier(subscriptionId));
    ResourceGroupResource rg = await sub.GetResourceGroupAsync(rgName);

    await foreach (var profile in rg.GetCdnProfiles().GetAllAsync())
    {
        Console.WriteLine($"Profile: {profile.Data.Name} [{profile.Data.Sku.Name}]");
        await foreach (var ep in profile.GetCdnEndpoints().GetAllAsync())
        {
            Console.WriteLine($" - Endpoint: {ep.Data.Name} ({ep.Data.HostName})");

            // Example purge of a single file
            // await ep.PurgeContentAsync(WaitUntil.Completed, new[] { "/index.html" });
        }
    }
}
```

---

## üü° Legacy SDK (matches your reference)

### Install

```bash
dotnet add package Microsoft.Azure.Management.Cdn
dotnet add package Microsoft.Rest.ClientRuntime
```

### Auth + Client

```csharp
using Microsoft.Azure.Management.Cdn;
using Microsoft.Azure.Management.Cdn.Models;
using Microsoft.Rest;

// accessToken: acquire via ADAL/MSAL/CLI; or use AzureServiceTokenProvider
var cdn = new CdnManagementClient(new TokenCredentials(accessToken))
{
    SubscriptionId = "<SUBSCRIPTION_ID>"
};
```

### List profiles & endpoints

```csharp
var profiles = cdn.Profiles.ListByResourceGroup("rg-az204-cdn");
foreach (var p in profiles)
{
    Console.WriteLine($"CDN profile: {p.Name}");
    var endpoints = cdn.Endpoints.ListByProfile("rg-az204-cdn", p.Name);
    foreach (var e in endpoints)
    {
        Console.WriteLine($" - {e.Name} ({e.HostName})");
    }
}
```

### Purge

```csharp
await cdn.Endpoints.PurgeContentAsync(
    resourceGroupName: "rg-az204-cdn",
    profileName: "happylearning-cdn",
    endpointName: "happylearning",
    contentPaths: new[] { "/images/*", "/css/app.css" });
```

> Works fine for simple management. For new projects, prefer the **modern** SDK.

---

## üß† Cheat-Sheet (Classes & Methods)

### Modern SDK

- `ArmClient` ‚Üí entry to Azure Resource Manager
- `SubscriptionResource` / `ResourceGroupResource`
- `CdnProfileCollection` + `CdnProfileResource`

  - `CreateOrUpdateAsync`, `GetAllAsync`

- `CdnEndpointCollection` + `CdnEndpointResource`

  - `CreateOrUpdateAsync`, `StartAsync`, `StopAsync`, `PurgeContentAsync`, `GetAllAsync`

- `CdnProfileData`, `CdnEndpointData`, `CdnSku`, `CdnDeepCreatedOrigin`

### Legacy SDK

- `CdnManagementClient`

  - `.Profiles.ListByResourceGroup(...)`
  - `.Endpoints.ListByProfile(...)`
  - `.Endpoints.PurgeContentAsync(...)`

---

## ‚úÖ Best Practices (what teams actually do)

- **Version your assets** (`/app.css?v=2025-09-28`) for instant refresh without global purges.
- Use **Purge** sparingly (surgical paths, not `/*`), and **automate** it in CI after deploy.
- Choose SKU intentionally:

  - **Standard Microsoft**: great default
  - **Akamai/Verizon**: specific enterprise/edge features
  - **Premium Verizon**: advanced rules engine

- For **modern security/routing/WAF**, consider **Azure Front Door** alongside CDN.
- Log & Alert: track **cache hit ratio**, **origin egress**, **4xx/5xx** spikes.

---

## üß≠ Quick ‚ÄúWhen to use what‚Äù

- **Need basic global caching fast** ‚Üí Standard Microsoft CDN
- **Complex edge logic (rewrite/redirect), cookie/header conditions** ‚Üí Premium Verizon or **Front Door**
- **Global LB + WAF + bot protection** ‚Üí **Front Door (Std/Prem)** + CDN for static offload
