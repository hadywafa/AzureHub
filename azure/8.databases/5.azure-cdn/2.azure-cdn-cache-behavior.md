# âš–ï¸ Azure CDN â€“ Controlling Caching Behavior

Caching = the **secret sauce** of CDN. Itâ€™s what makes your app _feel fast_ without hammering your origin servers. But caching is only great if you control it properly

Hereâ€™s the **Azure CDN caching brain map**, explained step by step.

---

<div align="center">
  <img src="image/2.azure-cdn-cache-behavior/1759019590375.png" alt="Capture Configuration" style="border-radius: 10px; border: 2px solid white; width: 60%;margin:0 30px; background-color: #ffffffff">
</div>

---

## ğŸ§  How Azure CDN Caching Works

- When a user requests content, Azure CDN checks the **edge POP cache**.
- If content is **fresh (within TTL)** â†’ âœ… return instantly.
- If **expired or missing** â†’ âŒ CDN goes back to origin (Storage, Web App, VM, etc.) and pulls a fresh copy.

ğŸ‘‰ Think of TTL as the "freshness timer".  
ğŸ‘‰ Exactly like CloudFront TTLs in AWS.

---

## âš™ï¸ 1. Caching Rules

Azure CDN gives you **two levels of rules**:

### ğŸ”¹ Global Caching Rules

- Apply to **all requests** on a CDN endpoint.
- Best for **default policies** like "cache everything for 7 days".

### ğŸ”¹ Custom Caching Rules

- Apply to **specific paths, file types, or conditions**.
- Example:

  - `/images/*` â†’ cache for 30 days
  - `/api/*` â†’ donâ€™t cache (bypass)

ğŸ‘‰ AWS analogy: Like **CloudFront cache behaviors per path pattern**.

---

## âš™ï¸ 2. Query String Caching

Requests often carry **query parameters** (`?id=123&lang=en`). Azure CDN lets you decide how to handle them:

- **Ignore Query Strings**:

  - All query variations use the **same cache object**.
  - Example: `index.html?id=1` and `index.html?id=2` â†’ same cached file.

- **Bypass Caching**:

  - If query strings exist â†’ skip CDN, always go to origin.
  - Used for **APIs or dynamic content**.

- **Cache Each Variant**:

  - Every unique query string = separate cache entry.
  - Perfect when query parameters actually change the content.

ğŸ‘‰ AWS analogy: Like **Cache Based on Query Strings** in CloudFront.

---

## â±ï¸ 3. TTL (Time-to-Live)

TTL = how long content lives in cache before CDN re-checks origin.

![1759019627120](image/2.azure-cdn-cache-behavior/1759019627120.png)

Azure CDN respects **Cache-Control** headers from origin.
But if origin doesnâ€™t set them â†’ Azure applies **default TTLs**:

- ğŸŒ **General Web Content** â†’ 7 days
- ğŸ“‚ **Large Files Delivery** â†’ 1 day
- ğŸ¬ **Media Streaming** â†’ 1 year

ğŸ‘‰ AWS analogy: CloudFront Default TTL / MinTTL / MaxTTL.

---

## ğŸ”„ 4. Content Updates & Refresh

How do you ensure users always see the **latest version**?

### ğŸ”¹ Normal Flow

- CDN serves cached content until TTL expires.
- After TTL, CDN revalidates with origin.

### ğŸ”¹ Versioning (Best Practice âœ…)

- Append version strings to file names or query params.
- Example:

  - `app.css?v=2.1` â†’ CDN sees this as a **new file**.

- Ensures **instant update** propagation across all POPs.

### ğŸ”¹ Manual Purging

- Admins can purge cache from Azure Portal, CLI, or API.
- Used when content **must refresh immediately** (breaking change, bug fix, etc.).

ğŸ‘‰ AWS analogy: CloudFront **invalidations**.

---

## ğŸ–¥ï¸ Hands-On Demo: CDN + Static Website

1. Create a **static website** in Azure Storage (`$web` container).
2. Attach a **CDN endpoint**:

   - Choose **Microsoft / Verizon / Akamai tier**
   - Pick an origin (storage account)
   - Provide endpoint name (`mysite.azureedge.net`)

3. Configure caching:

   - Query string behavior (ignore / bypass / cache each)
   - TTL rules (global + custom)

4. Access website via CDN endpoint â†’ static files now delivered from **nearest POP**.

---

## ğŸ” Verification with `nslookup`

Run:

```bash
nslookup mysite.azureedge.net
```

Output shows youâ€™re routed to the **nearest POP IP**.

- If you VPN into US, EU, AU â†’ youâ€™ll see **different edge IPs**.
- Thatâ€™s **global load balancing + caching in action**.

---

## ğŸ§© Memory Cheatsheet

- **Caching Rules** â†’ Global vs Custom
- **Query Strings** â†’ Ignore, Bypass, or Cache Each
- **TTL** â†’ 7d Web, 1d Large, 1y Media
- **Updates** â†’ TTL refresh, Versioning (best), Purging (manual)

ğŸ‘‰ In short: **â€œRules + Query + TTL + Update = Azure CDN Caching.â€**
