# âš–ï¸ Cosmos DB â€“ Consistency Models

## ğŸ“– What is Consistency in Cosmos DB?

When you replicate data across multiple regions, you need a contract between:

- **Consistency** (how fresh/accurate the data is)
- **Latency** (how fast queries return)
- **Availability** (what happens during failures)

Cosmos DB gives you **5 tunable consistency models**, instead of just strong vs eventual like DynamoDB.
This lets you choose the right balance for your app.

---

## ğŸ”‘ The 5 Consistency Levels

Think of them on a spectrum:

<div align="center" style="background-color: #ffffffff ;border-radius: 10px;border: 2px solid white">
  <img src="image/3.consistency-models/1758041796100.png" alt="Consistency Models in Cosmos DB" style="width: 60%; border-radius: 10px; border: 2px solid white;">
</div>

### 1. **ğŸ’ª Strong**

- **Guarantee**: Always read the **latest committed write**.
- **Trade-off**: Highest latency + reduced availability (only works within 1 region OR two <u title="Ù…Ø¬Ø§ÙˆØ±Ø©">adjacent</u> regions).
- **Use Case**: Banking transactions, <u title="ØªØ¬Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†">stock trading</u>.

### 2. **â³ <u title="Ø§Ù„Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯" >Bounded Staleness</u>**

- **Guarantee**: Reads lag behind writes by at most **N versions** or **T time interval**.
- **Trade-off**: Medium latency, predictable staleness.
- **Use Case**: Leaderboards, order tracking (slight delay OK).

### 3. **ğŸ‘¤ Session** _(Default)_

- **Guarantee**: Within a client session, you always see your own writes (Read-Your-Own-Writes).
- **Trade-off**: Best balance of **performance + consistency**.
- **Use Case**: Web/mobile apps where a user should see their updates immediately.

### 4. **ğŸ“– Consistent Prefix**

- **Guarantee**: Reads never see out-of-order writes (e.g., if writes are A â†’ B â†’ C, youâ€™ll never see A â†’ C without B).
- **Trade-off**: Better latency than Session, but less strict.
- **Use Case**: Social media feeds, logs.

### 5. **ğŸŒŠ Eventual**

- **Guarantee**: No ordering guarantees; reads eventually converge.
- **Trade-off**: Lowest latency, cheapest.
- **Use Case**: Analytics, recommendations, non-critical reads.

---

## âš–ï¸ Comparison Table

<div align="center" style="background-color: #ffffffff ;border-radius: 10px;border: 2px solid white">
  <img src="image/3.consistency-models/1758042318437.png" alt="Comparison Table" style="width: 50%; border-radius: 10px; border: 2px solid white;">
</div>

---

### ğŸ“Š Final Comparison Table (Cosmos DB Consistency Models)

<div align="center" style="color:white;background-color: #545b6bff ;border-radius: 10px;border: 2px solid white">

| Model                 | Freshness           | Ordering  | Latency | Throughput | Availability |
| --------------------- | ------------------- | --------- | ------- | ---------- | ------------ |
| **Strong**            | Latest              | Ordered   | Highest | Lowest     | Lowest       |
| **Bounded Staleness** | N versions / T time | Ordered   | High    | Low        | High         |
| **Session**           | Latest in session   | Ordered   | Medium  | Medium     | High         |
| **Consistent Prefix** | Can be stale        | Ordered   | Low     | High       | High         |
| **Eventual**          | Eventually          | Unordered | Lowest  | Highest    | Highest      |

</div>

---

### ğŸ” Header Explanations

The consistency level offered by Cosmos DB. Each model defines how data is read across replicas in a distributed system.

#### ğŸ¥— **Freshness**

How **up-to-date** the data is when read.

- High freshness = latest data
- Low freshness = possibly stale data

#### âš¡ **Latency**

How **quickly** the system responds to a read request.

- Low latency = fast response
- High latency = slower due to coordination

#### ğŸ›¡ï¸ **Availability**

How **reliably** the system can serve reads, even during failures.

- High availability = system rarely fails to respond
- Low availability = system may reject reads during issues

#### ğŸ” **Ordering**

Whether reads **preserve the order** of writes.

- Ordered = reads follow the sequence of writes
- Unordered = reads may arrive out of order

#### ğŸš€ **Throughput**

How many **operations per second** the system can handle.

- High throughput = more scalable
- Low throughput = more coordination overhead

---

## ğŸ§  How It Works Internally

- Cosmos DB uses a **replication protocol** across regions.
- The chosen consistency model defines how many replicas must **acknowledge a write** before confirming.
- Example:

  - **Strong** â†’ All replicas must confirm.
  - **Eventual** â†’ Primary replica confirms immediately, secondaries catch up later.

---

## ğŸ†š AWS Comparison

| Cosmos DB                                   | DynamoDB                         |
| ------------------------------------------- | -------------------------------- |
| 5 consistency levels                        | Only **Strong** and **Eventual** |
| Fine-grained tuning                         | Simple but less flexible         |
| Session-level reads (RYOW)                  | Not directly supported           |
| Global multi-region SLA tied to consistency | Only region-based replication    |

ğŸ‘‰ **Cosmos DB is more flexible**, which is why MSFT loves to test it.

---

## ğŸ› ï¸ Implementation Examples

### Set Consistency at Account Level (CLI)

```bash
az cosmosdb update \
  --name mycosmos \
  --resource-group myrg \
  --default-consistency-level Session
```

### Override Consistency Per Request (C# SDK)

```csharp
QueryRequestOptions options = new QueryRequestOptions
{
    ConsistencyLevel = ConsistencyLevel.BoundedStaleness
};

var query = container.GetItemQueryIterator<dynamic>(
    "SELECT * FROM c", requestOptions: options);
```

ğŸ“Œ **Default = Session**. You can override per request if needed.

---

## ğŸ¯ Exam Gotchas

- **Default consistency = Session**.
- **Strong consistency** only supported across **â‰¤2 regions in the same Azure geography**.
- **Bounded Staleness** â†’ must specify N versions or T interval.
- **Session consistency** ensures **Read-Your-Own-Writes** but not across users.
- **Consistent Prefix** preserves order but not freshness.
- **Eventual consistency** gives max performance but no guarantees.
- **Consistency can be set at account level** (default) and **overridden per request**.

ğŸ‘‰ Typical Exam Question:
_â€œA global shopping app requires users to always see their own updates instantly, but can tolerate stale data from other users. Which consistency model?â€_
âœ”ï¸ **Session**.

---

## ğŸ¬ The Movie Analogy ğŸ¥

Imagine you and your friends are watching a **movie** thatâ€™s being released globally.
Different consistency levels = how fast everyone sees the **latest scene**.

### 1. **Strong** ğŸ’ª = _Everyone in the cinema sees the latest scene at the same time._

- No one is behind.
- **But** you must wait for everyoneâ€™s screen to sync â†’ slow.
- âœ… Use: Banking, critical systems.
- âŒ Donâ€™t use: Global apps with high latency tolerance.

---

### 2. **Bounded Staleness** â³ = _Everyone sees the movie with a delay of exactly 5 minutes._

- Youâ€™ll never be more than **N versions** or **T time** behind.
- Predictable delay.
- âœ… Use: Leaderboards, order status (delay OK, but not chaos).
- âŒ Donâ€™t use: Anything needing _instant correctness_.

---

### 3. **Session** ğŸ‘¤ = _Each person has their own private Netflix account._

- You **always see your own actions instantly** (e.g., â€œcontinue watchingâ€).
- But other usersâ€™ actions might lag.
- âœ… Use: Most web/mobile apps (user sees their own cart, posts, likes).
- âŒ Donâ€™t use: Global shared truth across all users.

---

### 4. **Consistent Prefix** ğŸ“– = _Everyone sees the movie in the correct order of scenes, but they might be behind._

- If the movie is A â†’ B â†’ C, youâ€™ll never see A â†’ C without B.
- But you might only be at A or AB while others are at ABC.
- âœ… Use: Feeds, logs (order matters more than freshness).
- âŒ Donâ€™t use: Apps needing up-to-date reads.

---

### 5. **Eventual** ğŸŒŠ = _Everyone gets the movie scenes at random times, but eventually everyone catches up._

- You might see scene C before B.
- Lowest latency, maximum chaos.
- âœ… Use: Analytics, recommendations, background tasks.
- âŒ Donâ€™t use: Transactions or user-facing critical flows.

---

## ğŸ“Š Easy Table to Memorize

| Level                 | Guarantee                        | Real-Life Analogy              | Best For                     |
| --------------------- | -------------------------------- | ------------------------------ | ---------------------------- |
| **Strong**            | Always latest write              | Everyone in cinema, same frame | Banking, stock trades        |
| **Bounded Staleness** | At most N versions/T time stale  | Always 5 min behind            | Order tracking, leaderboards |
| **Session**           | Read-Your-Own-Writes             | Netflix â€œContinue Watchingâ€    | Most apps (default)          |
| **Consistent Prefix** | Order preserved, freshness not   | Watch movie scenes in order    | Feeds, logs                  |
| **Eventual**          | Eventually consistent, unordered | Scenes arrive randomly         | Analytics, caching           |

---

## ğŸ¯ Exam Hacks

1. **If â€œRead-Your-Own-Writesâ€ appears â†’ Session**.
2. **If â€œMust always see latest globallyâ€ â†’ Strong**.
3. **If â€œPredictable lagâ€ (N versions or T time) â†’ Bounded Staleness**.
4. **If â€œOrder must be preserved, but freshness can lagâ€ â†’ Consistent Prefix**.
5. **If â€œPerformance/lowest latency, stale data fineâ€ â†’ Eventual**.

---

## ğŸ§© Memory Trick

### ğŸ­ Mnemonic: "**Super Boring Sessions Can Explode**"

Each word stands for a consistency model in **descending order of consistency** (from strictest to loosest):

| Word         | Model                 | Personality      |
| ------------ | --------------------- | ---------------- |
| **Super**    | **Strong**            | ğŸ›¡ï¸ Perfectionist |
| **Boring**   | **Bounded Staleness** | â³ Timekeeper    |
| **Sessions** | **Session**           | ğŸ‘¤ Loyal Friend  |
| **Can**      | **Consistent Prefix** | ğŸ“š Historian     |
| **Explode**  | **Eventual**          | ğŸŒ€ Free Spirit   |

---

### ğŸ§  How to Use It

Imagine a **team of five characters** in a sitcom:

- **Super**: Always wants the freshest gossip, but takes forever to get ready.
- **Boring**: Shows up late but insists on telling stories in order.
- **Sessions**: Only remembers what _you_ told them.
- **Can**: Tells stories in order but forgets the juicy bits.
- **Explode**: Bursts in with random updates, no timeline, no order.

---

### ğŸª„ Bonus: Arabic Twist for Humor

If you want to explain this to Arabic-speaking peers:

> ØªØ®ÙŠÙ„Ù‡Ù… Ø²ÙŠ Ø®Ù…Ø³ Ø´Ø®ØµÙŠØ§Øª ÙÙŠ Ù…Ø³Ù„Ø³Ù„ ÙƒÙˆÙ…ÙŠØ¯ÙŠ:  
> "Ø³ÙˆØ¨Ø±" Ø¯Ø§ÙŠÙ…Ù‹Ø§ Ø¹Ø§ÙŠØ² Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±ØŒ Ø¨Ø³ Ø¨ ÙŠØ­ØªØ§Ø¬ ÙˆÙ‚Øª.  
> "Ø¨ÙˆØ±ÙŠÙ†Ø¬" Ø¨ÙŠØ­Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø³ Ù…Ø´ Ø¯Ø§ÙŠÙ…Ù‹Ø§ Ø³Ø±ÙŠØ¹.  
> "Ø³ÙŠØ´Ù†Ø²" ÙØ§ÙƒØ± ÙƒÙ„Ø§Ù…Ùƒ Ø¨Ø³ Ù…Ø´ ÙƒÙ„ Ø­Ø§Ø¬Ø©.  
> "ÙƒØ§Ù†" Ø¨ÙŠØ­ÙƒÙŠ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ø³ Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† Ù‚Ø¯ÙŠÙ….  
> "Ø¥ÙƒØ³Ø¨Ù„ÙˆØ¯" Ø¨ÙŠÙ‚ÙˆÙ„ Ø£ÙŠ Ø­Ø§Ø¬Ø© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª!
