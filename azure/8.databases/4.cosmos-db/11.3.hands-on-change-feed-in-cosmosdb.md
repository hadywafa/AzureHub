# üß™ What you‚Äôll build

- A Cosmos DB container named `Orders` (the **monitored** container).
- A **lease** container named `leases` (stores progress/checkpoints).
- An Azure Function that **fires automatically** whenever items are **inserted/updated** in `Orders`.
- Your function (the **delegate**) will log the changes (you can replace with your business logic).

---

## ‚úÖ Prereqs (once)

- Azure Subscription + Cosmos DB account (Core (SQL) API).
- .NET 8 SDK (for C#) or Node 18+ (for JavaScript).
- Azure Functions Core Tools (for local run): `npm i -g azure-functions-core-tools@4 --unsafe-perm true`
- VS Code is convenient, but optional.

---

## 1) Create Cosmos DB bits (names you‚Äôll use)

- **Database**: `shopdb`
- **Monitored container**: `Orders` with partition key `/pk`
- **Lease container**: `leases` with partition key `/id` (throughput 400 RU or autoscale)

> You can make these in the portal (Data Explorer) in 2‚Äì3 clicks.

---

## Option A ‚Äî C# (Isolated) Azure Function (v4/.NET 8)

### üìÅ Folder structure (minimal)

```ini
CosmosCfDemo/
  Program.cs
  OrdersChangeFeed.cs
  host.json
  local.settings.json
  CosmosCfDemo.csproj
```

### `CosmosCfDemo.csproj`

```xml
<Project Sdk="Microsoft.NET.Sdk.Isolated">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Microsoft.Azure.Functions.Worker" Version="1.22.0" />
    <PackageReference Include="Microsoft.Azure.Functions.Worker.Extensions.CosmosDB" Version="4.6.0" />
    <PackageReference Include="Microsoft.Azure.Functions.Worker.Sdk" Version="1.15.0" OutputItemType="Analyzer" />
  </ItemGroup>
</Project>
```

### `Program.cs`

```csharp
using Microsoft.Azure.Functions.Worker;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

var host = new HostBuilder()
    .ConfigureFunctionsWorkerDefaults()
    .ConfigureServices(s => { })
    .Build();

host.Run();
```

### `OrdersChangeFeed.cs` (your **delegate**)

```csharp
using System.Collections.Generic;
using Microsoft.Azure.Functions.Worker;
using Microsoft.Extensions.Logging;

public class OrdersChangeFeed
{
    private readonly ILogger<OrdersChangeFeed> _logger;
    public OrdersChangeFeed(ILogger<OrdersChangeFeed> logger) => _logger = logger;

    // This attribute wires the Cosmos DB Change Feed trigger
    [Function("OrdersChangeFeed")]
    public void Run(
        [CosmosDBTrigger(
            databaseName: "shopdb",
            containerName: "Orders",
            Connection = "CosmosConnection",           // from local.settings.json
            LeaseContainerName = "leases",             // lease container
            CreateLeaseContainerIfNotExists = true,
            StartFromBeginning = true,                 // read historical on first start
            MaxItemsPerInvocation = 50)]               // batch size
        IReadOnlyList<dynamic> input)
    {
        if (input is { Count: > 0 })
        {
            _logger.LogInformation("Change feed batch received: {Count} docs", input.Count);
            foreach (var doc in input)
            {
                // Idempotent, simple demo: log a few fields
                string id = doc.id;
                string pk = doc.pk;
                _logger.LogInformation("Changed doc -> id={Id}, pk={Pk}, doc={Doc}", id, pk, doc.ToString());
            }
        }
    }
}
```

### `host.json`

```json
{
  "version": "2.0",
  "logging": {
    "logLevel": { "default": "Information", "Host.Results": "Information" }
  }
}
```

### `local.settings.json` (not checked into git)

> Put your **Cosmos connection string** under `CosmosConnection`.

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
    "CosmosConnection": "AccountEndpoint=https://<your-account>.documents.azure.com:443/;AccountKey=<KEY>;"
  }
}
```

### ‚ñ∂Ô∏è Run locally

```bash
func start
```

You‚Äôll see the function `OrdersChangeFeed` listening.

---

## Option B ‚Äî JavaScript (Node 18) Azure Function

### üìÅ Folder structure

```ini
cosmos-cf-js/
  OrdersChangeFeed/function.json
  OrdersChangeFeed/index.js
  host.json
  local.settings.json
  package.json
```

### `package.json`

```json
{
  "name": "cosmos-cf-js",
  "version": "1.0.0",
  "main": "index.js",
  "type": "commonjs",
  "engines": { "node": ">=18" },
  "dependencies": {}
}
```

### `OrdersChangeFeed/function.json`

```json
{
  "bindings": [
    {
      "name": "documents",
      "type": "cosmosDBTrigger",
      "direction": "in",
      "connectionStringSetting": "CosmosConnection",
      "databaseName": "shopdb",
      "containerName": "Orders",
      "leaseContainerName": "leases",
      "createLeaseContainerIfNotExists": true,
      "startFromBeginning": true,
      "maxItemsPerInvocation": 50
    }
  ],
  "scriptFile": "index.js"
}
```

### `OrdersChangeFeed/index.js`

```js
module.exports = async function (context, documents) {
  if (!!documents && documents.length > 0) {
    context.log(`Change feed batch received: ${documents.length} docs`);
    for (const d of documents) {
      context.log(`Changed doc -> id=${d.id}, pk=${d.pk}, body=${JSON.stringify(d)}`);
      // TODO: your business logic here (idempotent!)
    }
  }
};
```

### `host.json`

```json
{
  "version": "2.0",
  "logging": { "logLevel": { "default": "Information" } }
}
```

### `local.settings.json`

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "CosmosConnection": "AccountEndpoint=https://<your-account>.documents.azure.com:443/;AccountKey=<KEY>;"
  }
}
```

### ‚ñ∂Ô∏è Run locally

```bash
func start
```

---

## üß™ Test the trigger (same for C# or JS)

Insert or update a document in **`shopdb` / `Orders`** (partition key `/pk`), e.g. in **Data Explorer** or with a quick REST/SDK call:

```json
{
  "id": "o-1001",
  "pk": "customer-42",
  "status": "Created",
  "total": 149.9
}
```

üëâ Within a second or two, your Function logs will show the batch with this document.

Update it:

```json
{
  "id": "o-1001",
  "pk": "customer-42",
  "status": "Paid",
  "total": 149.9
}
```

You‚Äôll see another change delivered.

> The **lease** container (`leases`) will populate with documents that track **which host owns which feed range** and the **continuation** (checkpoint).

---

## üí° Tips (keep it simple)

- Make your handler **idempotent** (if you run the same change twice, it shouldn‚Äôt break anything).
- Start with `StartFromBeginning=true` for learning; change to `false` in production to process only **new** changes.
- Keep batches small at first (`MaxItemsPerInvocation`) and increase later.
- If you need **deletes**, implement a **soft-delete** field (e.g., `"isDeleted": true`) and handle it in your code.

---

## üß≠ What you now understand

- **Monitored container** (`Orders`) produces the feed.
- **Lease container** (`leases`) stores progress/checkpoints for scaling & recovery.
- **Compute/Host** = your Function app.
- **Delegate** = your function code (the examples above).
