# ðŸ“ˆ **Azure SQL Monitoring, Alerts, and Performance Insights**

> â€œYou canâ€™t improve what you donâ€™t measure.â€ â€” So letâ€™s measure **everything** ðŸ˜Ž

---

## ðŸ§­ Overview

Azure SQL provides a **built-in monitoring ecosystem** that tracks metrics, performance trends, and anomalies **without installing agents**.

All Azure SQL deployment types (Database, Managed Instance, VM) integrate natively with:

- **Azure Monitor** (for metrics, logs, and alerts)
- **SQL Insights (preview)** (deep engine telemetry)
- **Query Performance Insight**
- **Automatic Tuning**
- **Log Analytics workspace**

---

## ðŸ§© Monitoring Architecture Overview

```mermaid
flowchart TD
    A["Azure SQL (DB / MI / VM)"] --> B["Azure Monitor Metrics"]
    A --> C["Diagnostic Logs"]
    A --> D["Query Performance Insight"]
    B --> E["Alerts"]
    C --> F["Log Analytics Workspace"]
    F --> G["Kusto Queries (KQL)"]
    D --> H["Performance Recommendations"]
    E --> I["Email / Teams / Logic App Notifications"]
    style A fill:#0078D7,stroke:#333,stroke-width:2px,color:#fff;
    style F fill:#00a8e8,stroke:#333,stroke-width:2px,color:#fff;
```

---

## ðŸ§± Azure Monitor for SQL (All Deployments)

**Azure Monitor** collects metrics and logs for:

| Category                | Description                          | Example                    |
| ----------------------- | ------------------------------------ | -------------------------- |
| ðŸ’¾ Resource Metrics     | CPU, DTU, IOPS, storage              | CPU usage %, Log IO %      |
| ðŸ” Query Metrics        | Execution count, duration            | Slow-running queries       |
| âš¡ Performance          | Wait stats, blocking, timeouts       | Top waits by type          |
| ðŸ§  Intelligent Insights | Auto detection of performance issues | High CPU spikes, deadlocks |
| ðŸ”” Alerts               | Trigger notifications on thresholds  | DTU > 90%, log IO > 80%    |

---

### ðŸ“Š Metrics (Portal Steps)

1. Go to **Azure Portal â†’ SQL Database / MI / VM**
2. Select **Monitoring â†’ Metrics**
3. Choose a **metric namespace**, e.g.:

   - `CPU percentage`
   - `Data IO percentage`
   - `Sessions count`

4. Optionally add **filters** (by database or DTU)
5. Click **New alert rule** to trigger actions

**Example alert:**

> Send email if CPU > 85% for 10 minutes.

---

## ðŸ§  Intelligent Insights (AI-driven Analysis)

Azure SQL continuously evaluates telemetry and provides:

- Root cause of performance degradation
- Impacted queries
- Recommended actions

**Enable in Portal:**

- Go to **SQL Database â†’ Intelligent Performance â†’ Intelligent Insights**
- Toggle **ON**
- You can review insights under **Performance â†’ Insights**

ðŸ” Examples of detections:

- Parameter sniffing issues
- High I/O latency
- Missing indexes
- Suboptimal query plans

---

## ðŸ“– Query Performance Insight (QPI)

Visual, easy-to-understand performance dashboard (for **Azure SQL Database only**).

**Use Case:** Identify top resource-consuming queries.

### ðŸ”¹ Portal Steps:

1. Navigate to your **SQL Database**
2. Go to **Intelligent Performance â†’ Query Performance Insight**
3. View charts by:

   - **DTU usage**
   - **CPU / IO / Duration**
   - **Top Queries**

4. Click a query to drill into its **execution stats** and **query text**
5. Get **automatic tuning suggestions** (e.g., create index)

---

## âš™ï¸ Automatic Tuning

Let Azure tune your SQL database automatically.
Three key options:

| Option                   | Description                  | Behavior           |
| ------------------------ | ---------------------------- | ------------------ |
| **CREATE INDEX**         | Adds missing indexes         | Auto-enabled       |
| **DROP INDEX**           | Removes unused indexes       | Optional           |
| **FORCE LAST GOOD PLAN** | Reverts to stable query plan | Highly recommended |

### ðŸ“‹ Portal Steps:

1. Go to **SQL Database â†’ Intelligent Performance â†’ Automatic tuning**
2. Turn ON options (can inherit from server)
3. Review applied and reverted tunings under **History**

ðŸ’¡ Works only for **Azure SQL Database** and **SQL Managed Instance**.

---

## ðŸ§© Diagnostic Settings

To send detailed telemetry to a **Log Analytics Workspace**, **Storage Account**, or **Event Hub**:

### ðŸ”¹ Portal Steps:

1. Go to **SQL Server / Database â†’ Diagnostic settings**
2. Click **+ Add diagnostic setting**
3. Choose:

   - âœ… **Send to Log Analytics Workspace**
   - ðŸ“¦ **Archive to Storage Account**
   - âš™ï¸ **Stream to Event Hub**

4. Select logs to collect:

   - `SQLInsights`
   - `Errors`
   - `QueryStoreRuntimeStatistics`
   - `Timeouts`
   - `Deadlocks`

5. Save âœ…

---

## ðŸ“˜ Log Analytics + KQL Queries

With logs in a **Log Analytics Workspace**, use **Kusto Query Language (KQL)** to analyze performance.

**Example: Find top 10 slow queries:**

```kql
AzureDiagnostics
| where Category == "QueryStoreRuntimeStatistics"
| summarize avg_duration = avg(duration_s) by statement_s
| top 10 by avg_duration desc
```

**Example: Detect blocking:**

```kql
AzureDiagnostics
| where Category == "Blocks"
| project TimeGenerated, blocking_session_id, blocked_session_id, duration_s
```

---

## ðŸš¨ Alerts and Notifications

Use **Action Groups** to notify teams via:

- ðŸ“§ Email
- ðŸ’¬ SMS
- ðŸ”” Push notifications
- ðŸ¤– Logic Apps (for Teams / Slack)

**Portal Steps:**

1. Go to **Azure Monitor â†’ Alerts â†’ Create alert rule**
2. Choose resource: your SQL Database / Server
3. Condition: `CPU > 80%`
4. Action Group: select existing or create new
5. Save âœ…

---

## ðŸ§® Performance Recommendations Dashboard

Azure automatically generates recommendations under
**SQL Database â†’ Intelligent Performance â†’ Recommendations**

Examples:

- â€œCreate nonclustered index on [Orders].Dateâ€
- â€œDrop unused index IDX_CustomerNameâ€
- â€œForce plan ID 45 for query 152â€

You can apply fixes directly with one click ðŸª„

---

## ðŸ§© SQL Insights (Preview)

For deeper engine-level telemetry across many databases:

- Collects performance counters (CPU, memory, waits)
- Stores data in Log Analytics
- Works for Azure SQL DB, MI, and SQL on VMs
- Useful for fleet-level performance management

Setup via **Azure Monitor â†’ Insights â†’ SQL**.

---

## ðŸ§  Comparison Table

| Feature                   | SQL DB | Managed Instance | SQL on VM |
| ------------------------- | ------ | ---------------- | --------- |
| Azure Monitor Metrics     | âœ…     | âœ…               | âœ…        |
| Query Performance Insight | âœ…     | âŒ               | âŒ        |
| Intelligent Insights      | âœ…     | âœ…               | âŒ        |
| Automatic Tuning          | âœ…     | âœ…               | âŒ        |
| Diagnostic Logs           | âœ…     | âœ…               | âœ…        |
| Log Analytics Integration | âœ…     | âœ…               | âœ…        |

---

## ðŸ“Š Diagram â€” Monitoring Flow

```mermaid
flowchart TD
    A["Azure SQL Database / MI"] -->|Metrics| B["Azure Monitor"]
    A -->|Logs| C["Log Analytics Workspace"]
    C --> D["KQL Queries & Dashboards"]
    B --> E["Alerts & Action Groups"]
    A --> F["Query Performance Insight"]
    A --> G["Automatic Tuning"]
    G --> H["Index / Plan Recommendations"]
    style A fill:#0078D7,stroke:#333,stroke-width:2px,color:#fff;
```

---

## âœ… Summary

| Concept                       | Summary                                        |
| ----------------------------- | ---------------------------------------------- |
| **Azure Monitor**             | Central telemetry and alerting for SQL         |
| **Query Performance Insight** | Visual breakdown of top resource-heavy queries |
| **Automatic Tuning**          | AI-based self-optimization engine              |
| **Intelligent Insights**      | Detects root causes automatically              |
| **Diagnostic Logs**           | Stream detailed telemetry to Log Analytics     |
| **Alerts**                    | Real-time notification via Action Groups       |
