# üìä Cosmos DB ‚Äì Monitoring & Reliability

## üìñ Why Monitoring Matters

Cosmos DB is **global, auto-scaled, and RU-based**, so issues usually show up as:

- Throttling (`HTTP 429` because RU quota exhausted).
- Skewed partitions (hot partition eating RUs).
- Latency spikes (due to consistency, region failover, or poor partitioning).
- Billing surprises (RU over-provisioning).

Monitoring = detecting these **before** your app blows up.

---

## 1Ô∏è‚É£ Service-Level Agreements (SLAs)

Cosmos DB is unique: it offers **comprehensive SLAs**, not just uptime.

| SLA Category     | Guarantee                                          |
| ---------------- | -------------------------------------------------- |
| **Availability** | 99.999% (multi-region with multi-write)            |
| **Latency**      | Reads < 10 ms, Writes < 15 ms (at 99th percentile) |
| **Consistency**  | Guaranteed per chosen consistency model            |
| **Throughput**   | Guaranteed provisioned RU/s                        |

üëâ Exam Trap: SLA **only applies if**:

- You provision **RU/s ‚â• 400** (not serverless with <400).
- For **99.999% availability**, must use **multi-region with multi-write**.

---

## 2Ô∏è‚É£ Monitoring Tools

### a. **Metrics (Azure Monitor)**

- Built-in metrics for:

  - **Consumed RUs**
  - **Throttled Requests (429s)**
  - **Data/Index Usage**
  - **Replication Latency**

üëâ In the Portal: `Cosmos DB ‚Üí Metrics`

### b. **Alerts**

- Configure alerts when:

  - RU consumption > 80%
  - Throttled Requests detected
  - Storage approaching partition limit (50 GB)

### c. **Logs (Diagnostic Settings)**

- Send to:

  - **Log Analytics** (for Kusto queries).
  - **Storage Account**.
  - **Event Hub** (for external monitoring tools).

### d. **Application Insights**

- Monitor **SDK calls** from your app.
- Track query latency and exceptions.
- Detect "fan-out queries" eating too many RUs.

---

## 3Ô∏è‚É£ Reliability Features

### a. **Multi-Region Replication**

- Automatic failover if region goes down.
- Configure **failover priorities**.

### b. **Automatic Failover**

- Cosmos reroutes clients automatically.
- Must be enabled in Portal/CLI.

### c. **Consistency SLAs**

- Cosmos guarantees your chosen consistency model globally.
- Example: If you choose **Bounded Staleness = 5 seconds**, Cosmos enforces it.

### d. **Backups**

- Automatic **continuous backup** (default: every 4 hours, retained 30 days).
- Can restore at **account, DB, or container** level.
- New **Point-in-Time Restore (PITR)** available for fine-grained recovery.

üëâ Exam Trap: Continuous backups = automatic, you don‚Äôt schedule them.

---

## üÜö AWS Comparison

| Feature  | Cosmos DB                                      | DynamoDB                           |
| -------- | ---------------------------------------------- | ---------------------------------- |
| SLA      | Latency, availability, consistency, throughput | Availability only                  |
| Metrics  | Azure Monitor                                  | CloudWatch                         |
| Failover | Multi-region, automatic                        | Global Tables, manual-ish failover |
| Backups  | Continuous + PITR                              | On-demand + PITR                   |
| Alerts   | Built-in                                       | CloudWatch Alarms                  |

üëâ Cosmos DB = more **aggressive SLAs** and built-in monitoring.

---

## üõ†Ô∏è Implementation Examples

### Enable Diagnostic Logs (CLI)

```bash
az monitor diagnostic-settings create \
  --name cosmosDiag \
  --resource "/subscriptions/<subId>/resourceGroups/myrg/providers/Microsoft.DocumentDB/databaseAccounts/mycosmos" \
  --workspace <logAnalyticsId>
```

### Set Automatic Failover (CLI)

```bash
az cosmosdb update \
  --name mycosmos \
  --resource-group myrg \
  --enable-automatic-failover true
```

### Query Logs in Log Analytics (KQL)

```kusto
AzureDiagnostics
| where ResourceType == "DATABASE"
| where OperationName == "Query"
| summarize avg(DurationMs) by bin(TimeGenerated, 5m)
```

---

## üéØ Exam Gotchas

- **SLA** only at RU ‚â• 400.
- **99.999% SLA requires multi-region + multi-write**.
- **Backups are automatic** (no cron-like schedules).
- **Partition limit = 50 GB / 10k RU** (watch metrics).
- **Metrics vs Logs vs App Insights** ‚Üí know when to use each.
- **Automatic failover must be explicitly enabled**.

üëâ Example Exam Question:
_‚ÄúYour app in East US must survive regional outages with automatic failover and 99.999% SLA. What should you configure?‚Äù_
‚úîÔ∏è Multi-region account with **multi-write + automatic failover**.
