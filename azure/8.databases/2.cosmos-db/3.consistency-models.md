# âš–ï¸ Cosmos DB â€“ Consistency Models

## ğŸ“– What is Consistency in Cosmos DB?

When you replicate data across multiple regions, you need a contract between:

- **Consistency** (how fresh/accurate the data is)
- **Latency** (how fast queries return)
- **Availability** (what happens during failures)

Cosmos DB gives you **5 tunable consistency models**, instead of just strong vs eventual like DynamoDB.
This lets you choose the right balance for your app.

---

## ğŸ”‘ The 5 Consistency Levels

Think of them on a spectrum:

<div align="center">
  <img src="image/3.consistency-models/1758041796100.png" alt="Consistency Models in Cosmos DB" style="width: 100%; border-radius: 10px; border: 2px solid white;">
</div>

### 1. **Strong** ğŸ’ª

- **Guarantee**: Always read the **latest committed write**.
- **Trade-off**: Highest latency + reduced availability (only works within 1 region OR two adjacent regions).
- **Use Case**: Banking transactions, stock trading.

### 2. **Bounded Staleness** â³

- **Guarantee**: Reads lag behind writes by at most **N versions** or **T time interval**.
- **Trade-off**: Medium latency, predictable staleness.
- **Use Case**: Leaderboards, order tracking (slight delay OK).

### 3. **Session** ğŸ‘¤ _(Default)_

- **Guarantee**: Within a client session, you always see your own writes (Read-Your-Own-Writes).
- **Trade-off**: Best balance of **performance + consistency**.
- **Use Case**: Web/mobile apps where a user should see their updates immediately.

### 4. **Consistent Prefix** ğŸ“–

- **Guarantee**: Reads never see out-of-order writes (e.g., if writes are A â†’ B â†’ C, youâ€™ll never see A â†’ C without B).
- **Trade-off**: Better latency than Session, but less strict.
- **Use Case**: Social media feeds, logs.

### 5. **Eventual** ğŸŒŠ

- **Guarantee**: No ordering guarantees; reads eventually converge.
- **Trade-off**: Lowest latency, cheapest.
- **Use Case**: Analytics, recommendations, non-critical reads.

---

## ğŸ“Š Comparison Table

| Model                 | Freshness           | Latency | Availability | Ordering  |
| --------------------- | ------------------- | ------- | ------------ | --------- |
| **Strong**            | Latest              | Highest | Lowest       | Ordered   |
| **Bounded Staleness** | N versions / T time | High    | High         | Ordered   |
| **Session** (default) | Latest in session   | Medium  | High         | Ordered   |
| **Consistent Prefix** | Can be stale        | Low     | High         | Ordered   |
| **Eventual**          | Eventually          | Lowest  | Highest      | Unordered |

---

<div align="left">
  <img src="image/3.consistency-models/1758042318437.png" alt="Comparison Table" style="width: 100%; border-radius: 10px; border: 2px solid white;">
</div>

---

## ğŸ§  How It Works Internally

- Cosmos DB uses a **replication protocol** across regions.
- The chosen consistency model defines how many replicas must **acknowledge a write** before confirming.
- Example:

  - **Strong** â†’ All replicas must confirm.
  - **Eventual** â†’ Primary replica confirms immediately, secondaries catch up later.

---

## ğŸ†š AWS Comparison

| Cosmos DB                                   | DynamoDB                         |
| ------------------------------------------- | -------------------------------- |
| 5 consistency levels                        | Only **Strong** and **Eventual** |
| Fine-grained tuning                         | Simple but less flexible         |
| Session-level reads (RYOW)                  | Not directly supported           |
| Global multi-region SLA tied to consistency | Only region-based replication    |

ğŸ‘‰ **Cosmos DB is more flexible**, which is why MSFT loves to test it.

---

## ğŸ› ï¸ Implementation Examples

### Set Consistency at Account Level (CLI)

```bash
az cosmosdb update \
  --name mycosmos \
  --resource-group myrg \
  --default-consistency-level Session
```

### Override Consistency Per Request (C# SDK)

```csharp
QueryRequestOptions options = new QueryRequestOptions
{
    ConsistencyLevel = ConsistencyLevel.BoundedStaleness
};

var query = container.GetItemQueryIterator<dynamic>(
    "SELECT * FROM c", requestOptions: options);
```

ğŸ“Œ **Default = Session**. You can override per request if needed.

---

## ğŸ¯ Exam Gotchas

- **Default consistency = Session**.
- **Strong consistency** only supported across **â‰¤2 regions in the same Azure geography**.
- **Bounded Staleness** â†’ must specify N versions or T interval.
- **Session consistency** ensures **Read-Your-Own-Writes** but not across users.
- **Consistent Prefix** preserves order but not freshness.
- **Eventual consistency** gives max performance but no guarantees.
- **Consistency can be set at account level** (default) and **overridden per request**.

ğŸ‘‰ Typical Exam Question:
_â€œA global shopping app requires users to always see their own updates instantly, but can tolerate stale data from other users. Which consistency model?â€_
âœ”ï¸ **Session**.

---

## ğŸ¬ The Movie Analogy ğŸ¥

Imagine you and your friends are watching a **movie** thatâ€™s being released globally.
Different consistency levels = how fast everyone sees the **latest scene**.

### 1. **Strong** ğŸ’ª = _Everyone in the cinema sees the latest scene at the same time._

- No one is behind.
- **But** you must wait for everyoneâ€™s screen to sync â†’ slow.
- âœ… Use: Banking, critical systems.
- âŒ Donâ€™t use: Global apps with high latency tolerance.

---

### 2. **Bounded Staleness** â³ = _Everyone sees the movie with a delay of exactly 5 minutes._

- Youâ€™ll never be more than **N versions** or **T time** behind.
- Predictable delay.
- âœ… Use: Leaderboards, order status (delay OK, but not chaos).
- âŒ Donâ€™t use: Anything needing _instant correctness_.

---

### 3. **Session** ğŸ‘¤ = _Each person has their own private Netflix account._

- You **always see your own actions instantly** (e.g., â€œcontinue watchingâ€).
- But other usersâ€™ actions might lag.
- âœ… Use: Most web/mobile apps (user sees their own cart, posts, likes).
- âŒ Donâ€™t use: Global shared truth across all users.

---

### 4. **Consistent Prefix** ğŸ“– = _Everyone sees the movie in the correct order of scenes, but they might be behind._

- If the movie is A â†’ B â†’ C, youâ€™ll never see A â†’ C without B.
- But you might only be at A or AB while others are at ABC.
- âœ… Use: Feeds, logs (order matters more than freshness).
- âŒ Donâ€™t use: Apps needing up-to-date reads.

---

### 5. **Eventual** ğŸŒŠ = _Everyone gets the movie scenes at random times, but eventually everyone catches up._

- You might see scene C before B.
- Lowest latency, maximum chaos.
- âœ… Use: Analytics, recommendations, background tasks.
- âŒ Donâ€™t use: Transactions or user-facing critical flows.

---

## ğŸ“Š Easy Table to Memorize

| Level                 | Guarantee                        | Real-Life Analogy              | Best For                     |
| --------------------- | -------------------------------- | ------------------------------ | ---------------------------- |
| **Strong**            | Always latest write              | Everyone in cinema, same frame | Banking, stock trades        |
| **Bounded Staleness** | At most N versions/T time stale  | Always 5 min behind            | Order tracking, leaderboards |
| **Session**           | Read-Your-Own-Writes             | Netflix â€œContinue Watchingâ€    | Most apps (default)          |
| **Consistent Prefix** | Order preserved, freshness not   | Watch movie scenes in order    | Feeds, logs                  |
| **Eventual**          | Eventually consistent, unordered | Scenes arrive randomly         | Analytics, caching           |

---

## ğŸ¯ Exam Hacks

1. **If â€œRead-Your-Own-Writesâ€ appears â†’ Session**.
2. **If â€œMust always see latest globallyâ€ â†’ Strong**.
3. **If â€œPredictable lagâ€ (N versions or T time) â†’ Bounded Staleness**.
4. **If â€œOrder must be preserved, but freshness can lagâ€ â†’ Consistent Prefix**.
5. **If â€œPerformance/lowest latency, stale data fineâ€ â†’ Eventual**.

---

## ğŸ§© Memory Trick

ğŸ‘‰ Just remember the word: **SB-SCE**

- **S**trong
- **B**ounded Staleness
- **S**ession
- **C**onsistent Prefix
- **E**ventual

ğŸ’¡ Mnemonic:
**â€œSome Banks Still Care Eventuallyâ€**

- Banks = Strong (latest data).
- Still = Bounded Staleness (slight delay).
- Care = Session (care about your own stuff).
- Eventually = Eventual (everyone catches up).
