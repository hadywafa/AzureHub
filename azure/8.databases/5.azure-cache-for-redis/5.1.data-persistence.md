# 🗄️ Data Persistence in Azure Cache for Redis

## 📖 Official definition

By default, Redis is **in-memory only** → super fast 🚀 but volatile.  
Azure adds **persistence options** so you can recover data if the cache restarts, node fails, or service reboots.

---

## 🔑 Persistence options

<div align="center">
  <img src="image/5.1.data-persistence/1759581403851.png" alt="xxxxxxxxxxxxx" style="width: 60%; border-radius: 10px; border: 2px solid white;">
</div>

---

### 1️⃣ **No Persistence**

- Redis only stores data in memory.
- If the VM hosting the cache fails → data is lost.
- Best for:

  - Pure caching (data already stored elsewhere, e.g. SQL, CosmosDB).
  - Scenarios where losing cached data is acceptable.

---

### 2️⃣ **RDB (Redis Database Snapshot)**

- **Point-in-time snapshots** of your Redis dataset.
- Periodically writes the full dataset to an Azure Storage Account as `.rdb` files.
- Useful for:

  - Disaster recovery (restore to a specific snapshot).
  - Scenarios where full dataset backups at intervals are acceptable.

- Trade-offs:

  - Snapshot frequency = risk of data loss between snapshots.
  - Good balance of **performance + durability**.

---

### 3️⃣ **AOF (Append-Only File)**

- Logs every write operation (`SET`, `INCR`, etc.) to an append-only file.
- On restart, Redis **replays the log** to reconstruct the dataset.
- Advantages:

  - **More durable**: minimizes risk of data loss (depends on write frequency).
  - Supports **“always safe” mode** (write after every operation).

- Trade-offs:

  - Higher storage I/O cost.
  - Slight performance impact vs RDB.

---

## 🧭 Flow: Redis Persistence Options

```mermaid
---
config:
  look: handDrawn
  theme: dark
title: "Azure Cache for Redis Persistence Options"
---
flowchart TD
    A[Redis In-Memory Cache]

    A --> NP[No Persistence]
    NP:::gray --> L1[Data lost if node restarts]

    A --> RDB["Redis DB Snapshot (RDB)"]
    RDB --> F1[Periodic .rdb backup to Storage Account]

    A --> AOF["Append-Only File (AOF)"]
    AOF --> F2[Every write logged to file]
    F2 --> R1[Replay log to rebuild dataset]

    classDef gray fill:#ddd,stroke:#333,color:#111;
    classDef yellow fill:#fffa99,stroke:#333,color:#111;
    classDef pink fill:#f9f,stroke:#333,color:#111;
    classDef green fill:#99ffa5,stroke:#333,color:#111;

    class NP gray
    class RDB pink
    class AOF green
```

---

## 📜 Sequence: Recovery workflow with AOF

```mermaid
---
config:
  look: handDrawn
  theme: dark
title: "AOF Persistence Recovery"
---
sequenceDiagram
    participant C as Client
    participant R as Redis
    participant A as Append-only File
    participant S as Storage Account

    C->>R: SET user:1 "Alice"
    R->>A: Append "SET user:1 Alice"
    A->>S: Save to Blob (periodic)

    Note over R: Redis crashes/restarts

    R->>A: Read AOF file
    A->>R: Replay commands
    R-->>C: Data restored (user:1="Alice")
```

---

## 🧪 Hands-on tip

When enabling persistence:

- **Choose storage account(s):** You can configure primary + secondary storage accounts for redundancy (that’s the empty “Second Storage Account” in your screenshot).
- **Soft delete warning:** If soft delete is ON in Blob Storage, AOF writes may accumulate → storage costs rise. (Azure even warns you in the UI ✅).

---

## 🧠 Cheat sheet

- **No Persistence** → fastest, but data gone on restart.
- **RDB** → periodic snapshots, good compromise.
- **AOF** → logs every write, best durability, higher cost.
- **Best practice**:

  - Use **No Persistence** when Redis is just a cache.
  - Use **RDB/AOF** when Redis is acting as a **primary data store** (not just a cache).
  - Always configure a **secondary storage account** for HA in production.

---

✅ In short:

- **RDB = backup snapshots** (efficient, periodic).
- **AOF = write journal** (durable, continuous).
- Choose based on **cache vs datastore** role.
