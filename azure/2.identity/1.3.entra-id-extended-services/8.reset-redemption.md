# ğŸ”„ Azure B2B Guest Users & Reset Redemption

## ğŸŸ¢ Introduction

In Azure Active Directory (now **Microsoft Entra ID**), external users (guests) can be invited into your tenant for **B2B collaboration**. When invited, they receive a **redemption link** which they must accept to activate their guest account.

But what if:

- The user redeemed the invitation with the wrong email/identity provider?
- Their original account was deleted or changed?
- You need them to redeem again, without losing all their access assignments?

ğŸ‘‰ This is where **Reset Redemption** comes in.

---

## ğŸ“Œ What is Reset Redemption?

**Reset Redemption** is a feature that allows administrators to **reset the redemption state of a B2B guest user**.

- It **does not delete the user object**.
- It allows the guest to **redeem the invitation again**, possibly using a **different identity provider or email**.
- It **preserves**:

  - User **Object ID**
  - **Group memberships**
  - **App role assignments**
  - **Access permissions**

ğŸ’¡ Think of it as hitting a **â€œReset buttonâ€** on the guestâ€™s invitation acceptance, without wiping out their history in your tenant.

---

## ğŸ— How Redemption Normally Works

1. You invite `guest@contoso.com`.
2. They click the invitation link and **redeem** it with a Microsoft account, work account, or social ID.
3. That external identity is tied permanently to the guest object.

âŒ Without reset, if they later need to use `newguest@contoso.com`, youâ€™d have to **delete and re-invite**, losing permissions.

---

## ğŸ”§ How Reset Redemption Works

When you **reset redemption**:

- The user object remains.
- A new invitation is sent.
- The guest redeems the invite again, using a new identity.
- Access and group assignments are preserved.

---

## âš™ï¸ Permissions Required

To use reset redemption, you need one of the following roles at tenant scope:

- **User Administrator**
- **Helpdesk Administrator**

---

## ğŸš€ Ways to Reset Redemption

### 1ï¸âƒ£ Microsoft Entra Admin Center (UI)

1. Go to [Entra Admin Center](https://entra.microsoft.com).
2. Navigate: **Users** â†’ Find the guest user.
3. On the profile page, look for **Reset redemption status** under B2B collaboration.
4. Click **Reset** â†’ a new invitation will be sent.

---

### 2ï¸âƒ£ Microsoft Graph API

You can programmatically reset redemption with the Graph API:

```http
POST https://graph.microsoft.com/v1.0/invitations
Content-Type: application/json

{
  "invitedUserEmailAddress": "newemail@domain.com",
  "sendInvitationMessage": true,
  "inviteRedirectUrl": "https://myapps.microsoft.com",
  "invitedUser": {
    "id": "<guestUserObjectId>"
  },
  "resetRedemption": true
}
```

Key part ğŸ‘‰ `"resetRedemption": true`

---

### 3ï¸âƒ£ PowerShell (Microsoft Graph SDK)

```powershell
Connect-MgGraph -Scopes "User.ReadWrite.All"

# Find existing guest user
$user = Get-MgUser -Filter "startsWith(mail,'old@domain.com')"

# Send new invitation with reset redemption
New-MgInvitation `
  -InvitedUserEmailAddress $user.Mail `
  -InviteRedirectUrl "https://myapps.microsoft.com" `
  -ResetRedemption `
  -SendInvitationMessage `
  -InvitedUser $user
```

---

## ğŸ“Š Real-World Scenarios

- âœ… **Email Change**: Guest changed companies, now uses `user@newdomain.com`. Reset redemption lets them re-redeem with the new email.
- âœ… **Account Recovery**: Original guest account deleted in their home tenant, but you need them to regain access without re-provisioning everything.
- âœ… **Wrong ID Used**: User redeemed with a personal Microsoft account but should have used a corporate account. Reset redemption fixes this.

---

## âš ï¸ Limitations & Caveats

- ğŸ”¹ Not supported in all setups â€” for example, some **Multitenant Organization (MTO)** scenarios.
- ğŸ”¹ Can cause **OID collisions** if multiple invites map to the same object.
- ğŸ”¹ Only works for **B2B guest users**, not for internal accounts.
- ğŸ”¹ Resetting does **not** remove existing group memberships or permissions â€” by design.

---

## ğŸ–¼ Visual Workflow

<div align="center">

```mermaid
flowchart TD
    A[Guest User Invited] --> B[Redemption Accepted]
    B -->|Identity tied| C[(Guest Object in Tenant)]
    C --> D[Access Granted]

    D -->|Need reset| E[Admin Resets Redemption]
    E --> F[New Invitation Sent]
    F --> G["Guest Redeems Again (new ID/email)"]
    G --> C
```

</div>

---

## âœ… Summary

- **Reset Redemption** = allows a B2B guest to redeem an invitation again.
- Keeps the **user object, groups, app assignments** intact.
- Useful for email changes, identity provider switches, or account resets.
- Can be done via **Entra Admin Center, Graph API, or PowerShell**.
- Watch out for **MTO limitations** and **OID collisions**.

---

## ğŸ“Š Feature Comparison Table

| Feature / Behavior          | **Reset Redemption**                                                                                 | **Re-invite (Delete + Invite again)**                                                 |
| --------------------------- | ---------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------- |
| **User object (Object ID)** | âœ… Preserved (same Object ID remains)                                                                | âŒ New object created (new Object ID)                                                 |
| **Group memberships**       | âœ… Preserved                                                                                         | âŒ Lost (must be re-added manually)                                                   |
| **App role assignments**    | âœ… Preserved                                                                                         | âŒ Lost (must be reassigned)                                                          |
| **Access permissions**      | âœ… Preserved                                                                                         | âŒ Lost (must be re-provisioned)                                                      |
| **User sign-in identity**   | ğŸ”„ Can change (new email/ID provider at redemption)                                                  | ğŸ”„ Can change (based on invite)                                                       |
| **Audit history**           | âœ… Preserved (same user object)                                                                      | âŒ Lost (new user object has fresh history)                                           |
| **Effort required**         | ğŸ”¹ Low â€“ single reset action                                                                         | ğŸ”¹ Higher â€“ delete, re-invite, reassign permissions                                   |
| **Use cases**               | - Email change (new domain) <br> - Wrong account used for redemption <br> - External account deleted | - You want a completely clean user object <br> - User shouldnâ€™t keep past assignments |
| **Risk**                    | ğŸ”¸ Possible OID collision if mismanaged                                                              | ğŸ”¸ Risk of access gaps until assignments are re-provisioned                           |

---

## ğŸ§  Easy Rule of Thumb

- âœ… **Use Reset Redemption** if you want to **keep all access intact** but allow the guest to redeem the invite again with a new identity.
- âŒ **Use Re-invite** if you want a **completely fresh start**, wiping all group memberships, app roles, and audit history.

---

## ğŸ–¼ Visual Side-by-Side

```mermaid
flowchart LR
    subgraph Reset Redemption
    A1[Guest User Object] --> B1[Reset Redemption Action]
    B1 --> C1[New Invite Sent]
    C1 --> D1[Guest Redeems Again]
    D1 --> E1[Same Object ID + Same Permissions]
    end

    subgraph Re-invite
    A2[Guest User Object] --> B2[Delete User]
    B2 --> C2[New Invite Sent]
    C2 --> D2[Guest Redeems Again]
    D2 --> E2[New Object ID + Lost Permissions]
    end
```

---

## âš¡ Real-World Scenarios

- **Reset Redemption**

  - Lindaâ€™s email changed from `linda@contoso.com` â†’ `linda@newco.com`.
  - You reset redemption, she redeems again with the new address.
  - All her Teams, SharePoint, and app access stay intact.

- **Re-invite**

  - John was a contractor whose account must be wiped clean.
  - You delete him and re-invite when he rejoins.
  - He gets a fresh user object, no leftover permissions.

---

## âœ… Summary

- **Reset Redemption** = Same guest object, same permissions, new redemption.
- **Re-invite** = New guest object, new permissions, everything must be reassigned.

---

ğŸ‘‰ Think of **Reset Redemption** as _â€œGive them a new key but keep the same houseâ€_,
while **Re-invite** is _â€œDemolish the house and build them a new one from scratch.â€_ ğŸ ğŸ”‘
