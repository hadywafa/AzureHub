# üîÑ MSAL ‚Äî On-Behalf-Of (OBO) Flow

## üìñ What it is

- An **OAuth 2.0 flow** where an **API (A)** calls another **API (B)** using the **user‚Äôs delegated token**.
- API A exchanges the **incoming access token** for a **new access token** to call API B.
- The new token carries **the same user context** (delegated permissions).

üëâ In short: _API A calls API B ‚Äúon behalf of‚Äù the signed-in user._

---

## üß≠ When to Use

‚úÖ Microservices where one API needs to call another.  
‚úÖ Middle-tier APIs forwarding user identity to downstream APIs.  
‚úÖ Example:

- User signs into a front-end app ‚Üí
- Front-end calls **API A** with user‚Äôs token ‚Üí
- API A calls **API B** using OBO flow.

‚ùå Not used for app-only calls (use **Client Credentials Flow** instead).

---

## üîÑ Flow Breakdown

```mermaid
sequenceDiagram
    participant User
    participant Client as Client App
    participant API1 as API A (Middle-tier)
    participant API2 as API B (Downstream)
    participant Entra as Microsoft Identity Platform

    User->>Client: Signs in
    Client->>API1: Calls with User Access Token
    API1->>Entra: OBO request (exchange incoming token)
    Entra-->>API1: New Access Token for API B
    API1->>API2: Calls with new Access Token
    API2-->>API1: Protected Data
    API1-->>Client: Response
```

---

## üìå Token Exchange (OBO request)

- API A receives an **access token** from client.
- Calls `/token` endpoint with:

  - `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer`
  - `requested_token_use=on_behalf_of`
  - `assertion=<incoming access token>`

---

## ‚úçüèª MSAL.NET Example ‚Äî API A acting on behalf of user

```csharp
using Microsoft.Identity.Client;
using System.Threading.Tasks;

public class TokenHelper
{
    private readonly IConfidentialClientApplication _confidentialClient;
    private readonly string[] _scopes = { "https://graph.microsoft.com/User.Read" };

    public TokenHelper(string clientId, string clientSecret, string tenantId)
    {
        _confidentialClient = ConfidentialClientApplicationBuilder.Create(clientId)
            .WithClientSecret(clientSecret)
            .WithAuthority(new Uri($"https://login.microsoftonline.com/{tenantId}"))
            .Build();
    }

    public async Task<string> GetAccessTokenOnBehalfOfAsync(string incomingAccessToken)
    {
        var userAssertion = new UserAssertion(incomingAccessToken);

        var result = await _confidentialClient
            .AcquireTokenOnBehalfOf(_scopes, userAssertion)
            .ExecuteAsync();

        return result.AccessToken;
    }
}
```

---

## ‚öôÔ∏è How it Works Step by Step

1. User signs into client app ‚Üí gets access token for API A.
2. Client calls **API A** with that token.
3. API A validates token, then creates a `UserAssertion`.
4. API A requests a new token **on behalf of the user** for **API B**.
5. API A calls **API B** with the new token.
6. API B enforces **delegated permissions**.

---

## üìù Real-World Example

- **Front-end web app** lets user view files.
- App calls **API A** (File Service).
- API A calls **API B** (Microsoft Graph ‚Üí OneDrive).
- API A must call Graph _on behalf of the signed-in user_.
- Without OBO ‚Üí Graph would think API A is acting alone.
- With OBO ‚Üí Graph enforces _user‚Äôs delegated rights_.

---

## üìå Exam & Real-World Notes

- **OBO = delegated permissions across APIs.**
- Requires:

  - Both API A & API B registered in Entra ID.
  - API A must be configured as a **confidential client**.
  - User‚Äôs original token must include scope for API A.

- OBO fails if:

  - API A only has application permissions (not delegated).
  - User didn‚Äôt consent to downstream API permissions.

- Refresh tokens are handled automatically by MSAL.

---

## ‚úÖ Quick Recap

- **Authorization Code Flow** ‚Üí User signs into app.
- **Device Code Flow** ‚Üí No browser, CLI/IoT.
- **Client Credentials Flow** ‚Üí App-only, no user.
- **On-Behalf-Of Flow** ‚Üí API ‚Üí API with user context.
