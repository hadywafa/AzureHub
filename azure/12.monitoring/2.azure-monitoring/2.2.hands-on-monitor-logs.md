# 🧪 Lab Guide: Azure Monitor Logs (Step by Step)

## 🏗️ **Lab Objective**

By the end of this lab you will:

1. Create a **Log Analytics Workspace (LAW)**.
2. Configure **data ingestion** (VM via AMA + DCR, Diagnostic Settings).
3. Query data using **Kusto Query Language (KQL)**.
4. Explore **insights and solutions** powered by LAW.

---

## 🔹 **Step 1: Create a Log Analytics Workspace**

1. Go to **Azure Portal → Search → Log Analytics Workspaces**.
2. Click **+ Create**.

   - **Subscription**: Select your subscription.
   - **Resource group**: `RG-Monitoring-Lab`.
   - **Name**: `LAW-MonitorLab`.
   - **Region**: Same as your VM for performance (e.g., `East US`).
   - **Pricing Tier**: Per GB (default).
   - **Retention**: 30 days (default, can extend later).

3. Click **Review + Create → Create**.

✅ Now you have a **central database** for logs.

---

## 🔹 **Step 2: Connect a Virtual Machine to LAW**

Here we’ll install the **Azure Monitor Agent (AMA)** and set up a **Data Collection Rule (DCR)**.

### 2.1 Install AMA

1. Go to **VM → Extensions + Applications → + Add**.
2. Select **Azure Monitor Agent** → Install.

   - If AMA already exists, you’re good (newer VMs may have it by policy).

### 2.2 Create a Data Collection Rule (DCR)

1. Go to **Azure Monitor → Data Collection Rules → + Create**.

   - Name: `DCR-VMLogs`.
   - Region: Same as LAW.
   - Add resources: Select your VM.
   - Destinations: Select `LAW-MonitorLab`.

2. **Configure Data Sources** inside the DCR:

   - **Windows Event Logs**: Add → `System`, `Application`, `Security`.
   - **Performance Counters**: Add CPU %, Memory %, Disk I/O, Network In/Out.
   - **Syslog** (for Linux VMs): Facility `auth`, `syslog`, Levels `Error`, `Critical`.

3. **Save + Deploy**.

✅ Now your VM starts sending **Perf + Event logs** to LAW.

---

## 🔹 **Step 3: Connect Azure Resource Logs (Diagnostic Settings)**

Not just VMs — you want Azure services (e.g., Storage, Key Vault, SQL DB) to send logs.

Example: **Connect Storage Account logs to LAW**

1. Go to **Storage Account → Monitoring → Diagnostic Settings → + Add**.
2. Select categories:

   - Audit logs (e.g., BlobRead, BlobWrite).
   - Metrics (transactions, latency).

3. Destination: **Send to Log Analytics Workspace → LAW-MonitorLab**.
4. Save.

✅ Now resource-level logs flow into LAW.

---

## 🔹 **Step 4: Validate Data in LAW**

1. Go to **LAW-MonitorLab → Logs (Preview)**.
2. Run basic queries:

### Check if VM is reporting (Heartbeat)

```kql
Heartbeat
| summarize LastSeen=max(TimeGenerated) by Computer
```

### CPU Usage (Perf table)

```kql
Perf
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| summarize AvgCPU=avg(CounterValue) by bin(TimeGenerated, 5m), Computer
```

### Windows Event Logs (Event table)

```kql
Event
| where TimeGenerated > ago(1h)
| project TimeGenerated, Computer, EventLevelName, RenderedDescription
| order by TimeGenerated desc
```

### Storage Account Access Logs

```kql
StorageBlobLogs
| where TimeGenerated > ago(1d)
| summarize Count=count() by OperationName, AuthenticationType, StatusText
```

---

## 🔹 **Step 5: Explore Insights and Solutions**

- Go to **Azure Monitor → Insights**:

  - **VM Insights**: Visualize CPU, Memory, Disk (from LAW).
  - **Container Insights**: See Kubernetes pod logs.
  - **Network Insights**: Flow logs analysis.

- Add a **Workbook** for rich dashboards:

  - Azure Monitor → Workbooks → + New → Use LAW queries to build charts.

---

## 🔹 **Step 6: Retention & Cost Management**

- Default = 30 days retention.
- Can extend to 2 years.
- Beyond retention → **Archive Logs** (cheaper, slower retrieval).
- Monitor usage:

  ```kql
  Usage
  | summarize IngestedGB=sum(Quantity) by bin(TimeGenerated,1d), DataType
  ```

---

## 🎯 Final Result

At this point you:

- Have a **Log Analytics Workspace**.
- Connected **VM + Azure services** to LAW.
- Queried logs via **KQL**.
- Built first monitoring dashboards.
- Prepared LAW for powering **Alerts, Defender, Sentinel, and App Insights**.
