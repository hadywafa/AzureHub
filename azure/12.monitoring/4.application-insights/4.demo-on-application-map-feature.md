# 🗺️ Demo Troubleshooting App Performance with Application Map

## 🌟 What is Application Map?

- A **visual topology** of your app’s components and dependencies.
- Each node = service/component (Web App, SQL DB, Storage, API, Queue, etc.).
- Each edge = dependency call (with latency, throughput, failures).
- Goal = **quickly spot bottlenecks, broken links, or failing dependencies**.

Think of it as your **“Google Maps for app telemetry”** — you don’t need to dig logs blindly; you see the _whole journey of a request_.

---

## 🖼️ Example Diagram (Overview)

Imagine a **central node (your app)** handling 12% of traffic, connected to:

- **Blob Storage** → 1.5k calls, 12.5 ms avg, **25% failures** ❌ (bottleneck 🚨)
- **SQL DB** → 3.8k calls, 16.3 ms avg, **5% failures** ⚠️ (needs tuning)
- **Queue Storage** → 1.1k calls, 8.3 s avg, **0% failures** ✅ (slow but stable)
- **Availability Circle** → 25% uptime, 517 synthetic tests, avg 8.3 s ⏱️

👉 The map uses **color + size** to scream problems:

- 🔴 Red edge = failing calls
- 🟡 Yellow node = slow response
- 🟢 Green node = healthy

---

## 🔍 How to Use Application Map

### Step 1: Deploy App with App Insights Enabled

- In Azure Portal → **App Services → Create Web App**
- Enable **Application Insights** ✅
- Choose `.NET 8` runtime (or your stack)
- Region: e.g., _Canada Central_
- App Insights settings (choose **Yes** under _Monitor + Secure_)

This hooks your app into telemetry collection automatically.

---

### Step 2: Explore Dependencies

- Go to your App Insights resource → **Application Map**
- Look at:

  - **Request flows** (entry → downstream services)
  - **Failure %** (where’s the red circle?)
  - **Latency hot spots** (is SQL slower than expected?)
  - **Throughput** (are calls piling up on one dependency?)

---

### Step 3: Availability Tests 🌍

- Application Map can **include synthetic availability checks**.
- You can test any HTTP/HTTPS endpoint (up to 100 tests).
- Example: Ping an external REST API your app depends on (even if you don’t own it).
- A red availability node = the API is flaky.

---

### Step 4: Drill Into Details

Click on a node or edge:

- **Blob node** → see failure exceptions & stack traces
- **SQL edge** → see queries + duration (Profiler shows SQL text!)
- **App node** → see failed requests, custom exceptions

---

## 🐛 The “Broken App” Demo (Hands-On)

This app simulates common errors so you can see them pop up in Application Map:

- **NullReferenceException**
- **DivideByZeroException**
- **Custom Exception**
- **Broken Database Connection**

### Landing Page (Razor Page)

```html
<h1>The Broken App 🐛</h1>
<div>
  <button onclick="location.href='?handler=NoneReference'">Null Reference</button>
  <button onclick="location.href='?handler=DivideByZero'">Divide By Zero</button>
  <button onclick="location.href='?handler=CustomException'">Custom Exception</button>
  <button onclick="location.href='?handler=DatabaseError'">Broken DB Connection</button>
</div>
```

### Example: Divide By Zero

```csharp
public IActionResult OnGetDivideByZero()
{
    int zero = 0;
    var result = 1 / zero;
    return Page();
}
```

### Example: Broken DB Connection

```csharp
public IActionResult OnGetDatabaseError()
{
    string connectionString = "Server=tcp:brokenserver.database.windows.net;Database=NonExistentDB;User Id=baduser;Password=badpassword;";
    try
    {
        using var conn = new SqlConnection(connectionString);
        conn.Open();
    }
    catch (SqlException ex)
    {
        throw new InvalidOperationException("Database connection failed.", ex);
    }
    return Page();
}
```

Deploy this to Azure, then trigger the buttons → you’ll see **red nodes** light up in your Application Map.

---

## ⚙️ Profiler, Snapshot Debugger & More

When enabling App Insights monitoring you can turn on:

- **Profiler** → deep traces of slow requests (where time is spent in code)
- **Snapshot Debugger** → capture local vars + call stack when exceptions occur
- **SQL Commands** → view actual queries, parameters, and durations

---

## 📊 Verify in Portal

1. Go to **Application Insights → Failures**

   - See 500 errors from NullRef, DivideByZero, DB failures

2. Go to **Live Metrics**

   - Watch real-time requests & exceptions

3. Go to **Application Map**

   - See failing dependencies marked in red
   - Click nodes for full details

---

## 🎯 Why It’s Useful

- Fast **root-cause analysis** → see if it’s SQL, Blob, or your code.
- Great for **distributed systems** → visualize service-to-service traffic.
- Combine with **Availability tests** → detect external API outages.
- Works with **live metrics** → confirm fixes instantly.

---

## 🧠 Easy Way to Memorize Features

Think of **Application Map** as your **3D MRI scanner** for apps:

- 🧩 **Pieces** = components (nodes)
- 🔗 **Connections** = dependencies (edges)
- 🎨 **Colors** = health (red=bad, green=ok)
- 👆 **Click** = drill into stack traces, SQL, or exceptions

---

✅ With this, you can deploy a “Broken App”, press the error buttons, and see **live red nodes appear in Application Map** — the most fun way to learn Application Insights troubleshooting.
