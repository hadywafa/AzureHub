# 🥑 **Availability Set (AS)**

**Definition (Microsoft official):**
An _Availability Set_ is a logical grouping of VMs that ensures your application remains available during planned and unplanned maintenance events.

👉 Think of it like a **chessboard grid**:

- **Rows = Update Domains (UDs)** → protect against **planned updates**.
- **Columns = Fault Domains (FDs)** → protect against **unplanned hardware failures**.

Azure automatically spreads your VMs across this grid when you place them inside an availability set.

---

## ⚡ **Fault Domains (FDs)**

- **What it is:** A **rack of servers** with independent **power + network switch**.
- **Unplanned protection:** If a rack loses power or network → all VMs in that rack (FD) go down.
- Azure ensures your VMs are split across **2 or 3 FDs** (depends on region).

### Example – 2 Fault Domains, 4 VMs

```ini
FD1 (Rack1): VM1, VM3
FD2 (Rack2): VM2, VM4
```

If FD1 rack dies → only VM1 & VM3 go offline. VM2 & VM4 are still alive.

---

## 🔄 **Update Domains (UDs)**

- **What it is:** A group of VMs that Azure can reboot at the same time during **planned maintenance**.
- **Planned protection:** Azure updates one UD at a time.
- By default, **5 UDs**, configurable up to **20**.

### Example – 5 Update Domains, 10 VMs

```ini
UD1: VM1, VM6
UD2: VM2, VM7
UD3: VM3, VM8
UD4: VM4, VM9
UD5: VM5, VM10
```

If Azure patches UD3 → only VM3 and VM8 reboot. Others remain online.

---

## 🧩 **How FD + UD Work Together**

⁉️ Questions:

You have an Azure Subscription and an availability set Prod-AS-01 that has 5 update domain. You deploy 27 virtual machines to Prod-AS-01.
After a planned update, what is the minimum number of virtual machines that are available?

✅ Answer:

### **📌 If FD = 3**

| UD ↓ / FD →  | **FD1**   | **FD2**   | **FD3**   | UD Total |
| ------------ | --------- | --------- | --------- | -------- |
| **UD1**      | VM1,VM2   | VM3,VM4   | VM5,VM6   | 6        |
| **UD2**      | VM7,VM8   | VM9,VM10  | VM11,VM12 | 6        |
| **UD3**      | VM13,VM14 | VM15,VM16 | VM17      | 5        |
| **UD4**      | VM18,VM19 | VM20      | VM21,VM22 | 5        |
| **UD5**      | VM23      | VM24,VM25 | VM26,VM27 | 5        |
| **FD Total** | 9         | 9         | 9         | 27       |

#### 🟢 Case 1: Planned Maintenance (Update Domains)

- Azure updates **one UD at a time**.
- Worst case = a UD with **6 VMs** goes offline.

👉 **Available VMs = 27 – 6 = 21**

#### 🔴 Case 2: Unplanned Failure (Fault Domains)

- If FD2 rack loses power/network:

  - All **9 VMs in FD2** are down.
  - Remaining = **18 VMs still available**.

👉 **Available VMs = 27 – 9 = 18**

### **📌 If FD = 1**

| UD ↓ / FD →  | **FD1**                    | UD Total |
| ------------ | -------------------------- | -------- |
| **UD1**      | VM1,VM2,VM3,VM4,VM5,VM6    | 6        |
| **UD2**      | VM7,VM8,VM9,VM10,VM11,VM12 | 6        |
| **UD3**      | VM13,VM14,VM15,VM16,VM17   | 5        |
| **UD4**      | VM18,VM19,VM20,VM21,VM22   | 5        |
| **UD5**      | VM23,VM24,VM25,VM26,VM27   | 5        |
| **FD Total** | 27                         | 27       |

#### 🟢 Case 1: Planned Maintenance (Update Domains)

- Azure updates **one UD at a time**.
- Worst case = a UD with **6 VMs** goes offline.

👉 **Available VMs = 27 – 6 = 21**

#### 🔴 Case 2: Unplanned Failure (Fault Domains)

- If FD1 rack loses power/network:

  - All **27 VMs in FD2** are down.

👉 **Available VMs = 27 – 27 = 0**

---

## 🔎 **Exam Case Examples**

### Case 1 – Planned Maintenance (UDs matter)

- Only **1 UD reboots at a time**.
- Largest UD has 6 VMs.
- Out of 27 → 6 offline → **21 available** ✅

### Case 2 – Unplanned Rack Failure (FDs matter)

- If FD2 rack dies, all 9 VMs in FD2 are offline.
- Out of 27 → 9 offline → **18 available** ✅

---

## 🧠 **Analogies to Remember**

- **Fault Domain (FD) = Different Rooms**  
  Each room has separate power/network. If one room’s power trips → only those servers die.

- **Update Domain (UD) = Maintenance Shifts**  
  IT says: “I’ll patch/reboot one shift (UD) at a time.”

- **Availability Set = Chessboard Grid**  
  Azure places your VMs across rows (UDs) and columns (FDs) so not all your eggs are in one basket.

---

## 📝 **Key Notes to Memorize**

- **FD = Unplanned protection** (rack/power/network).
- **UD = Planned protection** (maintenance/patching).
- **Availability Set** = group VMs → Azure auto-spreads them across FDs + UDs.
- Default = **2–3 FDs, 5 UDs**.
- Planned update → only 1 UD offline → worst-case = largest UD size.
- Unplanned failure → 1 FD offline → worst-case = total VMs in that FD.
- For **99.95% SLA** you need **2+ VMs in an availability set**.
