# âš™ï¸ **How Incremental Snapshots Work in Azure Managed Disks**

> ğŸ§  **TL;DR**
> Incremental snapshots in Azure are **not scheduled or automatic** (like AWS EBS Lifecycle Policies).  
> You **manually trigger** them â€” and **Azure internally tracks only changed blocks** since the **last snapshot**.

---

## ğŸ§© Core Concept

An **incremental snapshot** in Azure captures only **changed blocks** (deltas) from the last snapshot.

Think of your managed disk like this:

```ini
[ Block A ][ Block B ][ Block C ][ Block D ]
```

- ğŸ“¸ **Snapshot 1:** Captures all blocks (A, B, C, D) â†’ baseline
- ğŸ“¸ **Snapshot 2:** Captures only blocks that changed (say, B and D)
- ğŸ“¸ **Snapshot 3:** Captures only newly changed blocks (say, C)

Azure internally maintains a **block map** to keep track of which blocks changed since the last snapshot.

---

## â±ï¸ When Are Incremental Snapshots Taken?

> âš ï¸ **Thereâ€™s no automatic schedule!**

You â€” or your automation â€” must **explicitly trigger** a snapshot using:

- Azure CLI
- PowerShell
- REST API
- SDK
- Azure Policy
- Azure Backup service (if you want scheduled snapshots)

---

### ğŸ”§ Example Manual Snapshot Trigger

```bash
az snapshot create \
  --name daily-snap-001 \
  --resource-group RG1 \
  --source myManagedDisk \
  --incremental true
```

ğŸ§© You decide **when** to run it â€” hourly, daily, weekly â€” using tools like:

- **Azure Automation**
- **Azure Logic Apps**
- **Azure Functions with Timer Trigger**
- **DevOps Pipelines**

ğŸ’¡ **So no**, Azure doesnâ€™t take snapshots â€œevery minuteâ€ by default.

---

## ğŸ§  What Happens Internally (Incremental Logic)

Letâ€™s visualize how it behaves between snapshots ğŸ‘‡

<div align="center" style="background-color: #1E1E1E; border-radius: 10px;">

```mermaid
---
config:
  look: handDrawn
  theme: dark
  layout: elk
  elk:
    mergeEdges: false
    nodePlacementStrategy: LINEAR_SEGMENTS
title: "Incremental Snapshot Internals"
---
flowchart TB
    D["ğŸ’½ Managed Disk"]
    S1["ğŸ“¸ Snapshot 1 (Full baseline)"]
    S2["ğŸ“¸ Snapshot 2 (Changed blocks only)"]
    S3["ğŸ“¸ Snapshot 3 (Next changes)"]

    D --> S1
    D --> S2
    D --> S3

    S2 -.depends on.-> S1
    S3 -.depends on.-> S2
```

</div>

ğŸ§© Azure keeps a **dependency chain**:

- If you delete **S1**, Azure merges its required blocks into **S2** automatically.
- So your later snapshots (S2, S3) remain valid â€” no broken references.

---

## ğŸ“¦ How Azure Tracks Changes

Azureâ€™s **storage layer** (think of it like â€œblock diff trackingâ€) uses a **block change map**.

When you write to the disk:

- Azure flags changed blocks
- On snapshot trigger â†’ only those blocks are persisted as new deltas

âœ… Benefits:

- Low cost (only changed data stored)
- Fast snapshot creation (seconds)
- Minimal I/O impact on live VM

ğŸ’¡ Internally, Azure uses **incremental block blob storage** to store those delta blocks efficiently.

---

## ğŸ§° How to Automate Incremental Snapshots (Example)

Example: Take incremental snapshots every **6 hours**

### ğŸ•’ Using Logic App / Automation Schedule

```yaml
recurrence:
  frequency: Hour
  interval: 6
actions:
  create_snapshot:
    type: Azure CLI
    script: >
      az snapshot create --name autosnap-$(date +%s)
      --resource-group RG1 --source myDisk --incremental true
```

---

## ğŸŒ When Full Snapshots Happen in This Chain

Even though you only ask for â€œincremental,â€
Azure **automatically handles** the first one as **full baseline**.

| Snapshot # | Data Copied         | Depends On  |
| ---------- | ------------------- | ----------- |
| ğŸ§± #1      | All blocks          | None        |
| ğŸ” #2      | Only changed blocks | Snapshot #1 |
| ğŸ” #3      | Only changed blocks | Snapshot #2 |
| ğŸ” #4      | Only changed blocks | Snapshot #3 |

If you **copy/export** snapshot #4 â†’ it becomes a **full**, independent snapshot (Azure rehydrates the chain).

---

## ğŸ§© Retention & Cleanup

| Aspect                      | Behavior                                                        |
| --------------------------- | --------------------------------------------------------------- |
| ğŸ§¹ **Auto Cleanup**         | âŒ None (you manage retention manually)                         |
| ğŸ” **Dependency Cleanup**   | âœ… Azure merges deltas automatically when old snapshots deleted |
| ğŸ•’ **Retention Scheduling** | Use Azure Backup or Logic App                                   |
| ğŸ’° **Cost Optimization**    | Delete unneeded deltas to save storage                          |

---

## ğŸ§© Common Automation Patterns

| Use Case              | Tool                                                          | Frequency     |
| --------------------- | ------------------------------------------------------------- | ------------- |
| ğŸ• Hourly incremental | Azure Function Timer                                          | 1 hour        |
| ğŸ—“ï¸ Daily backup       | Azure Automation Runbook                                      | 24 hours      |
| ğŸ—‘ï¸ Retain last 7      | Logic App (delete older than X days)                          | 7 days        |
| ğŸ§­ Cross-region DR    | `az snapshot create --source existingSnap --location eastus2` | Weekly (full) |

---

## ğŸ§± Azure Incremental Snapshots vs AWS EBS Snapshots

| Concept                | Azure                     | AWS                       |
| ---------------------- | ------------------------- | ------------------------- |
| Default Type           | Incremental               | Incremental               |
| Auto Schedule          | âŒ Manual (or via Backup) | âœ… Lifecycle Manager      |
| First Snapshot         | Full baseline             | Full baseline             |
| Triggered By           | Manual / Policy / API     | Lifecycle Manager / API   |
| Changed Block Tracking | Yes (internal block map)  | Yes (CBT-based)           |
| Retention              | Manual                    | Automatic (if configured) |
| Cross-Region Copy      | Full snapshot             | Full snapshot             |

---

## ğŸ’¡ Quick Memory Hook

> ğŸ§  â€œIncrementals donâ€™t tick by time â€” they tick by your trigger.â€

- âœ… You control _when_ snapshots occur
- âœ… Azure tracks _what_ changed
- âœ… It stores _only deltas_
- âœ… Delete old ones freely â€” Azure auto-merges

---

### ğŸ§© Summary Recap

<div align="center" style="background-color: #1E1E1E; border-radius: 10px;">

| Feature           | Behavior                                |
| ----------------- | --------------------------------------- |
| â±ï¸ Frequency      | Manual trigger (not timed)              |
| ğŸ” Type           | Incremental                             |
| ğŸ§± First Snapshot | Full                                    |
| ğŸ’° Cost           | Per changed block                       |
| ğŸ§¹ Retention      | Manual                                  |
| âš™ï¸ Automation     | Use Azure Backup / Logic Apps / Runbook |
| ğŸ” Encryption     | Inherited / Scoped                      |
| ğŸŒ Cross-region   | Creates full copy                       |

</div>
