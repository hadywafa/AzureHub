# ğŸ” **Azure VM Disk Encryption (2025 Updated)**

> ğŸ’¡ _Protecting data across all layers: inside the VM, at the storage layer, and on the physical host._

---

## ğŸ§© Overview â€” Three Core Encryption Layers

Azure protects your disks using **three complementary encryption layers**, plus an optional **encryption scope** for fine-grained control:

<div align="center" style="background-color: #1b3f47ff; border-radius: 10px;">

| ğŸ’¡ Layer Purpose  | âœ… Azure Feature                 | ğŸ“ Where It Happens     | ğŸ”’ Protects                         |
| ----------------- | -------------------------------- | ----------------------- | ----------------------------------- |
| 1ï¸âƒ£ **Inside VM**  | **Azure Disk Encryption (ADE)**  | _Within the Guest OS_   | Data volumes (BitLocker / dm-crypt) |
| 2ï¸âƒ£ **At Storage** | **Server-Side Encryption (SSE)** | _Azure Storage layer_   | Managed disks, snapshots, images    |
| 3ï¸âƒ£ **At Host**    | **Encryption at Host**           | _Physical compute host_ | OS/Data/Temp disks + caches         |

</div>

---

## 1ï¸âƒ£ Azure Disk Encryption (ADE) â€” _Guest OS Encryption_

### ğŸ§© What It Is

Runs **inside the VM**, using:

- ğŸªŸ **BitLocker** (Windows)
- ğŸ§ **dm-crypt** (Linux)

ADE uses an **agent extension** to encrypt disks and store encryption keys in **Azure Key Vault (AKV)**.

<div align="center">
  <img src="images/vm-disk-encypt-2.png" alt="Azure VM Disk Encryption Key Components" style="width: 40%; border-radius: 10px;">
</div>

---

### âš™ï¸ Key Features

| Feature            | Details                                                   |
| ------------------ | --------------------------------------------------------- |
| ğŸ“ Scope           | OS + Data disks (not temp disks)                          |
| ğŸ”‘ Key Management  | Azure Key Vault **(must be in same region)**              |
| ğŸ” Requires Reboot | Yes (applies encryption to volumes)                       |
| ğŸš« Unsupported     | Ultra Disks, ephemeral OS disks, A-series, low-memory VMs |
| ğŸ§© Encryption Type | Volume-level using BitLocker/dm-crypt                     |
| ğŸ§± Architecture    | Guest-side agent encrypts before host/storage layer       |
| ğŸ”“ Decryption      | Performed inside VM using AKV key                         |
| ğŸ” Key Rotation    | Manual â€” re-encrypt with new keys if needed               |

---

### ğŸ” ADE Typical Flow

<div align="center" style="background-color: #1b3f47ff; border-radius: 10px;">

```mermaid
---
config:
  look: handDrawn
  theme: dark
title: "Azure Disk Encryption Flow"
---
sequenceDiagram
  participant VM as ğŸ–¥ï¸ VM (Guest OS)
  participant ADE as ğŸ”‘ ADE Extension
  participant AKV as ğŸ¦ Azure Key Vault
  participant Disk as ğŸ’½ Managed Disk

  VM->>ADE: Install ADE extension
  ADE->>AKV: Retrieve or create encryption key
  ADE->>VM: Encrypt OS/Data volumes (BitLocker/dm-crypt)
  VM->>Disk: Writes now encrypted
  AKV->>ADE: Returns KEK for unlock/decrypt operations
```

</div>

---

### ğŸ§  Quick Comparison

| AWS Term                  | Azure Equivalent          |
| ------------------------- | ------------------------- |
| EC2 BitLocker/LUKS        | Azure Disk Encryption     |
| AWS KMS CMK (client-side) | Azure Key Vault CMK (ADE) |

---

## 2ï¸âƒ£ Server-Side Encryption (SSE) â€” _Storage-Level Encryption_

Azure encrypts all **Managed Disks**, **Snapshots**, and **Images** by default, using **AES-256** encryption before writing data to storage.

---

### ğŸ§© 2.1. SSE with Microsoft-Managed Keys (MMK)

âœ… **Default mode** for all managed disks.

| Property          | Details           |
| ----------------- | ----------------- |
| ğŸ”‘ Key Ownership  | Microsoft         |
| ğŸ”„ Key Rotation   | Automatic         |
| ğŸ§¾ Billing Impact | None              |
| ğŸ› ï¸ Agent Needed   | No                |
| ğŸ“Š Performance    | No impact         |
| ğŸ§© Use Case       | General workloads |

ğŸ’¡ _Equivalent to AWS-managed EBS encryption (`aws/ebs`)._

---

### ğŸ§© 2.2. SSE with Customer-Managed Keys (CMK)

For compliance-focused workloads needing **key ownership** and **revocation**.

| Property         | Details                                                |
| ---------------- | ------------------------------------------------------ |
| ğŸ”‘ Key Ownership | Customer                                               |
| ğŸ¦ Key Storage   | Azure Key Vault or Managed HSM                         |
| ğŸ” Key Rotation  | Manual or via Azure Key Vault automation               |
| âš™ï¸ Requirements  | Managed Disk + Key Vault + RBAC permissions            |
| ğŸ§© Use Case      | Regulated industries (finance, healthcare, government) |

ğŸ’¡ _AWS Equivalent_: **EBS with KMS CMK**

---

### ğŸ§© 2.3. SSE with Double Encryption

A **defense-in-depth** layer that encrypts data **twice** â€” once with a **platform key**, once with your **customer key**.

| Layer | Encryption Type            |
| ----- | -------------------------- |
| 1     | Customer-Managed Key (CMK) |
| 2     | Platform-Managed Key (PMK) |

ğŸ’¡ Provides additional resilience against potential key or storage compromise.
ğŸ§  Supported for **Managed Disks**, **Snapshots**, and **Images**.

---

## 3ï¸âƒ£ Encryption at Host â€” _Physical Layer Encryption_

Encrypts all data handled by the **Azure host machine** (compute node) before writing to storage.

âœ… **Covers everything**, including:

- OS & Data disks
- **Temp Disks (D:)**
- **Host Cache**
- **Diagnostic Disks**

---

### âš™ï¸ Key Details

| Property           | Description                      |
| ------------------ | -------------------------------- |
| ğŸ§© Scope           | All disks attached to VM         |
| ğŸ“¦ Encryption Type | AES-256                          |
| ğŸ—ï¸ Applied On      | Physical host                    |
| âš™ï¸ Enabled         | At VM creation only              |
| ğŸš« Limitation      | Cannot be toggled after creation |
| ğŸ’¡ Tip             | Works seamlessly with SSE        |

---

### ğŸ§  Why It Matters

Without this, **temp disks and caches** may remain unencrypted â€” especially critical for workloads that store **sensitive intermediate data** (e.g., SQL tempdb or scientific processing).

ğŸ’¡ _AWS Equivalent_: Nitro host-level encryption for EC2 instances.

---

## ğŸ” Encryption Scope â€” _Granular Key Control (Newer Feature)_

Introduced to simplify **key hierarchy management** across multiple disks or containers.

### ğŸ’¡ What It Is

An **Encryption Scope** is a **boundary for applying an encryption key** â€” instead of assigning a key per resource, you can define one for:

- A **set of managed disks**, or
- A **container (like blob container)**

All items under that scope inherit the same encryption key and policy.

---

### âš™ï¸ Key Features

| Feature           | Description                                           |
| ----------------- | ----------------------------------------------------- |
| ğŸ“¦ Scope          | Storage account or individual container/disk          |
| ğŸ”‘ Keys Supported | CMK (from Key Vault) or Microsoft-managed             |
| ğŸ”„ Key Rotation   | Supported automatically                               |
| ğŸ§  Benefit        | Easier to manage CMKs across hundreds of disks        |
| ğŸ›¡ï¸ Security       | Strong boundary â€” encryption scopes cannot share keys |

---

### ğŸ§­ Example Use Case

> A financial institution encrypts all â€œFinanceDeptDisksâ€ under a single **Encryption Scope** using one CMK â€” simplifying rotation, audit, and compliance.

---

### ğŸ§  Visual

<div align="center" style="background-color: #1b3f47ff; border-radius: 10px;">

```mermaid
---
config:
  look: handDrawn
  theme: dark
title: "Encryption Scope Flow"
---
flowchart TD
    CMK["ğŸ”‘ Customer-Managed Key (Key Vault)"]
    Scope["ğŸŒ€ Encryption Scope (FinanceDeptScope)"]
    D1["ğŸ’½ Disk-1"]
    D2["ğŸ’½ Disk-2"]
    D3["ğŸ’½ Disk-3"]

    CMK --> Scope --> D1
    Scope --> D2
    Scope --> D3
```

</div>

---

## ğŸ§¾ Summary â€” Compare All Layers

<div align="center" style="background-color: #1b3f47ff; border-radius: 10px;">

| Layer     | Azure Feature                | Applies To                  | Key Location         | Key Type        | Default | Best For                        |
| --------- | ---------------------------- | --------------------------- | -------------------- | --------------- | ------- | ------------------------------- |
| Inside VM | Azure Disk Encryption (ADE)  | OS/Data volumes             | Azure Key Vault      | Customer        | âŒ      | In-guest security policies      |
| Storage   | Server-Side Encryption (SSE) | Managed Disks, Snapshots    | Microsoft / Customer | Platform or CMK | âœ…      | Default protection              |
| Physical  | Encryption at Host           | Temp + cache + all I/O      | Microsoft            | Platform        | âŒ      | Full-stack encryption           |
| Scoped    | Encryption Scope             | Group of disks / containers | Customer             | CMK             | âŒ      | Simplified large-scale key mgmt |

</div>

---

## ğŸ§  Recommended Combinations

<div align="center" style="background-color: #1b3f47ff; border-radius: 10px;">

| Use Case                             | Recommended Layers                                         |
| ------------------------------------ | ---------------------------------------------------------- |
| General workloads                    | **SSE (default MMK)**                                      |
| Compliance (BYOK)                    | **SSE with CMK**                                           |
| OS-level policy requirement          | **ADE + SSE**                                              |
| Full protection including temp/cache | **Encryption at Host + SSE**                               |
| Large disk fleet with one key        | **Encryption Scope (CMK)**                                 |
| Max security combo                   | **ADE + SSE(CMK) + Encryption at Host + Encryption Scope** |

</div>

---

## ğŸ›‘ Important Notes

- **ADE** introduces **VM reboot** and needs **manual key management**
- **SSE** is **always-on** and safest for most workloads
- **Encryption at Host** only applies if enabled at **VM creation**
- Combining all 3 adds **maximum protection**, but also **operational complexity**

---

## âœ… Quick Takeaways

- **SSE (MMK)** = default and mandatory
- **SSE (CMK)** = BYOK for compliance
- **ADE** = inside-VM encryption, needs reboot
- **Encryption at Host** = includes temp/cache
- **Encryption Scope** = simplifies key management across many disks
