# âš™ï¸ Functions in ARM Templates

ARM templates support a wide range of **functions** that allow you to create **dynamic, reusable, and parameterized deployments**. Functions can be used within parameters, variables, resource definitions, and outputs to compute values at runtime.

---

## ğŸ”¹ Why Functions Matter

- Make templates **dynamic** â†’ e.g., generate unique names, IDs, or URIs.
- Reduce duplication by computing values instead of hardcoding.
- Enable **conditional logic** for multi-environment deployments.
- Simplify **string, numeric, and array manipulations**.

---

## ğŸ”¹ Categories of ARM Functions

Functions fall into major groups:

### 1. **String Functions**

Manipulate text values.

- `concat()` â†’ Joins multiple strings.
- `toLower()` / `toUpper()` â†’ Changes case.
- `substring(string, startIndex, length)` â†’ Extracts a substring.
- `length(string)` â†’ Returns length of string.
- `replace(original, old, new)` â†’ Replaces substring.
- `format(formatString, arg1, arg2, â€¦)` â†’ Formats values.

ğŸ“Œ Example:

```json
"variables": {
  "resourceName": "[toLower(concat('stg', uniqueString(resourceGroup().id)))]"
}
```

---

### 2. **Numeric Functions**

Perform calculations.

- `add(a, b)` â†’ Adds two numbers.
- `sub(a, b)` â†’ Subtracts.
- `mul(a, b)` â†’ Multiplies.
- `div(a, b)` â†’ Divides (integer division).
- `mod(a, b)` â†’ Remainder after division.
- `min(a, b)` / `max(a, b)` â†’ Minimum or maximum value.

ğŸ“Œ Example:

```json
"variables": {
  "vmCount": "[add(parameters('baseVmCount'), 2)]"
}
```

---

### 3. **Array & Object Functions**

Work with collections.

- `array(value)` â†’ Converts to array.
- `first(array)` / `last(array)` â†’ Gets first or last element.
- `union(array1, array2)` â†’ Combines arrays.
- `intersection(a1, a2)` â†’ Returns common values.
- `length(array)` â†’ Number of elements.
- `contains(array, value)` â†’ Checks existence.
- `json(string)` â†’ Converts string to JSON object.

ğŸ“Œ Example:

```json
"variables": {
  "vmSizes": ["Standard_B2s", "Standard_D4s_v3"],
  "chosenVm": "[variables('vmSizes')[0]]"
}
```

---

### 4. **Comparison & Logical Functions**

Add conditions and decisions.

- `equals(a, b)` â†’ Boolean check.
- `if(condition, trueValue, falseValue)` â†’ Conditional value.
- `not(value)` â†’ Negates boolean.
- `and(arg1, arg2)` / `or(arg1, arg2)` â†’ Logical operators.

ğŸ“Œ Example:

```json
"variables": {
  "sku": "[if(equals(parameters('environment'), 'prod'), 'Premium_LRS', 'Standard_LRS')]"
}
```

---

### 5. **Deployment & Scope Functions**

Get metadata about current deployment.

- `resourceGroup()` â†’ Current RG info (id, location, name).
- `subscription()` â†’ Subscription details.
- `tenant()` â†’ Tenant ID details.
- `deployment()` â†’ Deployment name, outputs, correlation ID.

ğŸ“Œ Example:

```json
"variables": {
  "rgLocation": "[resourceGroup().location]",
  "subId": "[subscription().subscriptionId]"
}
```

---

### 6. **Resource Functions**

Work with resources.

- `resourceId([subscriptionId], [resourceGroupName], resourceType, resourceName)` â†’ Full resource ID.
- `reference(resourceId, [apiVersion])` â†’ Gets runtime properties of a resource.
- `listKeys(resourceId, apiVersion)` â†’ Retrieves keys (like storage account keys).
- `providers(namespace)` â†’ Info about resource providers.

ğŸ“Œ Example:

```json
"variables": {
  "storageId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
}
```

---

### 7. **Unique String & GUID Functions**

Generate unique but consistent values.

- `uniqueString(baseString1, baseString2, â€¦)` â†’ Deterministic hash string.
- `newGuid()` â†’ Generates a unique GUID each deployment.

ğŸ“Œ Example:

```json
"variables": {
  "dnsLabel": "[concat('app-', uniqueString(resourceGroup().id))]"
}
```

---

### 8. **Date & Time Functions**

Limited support in ARM.

- `utcNow([format])` â†’ Returns current UTC timestamp (ISO 8601 by default).

ğŸ“Œ Example:

```json
"variables": {
  "buildDate": "[utcNow('yyyy-MM-dd')]"
}
```

âš ï¸ Note: `utcNow()` is _non-deterministic_ â†’ every deployment it changes. Use carefully.

---

### 9. **Deployment Script Functions (Bicep & ARM)**

When using `Microsoft.Resources/deploymentScripts`:

- `environment()` â†’ Returns cloud environment info (AzureCloud, AzureChinaCloud, etc.).

---

## ğŸ”¹ Authentication vs Authorization in Functions Context

Some functions (like `listKeys`, `reference`) require:

- **Authentication** â†’ You (deployment identity) must be authenticated to Azure.
- **Authorization** â†’ You must have permission (e.g., `Microsoft.Storage/storageAccounts/listKeys/action`) to fetch sensitive info.

---

## ğŸ”¹ Examples Putting It All Together

### Generate Resource Name with Environment Prefix

```json
"variables": {
  "env": "[parameters('environment')]",
  "storageName": "[toLower(concat(parameters('env'), 'stg', uniqueString(resourceGroup().id)))]"
}
```

### Conditional SKU Selection

```json
"variables": {
  "sku": "[if(equals(parameters('env'), 'prod'), 'Premium_LRS', 'Standard_LRS')]"
}
```

### Using Reference to Fetch Storage Keys

```json
"outputs": {
  "primaryKey": {
    "type": "string",
    "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), '2021-09-01').keys[0].value]"
  }
}
```

---

## ğŸ”¹ Best Practices

- âœ… Use **variables + functions** for readability.
- âœ… Keep **parameters simple**, do heavy logic with functions.
- âœ… Use **`uniqueString()` for deterministic names** (not `newGuid()` unless required).
- âš ï¸ Avoid overusing `utcNow()` (non-repeatable deployments).
- âœ… Always check **RBAC** before using `listKeys` or `reference`.

---

## âœ… Summary

- ARM Templates provide **powerful built-in functions** for strings, numbers, arrays, logic, deployments, and resources.
- They make templates **flexible, reusable, and environment-agnostic**.
- Functions can be combined with **variables and parameters** to create highly dynamic infrastructure definitions.
