# ğŸ” **Azure Key Vault (AKV)**

Azure Key Vault is a **cloud-based service** that helps you **securely store and manage sensitive information**, such as **keys, secrets, and certificates**. Itâ€™s a central place for managing cryptographic keys and secrets that applications and services use, without hardcoding them.

---

<div align="center">
<img src="images/az-vault-key-2.png" alt="Azure Key Vault" style="border-radius: 10px; width: 100%; border: 2px solid">
</div>

---

> ğŸ’¡ Think of Key Vault as **Azureâ€™s equivalent of AWS KMS + Secrets Manager + Certificate Manager combined into one service**.  
> It gives you a **secure, centralized, audited** place to manage secrets, encryption keys, and TLS certificates.

---

## ğŸŒŸ Why Microsoft Created Key Vault

Before Key Vault, apps used to store secrets in:

- `appsettings.json` (bad âŒ)
- Environment variables (better, but still scattered)
- Databases with weak protection

Problem: **secrets sprawled everywhere â†’ security risk, auditing nightmare**.

Solution:

- **Centralized Management** â†’ Manage all your secrets, keys, and certificates in one place.
- Secure with **HSMs (Hardware Security Modules)** in Premium tier.
- Enforce **fine-grained RBAC**.
- Integrate natively with **Azure SDKs, Functions, AKS, App Service, etc.**
- **Automatic Rotation** â†’ Certificates and secrets can be rotated automatically.
- **Logging & Compliance** â†’ Integration with **Azure Monitor**, **Event Hub**, **Sentinel** for audit.

---

## ğŸ­ **Types of Azure Key Vault Pricing Tier**

Choose between:

1. **Standard**: Software-based security
2. **Premium**: Hardware-based security modules, ideal for stringent compliance requirements

---

## ğŸ§© **Types of Azure Key Vault Data**

<div align="center"  >
<img src="images/az-vault-key-1.png" alt="Types of Azure Key Vault Data" style="border-radius: 10px; width: 100%; border: 2px solid">
</div>

---

### 1ï¸âƒ£ **Secrets**

- Secure storage of sensitive data:

  - Connection strings
  - Passwords
  - API keys

- Example: Store a SQL DB password instead of writing it in app config.

  ```bash
  # Store a secret
  az keyvault secret set --vault-name MyKeyVault --name "DBPassword" --value "P@ssw0rd123"

  # Retrieve secret
  az keyvault secret show --vault-name MyKeyVault --name "DBPassword"
  ```

### 2ï¸âƒ£ **Keys**

- Cryptographic keys for **encryption, decryption, signing, and key exchange**.
- Supports software-protected or **HSM-protected** keys.
- Use cases:

  - Data encryption at rest
  - Signing JWT tokens
  - TLS/SSL offloading

- Example:

  ```bash
  # Create RSA key
  az keyvault key create --vault-name MyKeyVault --name "encryptionKey" --protection software --kty RSA
  ```

### 3ï¸âƒ£ **Certificates**

- Manage **X.509 certificates** for TLS/SSL.
- Automatic integration with **Certificate Authorities (CA)**.
- Auto-renewal supported.
- Example:

  ```bash
  # Import certificate
  az keyvault certificate import --vault-name MyKeyVault --name "mycert" --file cert.pfx
  ```

---

## ğŸ§‘â€ğŸ’» **Types of Access Control (RBAC vs Vault Access Policies)**

<div align="center"  >
<img src="images/az-vault-key-3.png" alt="Azure Key Vault Types of Data" style="border-radius: 10px; width: 100%; border: 2px solid;margin: 0 30px">
</div>

---

- **Vault Access Policies**: older checkbox model â†’ assign read/write/delete at vault level
- **Azure RBAC**: unified, fine-grained roles like:

  - `Key Vault Reader` â†’ list metadata
  - `Key Vault Secrets User` â†’ read secrets only
  - `Key Vault Crypto Officer` â†’ encrypt/decrypt but not read key

<div align="center"  >
<img src="image/1.azure-key-vault/1758173263850.png" alt="Azure Key Vault Types of Data" style="border-radius: 10px; width: 100%; border: 2px solid;margin: 0 30px">
</div>

---

ğŸ’¡ **Use RBAC** for modern deployments (consistent across Azure).

---

## âš™ï¸ **How Key Vault Works Internally**

- **Management Plane (control who can manage vault)**

  - At the subscription/resource level
  - Managed via ARM RBAC (`Owner`, `Contributor`, etc.)

- **Data Plane (control who can read/write secrets)**

  - Enforced by **Key Vault RBAC** (e.g., `Key Vault Secrets User`)
  - Requests flow through HTTPS endpoint:

    ```ini
    # Standard key vault
    https://<vault-name>.vault.azure.net/secrets/<secret-name>/<version>
    # Premium key vault
    https://<vault-name>.managedhsml.azure.net/secrets/<secret-name>/<version>
    ```

- **Soft Delete + Purge Protection**

  - Even if someone deletes a secret, you can recover it
  - Purge protection ensures _irrevocable deletion requires explicit action_

---

## ğŸš€ **Creating a Key Vault (Portal)**

1. Search â†’ **Key Vault** â†’ _Create_
2. Configure:

   - Resource Group: `RG-Security`
   - Name: `akv-demo-204` (globally unique)
   - Pricing: **Standard** (software) or **Premium** (HSM)
   - Access Configuration:

     - **Vault Access Policy** (legacy) or
     - **Azure RBAC** (recommended âœ…)

3. Enable **soft delete + purge protection**
4. Review â†’ _Create_

- Once deployed, vault endpoint looks like:

  - for standard vault

    ```ini
    https://akv-demo-204.vault.azure.net/
    ```

  - for premium vault

    ```ini
    https://akv-demo-204.managedhsm.azure.net/
    ```

---

<div align="center">
  <img src="image/1.azure-key-vault/1758172194275.png" alt="Azure Key Vault" style="width: 80%; border-radius: 10px; border: 2px solid white;">
</div>

---

## ğŸ’» **Using Key Vault in .NET**

### Install packages:

```bash
dotnet add package Azure.Identity
dotnet add package Azure.Security.KeyVault.Secrets
```

### Example: Store & Retrieve a Secret

```csharp
using Azure.Identity;
using Azure.Security.KeyVault.Secrets;

var kvUri = "https://akv-demo-204.vault.azure.net/";
var client = new SecretClient(new Uri(kvUri), new DefaultAzureCredential());

// Store secret
client.SetSecret(new KeyVaultSecret("SQLConnectionString",
    "Server=dbserver;Database=appdb;User Id=appuser;Password=P@ssw0rd"));

// Get secret
KeyVaultSecret secret = client.GetSecret("SQLConnectionString");
Console.WriteLine($"Fetched Secret: {secret.Value}");
```

ğŸ‘‰ Notes:

- `DefaultAzureCredential` automatically tries: Managed Identity, VS Code creds, CLI login.
- Never hardcode secrets â€” app just needs RBAC role like **Key Vault Secrets User**.

---

## ğŸ”— **Integration Scenarios**

1. **Applications**

   - Apps fetch secrets (e.g., DB connection strings) dynamically instead of storing them in configs.
   - Use **Managed Identity** â†’ no need to handle credentials.

   Example (C# app snippet):

   ```csharp
   var client = new SecretClient(new Uri("https://mykeyvault.vault.azure.net/"), new DefaultAzureCredential());
   KeyVaultSecret secret = client.GetSecret("DBPassword");
   string dbPassword = secret.Value;
   ```

2. **Azure Services**

   - Integrates with:

     - **Azure SQL** â†’ TDE keys in Key Vault.
     - **Azure Functions** â†’ fetch secrets at runtime.
     - **VMs/VMSS** â†’ disks encrypted using Key Vault keys.

3. **DevOps**

   - Pipelines fetch secrets at build/deploy time.
   - Example: GitHub Actions or Azure DevOps pipeline uses Key Vault secrets.

---

## ğŸ“Š **Backup & Recovery**

- Export and backup (keys, secrets, and certificates).

  ```bash
  # Backup a key
  az keyvault key backup --vault-name MyKeyVault --name encryptionKey --file encryptionKey.backup

  # Restore a key
  az keyvault key restore --vault-name MyKeyVault --file encryptionKey.backup
  ```

- Recovery features:

  - **Soft Delete** â†’ Items recoverable even after deletion (default 90 days).
  - **Purge Protection** â†’ Prevents permanent deletion.

---

## ğŸ›¡ï¸ **Security & Best Practices**

- Use **Private Endpoints** â†’ block public access.
- Always use **RBAC**, avoid legacy Access Policies.
- Enable **soft-delete + purge protection** â†’ prevent accidental deletion.
- Rotate secrets & certificates automatically.
- Monitor access using **Azure Monitor / Sentinel**.
- Restrict export of HSM keys unless required.

---

## ğŸ“‹ Best Practices

- âœ… **Use RBAC, not Access Policies** for consistency
- âœ… **Enable soft delete + purge protection** (default now)
- âœ… **Rotate secrets automatically** (Key Vault supports auto rotation)
- âœ… **Use Managed Identity** for apps â†’ no embedded credentials
- âœ… **Never expose account keys** â†’ always fetch secrets at runtime
- âœ… **Log access** with Azure Monitor + diagnostic settings
- âœ… **Use Premium tier** if compliance requires HSM
