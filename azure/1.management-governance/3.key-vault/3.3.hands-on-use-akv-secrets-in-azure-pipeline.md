# ğŸ” **Project: Use Azure Key Vault Secrets in Azure Pipelines**

## ğŸ“Œ **Project Scenario**

Youâ€™re building a **CI/CD pipeline** in **Azure DevOps**.
Your app needs a **SQL connection string** and an **API key**.

Instead of storing them in pipeline variables or code ğŸ˜±, youâ€™ll use **Azure Key Vault**.
Secrets will be securely pulled **at build time** into your pipeline. ğŸš€

---

## ğŸ“Œ **Step-by-Step Implementation**

### ğŸ”¹ Step 1: Create a Resource Group

```bash
az group create --name rg-kv-pipeline-demo --location eastus
```

---

### ğŸ”¹ Step 2: Create a Key Vault

```bash
az keyvault create \
  --name kvpipeline123 \
  --resource-group rg-kv-pipeline-demo \
  --location eastus \
  --enable-rbac-authorization true
```

ğŸ‘‰ RBAC mode recommended (instead of legacy Access Policies).

---

### ğŸ”¹ Step 3: Add Secrets

```bash
az keyvault secret set --vault-name kvpipeline123 --name "SqlConnectionString" --value "Server=db;Database=app;User=sa;Password=SuperP@ss;"
az keyvault secret set --vault-name kvpipeline123 --name "ApiKey" --value "abc12345xyz"
```

---

### ğŸ”¹ Step 4: Create a Service Principal for Azure DevOps

Azure DevOps pipelines use a **Service Connection** â†’ backed by a Service Principal.

```bash
az ad sp create-for-rbac --name "kv-pipeline-sp" --role "Contributor"
```

âš ï¸ Save the output (`appId`, `password`, `tenant`). Youâ€™ll use these in the **Azure DevOps Service Connection**.

---

### ğŸ”¹ Step 5: Assign Key Vault Access

```bash
# Assign Key Vault Secrets User role
KV_ID=$(az keyvault show -n kvpipeline123 --query id -o tsv)

az role assignment create \
  --assignee <APP_ID_FROM_SP> \
  --role "Key Vault Secrets User" \
  --scope $KV_ID
```

âœ… Now DevOps SP can **read secrets only** (no write/delete).

---

### ğŸ”¹ Step 6: Configure Azure DevOps Service Connection

- Go to **Project Settings â†’ Service Connections â†’ New â†’ Azure Resource Manager**.
- Use the SP credentials from step 4.
- Name it: `sc-azrm-kv`.

---

### ğŸ”¹ Step 7: Use Key Vault in Pipeline (YAML)

```yaml
trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  KV_NAME: kvpipeline123

steps:
  - task: AzureKeyVault@2
    displayName: "Fetch secrets from Key Vault"
    inputs:
      azureSubscription: sc-azrm-kv
      KeyVaultName: $(KV_NAME)
      SecretsFilter: SqlConnectionString,ApiKey # or "*"

  - script: |
      echo "SQL Conn length: ${#SqlConnectionString}"
      echo "ApiKey present? $([ -n "$ApiKey" ] && echo YES || echo NO)"
    displayName: "Use Secrets"
```

ğŸ‘‰ The secret values are injected as masked pipeline variables.
They **canâ€™t be echoed directly**, but you can check length/usage.

---

## ğŸ“Œ **(Optional) Reusable Variable Group**

Instead of repeating the task, link Key Vault once:

1. **Pipelines â†’ Library â†’ Variable Groups â†’ + New**

   - Check: _Link secrets from an Azure key vault_
   - Pick service connection + vault â†’ select secrets.

2. Reference in YAML:

```yaml
variables:
- group: vg-kv-secrets

steps:
- bash: echo "Using DB: ${#SqlConnectionString}"
```

---

## ğŸ“Œ **Security Notes**

- Use **RBAC roles** â†’ _Key Vault Secrets User_ (read-only).
- Rotate secrets in Key Vault â†’ pipeline always pulls **latest version**.
- Never log secrets (Azure masks them automatically).
- If you revoke the SPâ€™s role, pipeline loses access immediately.

---

## ğŸ **TL;DR Project Flow**

1. Create **Key Vault** â†’ add secrets.
2. Create **Service Principal** â†’ add service connection in DevOps.
3. Assign **Key Vault Secrets User** to SP.
4. Add **AzureKeyVault\@2** task in YAML â†’ secrets auto-injected.
5. Use secrets in build/test/deploy safely.
