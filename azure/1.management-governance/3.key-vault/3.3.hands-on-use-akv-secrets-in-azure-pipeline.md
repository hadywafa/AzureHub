# 🔐 **Project: Use Azure Key Vault Secrets in Azure Pipelines**

## 📌 **Project Scenario**

You’re building a **CI/CD pipeline** in **Azure DevOps**.
Your app needs a **SQL connection string** and an **API key**.

Instead of storing them in pipeline variables or code 😱, you’ll use **Azure Key Vault**.
Secrets will be securely pulled **at build time** into your pipeline. 🚀

---

## 📌 **Step-by-Step Implementation**

### 🔹 Step 1: Create a Resource Group

```bash
az group create --name rg-kv-pipeline-demo --location eastus
```

---

### 🔹 Step 2: Create a Key Vault

```bash
az keyvault create \
  --name kvpipeline123 \
  --resource-group rg-kv-pipeline-demo \
  --location eastus \
  --enable-rbac-authorization true
```

👉 RBAC mode recommended (instead of legacy Access Policies).

---

### 🔹 Step 3: Add Secrets

```bash
az keyvault secret set --vault-name kvpipeline123 --name "SqlConnectionString" --value "Server=db;Database=app;User=sa;Password=SuperP@ss;"
az keyvault secret set --vault-name kvpipeline123 --name "ApiKey" --value "abc12345xyz"
```

---

### 🔹 Step 4: Create a Service Principal for Azure DevOps

Azure DevOps pipelines use a **Service Connection** → backed by a Service Principal.

```bash
az ad sp create-for-rbac --name "kv-pipeline-sp" --role "Contributor"
```

⚠️ Save the output (`appId`, `password`, `tenant`). You’ll use these in the **Azure DevOps Service Connection**.

---

### 🔹 Step 5: Assign Key Vault Access

```bash
# Assign Key Vault Secrets User role
KV_ID=$(az keyvault show -n kvpipeline123 --query id -o tsv)

az role assignment create \
  --assignee <APP_ID_FROM_SP> \
  --role "Key Vault Secrets User" \
  --scope $KV_ID
```

✅ Now DevOps SP can **read secrets only** (no write/delete).

---

### 🔹 Step 6: Configure Azure DevOps Service Connection

- Go to **Project Settings → Service Connections → New → Azure Resource Manager**.
- Use the SP credentials from step 4.
- Name it: `sc-azrm-kv`.

---

### 🔹 Step 7: Use Key Vault in Pipeline (YAML)

```yaml
trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  KV_NAME: kvpipeline123

steps:
  - task: AzureKeyVault@2
    displayName: "Fetch secrets from Key Vault"
    inputs:
      azureSubscription: sc-azrm-kv
      KeyVaultName: $(KV_NAME)
      SecretsFilter: SqlConnectionString,ApiKey # or "*"

  - script: |
      echo "SQL Conn length: ${#SqlConnectionString}"
      echo "ApiKey present? $([ -n "$ApiKey" ] && echo YES || echo NO)"
    displayName: "Use Secrets"
```

👉 The secret values are injected as masked pipeline variables.
They **can’t be echoed directly**, but you can check length/usage.

---

## 📌 **(Optional) Reusable Variable Group**

Instead of repeating the task, link Key Vault once:

1. **Pipelines → Library → Variable Groups → + New**

   - Check: _Link secrets from an Azure key vault_
   - Pick service connection + vault → select secrets.

2. Reference in YAML:

```yaml
variables:
- group: vg-kv-secrets

steps:
- bash: echo "Using DB: ${#SqlConnectionString}"
```

---

## 📌 **Security Notes**

- Use **RBAC roles** → _Key Vault Secrets User_ (read-only).
- Rotate secrets in Key Vault → pipeline always pulls **latest version**.
- Never log secrets (Azure masks them automatically).
- If you revoke the SP’s role, pipeline loses access immediately.

---

## 🏁 **TL;DR Project Flow**

1. Create **Key Vault** → add secrets.
2. Create **Service Principal** → add service connection in DevOps.
3. Assign **Key Vault Secrets User** to SP.
4. Add **AzureKeyVault\@2** task in YAML → secrets auto-injected.
5. Use secrets in build/test/deploy safely.
