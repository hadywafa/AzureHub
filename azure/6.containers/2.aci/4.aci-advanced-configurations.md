# âš™ï¸ Azure Container Instances â€“ Advanced Configuration

Azure Container Instances (ACI) goes beyond just "run my container".  
It offers **fine-grained control** over networking, scaling, secrets, and lifecycle. Letâ€™s break it down:

---

## ğŸ’ª **Resource Allocation & GPU**

ğŸ”¹ ACI lets you request **CPU cores** and **Memory**.  
ğŸ”¹ Some regions support **GPU containers** (for ML workloads).

âœğŸ» **Example**

```bash
  az container create \
  -g rg-aci-advanced \
  --name aci-ml \
  --image tensorflow/tensorflow:latest-gpu \
  --cpu 4 \
  --memory 16 \
  --gpu count=1 sku=K80 \
  --restart-policy OnFailure
```

---

## ğŸ”‘ **Secrets Handling**

ğŸ”¹ Inject secrets as **environment variables** (not stored in code/image).  
ğŸ”¹ Or mount them as **secure files** in `/mnt/secrets`.

âœğŸ» **Example â€“ env secrets with restart policy:**

```bash
az container create \
-g rg-aci-advanced \
--name aci-secure-app \
--image myacr.azurecr.io/secureapi:v1 \
--registry-login-server myacr.azurecr.io \
--registry-username myacr \
--registry-password <ACR_PASSWORD> \
--environment-variables DB_CONN="Server=db;User=app;Pwd=supersecret" \
--restart-policy Always \
--ports 5000
```

---

## ğŸ”„ **Lifecycle Management with Restart Policy**

When you run a container in ACI, you must decide **what happens after it exits**.
There are **3 restart policies**:

ğŸ”¹ **Always** â†’ Web apps, APIs (keep alive).  
ğŸ”¹ **OnFailure** â†’ Jobs, batch processing.  
ğŸ”¹ **Never** â†’ One-time jobs (e.g., data migration).

âœğŸ» **Example â€“ word count job:**

```bash
az container create \
  -g rg-aci-advanced \
  --name aci-job \
  --image mcr.microsoft.com/azuredocs/aci-wordcount:latest \
  --restart-policy Never \
  --environment-variables FILE_URL="https://myblob.blob.core.windows.net/data/book.txt" WORD="Azure"
```

---

## ğŸ¤ **Multi-Container Groups**

ğŸ”¹ You can define **sidecar containers** (logging, caching, init jobs).  
ğŸ”¹ They **share network + storage volumes** inside the same ACI group.

âœğŸ» Example YAML with **Env Vars + Restart Policy**

```yaml
apiVersion: 2019-12-01
location: eastus
name: aci-multi
type: Microsoft.ContainerInstance/containerGroups
properties:
  osType: Linux
  restartPolicy: Always
  containers:
    - name: webapp
      properties:
        image: nginx
        resources:
          requests:
            cpu: 1.0
            memoryInGB: 1.5
        environmentVariables:
          - name: APP_MODE
            value: production
    - name: log-agent
      properties:
        image: busybox
        command: ["/bin/sh", "-c", "while true; do echo Logging...; sleep 10; done"]
        resources:
          requests:
            cpu: 0.5
            memoryInGB: 0.5
  volumes: []
```

âœ… `webapp` serves traffic.  
âœ… `log-agent` runs as a sidecar, logs continuously.

---

## ğŸ’¾ **Storage Mounts**

ğŸ”¹ Use **Azure File Shares** or **Azure Managed Disks**.  
ğŸ”¹ Best for apps needing persistent storage (logs, uploads).

âœğŸ» **Example**

```bash
az container create \
  -g rg-aci-advanced \
  --name aci-storage-demo \
  --image nginx \
  --azure-file-volume-share-name myshare \
  --azure-file-volume-account-name mystorageacct \
  --azure-file-volume-account-key <STORAGE_KEY> \
  --azure-file-volume-mount-path /mnt/azure \
  --restart-policy OnFailure
```

---

## ğŸŒ **Networking Options**

ğŸ”¹ **Public IP** â†’ container accessible over the internet.  
ğŸ”¹ **Private VNET** â†’ container joins your virtual network, communicates securely with databases, VNets, AKS.  
ğŸ”¹ **DNS Label** â†’ friendly name instead of raw IP.

âœğŸ» **Example â€“ with VNET & DNS:**

```bash
az container create \
  -g rg-aci-advanced \
  --name aci-api \
  --image mcr.microsoft.com/azuredocs/aci-helloworld \
  --vnet my-vnet \
  --subnet my-subnet \
  --dns-name-label aci-demo-dns \
  --ports 80 \
  --restart-policy Always
```

âœ… Access via: `http://aci-demo-dns.eastus.azurecontainer.io`

---

## ğŸ“Š **Diagnostics & Logs**

- Built-in logs:

  ```bash
  az container logs -g rg-aci-advanced -n aci-api
  ```

- Attach interactively:

  ```bash
  az container attach -g rg-aci-advanced -n aci-api
  ```

- Enable monitoring with **Log Analytics Workspace**.

---

## ğŸ“Œ Summary

- **Restart Policy** = container lifecycle (Always, Never, OnFailure).
- **Environment Variables** = dynamic configs without rebuilding image.
- **Advanced Config Includes**:

  - Networking (VNET, DNS)
  - Storage mounts (Azure Files, Disks)
  - Secrets (env vars or secure mounts)
  - Resource sizing + GPU
  - Multi-container groups
  - Diagnostics (logs + monitoring)
