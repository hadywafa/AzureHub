# ⚙️ Azure Container Instances – Advanced Configuration

Azure Container Instances (ACI) goes beyond just "run my container".  
It offers **fine-grained control** over networking, scaling, secrets, and lifecycle. Let’s break it down:

---

## 💪 **Resource Allocation & GPU**

🔹 ACI lets you request **CPU cores** and **Memory**.  
🔹 Some regions support **GPU containers** (for ML workloads).

✍🏻 **Example**

```bash
  az container create \
  -g rg-aci-advanced \
  --name aci-ml \
  --image tensorflow/tensorflow:latest-gpu \
  --cpu 4 \
  --memory 16 \
  --gpu count=1 sku=K80 \
  --restart-policy OnFailure
```

---

## 🔑 **Secrets Handling**

🔹 Inject secrets as **environment variables** (not stored in code/image).  
🔹 Or mount them as **secure files** in `/mnt/secrets`.

✍🏻 **Example – env secrets with restart policy:**

```bash
az container create \
-g rg-aci-advanced \
--name aci-secure-app \
--image myacr.azurecr.io/secureapi:v1 \
--registry-login-server myacr.azurecr.io \
--registry-username myacr \
--registry-password <ACR_PASSWORD> \
--environment-variables DB_CONN="Server=db;User=app;Pwd=supersecret" \
--restart-policy Always \
--ports 5000
```

---

## 🔄 **Lifecycle Management with Restart Policy**

When you run a container in ACI, you must decide **what happens after it exits**.
There are **3 restart policies**:

🔹 **Always** → Web apps, APIs (keep alive).  
🔹 **OnFailure** → Jobs, batch processing.  
🔹 **Never** → One-time jobs (e.g., data migration).

✍🏻 **Example – word count job:**

```bash
az container create \
  -g rg-aci-advanced \
  --name aci-job \
  --image mcr.microsoft.com/azuredocs/aci-wordcount:latest \
  --restart-policy Never \
  --environment-variables FILE_URL="https://myblob.blob.core.windows.net/data/book.txt" WORD="Azure"
```

---

## 🤝 **Multi-Container Groups**

🔹 You can define **sidecar containers** (logging, caching, init jobs).  
🔹 They **share network + storage volumes** inside the same ACI group.

✍🏻 Example YAML with **Env Vars + Restart Policy**

```yaml
apiVersion: 2019-12-01
location: eastus
name: aci-multi
type: Microsoft.ContainerInstance/containerGroups
properties:
  osType: Linux
  restartPolicy: Always
  containers:
    - name: webapp
      properties:
        image: nginx
        resources:
          requests:
            cpu: 1.0
            memoryInGB: 1.5
        environmentVariables:
          - name: APP_MODE
            value: production
    - name: log-agent
      properties:
        image: busybox
        command: ["/bin/sh", "-c", "while true; do echo Logging...; sleep 10; done"]
        resources:
          requests:
            cpu: 0.5
            memoryInGB: 0.5
  volumes: []
```

✅ `webapp` serves traffic.  
✅ `log-agent` runs as a sidecar, logs continuously.

---

## 💾 **Storage Mounts**

🔹 Use **Azure File Shares** or **Azure Managed Disks**.  
🔹 Best for apps needing persistent storage (logs, uploads).

✍🏻 **Example**

```bash
az container create \
  -g rg-aci-advanced \
  --name aci-storage-demo \
  --image nginx \
  --azure-file-volume-share-name myshare \
  --azure-file-volume-account-name mystorageacct \
  --azure-file-volume-account-key <STORAGE_KEY> \
  --azure-file-volume-mount-path /mnt/azure \
  --restart-policy OnFailure
```

---

## 🌐 **Networking Options**

🔹 **Public IP** → container accessible over the internet.  
🔹 **Private VNET** → container joins your virtual network, communicates securely with databases, VNets, AKS.  
🔹 **DNS Label** → friendly name instead of raw IP.

✍🏻 **Example – with VNET & DNS:**

```bash
az container create \
  -g rg-aci-advanced \
  --name aci-api \
  --image mcr.microsoft.com/azuredocs/aci-helloworld \
  --vnet my-vnet \
  --subnet my-subnet \
  --dns-name-label aci-demo-dns \
  --ports 80 \
  --restart-policy Always
```

✅ Access via: `http://aci-demo-dns.eastus.azurecontainer.io`

---

## 📊 **Diagnostics & Logs**

- Built-in logs:

  ```bash
  az container logs -g rg-aci-advanced -n aci-api
  ```

- Attach interactively:

  ```bash
  az container attach -g rg-aci-advanced -n aci-api
  ```

- Enable monitoring with **Log Analytics Workspace**.

---

## 📌 Summary

- **Restart Policy** = container lifecycle (Always, Never, OnFailure).
- **Environment Variables** = dynamic configs without rebuilding image.
- **Advanced Config Includes**:

  - Networking (VNET, DNS)
  - Storage mounts (Azure Files, Disks)
  - Secrets (env vars or secure mounts)
  - Resource sizing + GPU
  - Multi-container groups
  - Diagnostics (logs + monitoring)
