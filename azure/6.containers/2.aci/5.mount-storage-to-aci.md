# ðŸ’½ Mounting Storage to Azure Container Instances (ACI)

## ðŸ“Œ Why Storage Mounts Matter

Containers by default are **ephemeral** â†’ once they restart, you lose data.
To persist logs, cache, uploaded files, or databases, you need to **mount external storage** into your ACI.

Azure supports **four types** of storage mounts:

1. **Azure File Share** (most common; SMB-based persistent volumes)
2. **Azure Blob Storage (fuse driver)** (Linux only, preview)
3. **Azure Disks** (block storage, like attaching a disk to a VM)
4. **EmptyDir** (ephemeral scratch space shared across containers in the same group)

---

## ðŸ”¹ 1. Mounting **Azure File Share**

Best for: web apps, Redis persistence, configs, logs.

- Backed by **Azure Storage Account â†’ File Share**.
- Mountable across multiple containers in a group.
- SMB over 445 â†’ check firewall/NSG.

### Steps

1. **Create Storage Account & File Share**

   ```bash
   STORAGE=acifilestore$RANDOM
   SHARE=myshare
   az storage account create -n $STORAGE -g $RG -l $LOC --sku Standard_LRS
   KEY=$(az storage account keys list -n $STORAGE -g $RG --query [0].value -o tsv)
   az storage share-rm create --storage-account $STORAGE --name $SHARE
   ```

2. **Mount in ACI YAML**

   ```yaml
   apiVersion: 2021-10-01
   location: eastus
   name: aci-files
   type: Microsoft.ContainerInstance/containerGroups
   properties:
   osType: Linux
   containers:
       - name: app
       properties:
           image: nginx:alpine
           resources: { requests: { cpu: 1, memoryInGB: 1 } }
           volumeMounts:
           - name: myvol
               mountPath: /mnt/data
   volumes:
       - name: myvol
       azureFile:
           shareName: myshare
           storageAccountName: <storage-account-name>
           storageAccountKey: <storage-account-key>
   ```

3. **Deploy**

   ```bash
   az container create -g $RG --file aci-files.yaml
   ```

ðŸ“Œ Now `/mnt/data` inside the container is persisted in Azure File Share.

---

## ðŸ”¹ 2. Mounting **Azure Blob Storage (Blobfuse2)**

Best for: object-store style workloads (media, large datasets).

- Works only on **Linux** containers.
- Requires **fuse driver** (ACI mounts automatically).
- Read/write via blob semantics.

### YAML Example

```yaml
volumes:
  - name: blobvol
    azureBlob:
      containerName: myblobcontainer
      storageAccountName: mystorageacct
      storageAccountKey: <storage-key>
```

Mount inside container:

```yaml
volumeMounts:
  - name: blobvol
    mountPath: /mnt/blob
```

---

## ðŸ”¹ 3. Mounting **Azure Disks**

Best for: single-instance apps needing low-latency storage (like DBs).

- Block device, not shared across containers.
- Must be in same region as ACI.
- Can only mount once (no multi-reader).

```yaml
volumes:
  - name: diskvol
    azureDisk:
      diskName: myManagedDisk
      diskUri: /subscriptions/.../resourceGroups/.../providers/Microsoft.Compute/disks/myManagedDisk
      caching: ReadWrite
      diskIOPSReadWrite: 500
```

---

## ðŸ”¹ 4. **EmptyDir Volume**

Best for: temporary scratch data shared between containers.

- Data lost when group stops.
- Useful for sidecars.

```yaml
volumes:
  - name: cache
    emptyDir: {}
```

Mount:

```yaml
volumeMounts:
  - name: cache
    mountPath: /tmp/cache
```

---

## ðŸ§ª Example: Web App + Redis with File Share Persistence

```yaml
volumes:
  - name: redisdata
    azureFile:
      shareName: redis-share
      storageAccountName: mystorageacct
      storageAccountKey: <storage-key>

containers:
  - name: redis
    properties:
      image: redis:7-alpine
      resources: { requests: { cpu: 0.5, memoryInGB: 0.5 } }
      volumeMounts:
        - name: redisdata
          mountPath: /data
      command: ["redis-server", "--appendonly", "yes", "--dir", "/data"]
```

ðŸ“Œ Redis persistence now survives container restarts.

---

## ðŸ›  CLI Example (Quick Mount)

```bash
az container create \
  -g $RG -n aci-files-demo \
  --image nginx:alpine \
  --azure-file-volume-account-name $STORAGE \
  --azure-file-volume-account-key $KEY \
  --azure-file-volume-share-name $SHARE \
  --azure-file-volume-mount-path /mnt/data \
  --ip-address Public --ports 80
```

---

## âœ… Key Takeaways

- Use **Azure Files** for shared, persistent data.
- Use **EmptyDir** for temporary scratch across sidecars.
- Use **Disks** only if you need block performance.
- Use **Blob mounts** for object storage (large datasets).
- Always store **storage keys in Key Vault or Managed Identity**, not hardcoded in YAML.
