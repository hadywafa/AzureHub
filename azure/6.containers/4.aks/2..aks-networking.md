# ğŸŒ Azure AKS Networking

## ğŸ§  Big Picture (Mental Model First)

Before we touch modes, IPs, or plugins, **understand this core truth**:

> **AKS networking answers 3 questions**

1. **Where does a Pod get its IP from?**
2. **How does traffic flow inside the cluster?**
3. **How does traffic reach outside the cluster (and vice versa)?**

Everything else is just _implementation detail_.

---

## ğŸ—ï¸ AKS Basic Building Blocks (Networking Context)

```mermaid
flowchart LR
    VNET --> Subnet
    Subnet --> NodePool
    NodePool --> Node
    Node --> Pod
```

### Key Components

| Component   | Meaning                  |
| ----------- | ------------------------ |
| **VNet**    | Azure virtual network    |
| **Subnet**  | Where AKS nodes live     |
| **Node**    | Azure VM                 |
| **Pod**     | Smallest Kubernetes unit |
| **Service** | Stable virtual IP (VIP)  |

---

## ğŸš¦ First Distinction (Very Important)

### ğŸ”´ Node IP vs Pod IP

| Item     | Gets IP from                   |
| -------- | ------------------------------ |
| **Node** | Azure **VNet subnet**          |
| **Pod**  | Depends on **networking mode** |

âš ï¸ This is where confusion starts.

---

## ğŸ§© AKS Networking Modes (The Core Topic)

AKS supports **two primary networking models**:

1. **Kubenet** (Legacy / Simple)
2. **Azure CNI** (VNet-native)

   - Azure CNI **Classic**
   - Azure CNI **Overlay**

Letâ€™s go one by one ğŸ‘‡

---

## ğŸŸ¦ 1ï¸âƒ£ Kubenet (Basic / Legacy Mode)

### ğŸ” What is Kubenet?

> **Pods do NOT get IPs from the VNet**

Instead:

- Nodes get VNet IPs
- Pods get IPs from an **internal virtual network**
- Traffic is **NATed** when leaving the node

---

### ğŸ§  IP Allocation (Very Important)

| Resource | IP Source                          |
| -------- | ---------------------------------- |
| Node     | VNet subnet                        |
| Pod      | Internal Pod CIDR (not Azure IPAM) |

---

### ğŸ” Traffic Flow (Kubenet)

```mermaid
sequenceDiagram
    Pod ->> Node: Pod IP (private)
    Node ->> Azure NAT: Source NAT
    Azure NAT ->> Destination: VNet / Internet
```

---

### ğŸ“Œ Characteristics

âœ… Pros

- Uses **fewer VNet IPs**
- Simple to set up
- Cheap

âŒ Cons

- NAT overhead
- Harder troubleshooting
- Limited enterprise features
- **Not recommended for production anymore**

---

### ğŸ§ª Example IPs

```ini
Node IP: 10.0.1.4
Pod IP: 10.244.0.5   (NOT routable in VNet)
```

---

## ğŸ›‘ When to use Kubenet?

ğŸ‘‰ **Almost never in modern AKS**
Only for **learning or small test clusters**

---

## ğŸŸ© 2ï¸âƒ£ Azure CNI (The Real Production Networking)

> **Pods get real IPs that are routable inside the VNet**

This is what most enterprises use.

---

### ğŸ§  Azure CNI â€” Core Idea

> **Every Pod becomes a first-class citizen in the VNet**

No NAT
No hidden networks
No tricks

---

### ğŸŸ© Azure CNI â€” Two Variants (VERY IMPORTANT)

| Mode        | Pod IP Source                            |
| ----------- | ---------------------------------------- |
| **Classic** | VNet subnet (Azure IPAM)                 |
| **Overlay** | Overlay CIDR (VNet-routable via routing) |

Letâ€™s deep dive ğŸ‘‡

---

## ğŸŸ¢ Azure CNI (Classic)

### ğŸ” What Happens Here?

- Nodes get IPs from subnet
- **Pods ALSO get IPs from the SAME subnet**
- Azure **IPAM** manages Pod IPs

---

### ğŸ§  IP Allocation

| Resource | IP Source           |
| -------- | ------------------- |
| Node     | VNet Subnet         |
| Pod      | **Azure VNet IPAM** |

---

### ğŸ” Traffic Flow

```mermaid
sequenceDiagram
    Pod ->> Pod: Direct VNet routing
    Pod ->> Service: No NAT
    Pod ->> Internet: SNAT via Azure
```

---

### ğŸ“Œ Example

```ini
Subnet: 10.0.1.0/24
Node IP: 10.0.1.10
Pod IP: 10.0.1.50
```

ğŸ‘‰ **Pod is directly reachable from any VNet resource**

---

### âš ï¸ BIG PROBLEM (Classic CNI)

âŒ **IP exhaustion**

Each Pod consumes:

- 1 VNet IP
- Pre-allocated IPs per node

Example:

```ini
50 nodes Ã— 30 pods = 1500 IPs ğŸ˜¬
```

---

## ğŸŸ¢ Azure CNI Overlay (Modern & Recommended)

### ğŸ” What is Overlay Mode?

> Pods get IPs from an **overlay network**, BUT
> traffic is **routable without NAT**

Best of both worlds ğŸ’

---

### ğŸ§  IP Allocation

| Resource | IP Source                     |
| -------- | ----------------------------- |
| Node     | VNet subnet                   |
| Pod      | Overlay CIDR (not Azure IPAM) |

âš ï¸ Overlay IPs are **not** Azure IPAM IPs
But Azure knows **how to route them**

---

### ğŸ” Traffic Flow

```mermaid
flowchart LR
    Pod --> Node
    Node --> AzureRouting
    AzureRouting --> VNet
```

- âœ”ï¸ No NAT
- âœ”ï¸ Scales massively
- âœ”ï¸ No IP exhaustion

---

### ğŸ“Œ Example

```ini
Node IP: 10.0.1.10
Pod IP: 192.168.0.5 (Overlay)
```

Still reachable inside the cluster without NAT ğŸ¯

---

## ğŸ† Azure CNI Overlay â€” Why Itâ€™s the Best Choice

âœ… Massive scale
âœ… Lower IP usage
âœ… Full AKS features
âœ… Better performance
âœ… Future-proof

ğŸ‘‰ **This is the default recommendation now**

---

## ğŸ”Œ Services Networking (Very Important)

### ğŸ§© Kubernetes Service Types

| Type         | IP Source               |
| ------------ | ----------------------- |
| ClusterIP    | Virtual IP (kube-proxy) |
| NodePort     | Node IP + Port          |
| LoadBalancer | Azure Load Balancer     |
| ExternalName | DNS only                |

---

### ğŸ§  ClusterIP (Virtual IP)

```mermaid
flowchart LR
    Client --> ServiceVIP
    ServiceVIP --> Pod1
    ServiceVIP --> Pod2
```

âš ï¸ Service IP is **NOT** from VNet
Itâ€™s a **virtual IP managed by kube-proxy**

---

## ğŸŒ Ingress & Egress

### ğŸ”½ Ingress (Incoming Traffic)

Options:

- Azure Application Gateway Ingress Controller (AGIC)
- NGINX Ingress
- Azure Load Balancer

```mermaid
flowchart LR
    Internet --> LoadBalancer --> Ingress --> Service --> Pod
```

---

### ğŸ”¼ Egress (Outgoing Traffic)

| Method      | Use Case           |
| ----------- | ------------------ |
| SNAT        | Default            |
| NAT Gateway | Stable outbound IP |
| Firewall    | Enterprise control |

---

## ğŸ” Network Policies (Security)

AKS supports:

- **Azure Network Policy**
- **Calico Network Policy**

Controls:

- Pod â†’ Pod
- Namespace isolation
- Zero Trust networking

```mermaid
flowchart LR
    PodA -- allowed --> PodB
    PodA -- denied --> PodC
```

---

## ğŸ§  Advanced Topics (You WILL see these in real jobs)

### ğŸ”¹ Pod CIDR vs Service CIDR

### ğŸ”¹ kube-proxy (iptables vs IPVS)

### ğŸ”¹ SNAT port exhaustion

### ğŸ”¹ Private AKS clusters

### ğŸ”¹ VNet peering

### ğŸ”¹ UDRs & custom routing

### ğŸ”¹ Azure Firewall integration

### ğŸ”¹ DNS (CoreDNS + Azure DNS)

### ğŸ”¹ Dual-stack IPv4/IPv6

### ğŸ”¹ Overlay vs VNet latency

---

## ğŸ Final Recommendation (Real World)

| Scenario         | Best Choice                     |
| ---------------- | ------------------------------- |
| Learning         | Kubenet                         |
| Small prod       | Azure CNI Overlay               |
| Large enterprise | Azure CNI Overlay + NAT Gateway |
| Regulated env    | Azure CNI + Firewall            |

---

If you want, next we can:

- ğŸ”¥ Trace **real packet flow step-by-step**
- ğŸ§ª Design an **AKS VNet from scratch**
- ğŸ¯ Compare **AKS vs EKS networking**
- ğŸ“¦ Deep dive **Ingress controllers**
- ğŸ§  Explain **Service Mesh networking (Istio / Linkerd)**

Just tell me what to attack next ğŸ˜„
