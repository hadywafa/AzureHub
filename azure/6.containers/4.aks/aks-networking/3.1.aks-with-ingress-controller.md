# üß† **Ingress-NGINX on AKS ‚Äî Correct Installation & Internals (Production-Grade)**

> On **Azure Kubernetes Service (AKS)**, an Ingress Controller is **not a managed Azure component**.
> It is a **Kubernetes workload (pods + service)** that integrates with **Azure Load Balancer**.
> The **most critical AKS-specific requirement** is **correct Azure Load Balancer health-probe configuration** ‚Äî without it, **traffic is silently dropped** even if Kubernetes is healthy.

---

<div align="center" style="background-color:#2b3436ff; border-radius:10px; border:2px solid">

```mermaid
graph TD
    A([üë§ Client])
    B[(üåç DNS)]
    C@{shape: hex, label: "‚òÅÔ∏è Azure Load Balancer\n(Public Frontend IP)"}
    D@{shape: hex, label: "üö™ Ingress Service\n(type=LoadBalancer)"}
    E@{shape: processes, label: "üß≠ ingress-nginx Controller Pod"}

    S1{{"üß© Backend Service A (ClusterIP)"}}
    S2{{"üß© Backend Service B (ClusterIP)"}}
    P1@{shape: processes, label: "üì¶ App Pod A"}
    P2@{shape: processes, label: "üì¶ App Pod B"}

    A --> B --> C --> D --> E
    E -->|/api| S1 --> P1
    E -->|/web| S2 --> P2
```

</div>

---

## üî¥ **The Problem Ingress Solves (Why It Exists)**

### 1Ô∏è‚É£ Phase 1 ‚Äî NodePort (Primitive Access)

- App exposed via `Service: NodePort`
- Accessed using:

  ```ini
  http://<NodeIP>:31234
  ```

- ‚ùå Problems:

  - No DNS
  - No TLS
  - No routing
  - Operationally ugly

---

### 2Ô∏è‚É£ Phase 2 ‚Äî LoadBalancer per Service

- Each service uses:

  ```yaml
  type: LoadBalancer
  ```

- Azure provisions:

  - Public IP
  - LB rule

- ‚ùå Problems:

  - One public IP **per service**
  - Expensive
  - No path-based routing

---

## üü¢ **Ingress + Ingress Controller (Correct Model)**

- **One** public entry point
- **Many** backend services
- Routing by:

  - Host
  - Path

- TLS termination
- Centralized traffic control

> **Ingress = rules** > **Ingress Controller = engine**

---

## ‚öôÔ∏è **AKS-Specific Ingress Architecture**

<div align="center" style="background-color:#141a19ff;color:#a8a5a5ff; border-radius:10px; border:2px solid">

| Component           | AKS Reality                   |
| ------------------- | ----------------------------- |
| Azure Load Balancer | L4 only (TCP/UDP)             |
| Ingress Controller  | L7 (HTTP/HTTPS)               |
| Backend Pool        | AKS nodes (not pods)          |
| Health Probe        | MUST be explicitly configured |
| NAT Rules           | ‚ùå Never used                 |
| Pod IPs             | ‚ùå Never visible to Azure LB  |

</div>

---

## üåê **Full Request Flow (AKS-Accurate)**

<div align="center" style="background-color:#232b2dff; border-radius:10px; border:2px solid">

```mermaid
sequenceDiagram
    participant User as üë§ User
    participant DNS as üåç DNS
    participant ALB as ‚òÅÔ∏è Azure Load Balancer
    participant Node as üñ•Ô∏è AKS Node
    participant NodePort as üö™ NodePort
    participant NGINX as üß≠ NGINX Ingress
    participant SVC as üß© ClusterIP Service
    participant Pod as üì¶ Pod

    User->>DNS: Resolve domain
    DNS->>ALB: Public IP
    ALB->>Node: TCP 80 ‚Üí NodePort
    Node->>NodePort: kube-proxy
    NodePort->>NGINX: Forward traffic
    NGINX->>SVC: Match host/path
    SVC->>Pod: Load-balance
    Pod-->>User: Response
```

</div>

---

## üß† **CRITICAL AKS RULE (Memorize This)**

> **Azure Load Balancer probes NODE IPs ‚Äî not pods ‚Äî and nodes do NOT listen on port 80/443.**

If health probes fail:

- Azure LB marks nodes **unhealthy**
- **ALL inbound traffic is dropped**
- `curl` times out
- Kubernetes still looks ‚Äúhealthy‚Äù

This is **the #1 AKS Ingress pitfall**.

---

## ‚úÖ **Correct Way to Install ingress-nginx on AKS**

### 0Ô∏è‚É£ Prerequisites

- AKS cluster running
- kubectl configured
- Helm installed

---

### 1Ô∏è‚É£ Add Helm Repository

```bash
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
```

---

### 2Ô∏è‚É£ Install Ingress Controller (AKS-Correct)

```bash
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace \
  --set controller.service.type=LoadBalancer
```

What AKS creates:

- **Service: LoadBalancer**
- Azure:

  - Reuses AKS Standard Load Balancer
  - Adds **new frontend IP**
  - Adds **LB rules (80/443)**
  - Adds **health probes (default = WRONG)**

---

## üö® **MANDATORY AKS FIX ‚Äî Health Probe Annotation**

This step is **not optional**.

### Why?

- Azure LB probes `NodeIP:80`
- Nodes return **no HTTP 200**
- LB marks nodes **DOWN**

---

### ‚úÖ Apply Correct Health Probe

```bash
kubectl annotate svc ingress-nginx-controller -n ingress-nginx \
  service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path=/healthz
```

What happens:

- Azure LB probe ‚Üí `/healthz`
- NGINX responds `200 OK`
- Nodes become **Healthy**
- Traffic flows

---

## üîç **Verify Correct State**

### Kubernetes

```bash
kubectl get svc -n ingress-nginx
```

Expected:

```ini
EXTERNAL-IP   <public-ip>
PORT(S)       80:31xxx,443:30xxx
```

---

### Azure Portal

- Load Balancer ‚Üí Load balancing rules
- Health status:

  ```ini
  100% healthy
  ```

---

## üß© **Ingress Resource (Example)**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress
spec:
  ingressClassName: nginx
  rules:
    - host: hello.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: hello-service
                port:
                  number: 80
```

---

## üîë **Why Azure NAT Rules Are NEVER Used**

| Feature              | Used in AKS Ingress? |
| -------------------- | -------------------- |
| Inbound NAT rules    | ‚ùå No                |
| Load balancing rules | ‚úÖ Yes               |
| Health probes        | ‚úÖ Mandatory         |
| NodePort             | ‚úÖ Internal only     |

NAT rules are **1:1 VM access**, not fan-out traffic.

---

## üß† **Mental Model (Lock This In)**

> **Azure Load Balancer only knows nodes.
> Kubernetes only knows pods.
> Ingress bridges the two ‚Äî but only if health probes are correct.**

---

## üß† **Mnemonic for AKS Ingress ‚Äî ‚ÄúPHANTOM‚Äù**

| Letter | Meaning                         |
| ------ | ------------------------------- |
| **P**  | Public IP (Azure LB frontend)   |
| **H**  | Health probe (/healthz)         |
| **A**  | Azure Load Balancer             |
| **N**  | NodePort                        |
| **T**  | Traffic ‚Üí NGINX                 |
| **O**  | Orchestration via Ingress rules |
| **M**  | Microservices behind ClusterIP  |

---

## üéØ **Interview-Grade One-Liner**

> _On AKS, ingress-nginx must be exposed via a LoadBalancer service with a correctly configured Azure health probe; otherwise, Azure Load Balancer marks nodes unhealthy and silently drops all inbound traffic._
