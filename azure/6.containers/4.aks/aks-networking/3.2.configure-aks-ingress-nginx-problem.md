# üß† **AKS Ingress Health Probe Annotation ‚Äî Internals (No Magic Edition)**

> The annotation
> `service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path=/healthz`
> does **NOT** configure NGINX directly and does **NOT** add Azure logic.
> It is a **contract between Kubernetes and Azure Cloud Controller Manager** that changes how **Azure Load Balancer probes AKS nodes**, while `/healthz` itself is **pure ingress-nginx logic**.

---

<div align="center" style="background-color:#2b3436ff; border-radius:10px; border:2px solid">

```mermaid
graph TD
    A[üìù Kubernetes Service<br/>type=LoadBalancer]
    B[üß† Azure Cloud Controller Manager]
    C[‚òÅÔ∏è Azure Load Balancer]
    D[üñ•Ô∏è AKS Node]
    E[üß≠ ingress-nginx Pod]
    F[/healthz Endpoint]

    A -->|Service annotation| B
    B -->|ARM API call| C
    C -->|HTTP probe| D
    D -->|NodePort iptables| E
    E --> F
```

</div>

---

## üî¥ **The Problem (Before the Annotation)**

### What Azure Load Balancer does by default

When AKS sees:

```yaml
spec:
  type: LoadBalancer
  ports:
    - port: 80
```

Azure Cloud Controller Manager creates:

```text
Health Probe:
  Protocol: HTTP
  Port: 80
  Path: /
```

So Azure LB probes:

```http
GET http://<NodeIP>:80/
```

---

### Why this FAILS on AKS

| Component       | Reality              |
| --------------- | -------------------- |
| AKS Node        | ‚ùå Not a web server  |
| Port 80 on node | ‚ùå Nothing listening |
| Response        | ‚ùå No HTTP 200       |
| LB verdict      | ‚ùå Node = unhealthy  |

Result:

- Backend pool = **0% healthy**
- Azure LB **drops all inbound traffic**
- `curl` ‚Üí **timeout**

This failure happens **before Kubernetes routing**.

---

## üü¢ **What `/healthz` Actually Is**

### üîç Ownership (important)

| Question                           | Answer |
| ---------------------------------- | ------ |
| Is `/healthz` Azure logic?         | ‚ùå No  |
| Is `/healthz` Kubernetes core?     | ‚ùå No  |
| Is `/healthz` ingress-nginx logic? | ‚úÖ Yes |

---

### What ingress-nginx does internally

The ingress-nginx controller process:

- Starts **NGINX**
- Starts a **separate internal HTTP server**
- Exposes fixed endpoints:

  - `/healthz`
  - `/readyz`
  - `/metrics`

`/healthz` means:

> ‚ÄúIs the ingress controller process alive and able to proxy traffic?‚Äù

If yes ‚Üí `HTTP 200`
If no ‚Üí `HTTP 500`

That‚Äôs it.

No Azure awareness. No Kubernetes awareness.

---

## ‚öôÔ∏è **What the Annotation REALLY Does**

### The annotation

```yaml
service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz
```

### ‚ùó Key insight

> This annotation is **read by Azure Cloud Controller Manager**, not by ingress-nginx.

---

## üß† **Azure Cloud Controller Manager (CCM) Logic**

Azure CCM runs a reconciliation loop:

```text
Desired state (K8s Service)
‚Üì
Compare with Azure LB
‚Üì
Apply delta
```

### Pseudocode (conceptual)

```go
if svc.Type == LoadBalancer {
    probePath := annotation["azure-load-balancer-health-probe-request-path"]
    if probePath != "" {
        configureAzureLBProbe(path=probePath)
    }
}
```

---

## üîÅ **What Changes After the Annotation**

### Before

```text
Probe ‚Üí NodeIP:80 /
Result ‚Üí ‚ùå
```

### After

```text
Probe ‚Üí NodeIP:80 /healthz
Result ‚Üí ‚úÖ
```

---

<div align="center" style="background-color:#232b2dff; border-radius:10px; border:2px solid">

```mermaid
sequenceDiagram
    participant ALB as ‚òÅÔ∏è Azure LB
    participant Node as üñ•Ô∏è Node IP
    participant NP as üö™ NodePort
    participant NGINX as üß≠ ingress-nginx
    participant Health as ‚ù§Ô∏è /healthz

    ALB->>Node: GET /healthz
    Node->>NP: iptables DNAT
    NP->>NGINX: forward request
    NGINX->>Health: health check
    Health-->>NGINX: 200 OK
    NGINX-->>ALB: 200 OK
```

</div>

---

## üü¢ **Why the Port Stays 80 (Very Important)**

You might expect:

> ‚ÄúShouldn‚Äôt Azure probe port 10254?‚Äù

Answer: **No**.

Because:

- Azure LB probes **frontend ‚Üí backend mapping**
- Backend port is **NodePort**
- iptables handles the translation
- Azure doesn‚Äôt need to know internal ports

Azure only sees:

```ini
NodeIP:80 ‚Üí healthy or not
```

---

## üß† **Why Azure Does NOT Auto-Detect This**

Because:

- Not all ingress controllers expose `/healthz`
- Some use TCP probes
- Some use custom paths
- Some don‚Äôt expose HTTP at all

So AKS uses:

> **Annotations as an explicit contract**

No guessing. No magic.

---

## üß† **Mental Model (Lock This In)**

> `/healthz` is an ingress-nginx self-test endpoint.
> The annotation tells Azure **where to look**, not **what to run**.
> Azure Load Balancer is blind ‚Äî it only trusts HTTP 200.

---

## üß† **Mnemonic ‚Äî ‚ÄúWATCH, DON‚ÄôT SERVE‚Äù**

| Layer               | Responsibility        |
| ------------------- | --------------------- |
| ingress-nginx       | **Serves** `/healthz` |
| Kubernetes Service  | **Declares** intent   |
| Azure CCM           | **Translates** intent |
| Azure Load Balancer | **Watches** for 200   |

---

## üéØ **Interview-Grade Explanation**

> _The `/healthz` endpoint is implemented by ingress-nginx to expose controller health; the Azure load balancer health probe annotation instructs the Azure Cloud Controller Manager to configure the load balancer to probe that endpoint, allowing node health to be evaluated correctly._

---

If you want next, I can:

- Compare `/healthz` vs `/readyz`
- Trace the **iptables DNAT rules**
- Explain **why NodePort is unavoidable**
- Compare **AKS vs EKS behavior**

Just say the word.
