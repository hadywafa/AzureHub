# âš¡ Dapr in Azure Container Apps (ACA)

## ğŸ—ï¸ ACA Architecture Recap (with Dapr)

<div align="center">

```mermaid
---
config:
  look: handDrawn
  theme: dark
title: "ACA + Dapr Architecture Overview"
---

flowchart TD
  %% Styling
  classDef app fill:#bbf,stroke:#333,stroke-width:2px,color:#000,font-size:12pt;
  classDef dapr fill:#f9f,stroke:#333,stroke-width:2px,color:#000,font-size:12pt;
  classDef infra fill:#bfb,stroke:#333,stroke-width:2px,color:#000,font-size:12pt;

  %% ACA Environment
  subgraph ENV["ğŸŒ ACA Environment"]
    subgraph APP["ğŸš€ Container App"]
      A[ğŸ§© Your App Container]
      S[ğŸ”„ Dapr Sidecar]
      class A,S app
    end

    subgraph DAPR["ğŸ› ï¸ Dapr Control Plane"]
      Placement[ğŸ“ Placement Service]
      Sentry["ğŸ” Sentry (mTLS CA)"]
      Operator[âš™ï¸ Operator]
      class Placement,Sentry,Operator dapr
    end
    class ENV infra
  end

  %% Connections
  A <--> S
  S --> Placement
  S --> Sentry
  S --> Operator
```

</div>

- Each **Container App** can opt-in to Dapr with a simple flag.
- ACA provisions the **Dapr sidecar** for you (no YAML boilerplate).
- Control plane (placement, sentry, operator) is **managed by Microsoft** â†’ you donâ€™t run/patch it.

---

## âš™ï¸ Enabling Dapr in ACA

When you define a Container App, you just add a `dapr` block:

```yaml
properties:
  configuration:
    dapr:
      enabled: true
      appId: orders
      appPort: 5000
      logLevel: debug
```

Thatâ€™s it. Your app now has a sidecar with:

- Service invocation (`/v1.0/invoke/...`)
- State store (`/v1.0/state/...`)
- Pub/Sub
- Secrets
- Actors

---

## ğŸ”‘ How Dapr + ACA Work Together

### 1ï¸âƒ£ Service Invocation

- Call another container app by its **Dapr App ID**:

  ```bash
  curl http://localhost:3500/v1.0/invoke/payments/method/charge
  ```

- ACA **knows app IDs across the environment** â†’ internal DNS/routing handled.

### 2ï¸âƒ£ Pub/Sub

- Configure pub/sub component (e.g., Service Bus, RabbitMQ, Kafka, Redis) in ACA.
- Publish in one app:

  ```http
  POST http://localhost:3500/v1.0/publish/pubsub/orders
  ```

- Subscriber app automatically gets messages at `/orders` endpoint.

### 3ï¸âƒ£ State Management

- Drop in Redis (or Cosmos DB) as a state store component.
- Your app does:

  ```http
  POST /v1.0/state/statestore
  [
    { "key": "cart1", "value": { "item": "book", "qty": 2 } }
  ]
  ```

- ACA/Dapr persists state â†’ no SDKs needed.

### 4ï¸âƒ£ Secrets Management

- Bind Key Vault to Dapr secrets store.
- App retrieves secrets from `http://localhost:3500/v1.0/secrets/keyvault/mySecretKey`.

### 5ï¸âƒ£ Actors

- ACA supports **Dapr actors** natively.
- Great for IoT, gaming, session state, etc.
- You donâ€™t worry about placement â†’ ACAâ€™s Dapr control plane manages it.

---

## ğŸ” Authentication & Security (ACA + Dapr)

- All **Dapr traffic between apps is mTLS secured** (via Dapr Sentry).
- Identity can integrate with **Azure Entra ID** for external requests.
- Secrets can be fetched securely from **Key Vault** using ACA-managed identities.

---

## ğŸ§ª Hands-On: ACA + Dapr (Orders + Payments)

1. **Define components** (Redis for state, Service Bus for pub/sub) in ACA YAML.

   ```yaml
   components:
     - name: statestore
       type: state.azure.cosmosdb
       version: v1
       metadata:
         - name: connectionString
           secretRef: cosmos-conn
   ```

2. **Orders service** (writes state, publishes events).

   ```bash
   POST http://localhost:3500/v1.0/state/statestore
   ```

3. **Payments service** (subscribes to orders events).

   ```yaml
   routes:
     - path: /orders
   ```

4. Both apps run in ACA, both with Dapr enabled.
   â†’ Orders publishes to topic â†’ Dapr routes â†’ Payments receives.

---

## ğŸš€ Why Dapr in ACA Rocks

- âœ… **Zero infra ops** â†’ Dapr control plane is managed.
- âœ… **No sidecar setup** â†’ ACA auto-injects.
- âœ… **Multi-cloud abstractions** â†’ switch Service Bus â†’ Kafka â†’ RabbitMQ with config only.
- âœ… **First-class ACA citizen** â†’ monitored in ACA logs, integrated with ACA secrets/env.

---

## ğŸŒ Real-world Example

Imagine an **e-commerce ACA environment**:

- `orders` app â†’ exposes HTTP API
- `payments` app â†’ invoked via Dapr service invocation
- `inventory` app â†’ consumes messages from pub/sub
- `cart` app â†’ uses state store (Redis/Cosmos DB)
- All wired by **Dapr**, no custom SDKs.

---

ğŸ‘‰ Thatâ€™s the power of **Dapr + ACA**: a managed, production-ready distributed app platform where you focus on code, not plumbing.

---

Do you want me to prepare a **full hands-on ACA project** (with YAML + CLI) showing:

- `orders` + `payments` apps
- Pub/Sub via Service Bus
- State store via Redis
- Secrets via Key Vault

so you can run it end-to-end?
