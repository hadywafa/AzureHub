# üöÄ Project: ‚ÄúCdnMini‚Äù ‚Äî .NET + Azure CDN + Static Website

## 0) Prereqs

- .NET 8+
- Azure CLI (`az`) logged in: `az login`
- Your subscription ID: `az account show --query id -o tsv`
- VS Code (optional)

---

## 1) Create the origin: Storage Static Website (CLI)

Choose names:

```bash
SUB="<your-subscription-id>"
RG="rg-cdnmini"
LOC="westeurope"            # or your region
STG="stcdn$(openssl rand -hex 3)"  # globally unique
```

Create the resources:

```bash
az account set -s $SUB
az group create -n $RG -l $LOC

# Storage with static website enabled
az storage account create -n $STG -g $RG -l $LOC --sku Standard_LRS --kind StorageV2
az storage blob service-properties update --account-name $STG --static-website --index-document index.html

# Upload a simple site
echo '<h1>Hello from Storage Static Website ü™Ñ</h1>' > index.html
az storage blob upload --account-name $STG -c '$web' -f index.html -n index.html --only-show-errors

# Get static website endpoint host (host only, no scheme)
ORIGIN_HOST=$(az storage account show -n $STG -g $RG --query "primaryEndpoints.web" -o tsv | sed -E 's#^https?://##; s#/$##')
echo "Origin host: $ORIGIN_HOST"   # e.g. stcdnabc.z6.web.core.windows.net
```

Open the origin URL in a browser to confirm it works.

---

## 2) Create the .NET project & add SDK packages

```bash
mkdir CdnMini && cd CdnMini
dotnet new console -n CdnMini
cd CdnMini

dotnet add package Azure.Identity
dotnet add package Azure.ResourceManager
dotnet add package Azure.ResourceManager.Cdn
```

Create `appsettings.json` (dev only; use Key Vault/env in prod):

```json
{
  "SubscriptionId": "<SUBSCRIPTION_ID>",
  "ResourceGroup": "rg-cdnmini",
  "Location": "westeurope",
  "ProfileName": "cdnmini-profile",
  "EndpointName": "cdnmini-endpoint",
  "OriginHostName": "<REPLACE_WITH_ORIGIN_HOST>",
  "PurgePaths": ["/index.html"]
}
```

> `OriginHostName` is the value you printed above (e.g., `stcdnabc.z6.web.core.windows.net`).

---

## 3) Program.cs ‚Äî create/list/purge/start

Replace `Program.cs` with:

```csharp
using Azure;
using Azure.Identity;
using Azure.ResourceManager;
using Azure.ResourceManager.Cdn;
using Azure.ResourceManager.Cdn.Models;
using Azure.ResourceManager.Resources;
using Microsoft.Extensions.Configuration;

// ----- load config -----
var cfg = new ConfigurationBuilder()
    .AddJsonFile("appsettings.json", optional: false)
    .AddEnvironmentVariables()
    .Build();

string subscriptionId = cfg["SubscriptionId"]!;
string rgName         = cfg["ResourceGroup"]!;
string location       = cfg["Location"] ?? "westeurope";
string profileName    = cfg["ProfileName"] ?? "cdnmini-profile";
string endpointName   = cfg["EndpointName"] ?? "cdnmini-endpoint";
string originHostName = cfg["OriginHostName"]!; // e.g. stcdnabc.z6.web.core.windows.net
var purgePaths        = cfg.GetSection("PurgePaths").Get<string[]>() ?? new[] { "/index.html" };

Console.WriteLine("== CdnMini starting ==");

// ----- authenticate -----
var credential = new DefaultAzureCredential();
ArmClient arm = new ArmClient(credential);

// ----- resource group -----
SubscriptionResource sub = arm.GetSubscriptionResource(
    SubscriptionResource.CreateResourceIdentifier(subscriptionId));

ResourceGroupCollection rgCol = sub.GetResourceGroups();
ResourceGroupResource rg;
try
{
    rg = await rgCol.GetAsync(rgName);
    Console.WriteLine($"RG exists: {rgName}");
}
catch (RequestFailedException)
{
    Console.WriteLine($"Creating RG: {rgName}");
    rg = (await rgCol.CreateOrUpdateAsync(WaitUntil.Completed, rgName, new ResourceGroupData(location))).Value;
}

// ----- CDN profile (Standard Microsoft recommended default) -----
var profiles = rg.GetCdnProfiles();
CdnProfileResource profile;
bool profileExists = await profiles.ExistsAsync(profileName);
if (!profileExists)
{
    Console.WriteLine($"Creating CDN profile: {profileName}");
    var profileData = new CdnProfileData(location)
    {
        Sku = new CdnSku(CdnSkuName.StandardMicrosoft)
    };
    profile = (await profiles.CreateOrUpdateAsync(WaitUntil.Completed, profileName, profileData)).Value;
}
else
{
    profile = await profiles.GetAsync(profileName);
    Console.WriteLine($"CDN profile exists: {profile.Data.Name}");
}

// ----- CDN endpoint -----
var endpoints = profile.GetCdnEndpoints();
CdnEndpointResource endpoint;
bool endpointExists = await endpoints.ExistsAsync(endpointName);
if (!endpointExists)
{
    Console.WriteLine($"Creating CDN endpoint: {endpointName}");
    var epData = new CdnEndpointData(location)
    {
        IsHttpAllowed = false,
        IsHttpsAllowed = true,
        // Optional: compression
        IsCompressionEnabled = true,
        ContentTypesToCompress = { "text/plain", "text/css", "application/json", "application/javascript", "text/html" },
        Origins =
        {
            new CdnDeepCreatedOrigin(
                name: "origin-1",
                hostName: originHostName) // no scheme, no trailing slash
            {
                HttpPort = 80,
                HttpsPort = 443,
            }
        }
    };

    endpoint = (await endpoints.CreateOrUpdateAsync(WaitUntil.Completed, endpointName, epData)).Value;
}
else
{
    endpoint = await endpoints.GetAsync(endpointName);
    Console.WriteLine($"CDN endpoint exists: {endpoint.Data.Name}");
}

Console.WriteLine($"Endpoint host: {endpoint.Data.HostName} (use HTTPS)");

// ----- start endpoint (safe if already started) -----
Console.WriteLine("Starting endpoint (idempotent) ‚Ä¶");
await endpoint.StartAsync(WaitUntil.Completed);
Console.WriteLine("Endpoint is running.");

// ----- list profiles + endpoints -----
Console.WriteLine("\n== Listing profiles/endpoints ==");
await foreach (var p in rg.GetCdnProfiles().GetAllAsync())
{
    Console.WriteLine($"Profile: {p.Data.Name} [{p.Data.Sku.Name}]");
    await foreach (var ep in p.GetCdnEndpoints().GetAllAsync())
        Console.WriteLine($" - Endpoint: {ep.Data.Name} ({ep.Data.HostName})");
}

// ----- optional purge (force refresh a path) -----
Console.WriteLine("\nSubmitting purge ‚Ä¶");
await endpoint.PurgeContentAsync(WaitUntil.Completed, purgePaths);
Console.WriteLine("Purge submitted.");

// ----- hints -----
Console.WriteLine($"\nOpen: https://{endpoint.Data.HostName}/index.html");
Console.WriteLine("Tip: version files (e.g., /app.css?v=2025-09-28) to bypass cache instantly.");
Console.WriteLine("== Done ==");
```

---

## 4) Run it

```bash
# Make sure your CLI login/identity has permissions on the subscription/RG
dotnet run
```

Expected output (truncated):

```ini
== CdnMini starting ==
RG exists: rg-cdnmini
Creating CDN profile: cdnmini-profile
Creating CDN endpoint: cdnmini-endpoint
Endpoint host: cdnmini-endpoint.azureedge.net
Starting endpoint (idempotent) ‚Ä¶
Endpoint is running.

== Listing profiles/endpoints ==
Profile: cdnmini-profile [Standard_Microsoft]
 - Endpoint: cdnmini-endpoint (cdnmini-endpoint.azureedge.net)

Submitting purge ‚Ä¶
Purge submitted.

Open: https://cdnmini-endpoint.azureedge.net/index.html
Tip: version files (e.g., /app.css?v=2025-09-28) to bypass cache instantly.
== Done ==
```

Open the printed URL ‚Äî you should see your static site delivered from the **nearest CDN POP**.

---

## 5) Verify / Troubleshoot

- **DNS / POP**:

  ```bash
  nslookup cdnmini-endpoint.azureedge.net
  ```

  You‚Äôll see POP-specific host/IPs (change with geography).

- **Cache behavior**: Update `index.html`, re-upload, then:

  - Use **versioning** (`index.html?v=2`) ‚Üí instant refresh, or
  - **Purge** the path (`/index.html`) via the SDK (already shown).

- **Auth**: `DefaultAzureCredential` uses your VS/CLI login locally; in Azure, it uses **Managed Identity** automatically (give it RBAC like **Contributor** on the RG).

---

## 6) Clean up (optional)

```bash
az group delete -n $RG --yes --no-wait
```

---

## 7) What you just used (memorize fast)

- **Packages**: `Azure.Identity`, `Azure.ResourceManager`, `Azure.ResourceManager.Cdn`
- **Classes**:

  - `ArmClient`, `SubscriptionResource`, `ResourceGroupResource`
  - `CdnProfileCollection` ‚Üí `CdnProfileResource`
  - `CdnEndpointCollection` ‚Üí `CdnEndpointResource`
  - `CdnProfileData`, `CdnEndpointData`, `CdnDeepCreatedOrigin`, `CdnSku`

- **Ops**: `CreateOrUpdateAsync`, `GetAllAsync`, `StartAsync`, `PurgeContentAsync`

---

## 8) Pro tips

- **Always version assets**: `/app.css?v=2025-09-28` (beats global purges).
- **Purge surgically**: specific paths, not `/*`.
- **Compression on**: reduces egress cost & latency.
- **Rules**: for advanced cache/query/header logic consider **Premium Verizon** or **Azure Front Door** for modern routing + WAF.
