# ‚öôÔ∏è **Project: Deploy & Use Azure App Configuration**

## üìå Scenario

You want a central place to store **app settings** and **feature flags** (and reference Key Vault for secrets).
We‚Äôll:

1. Create App Configuration (Portal)
2. Create App Configuration (C# management SDK)
3. Add **key-values** and **feature flags** (SDK)
4. Read them in an app (runtime SDK)

---

## ‚úÖ Prereqs

- Azure subscription + `az login`
- .NET 8+ SDK
- A resource group (or we‚Äôll create one)
- Local/dev auth: you‚Äôre signed in with `az login` (for `DefaultAzureCredential`)

---

## 1) üñ±Ô∏è Deploy via **Azure Portal** (click-ops)

### Step 1 ‚Äî Create the store

1. Portal ‚Üí ‚Äú**App Configuration**‚Äù ‚Üí **Create**
2. **Subscription / Resource group**: pick or create (e.g., `rg-appcfg-demo`)
3. **Name**: globally unique (e.g., `appcfg-az204-12345`)
4. **Location**: closest region
5. **Pricing tier**:

   - **Free** (dev/demo)
   - **Standard** (prod, replicas, higher limits)

6. **Access**: leave public for now (Private Endpoint optional)
7. **Review + create**

> After deploy, note the **Endpoint** (e.g., `https://appcfg-az204-12345.azconfig.io`).

### Step 2 ‚Äî Grant access (RBAC)

- For **apps that read values**: assign **App Configuration Data Reader** to their identity
- For **writers/tools**: **App Configuration Data Owner**
  Portal ‚Üí your App Configuration ‚Üí **Access control (IAM)** ‚Üí **Add role assignment** ‚Üí pick the identity (user, SP, Managed Identity).

### Step 3 ‚Äî (Optional) Add settings & feature flags in Portal

- **Configuration Explorer** ‚Üí ‚Äú+ Create‚Äù key‚Äìvalue (`App:Theme = Dark`, Label=`Prod`)
- **Feature manager** ‚Üí ‚Äú+ Add‚Äù flag (`BetaCheckout`, enabled)

---

## 2) üß∞ Deploy via **.NET SDK** (management plane)

> Use the **Azure Resource Manager** SDK to _create the resource itself_ programmatically.

### Install packages

```bash
dotnet new console -n AppCfgProvisioning
cd AppCfgProvisioning
dotnet add package Azure.Identity
dotnet add package Azure.ResourceManager
dotnet add package Azure.ResourceManager.AppConfiguration
```

### Program.cs ‚Äî create RG + App Configuration store

```csharp
using Azure;
using Azure.Core;
using Azure.Identity;
using Azure.ResourceManager;
using Azure.ResourceManager.Resources;
using Azure.ResourceManager.AppConfiguration;
using Azure.ResourceManager.AppConfiguration.Models;

var cred = new DefaultAzureCredential();
var arm  = new ArmClient(cred);

// --------- inputs ----------
string subscriptionId = "<SUB_ID>";          // or read from env
string rgName         = "rg-appcfg-demo";
AzureLocation location = AzureLocation.EastUS;
string storeName      = "appcfg-az204-12345"; // must be globally unique
// ---------------------------

// 1) Ensure RG
var sub = arm.GetSubscriptionResource(new ResourceIdentifier($"/subscriptions/{subscriptionId}"));
ResourceGroupCollection rgCol = sub.GetResourceGroups();
var rg = await rgCol.CreateOrUpdateAsync(WaitUntil.Completed, rgName, new ResourceGroupData(location));

// 2) Create App Configuration store (Standard tier recommended)
var storeData = new AppConfigurationStoreData(location)
{
    Sku = new AppConfigurationSku("Standard"),
    PublicNetworkAccess = AppConfigurationPublicNetworkAccess.Enabled
};

var storeLro = await rg.Value.GetAppConfigurationStores()
    .CreateOrUpdateAsync(WaitUntil.Completed, storeName, storeData);

var store = storeLro.Value;
Console.WriteLine($"‚úÖ Created App Config: {store.Data.Name}");
Console.WriteLine($"Endpoint: {store.Data.Endpoint}");
```

> Output includes the **Endpoint** ‚Äî you‚Äôll use it in app code.

---

## 3) ‚úçÔ∏è Add **key-values** & **feature flags** (data plane)

> Use **Azure.Data.AppConfiguration** for key-values & flags.

### Install package

```bash
dotnet add package Azure.Data.AppConfiguration
```

### Add settings and a feature flag

```csharp
using Azure;
using Azure.Data.AppConfiguration;
using System.Text.Json;
using System.Collections.Generic;

var endpoint = new Uri("https://appcfg-az204-12345.azconfig.io");
var cfg = new ConfigurationClient(endpoint, new DefaultAzureCredential());

// 1) Key-Value (with label)
var kv = new ConfigurationSetting("App:Theme", "Dark", label: "Prod")
{
    ContentType = "text/plain"
};
await cfg.SetConfigurationSettingAsync(kv);
Console.WriteLine("‚úÖ Set App:Theme");

// 2) Feature flag (ON, no filters)
// Convention: key = ".appconfig.featureflag/<flagName>", JSON payload
var featureName = "BetaCheckout";
var flagKey = $".appconfig.featureflag/{featureName}";
var flagPayload = new
{
    id = featureName,
    description = "New checkout experience",
    enabled = true,
    conditions = new { client_filters = new object[] { } }
};
var flagJson = JsonSerializer.Serialize(flagPayload);
var featureSetting = new ConfigurationSetting(flagKey, flagJson, label: "Prod")
{
    ContentType = "application/vnd.microsoft.appconfig.ff+json;charset=utf-8"
};
await cfg.SetConfigurationSettingAsync(featureSetting);
Console.WriteLine("‚úÖ Set feature flag BetaCheckout");

// 3) Feature flag with 20% rollout
var flagPercName = "NewNav";
var flagPercKey = $".appconfig.featureflag/{flagPercName}";
var percPayload = new
{
    id = flagPercName,
    enabled = true,
    conditions = new
    {
        client_filters = new object[]
        {
            new {
                name = "Microsoft.Percentage",
                parameters = new Dictionary<string, object> { ["Value"] = 20 }
            }
        }
    }
};
var percJson = JsonSerializer.Serialize(percPayload);
await cfg.SetConfigurationSettingAsync(new ConfigurationSetting(
    flagPercKey, percJson, label: "Prod")
{
    ContentType = "application/vnd.microsoft.appconfig.ff+json;charset=utf-8"
});
Console.WriteLine("‚úÖ Set feature flag NewNav (20%)");
```

> Tip: You can also use the typed helper `FeatureFlagConfigurationSetting` if you prefer (same result). The JSON approach above is explicit and easy to memorize.

---

## 4) üèÉ Read configs/flags in your app (runtime)

> For your web/API, use the **App Config configuration provider** + **Feature Management**.

### Add packages to your app

```bash
dotnet add package Microsoft.Extensions.Configuration.AzureAppConfiguration
dotnet add package Microsoft.FeatureManagement
dotnet add package Microsoft.FeatureManagement.AspNetCore
dotnet add package Azure.Identity
```

### `Program.cs`

```csharp
using Azure.Identity;
using Microsoft.FeatureManagement;

var builder = WebApplication.CreateBuilder(args);

// 1) Connect to App Configuration (Prod label) and enable Feature Flags
builder.Configuration.AddAzureAppConfiguration(opts =>
{
    opts.Connect(new Uri("https://appcfg-az204-12345.azconfig.io"), new DefaultAzureCredential())
       .Select(KeyFilter.Any, label: "Prod")
       .ConfigureRefresh(r => r
           .Register("AppConfig:Sentinel", refreshAll: true)
           .SetCacheExpiration(TimeSpan.FromSeconds(30)))
       .UseFeatureFlags(ff => ff.CacheExpirationInterval = TimeSpan.FromSeconds(10));
});

builder.Services.AddAzureAppConfiguration();
builder.Services.AddFeatureManagement();

var app = builder.Build();

// 2) Enable middleware (dynamic refresh)
app.UseAzureAppConfiguration();

// 3) Example endpoints
app.MapGet("/theme", (IConfiguration c) => Results.Text(c["App:Theme"] ?? "N/A"));

app.MapGet("/beta", async (IFeatureManager fm) =>
    Results.Json(new { BetaCheckout = await fm.IsEnabledAsync("BetaCheckout") }));

app.Run();
```

> Update the **sentinel** to force refresh:

```bash
az appconfig kv set \
  --name appcfg-az204-12345 \
  --key "AppConfig:Sentinel" --value "$(date -u +%s)" --label "Prod"
```

---

## üîí Roles you‚Äôll typically use

| Purpose                             | Built-in role                      |
| ----------------------------------- | ---------------------------------- |
| Read settings/flags at runtime      | **App Configuration Data Reader**  |
| Create/update settings/flags        | **App Configuration Data Owner**   |
| Manage the resource (create/delete) | **Contributor** (management plane) |

> Assign to your **Managed Identity** (App Service/Functions/VM) for passwordless auth with `DefaultAzureCredential`.

---

## üßØ Gotchas & Tips

- **Name uniqueness**: store name must be globally unique (`*.azconfig.io`).
- **Labels**: use `Dev/Test/Prod` to separate environments.
- **Secrets**: don‚Äôt store in App Config ‚Äî store in **Key Vault** and reference from your app.
- **Networking**: if you enable **Private Endpoint**, make sure clients resolve the private DNS zone.
- **Free vs Standard**: Free is great for dev; use **Standard** in prod (limits, replicas).
- **Feature flags**: stored as special key/JSON; the Feature Management library reads them automatically.

---

## üèÅ TL;DR

- **Portal**: Create store ‚Üí assign RBAC ‚Üí add keys/flags.
- **.NET (ARM)**: Use `Azure.ResourceManager.AppConfiguration` to **create the store**.
- **.NET (data plane)**: Use `Azure.Data.AppConfiguration` to **set keys/flags**.
- **Runtime**: `AddAzureAppConfiguration()` + `UseFeatureFlags()` to read and toggle **without redeploying**.
