# üõ†Ô∏è Using Microsoft Graph with .NET SDK

## 1Ô∏è‚É£ Install the SDK

Add the official NuGet package:

```bash
dotnet add package Microsoft.Graph
dotnet add package Microsoft.Identity.Client
```

- `Microsoft.Graph` ‚Üí Graph client library
- `Microsoft.Identity.Client` (MSAL) ‚Üí Handles authentication

---

## 2Ô∏è‚É£ Authenticate with Microsoft Identity Platform

We need a **token provider** that GraphServiceClient can use.
Here‚Äôs a helper using **MSAL Confidential Client** (app-only permissions):

```csharp
using Microsoft.Graph;
using Microsoft.Identity.Client;

public class GraphAuthProvider
{
    private readonly IConfidentialClientApplication _confidentialClient;
    private readonly string[] _scopes;

    public GraphAuthProvider(string clientId, string tenantId, string clientSecret)
    {
        _scopes = new[] { "https://graph.microsoft.com/.default" }; // App-only

        _confidentialClient = ConfidentialClientApplicationBuilder
            .Create(clientId)
            .WithClientSecret(clientSecret)
            .WithAuthority($"https://login.microsoftonline.com/{tenantId}")
            .Build();
    }

    public async Task<string> GetTokenAsync()
    {
        var result = await _confidentialClient.AcquireTokenForClient(_scopes).ExecuteAsync();
        return result.AccessToken;
    }
}
```

---

## 3Ô∏è‚É£ Create the Graph Client

```csharp
var authProvider = new GraphAuthProvider(clientId, tenantId, clientSecret);

GraphServiceClient graphClient = new GraphServiceClient(new DelegateAuthenticationProvider(
    async (requestMessage) =>
    {
        var token = await authProvider.GetTokenAsync();
        requestMessage.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
    }));
```

---

## 4Ô∏è‚É£ Common Operations (CRUD-style)

### üîé Read user profile

```csharp
var me = await graphClient.Me.Request().GetAsync();
Console.WriteLine($"Hello {me.DisplayName}, your email is {me.Mail}");
```

---

### üìã List users in the tenant

```csharp
var users = await graphClient.Users.Request().GetAsync();
foreach (var user in users)
{
    Console.WriteLine($"{user.DisplayName} - {user.UserPrincipalName}");
}
```

---

### ‚úâÔ∏è Send email

```csharp
var message = new Message
{
    Subject = "Hello from Graph",
    Body = new ItemBody
    {
        ContentType = BodyType.Text,
        Content = "This email was sent using Microsoft Graph SDK in .NET!"
    },
    ToRecipients = new List<Recipient>()
    {
        new Recipient
        {
            EmailAddress = new EmailAddress
            {
                Address = "friend@contoso.com"
            }
        }
    }
};

await graphClient.Me.SendMail(message, null).Request().PostAsync();
```

---

### üìÖ Create a calendar event

```csharp
var @event = new Event
{
    Subject = "AZ-204 Study Session",
    Start = new DateTimeTimeZone { DateTime = "2025-09-17T10:00:00", TimeZone = "UTC" },
    End   = new DateTimeTimeZone { DateTime = "2025-09-17T11:00:00", TimeZone = "UTC" },
    Location = new Location { DisplayName = "Teams Meeting" }
};

await graphClient.Me.Events.Request().AddAsync(@event);
```

---

### üìÇ Upload a file to OneDrive

```csharp
using var fileStream = System.IO.File.OpenRead("notes.txt");

await graphClient.Me.Drive.Root
    .ItemWithPath("notes.txt")
    .Content.Request()
    .PutAsync<DriveItem>(fileStream);
```

---

## 5Ô∏è‚É£ Key Classes & Methods to Remember

| Class / Method                | Purpose                             |
| ----------------------------- | ----------------------------------- |
| `GraphServiceClient`          | Entry point for all Graph calls     |
| `.Me`                         | Current signed-in user              |
| `.Users`                      | Tenant-wide users                   |
| `.Groups`                     | Microsoft 365 Groups/Teams          |
| `.Drive` / `.ItemWithPath`    | OneDrive & SharePoint file handling |
| `.Events` / `.Calendar`       | Calendar events                     |
| `.SendMail()`                 | Send emails                         |
| `.Request().GetAsync()`       | Fetch (Read)                        |
| `.Request().AddAsync(obj)`    | Create (Insert)                     |
| `.Request().UpdateAsync(obj)` | Update                              |
| `.Request().DeleteAsync()`    | Delete                              |

---

## 6Ô∏è‚É£ Permissions to Watch for AZ-204

- **Delegated vs Application** permissions matter.
- Examples:

  - Read user profile ‚Üí `User.Read` (delegated)
  - Read all users ‚Üí `User.Read.All` (app-only or delegated with admin consent)
  - Send mail ‚Üí `Mail.Send`
  - Access files ‚Üí `Files.ReadWrite`

---

## ‚úÖ Summary

- **GraphServiceClient** is your main entry point.
- Authentication handled via **MSAL** (delegated or app-only).
- CRUD-like operations map cleanly: `GetAsync()`, `AddAsync()`, `UpdateAsync()`, `DeleteAsync()`.
- Graph unifies access to **users, mail, calendar, files, and more** under one endpoint.

---

## üë§ Users & Identity

| Task                    | REST Endpoint      | SDK Equivalent (.NET)                                   |
| ----------------------- | ------------------ | ------------------------------------------------------- |
| Get **current user**    | `GET /me`          | `await graphClient.Me.Request().GetAsync();`            |
| Get **all users**       | `GET /users`       | `await graphClient.Users.Request().GetAsync();`         |
| Get **user by ID**      | `GET /users/{id}`  | `await graphClient.Users["{id}"].Request().GetAsync();` |
| Get **manager** of user | `GET /me/manager`  | `await graphClient.Me.Manager.Request().GetAsync();`    |
| List user‚Äôs groups      | `GET /me/memberOf` | `await graphClient.Me.MemberOf.Request().GetAsync();`   |

---

## ‚úâÔ∏è Mail

| Task               | REST Endpoint           | SDK Equivalent (.NET)                                                 |
| ------------------ | ----------------------- | --------------------------------------------------------------------- |
| Get my messages    | `GET /me/messages`      | `await graphClient.Me.Messages.Request().GetAsync();`                 |
| Send an email      | `POST /me/sendMail`     | `await graphClient.Me.SendMail(message, null).Request().PostAsync();` |
| Get single message | `GET /me/messages/{id}` | `await graphClient.Me.Messages["{id}"].Request().GetAsync();`         |

---

## üìÖ Calendar

| Task         | REST Endpoint            | SDK Equivalent (.NET)                                                  |
| ------------ | ------------------------ | ---------------------------------------------------------------------- |
| List events  | `GET /me/events`         | `await graphClient.Me.Events.Request().GetAsync();`                    |
| Create event | `POST /me/events`        | `await graphClient.Me.Events.Request().AddAsync(eventObj);`            |
| Update event | `PATCH /me/events/{id}`  | `await graphClient.Me.Events["{id}"].Request().UpdateAsync(eventObj);` |
| Delete event | `DELETE /me/events/{id}` | `await graphClient.Me.Events["{id}"].Request().DeleteAsync();`         |

---

## üìÇ Files (OneDrive & SharePoint)

| Task            | REST Endpoint                           | SDK Equivalent (.NET)                                                                                     |
| --------------- | --------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| Get my drive    | `GET /me/drive`                         | `await graphClient.Me.Drive.Request().GetAsync();`                                                        |
| List root files | `GET /me/drive/root/children`           | `await graphClient.Me.Drive.Root.Children.Request().GetAsync();`                                          |
| Upload file     | `PUT /me/drive/root:/file.txt:/content` | `await graphClient.Me.Drive.Root.ItemWithPath("file.txt").Content.Request().PutAsync<DriveItem>(stream);` |
| Download file   | `GET /me/drive/items/{id}/content`      | `await graphClient.Me.Drive.Items["{id}"].Content.Request().GetAsync();`                                  |

---

## üí¨ Teams & Groups

| Task                    | REST Endpoint                             | SDK Equivalent (.NET)                                                                           |
| ----------------------- | ----------------------------------------- | ----------------------------------------------------------------------------------------------- |
| List joined Teams       | `GET /me/joinedTeams`                     | `await graphClient.Me.JoinedTeams.Request().GetAsync();`                                        |
| List channels in a Team | `GET /teams/{id}/channels`                | `await graphClient.Teams["{id}"].Channels.Request().GetAsync();`                                |
| Post message in channel | `POST /teams/{id}/channels/{id}/messages` | `await graphClient.Teams["{id}"].Channels["{channelId}"].Messages.Request().AddAsync(chatMsg);` |
| List groups             | `GET /groups`                             | `await graphClient.Groups.Request().GetAsync();`                                                |

---

## üîë Authentication Notes (for exam)

- All calls require **Bearer token** from Microsoft Identity Platform.
- Permissions must be correct:

  - **Delegated** ‚Üí User signs in (e.g., `User.Read`, `Mail.Read`)
  - **Application** ‚Üí App runs alone (e.g., `User.Read.All`, `Mail.Send`)
