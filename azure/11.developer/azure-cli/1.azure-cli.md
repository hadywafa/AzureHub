# 👨🏻‍💻 Logging into Azure in the Terminal (CLI & Beyond)

When you work with Azure in the terminal (Bash, PowerShell, Cloud Shell, GitHub Actions, DevOps agents, etc.), the very first step is always **authentication**. How you log in determines:

- What permissions you have
- How long your session lasts
- Whether secrets (like passwords) are stored or avoided

Let’s go from **basic developer login** → **enterprise automation** → **advanced token handling**.

---

## 1️⃣ **Interactive Login (az login)** 🧑‍💻

- **Command**:

  ```bash
  az login
  ```

- Opens a browser window → sign in with your Azure AD identity.
- On success, credentials are cached locally (`~/.azure/`).
- Supports **multiple accounts**; you can list them:

  ```bash
  az account list -o table
  az account set --subscription "SUBSCRIPTION_ID"
  ```

- **Use case**: Local development, exploratory CLI work.

👉 _Limitation_: Not suitable for CI/CD (requires human).

---

## 2️⃣ **Device Code Login** 📱

If you’re in a terminal **without browser access** (SSH, WSL, server):

```bash
az login --use-device-code
```

- Azure prints a code + URL.
- You open the URL on another device, enter code, authenticate → CLI session activates.

**When to use**: Headless environments (VM, SSH session).

---

## 3️⃣ **Service Principal Login** 🤖 (Automation Standard)

Instead of a user, you use an **app registration** (SPN = Service Principal).

- Create one:

  ```bash
  az ad sp create-for-rbac \
    --name my-cicd-spn \
    --role contributor \
    --scopes /subscriptions/<SUBSCRIPTION_ID>
  ```

- Output includes:

  ```json
  {
    "appId": "...",
    "password": "...",
    "tenant": "..."
  }
  ```

- Log in:

  ```bash
  az login \
    --service-principal \
    -u <APP_ID> \
    -p <PASSWORD> \
    --tenant <TENANT_ID>
  ```

✅ Best practice: store **appId** and **password** in GitHub Secrets, DevOps Library, or Key Vault.

**When to use**: CI/CD pipelines outside Azure (GitHub, Jenkins, GitLab, etc.).

---

## 4️⃣ **Managed Identity Login** 🔒 (Passwordless in Azure)

If your CLI runs **inside Azure** (VM, App Service, Function, AKS pod with MI), you can skip secrets.

- System-assigned MI:

  ```bash
  az login --identity
  ```

- User-assigned MI:

  ```bash
  az login --identity --username <CLIENT_ID>
  ```

👉 No secrets stored, Azure injects a token automatically.

**When to use**: Secure workloads inside Azure. Best practice for AKS, DevOps self-hosted agents, App Services.

---

## 5️⃣ **Cloud Shell Login** ☁️

- Cloud Shell (in Azure Portal) is **always pre-authenticated**.
- No need to `az login`.
- Context already set to the signed-in user’s tenant + subscription.

✅ Great for quick demos, one-off fixes, admin tasks.

---

## 6️⃣ **Token-based Login** 🎟️ (Advanced)

Sometimes you want **to log in with an existing OAuth2 token** (e.g., from Azure AD or MSAL).

- Example (using `az account get-access-token`):

  ```bash
  az account get-access-token --resource https://management.azure.com
  ```

- This gives you a bearer token you can reuse in REST calls:

  ```bash
  curl -H "Authorization: Bearer <TOKEN>" https://management.azure.com/subscriptions?api-version=2020-01-01
  ```

👉 Rarely used directly, but essential for debugging auth flows or building custom scripts.

---

## 7️⃣ **Federated Credentials (No Secrets)** 🔗

Instead of storing SP secrets in GitHub/Azure DevOps, you can use **federated identity credentials**:

- Azure trusts the **OIDC token** from GitHub or Azure DevOps.
- No password/secret needed.
- Configure in App Registration → **Federated Credentials** tab.

Login flow in GitHub Action:

```yaml
- uses: azure/login@v1
  with:
    client-id: ${{ secrets.AZURE_CLIENT_ID }}
    tenant-id: ${{ secrets.AZURE_TENANT_ID }}
    subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
```

✅ This is the **modern best practice** for secure CI/CD.

---

## 8️⃣ **Multiple Tenants / Subscriptions** 🏢

- List accounts:

  ```bash
  az account list -o table
  ```

- Switch:

  ```bash
  az account set --subscription "<SUBSCRIPTION_ID or NAME>"
  ```

- Verify:

  ```bash
  az account show
  ```

👉 You might log in once but manage **several tenants** (consultants, MSPs). Always double-check context before running commands.

---

## 9️⃣ **Troubleshooting Authentication** 🛠️

- Force re-login:

  ```bash
  az account clear
  az login
  ```

- Check which account is active:

  ```bash
  az account show
  ```

- Common issues:

  - `AADSTS50076`: MFA required → use `--use-device-code`.
  - Wrong subscription context → fix with `az account set`.
  - SPN password expired → rotate in Key Vault or App Registration.

---

## 🔟 **Best Practices Cheat Sheet** 📌

- ✅ Use **Entra ID login** (`az login`) for local dev.
- ✅ Use **Service Principal with secret** for automation **outside Azure**.
- ✅ Use **Managed Identity** for automation **inside Azure**.
- ✅ Use **Federated Identity** for modern CI/CD → no secrets at all.
- ✅ Always check context with `az account show` before running destructive commands.
- ✅ Rotate SP secrets every 90 days or move to federated creds.

---

## 🏁 **Summary:**

Logging into Azure from the terminal can be as simple as `az login` or as advanced as **federated OIDC CI/CD pipelines** with **no secrets**. The choice depends on **where** you’re running the CLI (local vs pipeline vs Azure resource) and **how secure** you need it to be.
