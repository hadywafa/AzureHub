# ‚úçüèª Hands-On: Compare All Azure CLI Login Methods

## üìå Prereqs (once)

```bash
# pick your subscription
SUBSCRIPTION_ID="<your-subscription-id>"
RG="rg-login-lab"
LOC="eastus"
```

Install/upgrade Azure CLI: [https://aka.ms/azcli](https://aka.ms/azcli)
Confirm version:

```bash
az version
```

A simple ‚Äúproof‚Äù command we‚Äôll run after each login:

```bash
# show the signed-in context
az account show --output table

# quick read access check
az group list --query "[].name" -o table

# quick write access check (safe to create; you can delete later)
az group create -n $RG -l $LOC -o table
```

---

## üìå 1) Interactive Login (Local Dev)

```bash
az login
az account set --subscription "$SUBSCRIPTION_ID"
```

Verify:

```bash
az account show -o table
az group create -n $RG -l $LOC -o table
```

> Tip: If a browser can‚Äôt open, use the device code flow below.

---

## üìå 2) Device Code Login (Headless SSH/Servers)

```bash
az login --use-device-code
# follow instructions: open https://microsoft.com/devicelogin and paste the code
az account set --subscription "$SUBSCRIPTION_ID"
```

Verify (same as above):

```bash
az account show -o table
az group list -o table
```

---

## üìå 3) Service Principal (SP) ‚Äî Automation Outside Azure

Create an SP with least privilege. Here we grant **Contributor** on the resource group scope (safer than whole subscription):

```bash
# create RG first (if not created)
az group create -n $RG -l $LOC -o table

# create SP and scope it to the RG
az ad sp create-for-rbac \
  --name "sp-login-lab" \
  --role Contributor \
  --scopes $(az group show -n $RG --query id -o tsv) \
  -o json > sp.json

cat sp.json
# { "appId": "...", "password": "...", "tenant": "..." }
APP_ID=$(jq -r .appId sp.json)
APP_SECRET=$(jq -r .password sp.json)
TENANT_ID=$(jq -r .tenant sp.json)
```

Login with the SP:

```bash
az login --service-principal -u "$APP_ID" -p "$APP_SECRET" --tenant "$TENANT_ID"
az account set --subscription "$SUBSCRIPTION_ID"
```

Verify:

```bash
az account show -o table
az group list -o table
# try a write action inside the RG scope
az tag create --resource-id $(az group show -n $RG --query id -o tsv) --tags owner=sp-demo
```

> Store **APP_ID / APP_SECRET / TENANT_ID** in a secure secret store (Key Vault, GitHub Actions secrets, DevOps Library). Rotate regularly.

Cleanup SP (optional):

```bash
az ad app delete --id "$APP_ID"
```

---

## üìå 4) Managed Identity (MI) ‚Äî Automation Inside Azure

We‚Äôll create a VM with a **system-assigned MI**, give it RBAC, then log in **from inside** the VM with no secrets.

Create a VM with MI:

```bash
VM="vm-mi-login-lab"
az vm create -g $RG -n $VM --image UbuntuLTS --admin-username azureuser --generate-ssh-keys --assign-identity -o table
VM_MI_PRINCIPAL_ID=$(az vm show -g $RG -n $VM --query identity.principalId -o tsv)

# grant Acr/Storage/Contributor as needed; here we grant Reader on the subscription (example)
az role assignment create --assignee $VM_MI_PRINCIPAL_ID --role Reader --scope /subscriptions/$SUBSCRIPTION_ID
```

SSH and log in using MI:

```bash
az vm ssh -g $RG -n $VM
# inside the VM:
az login --identity
az account show -o table
az group list -o table
exit
```

> You can also target a **user-assigned MI**: `az login --identity --username <client-id>`

---

## üìå 5) Federated Credentials ‚Äî GitHub Actions (No Secret SP)

**Goal:** GitHub OIDC ‚Üí Azure Entra App Registration ‚Üí no stored client secret.

### 5.1 Create App Registration

```bash
APP_NAME="gh-oidc-login-lab"
az ad app create --display-name $APP_NAME -o json > app.json
APP_ID=$(jq -r .appId app.json)
AZ_APP_OBJECT_ID=$(jq -r .id app.json)

# Service principal object for the app
SP_OBJECT_ID=$(az ad sp create --id $APP_ID --query id -o tsv)

# Scope a role to RG (Contributor example)
az role assignment create \
  --assignee-object-id $SP_OBJECT_ID \
  --assignee-principal-type ServicePrincipal \
  --role Contributor \
  --scope $(az group show -n $RG --query id -o tsv)
```

### 5.2 Add Federated Credential (GitHub ‚Üí Azure)

Replace `<OWNER>` and `<REPO>`. This trusts the `main` branch of your repo.

```bash
TENANT_ID=$(az account show --query tenantId -o tsv)

az ad app federated-credential create \
  --id $AZ_APP_OBJECT_ID \
  --parameters '{
    "name": "github-main",
    "issuer": "https://token.actions.githubusercontent.com",
    "subject": "repo:<OWNER>/<REPO>:ref:refs/heads/main",
    "audiences": ["api://AzureADTokenExchange"]
  }'
```

### 5.3 GitHub Actions workflow (`.github/workflows/azure-login.yml`)

Store these **as GitHub repo secrets**: `AZURE_CLIENT_ID` = `$APP_ID`, `AZURE_TENANT_ID` = `$TENANT_ID`, `AZURE_SUBSCRIPTION_ID`.

```yaml
name: Azure Login (OIDC)
on:
  push:
    branches: [main]
permissions:
  id-token: write
  contents: read

jobs:
  login-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify context
        run: |
          az account show
          az group list --query "[].name" -o table
          az group create -n rg-oidc-lab -l eastus -o table
```

Push to `main` and check the job logs ‚Äî you‚Äôll see `az account show` output **without any stored SP secret**.

---

## üìå 6) Token-Level (Advanced Debug)

Grab a raw ARM token and call the REST API with `curl`:

```bash
# resource ARM:
az account get-access-token --resource https://management.azure.com -o json > arm_token.json
TOKEN=$(jq -r .accessToken arm_token.json)

# list subscriptions via REST:
curl -s -H "Authorization: Bearer $TOKEN" \
"https://management.azure.com/subscriptions?api-version=2020-01-01" | jq .
```

---

## üìå Switching Contexts (Tenants & Subs)

```bash
az account list -o table
az account set --subscription "$SUBSCRIPTION_ID"
az account show -o table
```

---

## üìå Troubleshooting Cheats

```bash
# stale creds / switch user
az account clear
az login

# MFA blocking interactive login? use device code:
az login --use-device-code

# see who/what you are
az ad signed-in-user show  # (works for user accounts; SPs don‚Äôt have this)

# SP secret expired? update it:
az ad app credential reset --id $APP_ID --display-name "rotation-$(date +%F)" -o json
```

Common errors:

- `AADSTS50076` MFA required ‚Üí use `--use-device-code` or OIDC federation.
- ‚ÄúInsufficient privileges‚Äù ‚Üí you‚Äôre in the wrong subscription or missing RBAC role.
- SP can‚Äôt write at subscription scope ‚Üí scope it to the resource group (or elevate role).

---

## üìå Quick Comparison (When to Use What)

| Method                               | Where it runs            | Secrets kept?    | Best for                               |
| ------------------------------------ | ------------------------ | ---------------- | -------------------------------------- |
| `az login`                           | Dev laptop / Cloud Shell | No               | Interactive dev/admin                  |
| `az login --use-device-code`         | Headless terminals       | No               | SSH/servers without browser            |
| SP (`--service-principal`)           | Anywhere                 | **Yes (secret)** | External CI/CD, scripts                |
| Managed Identity (`--identity`)      | Inside Azure             | No               | Azure VMs, App Service, Functions, AKS |
| Federated OIDC (GitHub/Azure DevOps) | CI/CD                    | No               | Modern pipelines, zero secret sprawl   |
| Raw Token (get-access-token)         | Anywhere                 | N/A              | Debug/integration via REST             |

---

## üìå Clean Up (optional)

```bash
az group delete -n $RG -y
# If you created an app for OIDC:
az ad app delete --id $APP_ID
```

---

## ‚úÖ You now have:

- Working, copy-ready examples for **all login methods**
- A **single verification routine** to prove each method works
- Secure patterns (Managed Identity, OIDC Federation) for production
