# ğŸ§  **Agents & Execution Infrastructure**

## **Microsoft-Hosted Agents (How Your Pipeline _Actually_ Runs)**

> Microsoft-hosted agents are **ephemeral virtual machines** provisioned **per job**, fully managed by Microsoft.
> Every job gets a **fresh machine**, executes, uploads results, and is **destroyed**.
> They optimize **simplicity and isolation**, not persistence or speed.

---

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/media/agent-connections-devops.png?view=azure-devops)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "ğŸ“‹ Job Queued" }
    B@{ shape: hex, label: "â˜ï¸ New VM Provisioned" }
    C@{ shape: processes, label: "ğŸ¤– Hosted Agent\n(Run Job)" }
    D@{ shape: hex, label: "ğŸ“¤ Logs & Artifacts Uploaded" }
    E@{ shape: hex, label: "ğŸ—‘ï¸ VM Destroyed" }

    A --> B
    B --> C
    C --> D
    D --> E

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 700,animation: dash 22s linear infinite;
    class A,B,C,D,E animate
```

</div>

---

## ğŸ”´ **Problem: â€œWhy Is My Pipeline Slow / Forgetting Stuff?â€**

This question almost always comes from **not understanding hosted agents**.

Common wrong assumptions:

- Agents remember previous jobs
- Tools stay installed
- Files persist
- Builds get faster over time

âŒ None of this is true.

---

## 1ï¸âƒ£ Microsoft-Hosted Agent Pools (What You Really Get)

### ğŸ§  What Is a Hosted Pool?

A **Microsoft-hosted pool** is:

- A managed pool of **on-demand VMs**
- Created **per job**
- Shared across tenants
- Isolated per execution

You **do not see** the machines.
You **do not manage** them.
You **do not keep** them.

---

### ğŸ§ª Basic Usage Example

```yaml
pool:
  vmImage: ubuntu-latest
```

This means:

- â€œGive me **any fresh Ubuntu VM** with the `latest` imageâ€
- Not a specific machine
- Not the same one next time

---

### Common Hosted Images

| Image            | OS      |
| ---------------- | ------- |
| `ubuntu-latest`  | Linux   |
| `windows-latest` | Windows |
| `macos-latest`   | macOS   |

Each maps to a **specific VM image version** behind the scenes.

---

## 2ï¸âƒ£ Image Versions (Hidden but Critical)

### ğŸ§  Important Truth

> `ubuntu-latest` is **not a fixed OS**.

It is an **alias** that Microsoft updates over time.

---

### ğŸ§ª Example Problem

Your pipeline worked yesterday:

```yaml
pool:
  vmImage: ubuntu-latest
```

Today it fails:

- Node version changed
- Python upgraded
- Java removed/updated

âŒ Pipeline breaks without YAML changes

---

### âœ… Safer Pattern (Pin Image)

```yaml
pool:
  vmImage: ubuntu-22.04
```

âœ” Predictable
âœ” Stable
âœ” Reproducible

---

### ğŸ§  Senior Rule

- **Learning / demos** â†’ `*-latest`
- **Production CI/CD** â†’ pin image version

---

## 3ï¸âƒ£ Preinstalled Tools (What You Can Assume)

Microsoft-hosted agents come with **many tools preinstalled**:

- Git
- Docker
- .NET SDKs
- Java
- Node
- Python
- Azure CLI

Butâ€¦

> **Tool versions can change at any time**.

---

### ğŸ§ª Example: Checking Tool Versions

```yaml
steps:
  - script: |
      node --version
      python --version
      dotnet --version
```

You may see different outputs **between runs**.

---

### âŒ Dangerous Assumption

```yaml
- script: dotnet build
```

Assuming:

- Correct SDK version exists

---

### âœ… Safe Pattern

```yaml
- task: UseDotNet@2
  inputs:
    version: "8.0.x"
```

âœ” Explicit
âœ” Predictable
âœ” Reproducible

---

## 4ï¸âƒ£ Tool Caching (Why Builds Feel Slow)

### ğŸ§  Key Reality

> Hosted agents start **empty** (from your perspective).

Even though tools are installed:

- NuGet cache â†’ empty
- npm cache â†’ empty
- pip cache â†’ empty
- Maven cache â†’ empty

Because:

- New VM
- New disk
- Every job

---

### ğŸ§ª Example: Slow First Build

```yaml
- task: DotNetCoreCLI@2
  inputs:
    command: restore
```

This restores **everything** every time.

---

### âœ… Fix: Pipeline Caching

```yaml
- task: Cache@2
  inputs:
    key: 'nuget | "$(Agent.OS)" | **/*.csproj'
    path: ~/.nuget/packages
```

âœ” Cache survives across jobs
âœ” Huge speedup
âœ” Essential for hosted agents

---

### ğŸ§  Senior Rule

> **If you use hosted agents and donâ€™t use caching, your pipeline is inefficient by design.**

---

## 5ï¸âƒ£ Cold Start Behavior (The Hidden Cost)

### ğŸ§  What Is Cold Start?

Cold start includes:

1. VM provisioning
2. OS boot
3. Agent registration
4. Tool initialization

This happens **before your first step runs**.

---

### ğŸ§ª What You See in Logs

```ini
Starting: Initialize job
Downloading task...
```

This is **not your code** â€” itâ€™s infrastructure startup.

---

### Cold Start Characteristics

| Aspect     | Behavior   |
| ---------- | ---------- |
| Time       | 30s â€“ 2min |
| Frequency  | Every job  |
| Control    | None       |
| Visibility | Minimal    |

---

### âŒ Common Misinterpretation

> â€œMy pipeline script is slowâ€

Often false.

The time is spent **before your script starts**.

---

### âœ… Senior Optimization Strategy

- Fewer jobs (when possible)
- Use parallelism wisely
- Cache aggressively
- Avoid unnecessary stages

---

## 6ï¸âƒ£ Real Example: Why This Pipeline Is Slow

```yaml
jobs:
  - job: Build
  - job: Test
  - job: Lint
```

Each job:

- New VM
- New cold start
- New tool downloads

---

### ğŸ§  Optimization Insight

If jobs share context and donâ€™t need isolation:

- Combine them into one job
- Use steps instead

---

## 7ï¸âƒ£ Hosted Agents: Strengths vs Limits

### âœ… Strengths

âœ” Zero maintenance
âœ” Secure isolation
âœ” Easy onboarding
âœ” Works everywhere

---

### âŒ Limitations

âœ– Cold starts
âœ– No persistent disk
âœ– No private network access
âœ– Limited customization
âœ– Costly at scale

---

## ğŸ§  Mental Model (Lock This In)

```ini
Hosted Agent =
Disposable VM
Per Job
Zero Memory
Zero State
```

Or even simpler:

> **â€œEvery job starts from nothing.â€**

---

## ğŸ§  Memorization Tips

### ğŸ”‘ Mnemonic: **"D-I-C-C"**

| Letter | Meaning        |
| ------ | -------------- |
| **D**  | Disposable     |
| **I**  | Image-based    |
| **C**  | Cold start     |
| **C**  | Cache required |

---

## âŒ Top Hosted Agent Mistakes

| Mistake                     | Why It Hurts         |
| --------------------------- | -------------------- |
| Assuming persistence        | State lost           |
| Using `*-latest` blindly    | Breaking changes     |
| No caching                  | Slow builds          |
| Too many jobs               | Cold start explosion |
| Installing tools every time | Wasteful             |
