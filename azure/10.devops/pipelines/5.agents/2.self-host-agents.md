# üß† **Self-Hosted Agents ‚Äì Deep Dive**

## **Agent Architecture, Security, Scaling & Pitfalls**

> A self-hosted agent is **your machine**, running **Microsoft‚Äôs agent software**, executing **pipeline jobs under your responsibility**.
> Azure DevOps controls **what** runs.
> You control **where**, **how**, and **with what privileges** it runs.

---

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/media/agent-connections-devops.png?view=azure-devops)

![Image](https://cloud-cod.com/wp-content/uploads/2025/01/diagram_pipeline_agent_private_endpoint_terraform.png)

![Image](https://pmorisseau-preview.azurewebsites.net/img/tips.06.schema-EphemeralAgentsV2.svg)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "üß† Azure Pipelines Service" }
    B@{ shape: hex, label: "üì° Agent Listener" }
    C@{ shape: processes, label: "ü§ñ Self-Hosted Agent" }
    D@{ shape: processes, label: "üñ•Ô∏è VM / Server / Container" }
    E@{ shape: rect, label: "‚öôÔ∏è Tools, Files, Network" }

    A --> B
    B --> C
    C --> D
    D --> E

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 700,animation: dash 22s linear infinite;
    class A,B,C,D,E animate
```

</div>

---

## üî¥ **Problem: ‚ÄúHosted Agents Are Too Slow / Limited‚Äù**

Typical reasons teams move to self-hosted agents:

- Terraform plans take too long
- Docker builds are slow
- Builds need private network access
- Tools must be preinstalled
- Compliance forbids shared infrastructure

This is **exactly when self-hosted agents are correct**.

---

## 1Ô∏è‚É£ Self-Hosted Agent Architecture (What Actually Runs)

### üß† What Is a Self-Hosted Agent?

It consists of:

1. **A machine** (VM, bare metal, container)
2. **Azure Pipelines Agent software**
3. **An agent pool registration**

Once registered:

- Agent **polls Azure DevOps**
- Receives jobs
- Executes them locally

---

### üß™ Installation Reality

On the machine:

```bash
./config.sh
./run.sh
```

The agent:

- Opens an **outbound HTTPS connection**
- No inbound ports required
- Long-polling for jobs

‚úî Firewall-friendly  
‚úî Secure by default

---

### üîë Key Architectural Rule

> **Azure DevOps never connects _into_ your machine.**
> The agent connects _out_.

This is why self-hosted agents work even behind:

- Firewalls
- NAT
- Corporate networks

---

## 2Ô∏è‚É£ Security Boundaries (EXTREMELY IMPORTANT)

### üß® Truth Most Teams Learn the Hard Way

> **A self-hosted agent executes pipeline code with the permissions of the machine.**

This has massive implications.

---

### ‚ùå Dangerous Setup (Common Mistake)

- Agent runs as **root / Administrator**
- Pipeline runs arbitrary scripts
- Any repo contributor can:

  - Delete files
  - Read secrets
  - Exfiltrate data

This is a **supply-chain vulnerability**.

---

### ‚úÖ Secure Agent Design (Senior Pattern)

| Layer       | Best Practice                   |
| ----------- | ------------------------------- |
| OS user     | Dedicated low-privilege user    |
| Agent pool  | Restricted to trusted pipelines |
| Repo access | Protected branches              |
| Secrets     | Key Vault, not files            |
| Network     | Scoped access                   |

---

### üß™ Example: Least Privilege Agent

- Linux user: `azagent`
- No sudo
- Access only to required folders
- Network access limited via NSGs

‚úî Safer  
‚úî Auditable  
‚úî Compliant

---

## 3Ô∏è‚É£ Agent Pools & Trust Boundaries

### üß† Critical Design Rule

> **Agent pools are trust boundaries.**

Never mix:

- Prod deployments
- Dev builds
- Untrusted repos

---

### ‚ùå Bad Design

```ini
Agent Pool: Default
Used by:
- All pipelines
- All repos
- All environments
```

‚ùå One compromised pipeline = full access

---

### ‚úÖ Correct Design

```ini
Agent Pools:
- build-linux
- build-windows
- deploy-prod
- deploy-nonprod
```

Each pool:

- Has limited permissions
- Serves a specific purpose

---

## 4Ô∏è‚É£ Scaling Strategies (Where Most Fail)

Self-hosted agents **do not scale automatically** unless you design them to.

---

### üß± Strategy 1: Static Agents (Simplest)

- Fixed number of VMs
- One agent per VM

‚úî Easy  
‚ùå Queues build up  
‚ùå Underutilization

Used for:

- Low-volume pipelines
- Stable environments

---

### üß† Strategy 2: VM Scale Set (VMSS) Agents (Enterprise Standard)

> Azure DevOps can **automatically scale agents** using VMSS.

---

#### How It Works

1. Pipeline queues job
2. Azure DevOps requests VM
3. VM boots from image
4. Agent auto-registers
5. Job runs
6. VM is deleted

‚úî Elastic
‚úî Cost-efficient
‚úî Secure

This gives you **hosted-agent behavior** on **your infrastructure**.

---

### üß™ Real Example Use Case

- Terraform pipelines
- Docker-heavy builds
- Private registry access
- On-demand scale

---

### üî• Senior Insight

> VMSS agents are the **default choice** for serious self-hosted setups.

---

## 5Ô∏è‚É£ Maintenance Pitfalls (Where Teams Suffer)

Self-hosted agents **shift responsibility to you**.

---

### ‚ùå Pitfall #1 ‚Äì Tool Drift

- Node version upgraded
- Terraform changed
- Docker updated

Pipelines start failing **randomly**.

---

### ‚úÖ Fix: Immutable Images

- Bake tools into VM image
- Version the image
- Roll out changes deliberately

Same principle as:

- Docker images
- AMIs

---

### ‚ùå Pitfall #2 ‚Äì Dirty Agents

- Leftover files
- Cached credentials
- Broken workspaces

Causes:

- Flaky builds
- Security leaks

---

### ‚úÖ Fix

- Clean work directories
- Use disposable agents (VMSS)
- Periodic rebuilds

---

### ‚ùå Pitfall #3 ‚Äì Agent Starvation

Symptoms:

- Jobs stuck in queue
- ‚ÄúWaiting for agent‚Ä¶‚Äù

Cause:

- Too few agents
- No autoscaling

---

### ‚úÖ Fix

- Monitor queue length
- Scale pools
- Use VMSS or containers

---

## 6Ô∏è‚É£ Self-Hosted vs Hosted (Reality Comparison)

| Aspect      | Hosted      | Self-Hosted         |
| ----------- | ----------- | ------------------- |
| Setup       | None        | Required            |
| Control     | Low         | High                |
| Performance | Medium      | High                |
| Security    | Managed     | Your responsibility |
| Network     | Public only | Full access         |
| Scaling     | Automatic   | Manual / VMSS       |

---

## üß† Mental Model (Lock This In)

```ini
Hosted Agent  = Convenience
Self-Hosted   = Responsibility
VMSS Agent    = Best of both
```

---

## üß† Memorization Tips

### üîë Mnemonic: **"A-S-S-M"**

| Letter | Meaning                       |
| ------ | ----------------------------- |
| **A**  | Agent runs as OS user         |
| **S**  | Security is yours             |
| **S**  | Scaling is manual unless VMSS |
| **M**  | Maintenance is mandatory      |

---

## ‚ùå Top Self-Hosted Agent Mistakes

| Mistake             | Consequence     |
| ------------------- | --------------- |
| Running as root     | Security breach |
| One pool for all    | Trust collapse  |
| No image versioning | Random failures |
| No autoscaling      | Queue backlog   |
| Ignoring cleanup    | Flaky builds    |
