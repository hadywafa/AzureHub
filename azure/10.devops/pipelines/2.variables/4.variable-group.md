# ğŸ§  **Variable Groups & Secure Data Flow**

> **Variable Groups are centralized, shared, and secured variable containers** managed in **Azure DevOps Library**.
> They exist **outside YAML**, can be **linked to many pipelines**, and are the **correct place for secrets and environment configuration**.
> Senior engineers treat Variable Groups as **configuration boundaries**, not just key-value stores.

---

![Image](https://i0.wp.com/dailydotnettips.com/wp-content/uploads/2020/03/FEatured.png?fit=907%2C543&ssl=1)

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/library/media/add-variable-group.png?view=azure-devops)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "ğŸ“„ pipeline.yml" }
    B@{ shape: hex, label: "ğŸ“¦ Variable Group\n(Library)" }
    C@{ shape: hex, label: "ğŸ§  Pipeline Service" }
    D@{ shape: processes, label: "ğŸ¤– Agent" }

    A --> C
    B --> C
    C --> D

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 650,animation: dash 20s linear infinite;
    class A,B,C,D animate
```

</div>

---

## ğŸ”´ **Problem: Hard-Coding Configuration**

This is **how junior pipelines start**:

```yaml
variables:
  dbPassword: SuperSecret123
```

- âŒ Secret in Git
- âŒ No rotation
- âŒ No environment separation
- âŒ Security violation

---

## ğŸ§  **What Is a Variable Group (Really)?**

A **Variable Group** is:

- Created in **Azure DevOps â†’ Library**
- Stored securely
- Optional secrets
- Linked to pipelines explicitly
- Governed by permissions

It is **not YAML**.  
It is **configuration infrastructure**.

---

## 1ï¸âƒ£ Creating & Linking a Variable Group

### ğŸ“¦ Variable Group: `common-vars`

| Name         | Value    | Secret |
| ------------ | -------- | ------ |
| `appName`    | `my-api` | âŒ     |
| `dbPassword` | `*****`  | âœ…     |

---

### ğŸ“„ Link in YAML

```yaml
variables:
  - group: common-vars
```

Usage:

```yaml
- script: echo App=$(appName)
```

- âœ” Values injected at runtime
- âœ” Secrets masked

---

## 2ï¸âƒ£ Secret Variables

### ğŸ§ª Example: Secret Variable

```yaml
- script: |
    echo $(dbPassword)
```

### Output

```ini
****
```

Azure DevOps:

- Masks secrets
- Blocks accidental logging
- Prevents secret leaks

---

### ğŸ”¥ Important Rule

> **Secrets are never available at compile-time**

âœ• You cannot use secrets in `${{ }}`  
âœ” You can use secrets in `$( )`

---

## 3ï¸âƒ£ Variable Groups vs YAML Variables

| Feature                 | YAML Variables | Variable Groups |
| ----------------------- | -------------- | --------------- |
| Stored in repo          | âœ…             | âŒ              |
| Secure secrets          | âŒ             | âœ…              |
| Shared across pipelines | âš ï¸             | âœ…              |
| RBAC controlled         | âŒ             | âœ…              |
| Environment separation  | âŒ             | âœ…              |

---

## 4ï¸âƒ£ Environment-Specific Variable Groups

### ğŸ“¦ Variable Groups

| Group Name  | Purpose     |
| ----------- | ----------- |
| `dev-vars`  | Dev config  |
| `test-vars` | Test config |
| `prod-vars` | Prod config |

---

### ğŸ“„ Pipeline (Using Parameters)

```yaml
parameters:
  - name: env
    type: string
    default: dev
    values: [dev, test, prod]

variables:
  - ${{ if eq(parameters.env, 'dev') }}:
      - group: dev-vars
  - ${{ if eq(parameters.env, 'test') }}:
      - group: test-vars
  - ${{ if eq(parameters.env, 'prod') }}:
      - group: prod-vars
```

âœ” Correct evaluation time  
âœ” Secure  
âœ” Scalable

---

## 5ï¸âƒ£ Variable Groups + Templates (Enterprise Pattern)

### ğŸ“„ `variables-common.yml`

```yaml
variables:
  retryCount: 3
  timeout: 60
```

---

### ğŸ“„ Pipeline

```yaml
variables:
  - template: variables-common.yml
  - group: prod-vars
```

Precedence:

```ini
YAML > Variable Group
```

âœ” Template defines defaults  
âœ” Variable group defines secrets

---

## 6ï¸âƒ£ Secure Runtime Injection (Best Practice)

### âŒ Bad Pattern (Inline Secrets)

```yaml
- script: az login --password $(dbPassword)
```

---

### âœ… Better Pattern (Environment Variable)

```yaml
- script: |
    az login --password $DB_PASSWORD
  env:
    DB_PASSWORD: $(dbPassword)
```

- âœ” Limits exposure
- âœ” Cleaner logs
- âœ” Industry best practice

---

## 7ï¸âƒ£ Azure Key Vault Integration (Enterprise Standard)

### ğŸ¦ Key Vault-Backed Variable Group

- Variable group linked to Key Vault
- Secrets pulled at runtime
- No secret stored in DevOps

---

### ğŸ“¦ Example

| Key Vault Secret | Variable Name |
| ---------------- | ------------- |
| `DbPassword`     | `dbPassword`  |

Usage:

```yaml
- script: echo Connecting with password $(dbPassword)
```

- âœ” Central rotation
- âœ” Audit logging
- âœ” Zero pipeline changes

---

## 8ï¸âƒ£ Variable Group Permissions (Often Forgotten)

Variable Groups have:

- Reader
- User
- Administrator

If a pipeline lacks permission:

- âŒ Variables resolve as empty
- âŒ No clear error

Always check:

> **Library â†’ Variable Group â†’ Security**

---

## 9ï¸âƒ£ Debugging Variable Groups (Real-World)

### ğŸ” Debug Checklist

When variable is empty:

1. Is group linked?
2. Correct environment?
3. Permission granted?
4. Secret masked?
5. Compile-time vs runtime usage?

---

### ğŸ§ª Debug Snippet

```yaml
- script: |
    echo "App=$(appName)"
    printenv | grep APP
```

---

## âŒ Common Variable Group Mistakes

| Mistake                   | Result            |
| ------------------------- | ----------------- |
| Using secrets in `${{ }}` | Empty value       |
| Forgetting permissions    | Empty value       |
| Hard-coding secrets       | Security breach   |
| One group for all envs    | Risky deployments |
| Logging secrets           | Masked or blocked |

---

## ğŸ§  **Memorization Tips**

### ğŸ”‘ Mnemonic: **"GROUPS = SAFE"**

| Letter | Meaning                |
| ------ | ---------------------- |
| **G**  | Governed by RBAC       |
| **R**  | Runtime injected       |
| **O**  | Outside repo           |
| **U**  | Used across pipelines  |
| **P**  | Protected secrets      |
| **S**  | Scoped per environment |
