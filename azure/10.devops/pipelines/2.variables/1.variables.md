# ğŸ§  **Azure Pipelines Variables â€“ Deep Internals**

> Variables in Azure Pipelines are **runtime data containers**, not compile-time constructs.
> They are **scoped**, **overridable**, and **resolved dynamically** depending on **where and when** they are accessed.
> Most variable bugs are caused by **wrong scope assumptions**, **wrong evaluation timing**, or **wrong syntax**.

---

![Image](https://skundunotes.com/wp-content/uploads/2020/12/30.-variables-in-azure-pipelines-image0-4.png)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "ğŸ“„ Pipeline Variables" }
    B@{ shape: hex, label: "ğŸ—ï¸ Stage Variables" }
    C@{ shape: hex, label: "ğŸ§© Job Variables" }
    D@{ shape: rect, label: "ğŸ”¹ Step Variables" }

    A --> B
    B --> C
    C --> D

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 600,animation: dash 20s linear infinite;
    class A,B,C,D animate
```

</div>

---

## ğŸ”´ **Problem: â€œWhy Did My Variable Change?â€**

This happens because:

> **Variables are resolved by scope, not by definition order**

The **closest scope wins**.

---

## 1ï¸âƒ£ Variable Scopes & Precedence

### ğŸ”¢ Precedence Rule (Memorize This)

```ini
Step > Job > Stage > Pipeline > Variable Group
```

Letâ€™s prove it with examples.

---

### ğŸŸ¦ Pipeline-Level Variable

```yaml
variables:
  env: dev

jobs:
  - job: Demo
    steps:
      - script: echo $(env)
```

âœ… Output:

```ini
dev
```

---

### ğŸŸ¨ Stage-Level Override

```yaml
variables:
  env: dev

stages:
  - stage: Build
    variables:
      env: test
    jobs:
      - job: Demo
        steps:
          - script: echo $(env)
```

âœ… Output:

```ini
test
```

---

### ğŸŸ§ Job-Level Override

```yaml
stages:
  - stage: Build
    variables:
      env: test
    jobs:
      - job: Demo
        variables:
          env: prod
        steps:
          - script: echo $(env)
```

âœ… Output:

```ini
prod
```

---

### ğŸ”¹ Step-Level Override (Least Known, Very Important)

```yaml
steps:
  - script: echo $(env)
    env:
      env: local
```

âœ… Output:

```ini
local
```

ğŸ“Œ Step-level `env:` **overrides everything** for that step only.

---

## 2ï¸âƒ£ System Variables vs User Variables

### âš™ï¸ System Variables (Built-in)

Provided automatically by Azure DevOps.

Examples:

- `Build.BuildId`
- `Build.SourceBranch`
- `System.JobName`
- `Agent.OS`

```yaml
- script: |
    echo Build ID: $(Build.BuildId)
    echo Branch: $(Build.SourceBranch)
    echo OS: $(Agent.OS)
```

âœ” Read-only  
âœ” Always available  
âœ• Cannot override safely

---

### ğŸ‘¤ User Variables

Defined by you.

```yaml
variables:
  appName: my-api
```

Usage:

```yaml
- script: echo $(appName)
```

âœ” Mutable  
âœ” Overridable  
âœ” Can be set via `##vso`

---

### âŒ Dangerous Pattern (Do Not Do This)

```yaml
variables:
  Build.BuildId: 123
```

âŒ This **does not override** the system variable  
âŒ Creates confusion  
âŒ Leads to broken pipelines

---

## 3ï¸âƒ£ Environment Variables Mapping

> Every pipeline variable becomes an **OS environment variable**.

---

### Mapping Rules

| Pipeline Variable | Linux / macOS   | Windows          |
| ----------------- | --------------- | ---------------- |
| `myVar`           | `$MYVAR`        | `%MYVAR%`        |
| `build.number`    | `$BUILD_NUMBER` | `%BUILD_NUMBER%` |

---

### Example (Linux Agent)

```yaml
variables:
  appName: backend

steps:
  - script: |
      echo $(appName)
      echo $APPNAME
```

âœ… Both print:

```ini
backend
```

---

### Example (Windows Agent)

```yaml
- powershell: |
    Write-Host $env:APPNAME
```

---

### ğŸ”¥ Why This Matters

This is how:

- Docker builds read variables
- Terraform reads env vars
- Bash scripts work naturally

---

## 4ï¸âƒ£ Variable Templates (Enterprise Pattern)

> Variable templates allow **centralized, reusable configuration**.

---

### ğŸ“„ `variables.yml`

```yaml
variables:
  appName: api
  port: 8080
  environment: dev
```

---

### ğŸ“„ `pipeline.yml`

```yaml
variables:
  - template: variables.yml

steps:
  - script: |
      echo $(appName)
      echo $(port)
```

âœ” Clean  
âœ” DRY  
âœ” Version-controlled

---

### ğŸ”¥ Template + Override Example

```yaml
variables:
  - template: variables.yml
  - name: environment
    value: prod
```

âœ… `environment = prod`  
ğŸ“Œ Local override wins

---

## 5ï¸âƒ£ Debugging Variable Resolution

### ğŸŸ¢ Enable Debug Mode

```yaml
variables:
  system.debug: true
```

This reveals:

- Variable expansion
- Scope resolution
- Expression evaluation
- Task inputs

---

### ğŸ§ª Debug Example

```yaml
variables:
  env: dev

steps:
  - script: |
      echo "env=$(env)"
      printenv | sort
```

Look for:

```ini
ENV=dev
```

---

### ğŸ” Debugging Checklist

When a variable is wrong:

1. What scope defines it?
2. Is it overridden?
3. Is it compile-time or runtime?
4. Is syntax correct (`$( )`)?
5. Is agent OS affecting env mapping?

---

## âŒ Common Variable Bugs

### âŒ Bug 1: Variable Is Empty

```yaml
- script: echo $(myVar)
```

Cause:

- Variable never defined

Fix:

```yaml
variables:
  myVar: value
```

---

### âŒ Bug 2: Variable Not Updating

```yaml
- script: |
    echo "##vso[task.setvariable variable=ver]1.0"
- script: echo $(ver)
```

âœ” Works **only in same job**

Across jobs â†’ âŒ
Fix requires `isOutput=true` (next topic).

---

### âŒ Bug 3: Using Variable in Structure

```yaml
- ${{ if eq(variables.env, 'prod') }}:
```

âŒ Variables donâ€™t exist at compile-time
âœ” Use parameters instead

---

## ğŸ§  **Memorization Tips**

### ğŸ”‘ Mnemonic: **"SCOPES WIN"**

| Letter | Meaning                   |
| ------ | ------------------------- |
| **S**  | Step overrides all        |
| **C**  | Closest scope wins        |
| **O**  | OS maps variables         |
| **P**  | Pipeline is default       |
| **E**  | Env vars are automatic    |
| **S**  | System vars are read-only |

---

## âœ… Why This Topic Separates Seniors

Senior engineers:

- Predict variable behavior
- Debug without guessing
- Design pipelines intentionally
- Avoid scope collisions
- Use templates properly

Junior engineers:

- Trial-and-error variables
- Random overrides
- â€œWhy is it empty?â€ questions

You are now firmly in **senior territory**.

---

### â–¶ï¸ Next Topic (Still Category 2)

**2.2 Parameters (Advanced Usage & Examples)**
We will cover:

- Parameters vs variables (real differences)
- Object & array parameters
- Dynamic pipelines
- Real broken vs fixed patterns

When ready, say:

> **â€œContinue with 2.2 Parameters in the same style, with heavy examplesâ€**
