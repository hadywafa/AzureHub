# ğŸ§  **Debugging Variable Resolution in Azure Pipelines**

> Debugging Azure Pipelines variables is **not guesswork**.
> Variables fail for **deterministic reasons**: wrong scope, wrong phase, wrong syntax, or wrong path.
> Senior engineers debug by **observing evaluation**, not by trial and error.

---

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/media/troubleshooting/job-task-logs.png?view=azure-devops)

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/build/media/options/system-debug.png?view=azure-devops)

![Image](https://richhewlett.com/assets/2024/05/pipeline-debug-output.jpg)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "â“ Variable Missing" }
    B@{ shape: hex, label: "ğŸ§  Evaluation Phase" }
    C@{ shape: hex, label: "ğŸ“ Scope" }
    D@{ shape: hex, label: "ğŸ” Logs" }
    E@{ shape: hex, label: "âœ… Fix" }

    A --> B
    B --> C
    C --> D
    D --> E

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 600,animation: dash 20s linear infinite;
    class A,B,C,D,E animate
```

</div>

---

## ğŸ”´ **Problem Pattern: â€œVariable Is Empty / Wrong / Inconsistentâ€**

Every real failure falls into **one of these buckets**:

1. Wrong evaluation phase
2. Wrong scope
3. Wrong syntax
4. Wrong dependency path
5. Permissions or secrets masking

We will debug **each with real pipelines**.

---

## 1ï¸âƒ£ Enable Full Debug Mode (First Step Always)

### âœ… Mandatory Debug Flag

```yaml
variables:
  system.debug: true
```

What this unlocks:

- Variable expansion logs
- Expression evaluation
- Task input resolution
- Agent diagnostics

âš ï¸ Seniors **never debug without this**.

---

## 2ï¸âƒ£ Debug Case #1 â€” Variable Exists, But Is Empty

### âŒ Broken Pipeline

```yaml
steps:
  - script: echo $(env)
```

Output:

```ini
(empty)
```

---

### ğŸ” Debug Process

Add:

```yaml
- script: printenv | sort
```

---

### ğŸ§  Diagnosis

- Variable not defined anywhere
- No pipeline / stage / job variable
- No variable group

---

### âœ… Fix

```yaml
variables:
  env: dev
```

---

## 3ï¸âƒ£ Debug Case #2 â€” Variable Works in One Job, Not Another

### âŒ Broken Pipeline

```yaml
jobs:
  - job: Build
    steps:
      - script: |
          echo "##vso[task.setvariable variable=ver]1.0"

  - job: Deploy
    steps:
      - script: echo $(ver)
```

---

### ğŸ” Debug Logs Reveal

- `ver` created
- Job ends
- New agent starts
- Variable gone

---

### ğŸ§  Diagnosis

- Job isolation
- Missing `isOutput=true`

---

### âœ… Fix (Output Variable)

```yaml
- script: |
    echo "##vso[task.setvariable variable=ver;isOutput=true]1.0"
  name: setVer
```

Consume via:

```yaml
$[ dependencies.Build.outputs['setVer.ver'] ]
```

---

## 4ï¸âƒ£ Debug Case #3 â€” Output Variable Path Is Wrong

### âŒ Broken Reference

```yaml
dependencies.Build.outputs['setVar.version']
```

---

### ğŸ” Debug Strategy

Enable debug and search logs for:

```ini
##vso[task.setvariable]
```

You will see:

```ini
Step name: setVersion
Variable name: version
```

---

### ğŸ§  Diagnosis

- Step name mismatch
- Case-sensitive
- Job name â‰  displayName

---

### âœ… Fix

```yaml
dependencies.Build.outputs['setVersion.version']
```

---

## 5ï¸âƒ£ Debug Case #4 â€” Variable Works in Script, Fails in Condition

### âŒ Broken Condition

```yaml
condition: eq($(env), 'prod')
```

---

### ğŸ§  Diagnosis

- `$(env)` resolves at step runtime
- Conditions evaluated before step execution

---

### âœ… Fix

```yaml
condition: eq(variables['env'], 'prod')
```

---

## 6ï¸âƒ£ Debug Case #5 â€” Variable Group Value Is Empty

### âŒ Broken Usage

```yaml
variables:
  - group: prod-vars

steps:
  - script: echo $(dbPassword)
```

Output:

```ini
(empty)
```

---

### ğŸ” Debug Checklist

1. Is group linked?
2. Permission granted?
3. Secret masked?
4. Correct environment?
5. Key Vault access?

---

### ğŸ§  Most Common Cause

âŒ Pipeline has **no permission** on variable group

---

### âœ… Fix

Azure DevOps UI â†’
Library â†’ Variable Group â†’ Security â†’ Grant pipeline access

---

## 7ï¸âƒ£ Debug Case #6 â€” Secret Looks Empty (But Isnâ€™t)

### âŒ Misleading Output

```yaml
- script: echo $(dbPassword)
```

Output:

```ini
***
```

---

### ğŸ§  Diagnosis

- Secret is masked
- Value exists

---

### âœ… Correct Verification

```yaml
- script: |
    if [ -n "$DB_PASSWORD" ]; then echo "Secret exists"; fi
  env:
    DB_PASSWORD: $(dbPassword)
```

---

## 8ï¸âƒ£ Debug Case #7 â€” Parameter Used Like Variable

### âŒ Broken Code

```yaml
parameters:
  - name: env
    type: string
    default: dev

steps:
  - script: echo $(env)
```

---

### ğŸ§  Diagnosis

- Parameters do not exist at runtime

---

### âœ… Fix

```yaml
variables:
  envVar: ${{ parameters.env }}

steps:
  - script: echo $(envVar)
```

---

## 9ï¸âƒ£ Debug Case #8 â€” Variable Overridden Unexpectedly

### âŒ Confusing Pipeline

```yaml
variables:
  env: dev

jobs:
  - job: Test
    variables:
      env: prod
    steps:
      - script: echo $(env)
```

Output:

```ini
prod
```

---

### ğŸ§  Diagnosis

- Closest scope wins

---

### ğŸ” Debug Tip

Log all scopes:

```yaml
- script: |
    echo Pipeline=$(ENV)
    printenv | grep ENV
```

---

## ğŸ” Senior Debugging Workflow (Memorize This)

### ğŸ§­ The â€œ5 Whyâ€ Variable Debug Flow

1. **When** should this exist? (compile vs runtime)
2. **Where** is it defined? (scope)
3. **How** is it accessed? (`${{ }}`, `$[ ]`, `$( )`)
4. **Who** owns it? (pipeline, job, group)
5. **Why** could it be masked or blocked?

---

## ğŸ§  **Memorization Tips**

### ğŸ”‘ Mnemonic: **"P-S-S-D-P"**

| Letter | Meaning         |
| ------ | --------------- |
| **P**  | Phase           |
| **S**  | Scope           |
| **S**  | Syntax          |
| **D**  | Dependency path |
| **P**  | Permissions     |
