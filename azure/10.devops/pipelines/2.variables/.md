# **complete, end-to-end explanation of variables in Azure Pipelines**

## 1. What Is a Variable in Azure Pipelines? (Foundation)

A **pipeline variable** is a **key–value pair** used to:

- Parameterize pipelines
- Avoid hard-coding values
- Share data between steps, jobs, and stages
- Control behavior across environments

Think of variables as **runtime configuration**, not code.

```text
variable_name = value
```

---

## 2. Variable Evaluation Model (Critical Concept)

Azure Pipelines has **two evaluation times**:

| Type             | When evaluated            | Syntax   |
| ---------------- | ------------------------- | -------- |
| **Compile-time** | Before pipeline runs      | `${{ }}` |
| **Runtime**      | While pipeline is running | `$( )`   |

This distinction is **extremely important**.

---

## 3. Basic Variable Declaration (YAML)

### 3.1 Inline Variables

```yaml
variables:
  appName: my-app
  environment: dev
```

Usage:

```yaml
- script: echo $(appName)
```

✔ Runtime evaluation
✔ Most common usage

---

## 4. Variables vs Parameters (Must Know Difference)

| Feature    | Variables        | Parameters            |
| ---------- | ---------------- | --------------------- |
| Evaluation | Runtime          | Compile-time          |
| Mutability | Can change       | Immutable             |
| Used for   | Secrets, outputs | Pipeline structure    |
| Syntax     | `$(var)`         | `${{ parameters.x }}` |

### Parameter Example

```yaml
parameters:
  - name: env
    type: string
    default: dev
```

Usage:

```yaml
- script: echo ${{ parameters.env }}
```

---

## 5. Variable Scopes (Hierarchy)

Variables can exist at **different scopes**:

```ini
Pipeline
 ├── Stage
 │    ├── Job
 │         ├── Step
```

### 5.1 Pipeline-Level Variable

```yaml
variables:
  buildConfig: Release
```

Available everywhere.

---

### 5.2 Stage-Level Variable

```yaml
stages:
  - stage: Build
    variables:
      stageVar: build-stage
```

Overrides pipeline variable.

---

### 5.3 Job-Level Variable

```yaml
jobs:
  - job: Test
    variables:
      jobVar: test-job
```

Overrides stage and pipeline.

---

### 5.4 Variable Precedence (Important)

```ini
Step > Job > Stage > Pipeline > Variable Group
```

Closest scope **wins**.

---

## 6. Variable Groups (Enterprise Usage)

Variable Groups are stored centrally in **Azure DevOps Library**.

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/library/media/add-variable-group.png?view=azure-devops)

![Image](https://zimmergren.net/content/images/2019/10/devopsvault12.jpg)

![Image](https://i0.wp.com/dailydotnettips.com/wp-content/uploads/2020/03/Variable-Group.png?resize=711%2C538&ssl=1)

### Use Case

- Shared across pipelines
- Environment-specific values
- Secrets

### Link Variable Group

```yaml
variables:
  - group: prod-variables
```

---

## 7. Secrets and Secure Variables

### 7.1 Secret Variable (Library or UI)

- Value is **masked**
- Cannot be echoed
- Cannot be logged

Usage:

```yaml
- script: |
    echo "##vso[task.setvariable variable=token;issecret=true]abc123"
```

Access:

```yaml
$(token)
```

---

## 8. Environment Variables Mapping

Azure Pipelines automatically maps variables to OS env vars.

| Pipeline Var | Linux/macOS | Windows   |
| ------------ | ----------- | --------- |
| `myVar`      | `$MYVAR`    | `%MYVAR%` |

Example:

```yaml
- script: echo $MYVAR
```

---

## 9. Output Variables (Passing Between Jobs)

### 9.1 Why Output Variables Exist

Jobs run on **different agents** → memory is lost
Output variables persist across jobs.

---

### 9.2 Step Output Variable

```yaml
- script: |
    echo "##vso[task.setvariable variable=version;isOutput=true]1.0.5"
  name: setVersion
```

---

### 9.3 Job Output Variable

```yaml
jobs:
  - job: Build
    steps:
      - script: |
          echo "##vso[task.setvariable variable=artifact;isOutput=true]drop"
        name: publishStep
```

---

### 9.4 Consume Output in Another Job

```yaml
- job: Deploy
  dependsOn: Build
  variables:
    artifactName: $[ dependencies.Build.outputs['publishStep.artifact'] ]
```

Usage:

```yaml
- script: echo $(artifactName)
```

✔ This is **the most common interview-tested pattern**

---

## 10. Passing Variables Between Stages

![Image](https://i.sstatic.net/cx1mv.png)

![Image](https://erwinstaal.nl/images/azdo-multi-stage.png)

![Image](https://blogs.blackmarble.co.uk/wp-content/uploads/sites/2/2022/01/image-1-1024x446.png)

```yaml
stages:
  - stage: Build
    jobs:
      - job: BuildJob
        steps:
          - script: |
              echo "##vso[task.setvariable variable=buildId;isOutput=true]1001"
            name: setId

  - stage: Deploy
    dependsOn: Build
    variables:
      buildIdFromBuild: $[ stageDependencies.Build.BuildJob.outputs['setId.buildId'] ]
```

---

## 11. Conditional Logic with Variables

### Runtime Condition

```yaml
condition: eq(variables['environment'], 'prod')
```

### Compile-Time Condition

```yaml
${{ if eq(parameters.env, 'prod') }}:
```

---

## 12. Variable Templates (Advanced Reusability)

### variables.yml

```yaml
variables:
  appName: api
  port: 8080
```

### Pipeline

```yaml
variables:
  - template: variables.yml
```

✔ Clean
✔ Reusable
✔ DRY

---

## 13. Environment-Specific Variable Pattern (Best Practice)

```yaml
variables:
  - ${{ if eq(parameters.env, 'dev') }}:
      - group: dev-vars
  - ${{ if eq(parameters.env, 'prod') }}:
      - group: prod-vars
```

---

## 14. Debugging Variables (Very Important)

Enable:

```yaml
variables:
  system.debug: true
```

Inspect logs to see:

- Variable expansion
- Conditions
- Overrides

---

## 15. Common Mistakes (Avoid These)

| Mistake                        | Why it fails          |
| ------------------------------ | --------------------- |
| Using `$(var)` in compile-time | Too late              |
| Using `${{ }}` for secrets     | Evaluated too early   |
| Forgetting `isOutput=true`     | Variable not exported |
| Wrong dependency path          | Outputs not resolved  |

---

## 16. Mental Model Summary

```ini
Parameters → pipeline structure
Variables → runtime data
Variable Groups → shared config
Output Variables → cross-job data
Secrets → secure runtime injection
```

---

## 17. Real-World Example (End-to-End)

```yaml
parameters:
  - name: env
    type: string
    default: dev

variables:
  - group: common-vars

stages:
  - stage: Build
    jobs:
      - job: BuildJob
        steps:
          - script: |
              echo "##vso[task.setvariable variable=version;isOutput=true]$(Build.BuildId)"
            name: setVersion

  - stage: Deploy
    dependsOn: Build
    variables:
      versionFromBuild: $[ stageDependencies.Build.BuildJob.outputs['setVersion.version'] ]
    jobs:
      - job: DeployJob
        steps:
          - script: echo Deploying version $(versionFromBuild)
```
