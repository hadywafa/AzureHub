# ğŸ§  **Real-World Template Patterns**

## **How Azure Pipelines Are Built in Production**

> Real pipelines are **not written per repo**.
> They are **assembled from platform templates**, versioned, governed, and reused.
> The difference between a _working pipeline_ and a _scalable DevOps platform_ is **architecture**, not YAML syntax.

---

![Image](https://learn.microsoft.com/en-us/azure/architecture/microservices/images/aks-cicd-flow.png)

![Image](https://learn.microsoft.com/en-us/samples/azure-samples/azure-pipelines-remote-tasks/azure-pipeline-remote-tasks/media/remote-access-diagram.png)

![Image](https://i.sstatic.net/W8nSt.png)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "ğŸ¢ DevOps Platform Repo" }
    B@{ shape: hex, label: "ğŸ“„ Base Pipeline (extends)" }
    C@{ shape: hex, label: "ğŸ§© Templates (jobs/stages)" }

    D1@{ shape: rect, label: "ğŸ“¦ Service A Repo" }
    D2@{ shape: rect, label: "ğŸ“¦ Service B Repo" }
    D3@{ shape: rect, label: "ğŸ“¦ Monorepo" }

    A --> B
    B --> C
    C --> D1
    C --> D2
    C --> D3

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 700,animation: dash 22s linear infinite;
    class A,B,C,D1,D2,D3 animate
```

</div>

---

## 1ï¸âƒ£ **Microservice Pipeline Pattern** (Most Common)

### ğŸ§  Problem

- 20â€“200 microservices
- Same CI logic
- Same security rules
- Same deployment flow

âŒ Copy-paste pipelines = chaos

---

### ğŸ—ï¸ Platform Template (Owned by DevOps Team)

ğŸ“„ `base-microservice-pipeline.yml`

```yaml
parameters:
  - name: serviceName
    type: string
  - name: dockerImage
    type: string
  - name: deploy
    type: boolean
    default: true

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - script: echo Building ${{ parameters.serviceName }}

  - stage: Test
    jobs:
      - job: Test
        steps:
          - script: echo Running tests

  - ${{ if eq(parameters.deploy, true) }}:
      - stage: Deploy
        jobs:
          - job: Deploy
            steps:
              - script: echo Deploying ${{ parameters.dockerImage }}
```

---

### ğŸ“„ Service Repo Pipeline (Tiny & Safe)

```yaml
extends:
  template: templates/v1/base-microservice-pipeline.yml
  parameters:
    serviceName: orders-api
    dockerImage: orders-api:latest
```

âœ” No duplication  
âœ” Platform rules enforced  
âœ” Easy onboarding

---

### âŒ Anti-Pattern

Each service defines its own:

- Build steps
- Security logic
- Deployment order

Result: **inconsistent releases**

---

## 2ï¸âƒ£ **Monorepo Pipeline Pattern** (Advanced but Powerful)

### ğŸ§  Problem

One repo contains:

- `/services/api`
- `/services/web`
- `/libs/common`

You must:

- Build only what changed
- Deploy independently

---

### ğŸ§± Parameterized Job Template

ğŸ“„ `job-build-service.yml`

```yaml
parameters:
  - name: name
    type: string
  - name: path
    type: string

jobs:
  - job: Build_${{ parameters.name }}
    steps:
      - script: |
          echo Building ${{ parameters.name }}
          echo Path: ${{ parameters.path }}
```

---

### ğŸ“„ Monorepo Pipeline

```yaml
parameters:
  - name: services
    type: object
    default:
      - name: api
        path: services/api
      - name: web
        path: services/web

jobs:
  - ${{ each svc in parameters.services }}:
      - template: job-build-service.yml
        parameters:
          name: ${{ svc.name }}
          path: ${{ svc.path }}
```

âœ” Single pipeline  
âœ” Multiple independent builds  
âœ” Scales cleanly

---

### ğŸ”¥ Advanced Add-On (Path Filters)

```yaml
trigger:
  paths:
    include:
      - services/api/*
```

âœ” Only relevant jobs run  
âœ” Faster pipelines

---

## 3ï¸âƒ£ **Multi-Environment Template Pattern** (Enterprise CD)

### ğŸ§  Problem

Deploy same app to:

- Dev
- Test
- Prod

But with:

- Different approvals
- Different variable groups
- Different protections

---

### ğŸ—ï¸ Environment Stage Template

ğŸ“„ `stage-deploy-env.yml`

```yaml
parameters:
  - name: env
    type: string

stages:
  - stage: Deploy_${{ parameters.env }}
    variables:
      - group: ${{ parameters.env }}-vars
    jobs:
      - deployment: Deploy
        environment: ${{ parameters.env }}
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo Deploying to ${{ parameters.env }}
```

---

### ğŸ“„ Main Pipeline

```yaml
stages:
  - template: stage-deploy-env.yml
    parameters:
      env: dev

  - template: stage-deploy-env.yml
    parameters:
      env: test

  - template: stage-deploy-env.yml
    parameters:
      env: prod
```

âœ” Same logic  
âœ” Different controls  
âœ” Approval-ready

---

### ğŸ”’ Production Safety

Azure DevOps Environments enforce:

- Approvals
- RBAC
- Deployment history

Templates + Environments = **safe CD**

---

## 4ï¸âƒ£ **Shared DevOps Platform Repository** (Architect-Level)

### ğŸ§  Problem

Templates scattered across repos:

- Hard to version
- Hard to govern
- Hard to audit

---

### ğŸ¢ Solution: Dedicated Platform Repo

```ini
devops-platform/
â”œâ”€ templates/
â”‚  â”œâ”€ v1/
â”‚  â”‚  â”œâ”€ base-pipeline.yml
â”‚  â”‚  â”œâ”€ job-build.yml
â”‚  â”‚  â””â”€ stage-deploy.yml
â”‚  â””â”€ v2/
â”‚     â””â”€ base-pipeline.yml
â”œâ”€ docs/
â”‚  â””â”€ usage.md
```

---

### ğŸ“„ Consuming Platform Templates

```yaml
resources:
  repositories:
    - repository: platform
      type: git
      name: DevOps/devops-platform
      ref: refs/heads/v1

extends:
  template: templates/base-pipeline.yml@platform
  parameters:
    serviceName: billing-api
```

âœ” Central ownership
âœ” Versioned rollout
âœ” Safe upgrades

---

## ğŸ§  **Pattern Comparison (Quick Reference)**

| Pattern       | When to Use             |
| ------------- | ----------------------- |
| Microservice  | Many repos, same rules  |
| Monorepo      | Many services, one repo |
| Multi-env     | Dev/Test/Prod promotion |
| Platform repo | Org-wide governance     |

---

## âŒ **Real-World Anti-Patterns**

| Anti-Pattern            | Why It Fails     |
| ----------------------- | ---------------- |
| Copy-paste YAML         | Unmaintainable   |
| No versioning           | Breaking changes |
| Teams control structure | Security risk    |
| One pipeline per env    | Duplication      |
| Secrets in templates    | Breach risk      |

---

## ğŸ§  **Memorization Tips**

### ğŸ”‘ Mnemonic: **"M-M-E-P"**

| Letter | Meaning       |
| ------ | ------------- |
| **M**  | Microservices |
| **M**  | Monorepos     |
| **E**  | Environments  |
| **P**  | Platform repo |
