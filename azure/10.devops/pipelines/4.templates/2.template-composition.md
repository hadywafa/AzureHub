# ğŸ§  **Template Composition & Contracts**

## **`extends`, Template Inheritance & Versioning (Enterprise Design)**

> Template composition is about **control and governance**.  
> Senior engineers do **not** let teams assemble pipelines freely.  
> Instead, they provide **safe extension points**, **strict contracts**, and **versioned templates** that evolve without breaking consumers.

---

![Image](https://josh-ops.com/assets/screenshots/2020-12-08-extends-template/required-check.png)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "ğŸ¢ Platform Template\n(Controlled)" }
    B@{ shape: hex, label: "ğŸ§© extends" }
    C@{ shape: hex, label: "ğŸ“„ Team Pipeline" }
    D@{ shape: hex, label: "ğŸ“‹ Final Pipeline" }

    A --> B
    B --> C
    C --> D

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 650,animation: dash 20s linear infinite;
    class A,B,C,D animate
```

</div>

---

## ğŸ”´ **Problem: Teams Assembling Pipelines Freely**

Typical junior design:

```yaml
steps:
  - task: TerraformCLI@0
  - script: rm -rf /
```

- âŒ No governance
- âŒ No standards
- âŒ Security risk
- âŒ Impossible to audit

---

## ğŸ§  **Two Ways to Use Templates**

Azure Pipelines gives you **two fundamentally different mechanisms**:

| Mechanism   | Purpose          | Control Level |
| ----------- | ---------------- | ------------- |
| `template:` | Include YAML     | Low           |
| `extends:`  | Inherit pipeline | **High**      |

This difference is **architectural**, not cosmetic.

---

## 1ï¸âƒ£ `template:` â€” Composition (Loose Control)

### ğŸ§© What It Does

- Injects YAML at a specific point
- Caller controls structure
- Template is **optional**

---

### ğŸ§ª Example: Job Template Inclusion

```yaml
jobs:
  - template: job-build.yml
    parameters:
      name: api
```

âœ” Flexible  
âœ” Composable  
âœ• No enforcement

---

### âŒ Why This Is Not Enough for Platforms

Teams can still:

- Add unsafe steps
- Bypass security
- Skip scans
- Change order

This is **not governance**.

---

## 2ï¸âƒ£ `extends:` â€” Inheritance (Strong Control)

> `extends` allows a pipeline to **inherit from a base template**.
> The base template **owns the structure**.
> The consumer only provides **inputs**.

This is the **platform-team weapon**.

---

### ğŸ—ï¸ Base Platform Template

ğŸ“„ `base-pipeline.yml`

```yaml
parameters:
  - name: appName
    type: string
  - name: runSecurityScan
    type: boolean
    default: true

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - script: echo Building ${{ parameters.appName }}

  - ${{ if eq(parameters.runSecurityScan, true) }}:
      - stage: Security
        jobs:
          - job: Scan
            steps:
              - script: echo Running security scan

  - stage: Deploy
    jobs:
      - job: Deploy
        steps:
          - script: echo Deploying ${{ parameters.appName }}
```

---

### ğŸ“„ Team Pipeline (Consumer)

```yaml
extends:
  template: base-pipeline.yml
  parameters:
    appName: payment-api
```

âœ” Team cannot remove security  
âœ” Team cannot change structure  
âœ” Only safe inputs allowed

---

## ğŸ”¥ **Key Rule (Memorize This)**

> **If you want governance â†’ use `extends`.** > **If you want reuse â†’ use `template`.**

---

## 3ï¸âƒ£ Parameter Inheritance & Flow (Very Important)

### ğŸ§  How Parameters Flow with `extends`

```ini
Team Pipeline â†’ Base Template â†’ Nested Templates
```

All parameters are:

- Compile-time
- Immutable
- Explicit

---

### ğŸ§ª Passing Parameters Down

ğŸ“„ `base-pipeline.yml`

```yaml
parameters:
  - name: appName
    type: string

stages:
  - stage: Build
    jobs:
      - template: job-build.yml
        parameters:
          name: ${{ parameters.appName }}
```

ğŸ“„ `job-build.yml`

```yaml
parameters:
  - name: name
    type: string

jobs:
  - job: Build_${{ parameters.name }}
```

âœ” Clean flow  
âœ” Explicit contracts  
âœ” No magic

---

## 4ï¸âƒ£ Template Contracts (Critical Concept)

> A **template contract** is the **public API** of your pipeline.

If you break it â†’ **you break every consumer**.

---

### ğŸ§© Good Contract Example

```yaml
parameters:
  - name: appName
    type: string
  - name: environment
    type: string
    values: [dev, test, prod]
```

âœ” Strong typing  
âœ” Validation  
âœ” Safe inputs

---

### âŒ Bad Contract Example

```yaml
parameters:
  - name: config
    type: object
```

âŒ No validation  
âŒ Easy to misuse  
âŒ Hard to debug

---

### ğŸ§  Contract Design Rules (Senior-Level)

1. Prefer **primitive types**
2. Restrict `values`
3. Provide defaults
4. Document intent
5. Never rely on implicit behavior

---

## 5ï¸âƒ£ Template Versioning Strategies (Enterprise Critical)

### âŒ Naive Strategy (Very Common Mistake)

```yaml
template: templates/base-pipeline.yml
```

âŒ Any change breaks everyone  
âŒ No rollback  
âŒ No safety

---

## âœ… Strategy 1: Repo-Level Versioning (Best Practice)

```ini
templates/
 â”œâ”€ v1/
 â”‚   â””â”€ base-pipeline.yml
 â”œâ”€ v2/
 â”‚   â””â”€ base-pipeline.yml
```

Usage:

```yaml
extends:
  template: templates/v1/base-pipeline.yml
```

âœ” Safe upgrades  
âœ” Parallel versions  
âœ” Predictable behavior

---

## âœ… Strategy 2: Branch-Based Versioning

```yaml
resources:
  repositories:
    - repository: templates
      type: git
      name: DevOps/PipelineTemplates
      ref: refs/heads/v1
```

âœ” Central platform repo  
âœ” Controlled releases

---

## âŒ Strategy to Avoid: â€œLatestâ€

```yaml
ref: refs/heads/main
```

âŒ Silent breaking changes  
âŒ Production outages

---

## 6ï¸âƒ£ Real Platform Pattern (How Big Companies Do It)

---

### ğŸ¢ Platform Team Owns:

- Base pipeline (`extends`)
- Security stages
- Compliance rules
- Versioning

---

### ğŸ‘¥ Product Teams Own:

- Parameters
- App-specific values
- No structure

---

### ğŸ§  Result

âœ” Central governance  
âœ” Team autonomy  
âœ” Safe evolution  
âœ” Zero copy-paste

---

## ğŸ§  Mental Model (Lock This In)

```ini
template  = include
extends   = inherit
parameters = contract
versions  = safety
```

---

## ğŸ§  Memorization Tips

### ğŸ”‘ Mnemonic: **"E-C-V-G"**

| Letter | Meaning                 |
| ------ | ----------------------- |
| **E**  | extends for enforcement |
| **C**  | Contracts define inputs |
| **V**  | Version templates       |
| **G**  | Governance at scale     |

---

## âŒ Common Template Composition Mistakes

| Mistake                         | Why              |
| ------------------------------- | ---------------- |
| Using `template` for governance | No control       |
| No versioning                   | Breaking changes |
| Weak contracts                  | Runtime failures |
| Overusing objects               | Hard to debug    |
| Letting teams change structure  | Chaos            |
