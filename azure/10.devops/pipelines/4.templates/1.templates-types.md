# ğŸ§  **Templates & Modularization**

## **Template Types â€“ Building Reusable Pipelines**

> Templates are **compile-time YAML macros**.  
> They are expanded by the **Pipeline Service**, not executed by agents.  
> Senior engineers use templates to enforce **consistency**, **governance**, and **scale** across dozens or hundreds of pipelines.

---

![Image](https://damienaicheh.github.io/assets/posts/2022-03-27-folder-architecture.png)

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/get-started/media/yaml-pipeline-editor/yaml-pipeline-editor-templates.png?view=azure-devops)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "ğŸ“„ Main Pipeline" }
    B@{ shape: hex, label: "ğŸ§  Compile-Time Expansion" }

    C@{ shape: rect, label: "ğŸ§© Variable Template" }
    D@{ shape: rect, label: "ğŸ”¹ Step Template" }
    E@{ shape: rect, label: "ğŸ§± Job Template" }
    F@{ shape: rect, label: "ğŸ—ï¸ Stage Template" }

    A --> B
    B --> C
    B --> D
    B --> E
    B --> F

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 650,animation: dash 20s linear infinite;
    class A,B,C,D,E,F animate
```

</div>

---

## ğŸ”´ **Problem: Copy-Paste Pipelines**

Typical junior pipeline:

```yaml
steps:
  - task: DotNetCoreCLI@2
  - task: DotNetCoreCLI@2
  - task: PublishBuildArtifacts@1
```

Copied into:

- 10 repos
- With tiny differences
- Impossible to maintain

âŒ Duplication  
âŒ Inconsistent behavior  
âŒ Platform chaos

---

## ğŸ§  **Golden Rule of Templates**

> Templates define **structure**, not runtime behavior.  
> They are expanded using **`${{ }}` only**.

No `$()`  
No runtime variables  
No `##vso` logic inside templates

---

## 1ï¸âƒ£ Step Templates (Smallest Unit)

### ğŸ§© When to Use

- Repeating **steps**
- Common build/test sequences
- Simple reuse

---

### ğŸ“„ `steps-build.yml`

```yaml
steps:
  - script: echo Restoring packages
  - script: echo Building project
  - script: echo Running tests
```

---

### ğŸ“„ Main Pipeline

```yaml
steps:
  - template: steps-build.yml
```

âœ” Simple  
âœ” Clean  
âœ” Compile-time inclusion

---

### ğŸ”¥ Step Template with Parameters

```yaml
# steps-build.yml
parameters:
  - name: configuration
    type: string
    default: Release

steps:
  - script: echo Building in ${{ parameters.configuration }}
```

Usage:

```yaml
steps:
  - template: steps-build.yml
    parameters:
      configuration: Debug
```

---

## 2ï¸âƒ£ Variable Templates (Configuration Layer)

> Variable templates define **defaults and shared config**, not secrets.

---

### ğŸ“„ `variables-common.yml`

```yaml
variables:
  buildConfig: Release
  timeout: 60
```

---

### ğŸ“„ Pipeline Usage

```yaml
variables:
  - template: variables-common.yml
```

Override locally:

```yaml
variables:
  - template: variables-common.yml
  - name: timeout
    value: 120
```

âœ” Central defaults  
âœ” Local overrides  
âœ” Predictable precedence

---

## 3ï¸âƒ£ Job Templates (Most Used in Real Life)

### ğŸ§± When to Use

- Standardized build jobs
- Shared agent configuration
- Repeatable CI logic

---

### ğŸ“„ `job-build.yml`

```yaml
parameters:
  - name: jobName
    type: string
  - name: vmImage
    type: string

jobs:
  - job: ${{ parameters.jobName }}
    pool:
      vmImage: ${{ parameters.vmImage }}
    steps:
      - script: echo Building on ${{ parameters.vmImage }}
```

---

### ğŸ“„ Main Pipeline

```yaml
jobs:
  - template: job-build.yml
    parameters:
      jobName: Build_Linux
      vmImage: ubuntu-latest

  - template: job-build.yml
    parameters:
      jobName: Build_Windows
      vmImage: windows-latest
```

âœ” Zero duplication  
âœ” Parallel jobs  
âœ” Clean abstraction

---

## 4ï¸âƒ£ Stage Templates (Enterprise Standard)

> Stage templates define **full CI or CD phases**.

---

### ğŸ—ï¸ When to Use

- CI stage reused across repos
- CD stage reused across environments
- Governance and approvals

---

### ğŸ“„ `stage-deploy.yml`

```yaml
parameters:
  - name: environment
    type: string

stages:
  - stage: Deploy_${{ parameters.environment }}
    jobs:
      - job: Deploy
        steps:
          - script: echo Deploying to ${{ parameters.environment }}
```

---

### ğŸ“„ Main Pipeline

```yaml
stages:
  - template: stage-deploy.yml
    parameters:
      environment: dev

  - template: stage-deploy.yml
    parameters:
      environment: prod
```

âœ” Consistent deployments  
âœ” Environment clarity  
âœ” Reusable CD logic

---

## 5ï¸âƒ£ Broken Template Patterns (Learn These)

### âŒ Using Runtime Variables in Templates

```yaml
# template.yml
- script: echo $(env)
```

âŒ Templates are expanded before runtime

---

### âœ… Correct Fix

Pass values via parameters:

```yaml
parameters:
  - name: env
    type: string
```

---

### âŒ Using `$()` in Template Conditions

```yaml
${{ if eq($(env), 'prod') }}:
```

âŒ Wrong phase

---

### âœ… Correct

```yaml
${{ if eq(parameters.env, 'prod') }}:
```

---

## 6ï¸âƒ£ Combining Templates + Loops (Platform-Level Pattern)

### ğŸ“„ `job-template.yml`

```yaml
parameters:
  - name: name
    type: string

jobs:
  - job: Build_${{ parameters.name }}
    steps:
      - script: echo Building ${{ parameters.name }}
```

---

### ğŸ“„ Main Pipeline

```yaml
parameters:
  - name: services
    type: object
    default: [api, web, worker]

jobs:
  - ${{ each svc in parameters.services }}:
      - template: job-template.yml
        parameters:
          name: ${{ svc }}
```

âœ” Dynamic pipelines  
âœ” Central logic  
âœ” Massive scale

---

## ğŸ§  **Template Type Comparison (Quick Reference)**

| Template Type | Scope      | Use Case        |
| ------------- | ---------- | --------------- |
| Step          | Steps only | Small reuse     |
| Variable      | Variables  | Defaults/config |
| Job           | Jobs       | CI logic        |
| Stage         | Stages     | CI/CD phases    |

---

## ğŸ§  Memorization Tips

### ğŸ”‘ Mnemonic: **"SVJS"**

| Letter | Meaning            |
| ------ | ------------------ |
| **S**  | Step templates     |
| **V**  | Variable templates |
| **J**  | Job templates      |
| **S**  | Stage templates    |

---

## âŒ Common Modularization Mistakes

| Mistake                    | Why            |
| -------------------------- | -------------- |
| One giant template         | Unmaintainable |
| Runtime logic in templates | Wrong phase    |
| No parameters              | Rigid design   |
| Hard-coded agent info      | No reuse       |
