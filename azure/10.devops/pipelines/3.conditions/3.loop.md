# ğŸ§  **Looping & Dynamic Control Flow**

## **Dynamic Pipelines with `each`, Objects & Fan-Out**

> Azure Pipelines does **not support runtime loops**.
> All looping is **compile-time only** and powered by **`${{ each }}`**.
> This means loops **generate pipeline structure**, not behavior.
> Senior engineers use loops to eliminate duplication and scale pipelines cleanly.

---

![Image](https://i.sstatic.net/yvYE2.png)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "ğŸ“„ Parameters / Objects" }
    B@{ shape: hex, label: "ğŸ§  Compile-Time Loop\n${{ each }}" }
    C@{ shape: hex, label: "ğŸ“‹ Expanded Pipeline" }
    D1@{ shape: processes, label: "ğŸ¤– Job A" }
    D2@{ shape: processes, label: "ğŸ¤– Job B" }
    D3@{ shape: processes, label: "ğŸ¤– Job C" }

    A --> B
    B --> C
    C --> D1
    C --> D2
    C --> D3

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 700,animation: dash 22s linear infinite;
    class A,B,C,D1,D2,D3 animate
```

</div>

---

## ğŸ”´ **Problem: Copy-Pasted Pipelines**

Junior pipelines look like this:

```yaml
jobs:
  - job: Build_API
  - job: Build_Web
  - job: Build_Worker
```

âŒ Duplication  
âŒ Error-prone  
âŒ Hard to scale

---

## ğŸ§  **Golden Rule of Looping**

> **`each` loops run at compile-time and generate YAML.**
> They do not iterate at runtime.

If data isnâ€™t known at compile-time â†’ you **cannot loop over it**.

---

## 1ï¸âƒ£ Basic `each` Loop (Step Level)

### ğŸ§ª Example: Repeating Steps

```yaml
parameters:
  - name: messages
    type: object
    default:
      - Hello
      - World
      - Pipeline

steps:
  - ${{ each msg in parameters.messages }}:
      - script: echo ${{ msg }}
```

âœ” Generates 3 steps  
âœ” No runtime looping

---

## 2ï¸âƒ£ Looping Over Jobs (Most Common Use Case)

### ğŸ§± Example: Dynamic Build Jobs

```yaml
parameters:
  - name: services
    type: object
    default:
      - api
      - web
      - worker

jobs:
  - ${{ each svc in parameters.services }}:
      - job: Build_${{ svc }}
        steps:
          - script: echo Building ${{ svc }}
```

âœ” 3 jobs  
âœ” Parallel execution  
âœ” Zero duplication

---

## 3ï¸âƒ£ Looping with Objects (Senior-Level Pattern)

### ğŸ§© Object Parameter

```yaml
parameters:
  - name: services
    type: object
    default:
      - name: api
        port: 8080
      - name: web
        port: 3000
```

---

### ğŸ” Dynamic Jobs with Object Fields

```yaml
jobs:
  - ${{ each svc in parameters.services }}:
      - job: Build_${{ svc.name }}
        steps:
          - script: |
              echo Service=${{ svc.name }}
              echo Port=${{ svc.port }}
```

âœ” Strongly structured  
âœ” Readable  
âœ” Scales cleanly

---

## 4ï¸âƒ£ Conditional Logic Inside Loops (Very Powerful)

### ğŸ§ª Example: Conditional Step per Service

```yaml
steps:
  - ${{ each svc in parameters.services }}:
      - script: echo Common step for ${{ svc.name }}
      - ${{ if eq(svc.name, 'api') }}:
          - script: echo API-only step
```

âœ” Logic applied per item
âœ” Clean branching

---

## 5ï¸âƒ£ Fan-Out â†’ Fan-In Pattern (Production Critical)

### ğŸ§  Pattern Explanation

- Fan-out: run many jobs in parallel
- Fan-in: one job depends on all

---

### ğŸ—ï¸ Fan-Out Build Jobs

```yaml
jobs:
  - ${{ each svc in parameters.services }}:
      - job: Build_${{ svc.name }}
        steps:
          - script: echo Building ${{ svc.name }}
```

---

### ğŸ”— Fan-In Job

```yaml
- job: Aggregate
  dependsOn:
    - ${{ each svc in parameters.services }}:
        - Build_${{ svc.name }}
  steps:
    - script: echo All builds completed
```

âœ” Parallel builds  
âœ” Controlled convergence

---

## 6ï¸âƒ£ Looping Across Stages (Advanced)

### ğŸ§ª Dynamic Environments

```yaml
parameters:
  - name: environments
    type: object
    default:
      - dev
      - test
      - prod
```

---

### ğŸ—ï¸ Dynamic Stages

```yaml
stages:
  - ${{ each env in parameters.environments }}:
      - stage: Deploy_${{ env }}
        jobs:
          - job: Deploy
            steps:
              - script: echo Deploying to ${{ env }}
```

âœ” Fully dynamic CD  
âœ” No duplication

---

## 7ï¸âƒ£ Broken Loop Examples (Learn These)

### âŒ Trying to Loop Over Runtime Data

```yaml
- ${{ each x in variables.list }}:
```

âŒ Variables donâ€™t exist at compile-time

---

### âŒ Trying to Loop Inside Script

```yaml
- script: |
    for i in $(services); do ...
```

âŒ Pipeline loop â‰  shell loop

---

### âœ… Correct Fix

Use **parameters** or **template objects**.

---

## 8ï¸âƒ£ Combining `each` + Templates (Enterprise Pattern)

---

### ğŸ“„ `job-template.yml`

```yaml
parameters:
  - name: name
    type: string

jobs:
  - job: Build_${{ parameters.name }}
    steps:
      - script: echo Building ${{ parameters.name }}
```

---

### ğŸ“„ Main Pipeline

```yaml
jobs:
  - ${{ each svc in parameters.services }}:
      - template: job-template.yml
        parameters:
          name: ${{ svc.name }}
```

âœ” Maximum reuse  
âœ” Clean structure  
âœ” Platform-team friendly

---

## ğŸ§  Expression Evaluation Reminder (Very Important)

Inside `each`:

- Use `${{ }}` only
- `$()` will not work
- No runtime access

---

## ğŸ§  Memorization Tips

### ğŸ”‘ Mnemonic: **"LEGO"**

| Letter | Meaning              |
| ------ | -------------------- |
| **L**  | Loop at compile-time |
| **E**  | Each generates YAML  |
| **G**  | Grows structure      |
| **O**  | Objects scale best   |

---

## âŒ Top Looping Mistakes

| Mistake                    | Why             |
| -------------------------- | --------------- |
| Looping over variables     | Too late        |
| Looping over outputs       | Impossible      |
| Mixing `$()` inside `each` | Wrong phase     |
| Over-nesting loops         | Unreadable YAML |
