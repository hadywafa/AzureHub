# ğŸ§  **Expressions Deep Dive**

## **Runtime vs Compile-Time Expressions (Heavy Examples)**

> Azure Pipelines has **two different expression engines** running at **two different times**.
> Expressions donâ€™t just â€œevaluateâ€ â€” they **shape the pipeline** or **control execution** depending on _when_ they run.
> If you mix these engines, pipelines fail silently.

---

![Image](https://christosmonogios.com/public/images/2025/11/azure-pipeline-parameter-ui.png)

![Image](https://i.sstatic.net/dbU83.png)

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/release/media/definition-02.png?view=azure-devops)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A@{ shape: hex, label: "ğŸ“„ YAML" }
    B@{ shape: hex, label: "ğŸ§  Compile-Time\n${{ }}" }
    C@{ shape: hex, label: "ğŸ“‹ Final Pipeline" }
    D@{ shape: hex, label: "ğŸ¤– Runtime\n$[ ] & $( )" }

    A --> B
    B --> C
    C --> D

    classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 700,animation: dash 22s linear infinite;
    class A,B,C,D animate
```

</div>

---

## ğŸ”´ **Problem: â€œExpression Works Here but Not Thereâ€**

This happens when:

- You use the **right expression in the wrong phase**
- You reference a value **before it exists**
- You mix syntaxes

Letâ€™s destroy these problems.

---

## 1ï¸âƒ£ Compile-Time Expressions â€“ `${{ }}`

> `${{ }}` runs **before the pipeline starts**.
> It **changes the shape** of the pipeline.

---

### âœ… What `${{ }}` Can Do

- âœ” Add/remove stages
- âœ” Add/remove jobs
- âœ” Add/remove steps
- âœ” Select templates
- âœ” Select variable groups

---

### âŒ What `${{ }}` Cannot Do

- âŒ Read runtime variables
- âŒ Read script output
- âŒ Read secrets
- âŒ Read artifacts

---

### ğŸ§ª Example: Conditional Stage Creation

```yaml
parameters:
  - name: deploy
    type: boolean
    default: false

stages:
  - stage: Build

  - ${{ if eq(parameters.deploy, true) }}:
      - stage: Deploy
```

âœ” Deploy stage **exists only if deploy=true**

---

### âŒ Broken Example: Using Variables at Compile-Time

```yaml
variables:
  env: prod

- ${{ if eq(variables.env, 'prod') }}:
```

âŒ Variables do not exist yet

---

### âœ… Fixed Pattern

```yaml
parameters:
  - name: env
    type: string
    default: prod

  - ${{ if eq(parameters.env, 'prod') }}:
```

---

## 2ï¸âƒ£ Runtime Expressions â€“ `$[ ]`

> `$[ ]` runs **after compile-time**, **before a job starts**.
> It is used for **data wiring**, not structure.

---

### âœ… What `$[ ]` Is Used For

- âœ” Output variables
- âœ” Dependency resolution
- âœ” Runtime conditions
- âœ” Cross-job data flow

---

### ğŸ§ª Example: Output Variable Consumption

```yaml
variables:
  version: $[ dependencies.Build.outputs['setVer.version'] ]
```

âœ” Evaluated once per job  
âœ” Value fixed for job duration

---

### âŒ Broken Example: Using `$()` Instead of `$[ ]`

```yaml
variables:
  version: $(dependencies.Build.outputs['setVer.version'])
```

âŒ `$()` only works in steps
âŒ Variable resolves to empty

---

## 3ï¸âƒ£ Step Runtime Expressions â€“ `$( )`

> `$( )` is resolved **inside scripts and tasks**, line by line.

---

### ğŸ§ª Example

```yaml
steps:
  - script: echo Version is $(version)
```

âœ” Works only during step execution

---

### âŒ Using `$( )` Outside Steps

```yaml
condition: eq($(env), 'prod')
```

âŒ Invalid
âœ” Use `variables['env']`

---

## 4ï¸âƒ£ Variable Dereferencing Pitfalls (Very Common)

---

### âŒ Pitfall #1 â€“ Dot Notation in Expressions

```yaml
condition: eq(variables.env, 'prod')
```

âŒ This fails silently in many cases

---

### âœ… Correct Access Pattern

```yaml
condition: eq(variables['env'], 'prod')
```

âœ” Always safe  
âœ” Recommended

---

### âŒ Pitfall #2 â€“ Undefined Variables

```yaml
condition: startsWith(variables['tag'], 'v')
```

âŒ Fails if `tag` is empty

---

### âœ… Safe Pattern (Short-Circuit)

```yaml
condition: and(
  ne(variables['tag'], ''),
  startsWith(variables['tag'], 'v')
)
```

---

## 5ï¸âƒ£ Expression Evaluation Order (Critical Insight)

### ğŸ§  Actual Order (Memorize This)

```ini
1. YAML parsed
2. Templates expanded
3. ${{ }} evaluated
4. Execution graph built
5. Job queued
6. $[ ] evaluated
7. Step starts
8. $( ) evaluated
```

---

### ğŸ§ª Example That Explains Everything

```yaml
parameters:
  - name: env
    type: string
    default: prod

variables:
  envVar: ${{ parameters.env }}

steps:
  - script: echo $(envVar)
```

âœ” Works because:

- Parameter â†’ compile-time
- Variable created â†’ runtime
- Used in step â†’ runtime

---

## 6ï¸âƒ£ Broken vs Fixed â€“ Real Production Scenarios

---

### âŒ Broken: Condition Using Output Variable Too Early

```yaml
condition: eq(variables['version'], '1.0')
```

âŒ `version` created by previous job

---

### âœ… Fixed

```yaml
variables:
  version: $[ dependencies.Build.outputs['setVer.version'] ]

condition: eq(variables['version'], '1.0')
```

---

## 7ï¸âƒ£ Complex Expression Example (Senior-Level)

### ğŸ›‘ Safe Prod Deployment Gate

```yaml
condition: and(
  succeeded(),
  eq(variables['env'], 'prod'),
  or(
    eq(variables['Build.SourceBranch'], 'refs/heads/main'),
    startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')
  )
)
```

âœ” Prevents accidental prod deploys  
âœ” Clear intent  
âœ” Auditable

---

## ğŸ§  Mental Model (Tattoo This)

```ini
${{ }} = Build pipeline
$[ ]   = Wire data
$( )   = Use values
```

---

## ğŸ§  Memorization Tips

### ğŸ”‘ Mnemonic: **"B-W-U"**

| Letter | Meaning                 |
| ------ | ----------------------- |
| **B**  | Build pipeline (${{ }}) |
| **W**  | Wire data ($[ ])        |
| **U**  | Use values ($( ))       |

---

## âŒ Top Expression Mistakes (With Reasons)

| Mistake                     | Why            |
| --------------------------- | -------------- |
| Using variables in `${{ }}` | Too early      |
| Using `$()` in conditions   | Too late       |
| Using parameters at runtime | Already gone   |
| Dot notation                | Unsafe         |
| Wrong evaluation order      | Silent failure |
