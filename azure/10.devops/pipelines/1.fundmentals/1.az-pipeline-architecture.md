# ğŸ§  **Azure Pipelines Architecture Internals**

> Azure Pipelines is **not a single runtime system**. It is a **distributed orchestration platform** composed of a **control plane (Pipeline Service)** and **execution workers (Agents)**.
> The Pipeline Service **parses YAML, resolves templates, schedules jobs, and enforces security**, while **Agents execute jobs in isolated environments**.
> Each **job runs on exactly one agent**, with **no shared state between jobs**. Any persistence must be **explicit** (artifacts, output variables, external storage).

---

![Image](https://learn.microsoft.com/en-us/azure/devops/pipelines/architectures/media/azure-devops-ci-cd-architecture.svg?view=azure-devops)

---

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
    A([ğŸ‘¤ User / Trigger])
    B@{ shape: hex, label: "ğŸ§  Azure Pipelines Service\n(Control Plane)" }
    C@{ shape: hex, label: "ğŸ“‹ Execution Plan\n(Stages â€¢ Jobs â€¢ Steps)" }

    D@{ shape: processes, label: "ğŸ¤– Agent A\n(Job 1)" }
    E@{ shape: processes, label: "ğŸ¤– Agent B\n(Job 2)" }
    F@{ shape: processes, label: "ğŸ¤– Agent C\n(Job 3)" }

    A --> B
    B --> C
    C --> D
    C --> E
    C --> F

    classDef animate stroke-dasharray: 8,4,stroke-dashoffset: 500,animation: dash 18s linear infinite;
    class A,B,C,D,E,F animate
```

</div>

---

## ğŸ”´ **Problem: Why Pipelines Feel â€œConfusingâ€ at First**

Most confusion comes from **assuming pipelines behave like a single process**.

Common wrong assumptions:

- Jobs share files
- Variables automatically persist
- Agents â€œrememberâ€ previous jobs
- YAML is executed top-down like a script

âŒ None of this is true.

To understand Azure Pipelines, you must separate:

> **Orchestration** from **Execution**

---

## ğŸ§  **Pipeline Service vs Agent**

### ğŸ§  Pipeline Service (Control Plane)

The **Pipeline Service never runs your code**.

It is responsible for:

- Reading YAML
- Expanding templates
- Resolving parameters
- Evaluating compile-time expressions (`${{ }}`)
- Building an execution graph
- Scheduling jobs
- Enforcing permissions

Think of it as:

> ğŸ§  _The architect and scheduler_

---

### ğŸ¤– Pipeline Agent (Execution Plane)

The **Agent only executes jobs**.

It is responsible for:

- Creating a working directory
- Checking out code
- Running scripts and tasks
- Producing logs
- Uploading artifacts

Think of it as:

> ğŸ¤– _A disposable worker with instructions_

The agent:

- Does **not** know pipeline structure
- Does **not** know other jobs exist
- Does **not** share memory or filesystem

---

## âš™ï¸ **What Actually Happens When a Pipeline Runs**

### ğŸŸ¦ Phase 1: Design Time (Pipeline Service)

1. YAML is parsed
2. Templates are expanded
3. Parameters are resolved
4. Stages, jobs, and steps are materialized
5. A **static execution plan** is created

âš ï¸ No agent exists yet  
âš ï¸ No scripts run  
âš ï¸ No runtime variables exist

---

### ğŸŸ© Phase 2: Job Scheduling

For **each job**, the service:

- Selects an agent pool
- Applies demands
- Finds a matching agent
- Assigns **one job â†’ one agent**

---

### ğŸŸ¨ Phase 3: Runtime Execution (Agent)

The agent:

1. Starts with a clean environment
2. Executes steps sequentially
3. Streams logs to the service
4. Publishes outputs (artifacts, variables)
5. Terminates job context

After this â†’ **everything is destroyed**.

---

## ğŸ”¥ **Job Isolation & Why State Is Lost**

### ğŸ§± Hard Rule (Memorize This)

> **Each job runs in total isolation.**

That isolation includes:

- Filesystem
- Environment variables
- Processes
- Installed tools (on hosted agents)

---

### âŒ Why This Fails

```yaml
jobs:
  - job: Build
    steps:
      - script: echo "hello" > version.txt

  - job: Deploy
    steps:
      - script: cat version.txt
```

**Reason**:
`Deploy` runs on a **different agent**.

---

### âœ… What Survives Job Boundaries

Only **explicit channels**:

- Pipeline artifacts
- Output variables (`isOutput=true`)
- External systems (Blob, DB, S3, etc.)

Isolation is a **feature**, not a limitation.

---

## â˜ï¸ **Hosted vs Self-Hosted Agents**

### â˜ï¸ Microsoft-Hosted Agents

> **Ephemeral, fully managed agents:**

**Characteristics:**

- New VM per job
- Preinstalled tools
- Auto-scaled
- Zero maintenance

**Trade-offs:**

- Cold start latency
- No persistent cache
- No private network access

Best for:

- CI pipelines
- Learning
- Standard workloads

---

### ğŸ  Self-Hosted Agents

> **Persistent machines you manage:**

**Characteristics:**

- Long-lived VM or container
- Custom tooling
- Network access (on-prem, private VNet)
- Full control

**Trade-offs:**

- You patch and secure
- You scale
- You monitor

Best for:

- Terraform / IaC
- Enterprise networks
- High-performance builds
- Compliance workloads

---

## ğŸ¯ **Agent Capabilities & Demands**

### ğŸ§© Agent Capabilities

Capabilities describe **what an agent can do**:

- OS
- Installed tools
- Custom labels

Examples:

```ini
Agent.OS = Linux
java = 17
docker = true
terraform = 1.6
```

---

### ğŸ¯ Demands (Job Requirements)

Jobs can require capabilities:

```yaml
pool:
  name: SelfHostedPool
  demands:
    - docker
    - terraform
```

The Pipeline Service:

- Scans agents
- Matches capabilities
- Queues job until a match is found

If no agent matches â†’ **job never starts**

---

## ğŸŒ **End-to-End Pipeline Execution Flow**

<div align="center" style="background-color: #232b2dff; border-radius: 10px; border: 2px solid">

```mermaid
sequenceDiagram
    title Azure Pipeline Execution Flow ğŸ§­

    participant User as ğŸ‘¤ User / Trigger
    participant Service as ğŸ§  Pipeline Service
    participant Agent as ğŸ¤– Pipeline Agent
    participant Repo as ğŸ“¦ Git Repo
    participant Artifact as ğŸ—‚ï¸ Artifact Storage

    User->>Service: â–¶ï¸ Trigger pipeline
    Service->>Service: ğŸ“‹ Parse YAML & templates
    Service->>Service: ğŸ§® Resolve parameters & expressions
    Service->>Agent: ğŸ“¦ Assign job
    Agent->>Repo: ğŸ”½ Checkout code
    Agent->>Agent: âš™ï¸ Run steps
    Agent->>Artifact: ğŸ“¤ Publish artifacts
    Agent-->>Service: ğŸ“ Stream logs
    Service-->>User: âœ… Pipeline result
```

</div>

---

## ğŸ§  **Memorization Tips**

### ğŸ”‘ Mnemonic: **"BRAINâ€“HANDSâ€“ISOLATION"**

| Concept       | Remember                         |
| ------------- | -------------------------------- |
| **BRAIN**     | Pipeline Service orchestrates    |
| **HANDS**     | Agent executes blindly           |
| **ISOLATION** | One job = one agent              |
| **NO MEMORY** | State dies after job             |
| **EXPLICIT**  | Only artifacts & outputs persist |
