# ğŸ›¡ï¸ GitHub Security: Enable & Use (End-to-End)

## ğŸ“¦ **Prereqs & scope**

- Youâ€™re an **Admin/Maintainer** on the repo (or Org owner for org-wide settings).
- Private repos: **GitHub Advanced Security (GHAS)** is required for **CodeQL** & **Secret Scanning** (public repos get reduced features free).
- Enable **Actions** for the repo (weâ€™ll run CodeQL via Actions).

---

## ğŸ”” **1. Dependabot (Alerts + Auto-PR Updates)**

### 1ï¸âƒ£ Turn on Dependabot Alerts (UI)

Repo â†’ **Settings** â†’ **Code security and analysis** â†’ **Dependency graph** (**Enable**) â†’ **Dependabot alerts** (**Enable**).
(Org owners can enable defaults at **Org â†’ Code security & analysis**.)

### 2ï¸âƒ£ Add update automation (dependabot.yml)

Create **`.github/dependabot.yml`** at repo root:

```yaml
version: 2
updates:
  # npm (Angular/Node)
  - package-ecosystem: "npm"
    directory: "/web" # path to package.json
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 5
    allow:
      - dependency-type: "direct"
    ignore:
      - dependency-name: "typescript" # example
  # NuGet (.NET)
  - package-ecosystem: "nuget"
    directory: "/api" # path to *.csproj or packages.config
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 5
  # GitHub Actions runner images/actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
```

**What happens:**

- Dependabot scans dependency manifests & the Advisory DB.
- Creates **Alerts** (Security tab) and **auto-PRs** to bump versions.
- Use **branch protection** to require CI & reviewers on these PRs.

**Tips:**

- Label route: create label **security** and configure **`labels: ["security"]`** per update block.
- If you use private registries, add **Dependabot secrets** (Repo â†’ Settings â†’ Secrets and variables â†’ Dependabot).

---

## ğŸ§  **2. CodeQL (Static Analysis & Quality Gates)**

### 1ï¸âƒ£ Enable CodeQL (UI shortcut)

Repo â†’ **Security** â†’ **Code scanning alerts** â†’ **Set up code scanning** â†’ choose **CodeQL Analysis** â†’ **Default**.
GitHub creates **`.github/workflows/codeql.yml`** automatically.

### 2ï¸âƒ£ Or customize the workflow

**`.github/workflows/codeql.yml`** (multi-language example for **.NET + JavaScript/TypeScript**):

```yaml
name: "CodeQL"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 3 * * 1" # weekly

permissions:
  contents: read
  security-events: write # required to upload results
  actions: read

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: ["csharp", "javascript"] # add "cpp","python","java","go" as needed

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Setup .NET only if needed
      - name: Setup .NET
        if: matrix.language == 'csharp'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # optional: packs or custom queries
          # queries: security-extended

      # Build your project so CodeQL sees compiled DBs
      - name: Build (.NET)
        if: matrix.language == 'csharp'
        run: |
          dotnet restore ./api
          dotnet build ./api --configuration Release --no-restore

      - name: Build (Web - optional)
        if: matrix.language == 'javascript'
        run: |
          cd web
          npm ci
          npm run build --if-present

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"
```

**What happens:**

- Runs on **push/PR** and weekly.
- Uploads findings to **Security â†’ Code scanning alerts**.
- PRs get **checks** (green/red). Add branch protection to **require CodeQL check to pass** before merge.

**Advanced:**

- Tighten rules: `queries: security-extended` or a custom pack.
- Monorepo? Use **multiple jobs** or **paths** filters.
- Speed up with **autobuild** for some languages (`init@v3` supports it).

---

## ğŸ”‘ **3. Secret Scanning (+ Push Protection & Custom Patterns)**

### 1ï¸âƒ£ Enable (UI)

Repo â†’ **Settings â†’ Code security and analysis**

- **Secret scanning** â†’ **Enable**
- **Push protection** â†’ **Enable** (prompts devs _before_ pushing a secret)

> Public repos: scanning is on by default. Private repos need GHAS.

### 2ï¸âƒ£ Add custom patterns (Org or Repo)

Org (recommended) â†’ **Code security & analysis â†’ Secret scanning** â†’ **Custom patterns â†’ New pattern**
Define a safe **regex** and (optional) **additional match requirements**.

Example pattern (very simple) for tokens like `ACME_[A-Z0-9]{32}`:

```ini
ACME_[A-Z0-9]{32}
```

**Push Protection:**

- On push (CLI or web), if a commit matches a provider pattern or your custom pattern, GitHub **blocks the push** and asks the developer to:

  - Remove the secret, or
  - Justify (rare), or
  - Mark as test (if allowed)

- Alerts show in **Security â†’ Secret scanning**.

**Best practice:**

- Rotate compromised credentials immediately.
- Add **validity checks** for custom patterns so you reduce false positives.

---

## âœ… **Make Findings Block Merges (Policies)**

1. **Require status checks to pass**

   - Repo â†’ **Settings â†’ Branches â†’ Branch protection rules**
   - Add rule for `main`:

     - âœ… Require pull request
     - âœ… Require status checks to pass:

       - _CodeQL_ (Code scanning results / analysis)
       - _Your CI workflow checks_

     - âœ… Dismiss stale approvals if new commits pushed

2. **Dependabot PRs**

   - Treat like normal PRs with required checks. Optionally auto-merge when checks pass.

3. **Secret Scanning Push Protection**

   - Already blocks at push time (stricter than PR checks).

---

## ğŸ“Š **Where to Read Results (Security tab)**

- **Dependabot** â†’ _Security â†’ Dependabot alerts_ (and auto-PRs)
- **CodeQL** â†’ _Security â†’ Code scanning alerts_
- **Secret scanning** â†’ _Security â†’ Secret scanning_

Each alert has:

- CWE/OWASP mapping (for CodeQL)
- Affected file/line
- Suggested **fix** or upgrade version (Dependabot)
- Severity & history

---

## ğŸ§ª **Example: Full â€œSecurityâ€ workflow file**

If you prefer a **single Action** that runs unit tests + CodeQL, keep Dependabot via its YAML and secret scanning via UI:

```yaml
name: ci-with-codeql

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  build-and-codeql:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Restore/Build/Test
        run: |
          dotnet restore ./api
          dotnet build ./api -c Release --no-restore
          dotnet test ./api/tests --logger trx

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: Web build
        run: |
          cd web
          npm ci
          npm run build --if-present

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp,javascript
          # queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
```

---

## ğŸ§­ **Roll-out Strategy (Org level)**

1. **Set org defaults** (Security & analysis): enable Dependency graph, Dependabot alerts, code scanning default setup, secret scanning & push protection.
2. **Security policy**: add a `SECURITY.md` explaining how to report/triage.
3. **Branch protection templates**: enforce CodeQL & CI checks across repos.
4. **Audit**: use org-level **Security overview** to track alerts across repos.

---

## âš™ï¸ **Troubleshooting**

- **CodeQL job says â€œno languages detectedâ€** â†’ ensure you listed correct languages in `init` and actually built relevant code.
- **Private package feeds** (npm/nuget) for Dependabot â†’ add **Dependabot secrets** so it can authenticate.
- **False positives in secret scanning** â†’ refine custom regex with _additional match_ or _post-processing_; mark alerts as _revoked_/_used in tests_ when appropriate.
- **Actions blocked** â†’ check org policy (**Actions â†’ Policies**) and required permissions (`security-events: write`).
- **Alert noise** â†’ start with **security-extended** queries later; first fix critical/high issues.

---

## ğŸ **TL;DR**

- **Dependabot**: enable alerts; add `dependabot.yml` to auto-PR updates.
- **CodeQL**: enable via Security tab or add `codeql.yml`; require check in branch protection.
- **Secret Scanning**: enable scanning + push protection; add custom patterns for your org secrets.
- Use **Branch Protection** so PRs **must** pass CodeQL and CI; Dependabot PRs follow same gate.
