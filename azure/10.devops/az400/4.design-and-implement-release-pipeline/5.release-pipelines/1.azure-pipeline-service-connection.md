# ğŸ”— **Azure DevOps Service Connections**

## ğŸ“– **What is a Service Connection?**

A **Service Connection (SC)** in Azure DevOps = a **secure â€œbridgeâ€ between your pipeline and an external system**.

- It stores credentials/secrets (e.g., Azure SPN, GitHub token, Docker registry password).
- Pipelines reference the SC **by name** instead of hardcoding secrets.
- Azure DevOps handles authentication under the hood.

ğŸ‘‰ Think of it as a **vaulted credential + configuration object** inside Azure DevOps.

---

## â‰ï¸ **Why Do We Need It?**

Without SCs, every pipeline would require:

- Explicit Client IDs, Secrets, Certificates, Tokens.
- Repeated authentication steps everywhere.
- Insecure storage of creds inside YAML. âŒ

With SCs:

- Credentials are stored **once** (encrypted in DevOps).
- Pipelines reference them safely.
- Rotation/updating secrets happens in one place.

---

## ğŸ—ï¸ How It Fits in Azure Pipelines

<div align="center">

```mermaid
flowchart LR
    subgraph Azure DevOps Project
      A[Pipeline YAML] --> B[Task: AzureCLI@2]
      B --> C((Service Connection))
    end
    C --> D[Azure Resource Manager]
    C --> E[GitHub Repo]
    C --> F[Docker Registry]
```

</div>

> âœ… Pipeline tasks reference the Service Connection to perform actions on external systems.

---

## ğŸ¤¹ğŸ» **Types of Service Connections**

<div align="center">
  <img src="images/service-connection.png" alt="service-connection" style="width: 100%; border-radius: 10px;">
</div>

---

Some common types:

- **Azure Resource Manager (ARM)** â†’ uses **Service Principal** from Entra ID.
- **GitHub / GitHub Enterprise** â†’ uses OAuth or PAT.
- **Docker Registry / ACR** â†’ uses username/password or SPN.
- **AWS, GCP, Bitbucket, Jenkins, SonarCloud** â†’ many built-in connectors.
- **Generic Service Connection** â†’ raw credentials for custom services.

---

## ğŸ” Azure Resource Manager (ARM) Types

Azure is the most common target. Letâ€™s break down ARM connection types.

| ğŸ”— ARM Connection Type                  | ğŸ“Œ Use Case                                           | ğŸ‘¤ Auth                  |
| --------------------------------------- | ----------------------------------------------------- | ------------------------ |
| **Service Principal (Automatic)**       | Default, most secure                                  | Entra ID App SP          |
| **Service Principal (Manual)**          | When you provide appId, secret, tenant                | Entra ID SP              |
| **Managed Identity**                    | When running pipeline from Azure-hosted agent with MI | System-assigned identity |
| **Workload Identity Federation (OIDC)** | Modern SP-less auth                                   | Entra ID + OIDC          |

---

<div align="left">
  <img src="images/arm-service-connection-authentication.png" alt="ARM Service Connection Authentication" style="width: 40%; border-radius: 10px;">
</div>

---

### âš™ï¸ **How It Works Internally (Azure Example)**

Letâ€™s take **Azure Resource Manager Service Connection**:

1. You create an **App Registration (SPN)** in Entra ID.
2. Assign it RBAC role (e.g., Contributor) at Subscription/Resource Group.
3. Create a Service Connection in DevOps:

   - Paste **Tenant ID, Subscription ID, Client ID, Client Secret**.
   - SC stores them securely in DevOps.

4. In pipeline YAML, you reference SC by name:

   ```yaml
   - task: AzureCLI@2
   inputs:
       azureSubscription: "sc-azure-demo"
       scriptType: bash
       scriptLocation: inlineScript
       inlineScript: az group list
   ```

5. At runtime:

   - Pipeline agent contacts DevOps service.
   - DevOps injects SC credentials into the job (as temp token).
   - Task uses those creds to login (`az login --service-principal`).
   - Executes `az`/ARM calls securely.

---

## ğŸ•³ï¸ **What Is Stored Internally?**

Inside DevOps:

- Encrypted JSON with:

  - **Client ID** (like username)
  - **Secret/Cert** (like password)
  - **Tenant ID**
  - **Subscription ID**

- Metadata: Connection name, type (AzureRM, Docker, GitHub), access policies.

ğŸ”’ Stored in DevOps backend KeyVault-like service.
Admins can configure **who can use the connection** in pipelines.

---

## ğŸ–¼ï¸ **Portal Views**

- **Project Settings â†’ Service Connections**
- Each SC can be:

  - **Authorized for all pipelines**
  - Or require explicit approval per pipeline

---

## ğŸ”§ Create Azure Resource Manager Connection (Manual)

> You need: `Subscription Owner` or `User Access Administrator` role

### ğŸ”¹ Steps:

1. Go to **Project Settings** â†’ **Service connections**
2. Click â• **New Service Connection**
3. Select **Azure Resource Manager**
4. Choose one:

   - ğŸ“¦ **Automatic**: Let DevOps create SP
   - ğŸ§¾ **Manual**: Provide:

     - Subscription ID
     - Tenant ID
     - App ID + Secret (Service Principal)

5. Set **scope level**:

   - Subscription or Management Group

6. Save and give it a name like `AzureRM-DevSub`

ğŸ”’ Optionally restrict access to pipelines or users.

---

<div align="left">
  <img src="images/arm-service-connection.png" alt="ARM Service Connection" style="width: 40%; border-radius: 10px;">
</div>

---

## ğŸ”„ Reuse in Pipeline

```yaml
trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: "AzureRM-DevSub"
      scriptType: "pscore"
      scriptLocation: "inlineScript"
      inlineScript: |
        az group create --name demo-rg --location eastus
```

> ğŸ” The `azureSubscription` field uses the Service Connection name.

---

## âœ… Best Practices

| ğŸ§  Tip                   | ğŸ’¬ Explanation                                           |
| ------------------------ | -------------------------------------------------------- |
| ğŸ” Avoid secrets in YAML | Always use secure connections and pipeline variables     |
| ğŸ·ï¸ Use friendly naming   | Name connections per env (e.g., `AzureRM-Staging`)       |
| ğŸ”„ Rotate secrets        | If using SP manually, rotate client secrets periodically |
| ğŸ‘¥ Restrict access       | Use RBAC and project-level permissions                   |
| ğŸ§ª Test permissions      | Run test pipeline to validate access before full deploy  |

---

## ğŸ” How to View & Manage

- Go to **Project Settings â†’ Service Connections**
- Click any connection to:

  - ğŸ” View details
  - ğŸ” Refresh token / secret
  - ğŸ›‘ Disable
  - ğŸ§¼ Delete

---

## ğŸ§ª Verify from CLI

```bash
az ad sp list --display-name "<AppName>"
az ad sp credential list --id <AppID>
```

Use to check if SP exists, roles assigned, expiry dates.

---

## ğŸ§µ Summary Table

| ğŸ”Œ Type  | ğŸ‘¨ Auth         | ğŸ“ Scope      | ğŸ—ï¸ Used by            |
| -------- | --------------- | ------------- | --------------------- |
| Azure RM | SP or MI        | Sub / MG      | CLI / ARM / Terraform |
| GitHub   | PAT / OAuth     | Org / Repo    | GitHub Task, Checkout |
| Docker   | Basic / SP      | Registry      | Docker Push           |
| K8s      | Kubeconfig / SP | AKS / Cluster | Helm / Kubectl        |

## ğŸ **TL;DR**

- A **Service Connection** = a **secure credential object** in DevOps.
- It ties pipelines to external services (Azure, GitHub, Docker, etc.).
- Internally, for Azure, itâ€™s basically a **Service Principalâ€™s Client ID/Secret** stored encrypted.
- At runtime, DevOps injects those creds into tasks (like AzureCLI\@2) to log in.
- You **reference SC by name** in YAML; never hardcode secrets.

---
