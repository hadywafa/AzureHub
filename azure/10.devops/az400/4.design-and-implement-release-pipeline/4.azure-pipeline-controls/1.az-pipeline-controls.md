# ğŸ§­ Azure Pipeline Controls

When you run a **Release Pipeline** in Azure DevOps, the process is not just "deploy and done." It has **checkpoints** before, during, and after deployment. These are called **Approvals** and **Gates**.

The diagram you uploaded shows exactly that:

---

<div align="center">
  <img src="images/1756648888298.png" alt="Azure DevOps Release Approvals & Gates" style="border-radius: 10px; border: 2px solid; width: 40%;">
</div>

---

## ğŸŸ¦ 1. Pre-deployment conditions

Before deployment begins, you can set **rules** to ensure the release is safe.

- **Approvers (ğŸ‘©â€ğŸ’» humans)**
  â†’ Example: A QA lead must click â€œApproveâ€ before deployment continues.
  â†’ Ensures _human validation_.

- **Gates (ğŸ¤– automated checks)**
  â†’ Example: Query ServiceNow for open incidents OR check monitoring alerts.
  â†’ Ensures _system validation_.

ğŸ’¡ **Think of this as: "Do we have permission and is everything okay before we touch production?"**

---

## ğŸŸª 2. Deployment process

This is the **actual deployment flow**.

- **Jobs** = logical units inside the deployment.
- **Automation tasks** = scripts, infrastructure as code, deployments, etc.
- **Manual intervention** = pause for a human to take action (e.g., verify in staging before promoting).

ğŸ’¡ **Think of this as: "Do the actual work of deploying, but allow pauses if needed."**

---

## ğŸŸ¦ 3. Post-deployment conditions

After deployment is finished, you can enforce more checks.

- **Approvers** â†’ Example: A manager signs off that production looks good.
- **Gates** â†’ Example: Run smoke tests, monitor telemetry, or check if error rates spiked.

ğŸ’¡ **Think of this as: "Double-check the release didnâ€™t break things before marking it successful."**

---

## ğŸ”‘ Key Idea

ğŸ‘‰ The **release pipeline flow** =
**Pre-checks (approvers + gates) â†’ Deployment jobs â†’ Post-checks (approvers + gates).**

This lets you control:

- **Who** can allow deployments.
- **What conditions** must be met automatically.
- **When** humans must step in.

---

## âœ… In short:

**Approvals** = Humans must say "yes".
**Gates** = Automated systems must say "yes".
Together, they ensure **safe, controlled deployments**.

---

<div align="center">
  <img src="images/az-pipeline-controls.png" alt="Azure Pipeline controls flow" style="width: 100%; border-radius: 10px;">
</div>

---

## âœ… 1. Conditions

### ğŸ§  What is it?

**Conditions** let you control _when_ a step, job, or stage should run â€” based on success, failure, skipped status, variable values, or expressions.

### ğŸ“¦ Example: Run deployment **only if build succeeded**

```yaml
- job: Deploy
  dependsOn: Build
  condition: succeeded() # ğŸ‘ˆ Only run if Build job succeeded
  steps:
    - script: echo "Deploying app..."
```

### ğŸ’¡ Common `condition` functions

| Function                       | Meaning                           |
| ------------------------------ | --------------------------------- |
| `succeeded()`                  | Previous stage/job was successful |
| `failed()`                     | It failed                         |
| `always()`                     | Run regardless of result          |
| `eq(variables['env'], 'prod')` | Run if variable equals value      |

---

## ğŸ™‹â€â™€ï¸ 2. Approvals (via **Environment Approvals**)

### ğŸ§  What is it?

Human **approvers** are required before deploying to a specific **Environment** (like Production). Approvals delay deployment until a team member clicks â€œApproveâ€.

### ğŸ¯ Where is it used?

In **multi-stage pipelines** or **deployment jobs** with `environment`.

---

### ğŸ“¦ Example: Require manual approval before deploying to `prod`

```yaml
- deployment: DeployProd
  environment: prod-env # ğŸ‘ˆ approval must be configured in the Azure UI for this environment
  strategy:
    runOnce:
      deploy:
        steps:
          - script: echo "Deploying to Production"
```

> ğŸ” Set up the `prod-env` environment in Azure DevOps UI and assign approvers from there.

---

## â›” 3. Gates / Checks

### ğŸ§  What are they?

**Automated or manual checks** that must pass before moving forward. Used in **environments** to run validations like:

- Run scripts
- Call APIs
- Wait for approvals
- Check Azure Monitor alerts

---

### ğŸ“¦ Example: Add delay + REST API check before production deploy

> âœ… Defined in Azure DevOps portal under **Environment > Checks**

| Check Type    | What it does                     |
| ------------- | -------------------------------- |
| Approval      | Requires manual approval         |
| REST API      | Calls an endpoint and expects OK |
| Timeout       | Adds wait time before deployment |
| Azure Monitor | Verifies metrics or alerts       |

> ğŸ’¡ You **donâ€™t define these in YAML** â€” you configure them in the **Azure portal** for the target environment.

---

## âœ‹ 4. Manual Trigger (Manual Intervention)

### ğŸ§  What is it?

Allows a stage/job to **wait for human interaction** during the pipeline â€” not just before deploy.

Unlike environment approval (which is before a deployment), **manual steps** can be anywhere.

---

### ğŸ“¦ Example: Pause for manual input before testing

```yaml
- task: ManualValidation@0
  inputs:
    instructions: "Please validate the app manually before proceeding"
    onTimeout: "reject"
    timeout: "1d"
```

| Property       | Purpose                       |
| -------------- | ----------------------------- |
| `instructions` | What you ask the user to do   |
| `timeout`      | Max wait time (e.g., `1d`)    |
| `onTimeout`    | What to do if no one responds |

---

## ğŸ“Š Summary Table

| Control Type    | Human Involved? | YAML Needed? | Purpose                                |
| --------------- | --------------- | ------------ | -------------------------------------- |
| **Condition**   | âŒ              | âœ…           | Control when jobs run                  |
| **Approval**    | âœ…              | âœ… + UI      | Require human approval via environment |
| **Gate/Check**  | âœ… or âŒ        | âŒ (UI only) | Block deploy with checks (REST, delay) |
| **Manual Step** | âœ…              | âœ…           | Pause inside pipeline for validation   |
