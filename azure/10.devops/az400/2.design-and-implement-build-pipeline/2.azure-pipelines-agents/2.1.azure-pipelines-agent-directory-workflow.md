# ğŸ’» **Azure Pipelines Agent Directory Workflow (From Scratch)**

## ğŸ“Œ **1. The Agent Root & Its World**

When you install (or use) an agent, it has a **root folder** where all jobs live.

- **Hosted agent (Microsoftâ€™s VM):**

  - Linux root: `/home/vsts/`
  - Windows root: `C:\agent\`
    ğŸ‘‰ This VM is **ephemeral**: everything is wiped when the job ends.

- **Self-hosted agent:**

  - You pick the folder (e.g., `C:\azagent` or `/opt/azagent`).
  - Inside, the agent creates `_work` and other helper folders.

ğŸ”‘ **Key sibling dirs inside root:**

```ini
/_work   # active job workspaces
/_temp   # temp files
/_tool   # tool cache
```

---

## ğŸ“Œ **2. `_work` Structure**

Each pipeline/project on that agent gets assigned a **numeric slot**. Example:

```ini
/_work/
  â”œâ”€ 1/    # slot 1
  â”‚   â”œâ”€ s/   â†’ sources (repo after checkout)
  â”‚   â”œâ”€ b/   â†’ binaries (Build.BinariesDirectory)
  â”‚   â”œâ”€ a/   â†’ artifacts (ArtifactStagingDirectory)
  â”‚   â””â”€ TestResults/
  â”œâ”€ 2/    # slot 2 for another pipeline
  â”œâ”€ _temp/
  â””â”€ _tool/
```

âš¡ Important:

- The number (`1`, `2`, â€¦) is **not your run ID**. Itâ€™s a **stable slot** assigned by the agent.
- Multiple runs of the same pipeline on the same agent will keep reusing the same number.

---

## ğŸ“Œ **3. Numeric Slot**

- **Hosted agent (Microsoft provided):**  
  ğŸ‘‰ Every job gets a **brand-new machine**. When the job ends, the whole machine (with all folders) is deleted.  
  âœ… In this case â†’ you donâ€™t really need to worry about numeric slots. They exist only during that job, then vanish.

- **Self-hosted agent (your own machine):**  
  ğŸ‘‰ The agent lives permanently on your machine, and it needs a way to **separate different pipelines/projects** that run on it.  
  âœ… Here is where the **numeric slots** come in.

---

### ğŸ”¢ What Is a Numeric Slot?

Think of a **locker number at a gym** ğŸ‹ï¸.

- You install an agent on your machine.
- It creates a `_work` folder.
- Inside `_work`, it gives each pipeline/project a **locker number** (like `1`, `2`, `3`â€¦).
- That locker has subfolders:

  - `s` â†’ sources
  - `b` â†’ binaries
  - `a` â†’ artifacts
  - `TestResults` â†’ test output

Example:

```ini
/_work/
  â”œâ”€ 1/   # Locker #1 for Pipeline A
  â”‚   â”œâ”€ s/
  â”‚   â”œâ”€ b/
  â”‚   â””â”€ a/
  â”œâ”€ 2/   # Locker #2 for Pipeline B
  â”‚   â”œâ”€ s/
  â”‚   â”œâ”€ b/
  â”‚   â””â”€ a/
```

ğŸ‘‰ So, **numeric slot = â€œworkspace lockerâ€ for a pipeline**.

---

### ğŸš€ How Theyâ€™re Used

- If **Pipeline A** runs on your self-hosted agent, the agent assigns it locker `1`.
- If later **Pipeline B** also runs, the agent gives it locker `2`.
- Next time Pipeline A runs again â†’ it will reuse locker `1` (same spot).

ğŸ’¡ Thatâ€™s why things can **persist** between runs on self-hosted agents (like your `node_modules` or `.git` folder).

---

### âœ… Hosted vs Self-hosted in One Sentence

- **Hosted agent** â†’ fresh machine each time, no slots matter (theyâ€™re deleted).
- **Self-hosted agent** â†’ permanent machine, needs slots (`1`, `2`, `3`) to keep pipelines separate.

---

## ğŸ“Œ **4. Default Directories & Variables**

Azure injects **variables** that map to these folders. Use them instead of hardcoding.

| Variable                                                             | Meaning                       | Path Example                    |
| -------------------------------------------------------------------- | ----------------------------- | ------------------------------- |
| `$(Pipeline.Workspace)`                                              | Run root folder               | `/home/vsts/work/1`             |
| `$(Build.SourcesDirectory)` / `$(System.DefaultWorkingDirectory)`    | Repo checkout path            | `/home/vsts/work/1/s`           |
| `$(Build.BinariesDirectory)`                                         | Compiled output               | `/home/vsts/work/1/b`           |
| `$(Build.ArtifactStagingDirectory)` / `$(System.ArtifactsDirectory)` | Staging for artifacts         | `/home/vsts/work/1/a`           |
| `$(Common.TestResultsDirectory)`                                     | Test results                  | `/home/vsts/work/1/TestResults` |
| `$(Agent.TempDirectory)`                                             | Agent temp files              | `/home/vsts/work/_temp`         |
| `$(Agent.ToolsDirectory)`                                            | Installed tool cache          | `/home/vsts/work/_tool`         |

---

## ğŸ“Œ **5. Lifecycle Per Run**

Hereâ€™s what happens each run:

<div align="center">

```mermaid
flowchart TD
    A[Pipeline Job Starts] --> B[Agent Allocated]
    B --> C[Assign Slot e.g. /_work/1]
    C --> D[Checkout Code â†’ /s]
    D --> E[Run Tasks â†’ Default in /s]
    E --> F[Build Outputs â†’ /b]
    F --> G[Artifacts â†’ /a]
    G --> H[Test Results â†’ /TestResults]
    H --> I[Job Ends]
```

> Hosted agent â†’ **VM destroyed** and Everything gone.  
> Self-hosted agent â†’ **workspace persists** in `/work/<N>`.

</div>

---

## ğŸ“Œ **6. Cleanup & Reuse**

### ğŸ–¥ Hosted Agent

- One job â†’ fresh VM/container
- After run: **entire VM is discarded**
- No persistence, no reuse

### ğŸ  Self-hosted Agent

- Workspaces **stay** unless you clean them
- Options:

  - **Job-level cleanup**

    ```yaml
    jobs:
      - job: Build
        workspace:
          clean: all # outputs | resources | all
    ```

  - **Checkout cleanup**

    ```yaml
    - checkout: self
      clean: true
    ```

  - **Agent pool maintenance** (UI) â†’ scheduled cleanups of old sources, outputs, caches

---

## ğŸ“Œ **7. Multi-Client & Concurrency**

- A single agent = **1 job at a time**.
- If you want parallel jobs on the same machine â†’ install **multiple agents**, each in its own folder.
- Different projects/pipelines can use the same agent â†’ theyâ€™ll reuse different slots (`1`, `2`, â€¦) under `_work`.

âœ… Safety net: No two jobs share the same slot **at the same time**.

---

## ğŸ“Œ **8. Container Jobs** ğŸ³

- When you use `container:`, the agent **mounts its `_work`** into the container:

  - `/__w` â†’ `_work`
  - `/__t` â†’ `_temp`

- Inside the container:

  ```ini
  /__w/1/s
  /__w/1/b
  /__w/1/a
  ```

- Cleanup rules: same as host. Container goes away, but host folders persist on self-hosted.

---

## ğŸ“Œ **9.Practical Best Practices**

1. **Always use variables** â†’ portable between OS, hosted/self-hosted, containers.
2. **Clean strategically**:

   - For CI (fast) â†’ keep sources, clean outputs
   - For Release (safe) â†’ clean everything

3. **Enable pool maintenance** â†’ prevent disk explosions on self-hosted.
4. **Donâ€™t assume `/1`**. Use `$(Pipeline.Workspace)` â†’ future-proof.
5. **Multi-repo checkout** â†’ secondary repos live under `/s/<RepoName>` unless you override `path:`.

---

## ğŸ **TL;DR**

- Each pipeline run = **workspace slot (`/work/<N>`)**, not a unique run ID.
- **Hosted agent** â†’ full cleanup each run (disposable VM).
- **Self-hosted agent** â†’ reuses same slot â†’ you must manage cleanup.
- Use **variables** (not paths) and **maintenance policies** to stay sane.
