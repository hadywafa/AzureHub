# ğŸ” Azure DevOps Deployment Jobs â€“ Rollback, Environment Variables, and Approvals

This topic walks you through three powerful capabilities of Azure DevOps **deployment jobs**:

âœ… Configuring **automatic rollback** on failure
âœ… Creating and using **environment-scoped variables**
âœ… Setting up **approval gates** before deployment

---

## â¤ï¸â€ğŸ©¹ 1. Configure Rollback in Deployment Job

Deployment jobs support rollback using the `on.failure` trigger. This allows you to run custom steps if the deployment fails â€” rollback changes, delete resources, trigger alerts, etc.

---

### ğŸ“¦ YAML Example with Rollback

```yaml
jobs:
  - deployment: DeployWebApp
    displayName: "ğŸš€ Deploy to Production"
    environment: "prod-env"
    strategy:
      runOnce:
        deploy:
          steps:
            - script: |
                echo "âš™ï¸ Deploying app..."
                exit 1  # simulate failure
              displayName: "âŒ Simulate Failed Deployment"

          on:
            failure:
              steps:
                - script: |
                    echo "ğŸ” Rolling back deployment..."
                    # Add rollback logic (e.g., restart, restore config, redeploy)
                  displayName: "ğŸ§¯ Rollback"
```

---

### ğŸ§  How It Works

| Phase              | Trigger                                  |
| ------------------ | ---------------------------------------- |
| `deploy.steps`     | Normal deployment                        |
| `on.failure.steps` | Executes **only if** previous steps fail |

You can also use `on.success`, `on.always`, and `on.canceled` to handle different paths.

---

## ğŸŒ¿ 2. Define and Use Environment Variables

Azure DevOps environments can have **scoped variables**, including **secrets**, that deployment jobs can consume automatically.

---

### ğŸ§ª Use Case: Define secrets like `webAppName`, `resourceGroup`, etc.

#### ğŸ§± Define in UI

1. Go to **Pipelines â†’ Environments**
2. Click your environment (e.g., `prod-env`)
3. Select the **"Variables"** tab
4. Add variables like:

   - `webAppName = my-prod-web`
   - `resourceGroup = prod-rg`
   - Mark secret values as **ğŸ”’ secret**

---

### ğŸ§± Use in YAML

```yaml
jobs:
  - deployment: DeployWebApp
    displayName: "Use Env Vars"
    environment: "prod-env"
    strategy:
      runOnce:
        deploy:
          steps:
            - script: |
                echo "App Name: $(webAppName)"
                echo "Deploying to Resource Group: $(resourceGroup)"
              displayName: "Read Environment Variables"
```

> ğŸ¯ These variables are automatically injected when the job runs in that environment.

---

## ğŸ›‘ 3. Create and Use Approvals in Pipeline

Azure Pipelines allows manual **approvals** before deploying to critical environments like production.

---

### ğŸ§± Configure Approvals in UI

1. Go to **Pipelines â†’ Environments**
2. Select your environment (`prod-env`)
3. Click **"Approvals and checks"**
4. Add a check: **"Approvals"**

   - Assign required approvers (e.g., Team Lead, Security, etc.)
   - Optional: add timeout, instructions, notifications

---

### ğŸ“¦ YAML Deployment Job with Approval Support

No YAML changes needed â€” approvals work **automatically** based on the `environment:` field.

```yaml
jobs:
  - deployment: DeployApp
    displayName: "ğŸ›‘ Deploy with Approval Gate"
    environment: "prod-env" # Must match approved environment name
    strategy:
      runOnce:
        deploy:
          steps:
            - script: echo "ğŸš€ Deploying after approval..."
```

---

### ğŸ“¸ Approval Prompt in Portal

When the pipeline reaches this job:

> âœ… It **pauses** and notifies the approvers
> ğŸ”“ Once approved, the pipeline resumes
> âŒ If rejected or timeout, the pipeline fails

---

## ğŸ”„ Full Example Putting It All Together

```yaml
trigger:
  - main

jobs:
- deployment: DeployApp
  displayName: "ğŸš€ Safe Deploy with Rollback & Approval"
  environment: 'prod-env'
  strategy:
    runOnce:
      deploy:
        steps:
          - script: |
              echo "ğŸ”§ Starting deployment..."
              exit 1  # simulate failure
            displayName: "âŒ Simulate Deployment Failure"

        on:
          failure:
            steps:
              - script: |
                  echo "ğŸ§¯ Rollback logic executing"
                  # Restore config or stop webapp here
                displayName: "Rollback Step"

        on:
          success:
            steps:
              - script: |
                  echo "âœ… Deployment succeeded!"
                displayName: "Confirm Success"
```

---

## ğŸ§  Summary

| Feature               | Purpose                       | How                         |
| --------------------- | ----------------------------- | --------------------------- |
| `on.failure`          | Execute rollback logic        | Inside deployment strategy  |
| Environment Variables | Inject secrets or settings    | Set in Environment UI       |
| Approvals             | Pause before deployment       | Set in Environment â†’ Checks |
| `environment:`        | Link job to environment logic | Required for all above      |

---

## ğŸ“Œ Pro Tips

- ğŸ” Use environment variables for sensitive data (connection strings, names, tokens)
- ğŸ›‘ Always add approvals for `production` or `client-facing` environments
- ğŸ” Add rollback to cleanly exit if a partial deploy fails
- ğŸ’¡ Use output variables and shared artifacts between jobs for even better control
