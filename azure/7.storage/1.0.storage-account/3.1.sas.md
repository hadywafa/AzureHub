# üîê Azure Shared Access Signature (SAS) ‚Äî Your Temporary Digital Pass

**SAS** security feature that allows you to grant limited access to your resources without exposing your storage account keys. SAS tokens help you define specific permissions, constrain the allowed time window, and restrict access by IP range, making them ideal for secure data sharing in Azure.

---

## üéØ **The Purpose of SAS**

SAS defines:

1. **üéØ What you can access** ‚Äî Scope of the resource (container, blob, file share, queue, or table).
2. **üõ† What you can do** ‚Äî Read, Write, Delete, etc.
3. **‚è≥ For how long** ‚Äî Start and expiry date/time.
4. **üåç From where** ‚Äî Restrict by IP and protocol (HTTPS recommended).

**Why it matters:**
This means you can give someone just enough access for just enough time ‚Äî without giving them the master keys.

---

## üß© **Types of SAS & Their Scope**

| üö¶ SAS Type                | üì¶ Scope                                                                                     | üîë Signing Method                      | üí° Best For                                                  |
| -------------------------- | -------------------------------------------------------------------------------------------- | -------------------------------------- | ------------------------------------------------------------ |
| **1Ô∏è‚É£ Service SAS**         | One **service** only (Blob, File, Queue, or Table) and its resources (container, blob, etc.) | Account Key **or** User Delegation Key | Fine-grained, single-service access                          |
| **2Ô∏è‚É£ Account SAS**         | Multiple **services** in the same storage account                                            | Account Key                            | Cross-service automation                                     |
| **3Ô∏è‚É£ User Delegation SAS** | Blob service only, scoped to **Azure AD identity**                                           | User Delegation Key from Azure AD      | Identity-based, least-privilege, **no account key exposure** |

üìå **How they relate:**

- **Service SAS** ‚Üí Precise access, one service.
- **Account SAS** ‚Üí Multiple services, one signature.
- **User Delegation SAS** ‚Üí Service SAS powered by Azure AD identity.

---

üìå **Why UD SAS is often preferred:**

- **No account keys** in your app or pipeline ‚Üí huge blast-radius reduction.
- Honors **Azure AD RBAC** (who is allowed to request a UD key), **Conditional Access**, MFA, risk policies.
- **Short-lived by design** (you control lifetime). If a user/app loses access, they **cannot mint new** UD tokens.
- Fits **zero-trust** and least-privilege patterns (one-time, narrow permission, short TTL).

> Note: an already-issued SAS (any type) works until it **expires**. You can‚Äôt ‚Äúyank‚Äù a specific SAS early (`except` Service/Account SAS issued via `stored access policies`).  
> So: **keep expiry short**.

---

## üèó **SAS Building Blocks**

Every SAS token (no matter the type) contains these components:

1. **üìç Resource scope** ‚Äî Which container, blob, share, queue, or table.
2. **üîí Permissions** ‚Äî R (Read), W (Write), D (Delete), L (List), A (Add), U (Update), C (Create), P (Process).
3. **‚è≥ Validity window** ‚Äî Start + expiry time.
4. **üîê Protocol** ‚Äî HTTPS only (recommended) or HTTPS+HTTP.
5. **üåê IP restrictions** ‚Äî Optional range limits.
6. **üñä Signature** ‚Äî Cryptographic proof it‚Äôs valid.

---

## ‚úç **Signing Methods**

1. **üîë Account Key** ‚Äî Directly signs the SAS with a **storage account key** (simple, but leaks are dangerous).
2. **üë§ User Delegation Key** ‚Äî Issued by Azure AD for **Blob only**. Tied to identity and permissions.

---

### üí° Prereqs & roles (UD SAS)

To create UD SAS, the caller must be able to request a **User Delegation Key**. Give one of:

- **Storage Blob Data Owner** (broad)
- **Storage Blob Data Contributor** (broad)
- **Storage Blob Delegator** (narrow; purpose-built for generating UD keys)

You can assign these at **account**, **container**, or **RG/subscription** scope (least privilege!).

---

## üéÅ How UD SAS actually works

```mermaid
sequenceDiagram
    autonumber
    participant Client as Your App (AAD identity)
    participant Entra as Microsoft Entra ID
    participant BlobSvc as Blob Service
    participant Target as Target Blob/Container

    Client->>Entra: Get AAD token (MSAL / DefaultAzureCredential)
    Entra-->>Client: AAD access token
    Client->>BlobSvc: GetUserDelegationKey(start, expiry) (Bearer AAD token)
    BlobSvc-->>Client: User Delegation Key (time-bound)
    Client->>Client: Build Blob SAS (permissions, start/expiry, IP, https)
    Client->>Target: Use SAS (or hand to a caller)
    Target-->>Client: Access granted per SAS rules
```

- Your app never uses an account key.
- The **User Delegation Key** is time-scoped; you use it to sign the SAS.

---

## üîç **SAS Token Anatomy** ‚Äì Dissecting the Beast

When you generate a SAS, you actually get **two parts**:

```ini
https://<account>.blob.core.windows.net/<resource-path>?<SAS-token>
```

- **Base URL** ‚Üí Points to the actual Azure resource (container/blob/etc.).
- **Query String (SAS Token)** ‚Üí The ‚Äúmagic pass‚Äù with all the rules encoded.

---

## üß© **SAS Query Parameters**

Here‚Äôs what you might see in a **Service SAS** for Blob:

```ini
?sv=2023-11-03&ss=b&srt=o&sp=rwdl&st=2025-08-13T07:00Z&se=2025-08-13T09:00Z&sip=192.168.1.0-192.168.1.255&spr=https&sig=<signature>
```

| Param             | Meaning                           | Example Value                                           | Applies To          |
| ----------------- | --------------------------------- | ------------------------------------------------------- | ------------------- |
| **sv**            | Storage Service Version           | `2023-11-03`                                            | All SAS types       |
| **sp**            | Permissions                       | `r` (Read), `w` (Write), `d` (Delete), `l` (List), etc. | All SAS types       |
| **ss**            | Service(s) allowed                | `b` (Blob), `f` (File), `q` (Queue), `t` (Table)        | Account SAS         |
| **srt**           | Resource Types                    | `o` (Object), `c` (Container), `s` (Service)            | Account SAS         |
| **sr**            | Resource                          | `b` (Blob), `c` (Container)                             | Service SAS         |
| **st**            | Start Time                        | `2025-08-13T07:00Z`                                     | All SAS types       |
| **se**            | Expiry Time                       | `2025-08-13T09:00Z`                                     | All SAS types       |
| **sip**           | Allowed IP Range                  | `192.168.1.0-192.168.1.255`                             | Optional            |
| **spr**           | Protocol                          | `https` or `https,http`                                 | Optional            |
| **skoid**         | Object ID (Azure AD user)         | GUID                                                    | User Delegation SAS |
| **sktid**         | Tenant ID (Azure AD tenant)       | GUID                                                    | User Delegation SAS |
| **skt** / **ske** | Start & Expiry for delegation key | ISO timestamp                                           | User Delegation SAS |
| **sig**           | Signature                         | Long Base64 hash                                        | All SAS types       |

---

## üèó **Relationship Between SAS Type & Parameters**

| SAS Type            | Unique Params                  | Why?                                               |
| ------------------- | ------------------------------ | -------------------------------------------------- |
| **Service SAS**     | `sr` only                      | You‚Äôre targeting a single resource.                |
| **Account SAS**     | `ss`, `srt`                    | Grants multiple services/resource types in one go. |
| **User Delegation** | `skoid`, `sktid`, `skt`, `ske` | Ties token to Azure AD-issued delegation key.      |

---

## üìú **Stored Access Policies**

Instead of defining expiry and permissions in each SAS manually:

- Create a **policy** once at the container/share/table/queue level.
- Reference the **policy name** in SAS tokens.
- Update/revoke the policy ‚Üí **all linked SAS become updated instantly**.

---

<div align="center">
<img src="images/service-sas.png" alt="service-sas" style="border-radius:10px;width:60%; border: 2px solid white;">
</div>

---

> üí° **Pro Tip:** Great for revoking multiple SAS tokens at once without hunting them down.

---

## üìú **Stored Access Policy in URL**

When you use a **Stored Access Policy**, instead of `st` and `se` in the SAS, you may see:

```ini
?si=PolicyName
```

Where `si` = **Signed Identifier** (name of the policy).
The expiry and permissions are **looked up** in Azure instead of being embedded in the SAS.

---

## üîÑ **How SAS Gets Generated** (End-to-End)

```mermaid
sequenceDiagram
    participant Admin as Admin/Service
    participant Azure as Azure Storage
    participant Client as Client/App

    Admin->>Azure: Request SAS (specify type, scope, perms, expiry, IP, protocol)
    Azure-->>Admin: Returns SAS token with signature
    Admin->>Client: Send full URL (Base + Token)
    Client->>Azure: Makes request with SAS URL
    Azure-->>Client: Grants access if SAS valid
```

---

## ‚úçüèª **Example** ‚Äì Breaking Down a SAS

**URL**:

```ini
https://myaccount.blob.core.windows.net/mycontainer/myfile.txt?sv=2023-11-03&sr=b&sp=rw&st=2025-08-13T07:00Z&se=2025-08-13T09:00Z&spr=https&sig=abcdef123456...
```

- `sv=2023-11-03` ‚Üí API version.
- `sr=b` ‚Üí Resource = Blob.
- `sp=rw` ‚Üí Read + Write permissions.
- `st` / `se` ‚Üí 2-hour validity window.
- `spr=https` ‚Üí HTTPS only.
- `sig=...` ‚Üí Signed with account key or user delegation key.

---

## üéØ When to Use Shared Access Signatures (SAS)

SAS is your way to give **temporary, limited access** to Azure Storage **without exposing account keys**.
Two main design patterns exist depending on your needs:

### 1Ô∏è‚É£ **Frontend Proxy Service**

- **How it works**:
  Clients talk to **your service first** ‚Üí the proxy uploads/downloads data from Storage.

- **Pros**:

  - ‚úÖ Can enforce **business rules** (e.g., file type checks, quotas).
  - ‚úÖ Centralized logging & validation.

- **Cons**:

  - ‚ùå Becomes a **bottleneck** under heavy load.
  - ‚ùå Expensive to scale (all traffic goes through the proxy).

- **Best for**:
  üõí Medium-volume apps where **strict validations** are more important than raw performance.

<div align="center">
  <img src="image/3.1.sas/1758125036086.png" alt="SAS Token Flow" style="border-radius: 10px; border: 2px solid; width: 100%;margin: 0 30px">
</div>

---

### 2Ô∏è‚É£ **Lightweight Auth Service + SAS Tokens**

- **How it works**:
  A small service authenticates users ‚Üí issues a **SAS token** ‚Üí client talks **directly** to Storage with it.

- **Pros**:

  - ‚úÖ **High scalability** (no proxy bottleneck).
  - ‚úÖ **Efficient** (server doesn‚Äôt handle file streams).
  - ‚úÖ Perfect for large/unpredictable data (e.g., video uploads).

- **Cons**:

  - ‚ùå Less control over **inline business validations** (since clients bypass proxy).

- **Best for**:
  üìπ Apps with **large file transfers** or **high upload rates** where performance & scalability matter.

<div align="center">
  <img src="image/3.1.sas/1758125062144.png" alt="SAS Token Flow" style="border-radius: 10px; border: 2px solid; width: 100%;margin: 0 30px">
</div>
## üìö **Example Scenarios**

1. **üé• Temporary Media Upload Portal**

   - **Type:** Service SAS (Blob)
   - **Permission:** Write only
   - **Expiry:** 1 hour
   - **Use:** Client uploads directly, server never sees your keys.

2. **üì¶ Multi-Service Data Pipeline**

   - **Type:** Account SAS
   - **Permission:** Read + List
   - **Expiry:** 24 hours
   - **Use:** ETL job fetches from Blob & Queue in one go.

3. **üîê Employee Access to Private Files**

   - **Type:** User Delegation SAS
   - **Permission:** Read
   - **Expiry:** Until end of shift
   - **Use:** Scoped to employee‚Äôs Azure AD identity.

---
