# 🧪 **Lab Guide: Azure Network Watcher**

## 🎯 **Lab Objectives**

By the end of this lab, you will:

1. Enable **Azure Network Watcher** in your region.
2. Use **Monitoring tools** (Topology, Connection Monitor).
3. Perform **Diagnostics** (IP Flow Verify, Effective Rules, Next Hop, Packet Capture, Connection Troubleshooting).
4. Collect and analyze **Logs** (NSG Flow Logs + Traffic Analytics).

---

## 🔹 **Step 1: Enable Network Watcher**

### 📌 Portal

1. In Azure Portal → Search **Network Watcher**.
2. Click **Enable** for your subscription/region (if not already enabled).

### 📌 CLI

```bash
# Enable Network Watcher in East US
az network watcher configure --locations eastus --enabled true --resource-group NetworkWatcherRG
```

✅ Now the service is ready.

---

## 👁️ **Lab Part 1: Monitoring Features**

### 🌐 1.1 Topology

**Scenario:** You want to see how your VMs, NICs, NSGs, and subnets are connected.

📌 Portal Steps:

1. Go to **Network Watcher → Topology**.
2. Select your **Resource Group + VNet**.
3. Watch Azure build a live diagram 🗺️.

✅ You’ll see which VM → NIC → Subnet → NSG chain exists.

---

### 🔄 1.2 Connection Monitor

**Scenario:** Check connectivity from a Web VM → SQL Database.

📌 Portal Steps:

1. Go to **Network Watcher → Connection Monitor**.
2. Click **+ Add**.
3. **Source:** WebVM NIC, **Destination:** SQL Database (1433).
4. Start Monitoring.

📌 CLI:

```bash
az network watcher connection-monitor create \
  --name WebToSQLMonitor \
  --resource-group NetworkWatcherRG \
  --location eastus \
  --source-resource WebVM \
  --dest-address sqlserver123.database.windows.net \
  --dest-port 1433
```

✅ Connection Monitor will show latency, packet loss, reachability.

---

## 🔍 **Lab Part 2: Diagnostic Features**

### 🚦 2.1 IP Flow Verify

**Scenario:** VM can’t reach SQL DB. Is NSG blocking it?

📌 Portal:

1. Go to **Network Watcher → IP Flow Verify**.
2. Select VM NIC, Direction = Outbound, Destination = SQL DB, Port = 1433.
3. Click **Check**.

📌 CLI:

```bash
az network watcher test-ip-flow \
  --resource-group MyRG \
  --vm-name WebVM \
  --direction Outbound \
  --protocol TCP \
  --local 10.0.1.5:50000 \
  --remote 52.167.220.45:1433
```

✅ Result will say `ALLOW` or `DENY` with the exact NSG rule.

---

### 🔐 2.2 Effective Security Rules

**Scenario:** Your NSGs are complicated, which rule actually applies?

📌 Portal:

1. Go to **Network Watcher → Effective Security Rules**.
2. Select VM NIC.
3. Azure shows the **merged NSG rules**.

✅ Helps you find conflicts like `DenyAll` shadowing `AllowHTTP`.

---

### 🛣️ 2.3 Next Hop

**Scenario:** VM traffic goes to the wrong place.

📌 Portal:

1. Go to **Network Watcher → Next Hop**.
2. Enter Source = VM NIC, Destination = 8.8.8.8.
3. See Next Hop (Internet / NVA / Blackhole).

📌 CLI:

```bash
az network watcher show-next-hop \
  --resource-group MyRG \
  --vm-name WebVM \
  --source-ip 10.0.1.5 \
  --dest-ip 8.8.8.8
```

✅ Reveals if UDR is misrouting traffic.

---

### 📦 2.4 Packet Capture

**Scenario:** You suspect slow TLS negotiation.

📌 Portal:

1. Go to **Network Watcher → Packet Capture**.
2. Select VM → NIC.
3. Choose filters (port 443 only).
4. Start Capture → Download `.cap` → Analyze in Wireshark.

📌 CLI:

```bash
az network watcher packet-capture create \
  --name TLSCapture \
  --resource-group MyRG \
  --vm WebVM \
  --storage-account mystorageacct \
  --time-limit 300
```

✅ Gives raw packet-level details.

---

### 🔍 2.5 Connection Troubleshooting

**Scenario:** App VM can’t reach Internet.

📌 Portal:

1. Go to **Network Watcher → Connection Troubleshoot**.
2. Source = WebVM, Destination = [www.microsoft.com:443](http://www.microsoft.com:443).
3. Run test.

📌 CLI:

```bash
az network watcher test-connectivity \
  --source-resource WebVM \
  --dest-address www.microsoft.com \
  --dest-port 443
```

✅ Returns details: Success/Fail + where it failed (NSG, Route, DNS).

---

### 🔒 2.6 VPN Troubleshooting

**Scenario:** Site-to-site VPN tunnel is down.

📌 Portal:

1. Go to **Network Watcher → VPN Troubleshoot**.
2. Select VPN Gateway.
3. Run diagnostics.

✅ Finds root cause: bad shared key, unreachable peer, etc.

---

## 📜 **Lab Part 3: Logging Features**

### 📊 3.1 NSG Flow Logs

**Scenario:** You want to see _who_ has been trying to access your VMs.

📌 Portal:

1. Go to **Network Watcher → NSG Flow Logs**.
2. Select your NSG → Enable.
3. Choose **Storage Account / Log Analytics / Event Hub** as destination.

📌 CLI:

```bash
az network watcher flow-log configure \
  --resource-group MyRG \
  --nsg WebVM-NSG \
  --enabled true \
  --storage-account mystorageacct \
  --retention 7
```

✅ Flow logs show Allowed/Deny flows with timestamps.

---

### 📈 3.2 Traffic Analytics

**Scenario:** Who’s hogging all the bandwidth?

📌 Portal:

1. Go to **Network Watcher → Traffic Analytics**.
2. Link it to your **NSG Flow Logs + Log Analytics Workspace**.
3. Open dashboard.

✅ See top talkers, inbound/outbound trends, malicious IPs.
