# üß© App Settings (what you‚Äôll need)

Here are **real, runnable examples** showing **both** ways to connect from Azure Functions:

- **A. Connection String (secret-based)**
- **B. Managed Identity (passwordless, RBAC)**

This Example will use **Azure Blob Storage** (common + easy to test) in **C# (.NET 8 isolated)** and **Python**. You can swap Blob for Cosmos/Service Bus with the same patterns.

## In Azure (portal ‚Üí Function App ‚Üí Environment variables)

Set the **same keys** under ‚ÄúApplication settings‚Äù:

- `Blob__ConnectionString` (for secret-based)
- `Blob__AccountUrl` (for MI-based; e.g., `https://mystorage.blob.core.windows.net`)

> Tip: If you must keep secrets, use **Key Vault references** instead of raw secrets.

---

## Local (not deployed)

`local.settings.json`

```json
{
  "IsEncrypted": false,
  "Values": {
    "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",

    // -- A) Secret-based (connection string) --
    "Blob__ConnectionString": "DefaultEndpointsProtocol=...;AccountName=...;AccountKey=...;EndpointSuffix=core.windows.net",

    // -- B) Managed Identity (no secret) --
    "Blob__AccountUrl": "https://<youraccount>.blob.core.windows.net"
  }
}
```

## üü¶ C# (.NET 8 isolated) ‚Äî HTTP trigger ‚Üí write/read a blob

### A) Using Connection String (secret-based)

`Functions/BlobDemo.cs`

```csharp
using System.Net;
using System.Text;
using Azure.Storage.Blobs;
using Microsoft.Azure.Functions.Worker;
using Microsoft.Azure.Functions.Worker.Http;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;

namespace Demo.Functions;

public class BlobDemo_ConnStr
{
    private readonly ILogger<BlobDemo_ConnStr> _log;
    private readonly IConfiguration _cfg;

    public BlobDemo_ConnStr(ILogger<BlobDemo_ConnStr> log, IConfiguration cfg)
    {
        _log = log;
        _cfg = cfg;
    }

    [Function("BlobDemo-ConnStr")]
    public async Task<HttpResponseData> Run(
        [HttpTrigger(AuthorizationLevel.Function, "post", "get", Route = "blob/conn")] HttpRequestData req)
    {
        var res = req.CreateResponse(HttpStatusCode.OK);

        // 1) Get connection string from App Settings / local.settings.json
        string conn = _cfg["Blob__ConnectionString"];
        var service = new BlobServiceClient(conn);

        // 2) Target container + blob
        var container = service.GetBlobContainerClient("demo");
        await container.CreateIfNotExistsAsync();
        var blob = container.GetBlobClient("hello.txt");

        if (req.Method == "POST")
        {
            await blob.UploadAsync(new BinaryData("Hello from connection string!"), overwrite: true);
            await res.WriteStringAsync("Uploaded via connection string.");
            return res;
        }
        else
        {
            if (await blob.ExistsAsync())
            {
                var content = (await blob.DownloadContentAsync()).Value.Content.ToString();
                await res.WriteStringAsync($"Read via connection string: {content}");
            }
            else
            {
                res.StatusCode = HttpStatusCode.NotFound;
                await res.WriteStringAsync("Blob not found.");
            }
            return res;
        }
    }
}
```

### B) Using Managed Identity (no secrets, RBAC)

`Functions/BlobDemo.cs` (second function in same file or separate)

```csharp
using System.Net;
using System.Text;
using Azure.Identity;
using Azure.Storage.Blobs;
using Microsoft.Azure.Functions.Worker;
using Microsoft.Azure.Functions.Worker.Http;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;

namespace Demo.Functions;

public class BlobDemo_MI
{
    private readonly ILogger<BlobDemo_MI> _log;
    private readonly IConfiguration _cfg;

    public BlobDemo_MI(ILogger<BlobDemo_MI> log, IConfiguration cfg)
    {
        _log = log;
        _cfg = cfg;
    }

    [Function("BlobDemo-MI")]
    public async Task<HttpResponseData> Run(
        [HttpTrigger(AuthorizationLevel.Function, "post", "get", Route = "blob/mi")] HttpRequestData req)
    {
        var res = req.CreateResponse(HttpStatusCode.OK);

        // 1) Account URL from settings; auth with Managed Identity
        string accountUrl = _cfg["Blob__AccountUrl"]; // e.g., https://mystorage.blob.core.windows.net
        var credential = new DefaultAzureCredential(); // uses MI in Azure; dev uses VS/CLI identity
        var service = new BlobServiceClient(new Uri(accountUrl), credential);

        // 2) Target container + blob
        var container = service.GetBlobContainerClient("demo");
        await container.CreateIfNotExistsAsync();
        var blob = container.GetBlobClient("hello.txt");

        if (req.Method == "POST")
        {
            await blob.UploadAsync(new BinaryData("Hello from managed identity!"), overwrite: true);
            await res.WriteStringAsync("Uploaded via Managed Identity.");
            return res;
        }
        else
        {
            if (await blob.ExistsAsync())
            {
                var content = (await blob.DownloadContentAsync()).Value.Content.ToString();
                await res.WriteStringAsync($"Read via Managed Identity: {content}");
            }
            else
            {
                res.StatusCode = HttpStatusCode.NotFound;
                await res.WriteStringAsync("Blob not found.");
            }
            return res;
        }
    }
}
```

---

## üü£ Python (v1 JSON model) ‚Äî HTTP trigger ‚Üí write/read a blob

`HttpToBlob/__init__.py`

```python
import logging
import os
import azure.functions as func
from azure.storage.blob import BlobServiceClient
from azure.identity import DefaultAzureCredential

def main(req: func.HttpRequest) -> func.HttpResponse:
    mode = (req.params.get("mode") or "conn").lower()  # conn | mi
    logging.info("Python HTTP trigger: mode=%s", mode)

    container_name = "demo"
    blob_name = "hello.txt"

    if mode == "mi":
        # B) Managed Identity
        account_url = os.environ.get("Blob__AccountUrl")  # e.g., https://mystorage.blob.core.windows.net
        credential = DefaultAzureCredential()
        svc = BlobServiceClient(account_url=account_url, credential=credential)
    else:
        # A) Connection string (default)
        conn = os.environ.get("Blob__ConnectionString")
        svc = BlobServiceClient.from_connection_string(conn)

    container = svc.get_container_client(container_name)
    try:
        container.create_container()
    except Exception:
        pass

    method = req.method.upper()
    blob = container.get_blob_client(blob_name)

    if method == "POST":
        payload = "Hello from " + ("Managed Identity" if mode == "mi" else "Connection String")
        blob.upload_blob(payload, overwrite=True)
        return func.HttpResponse(f"Uploaded via {mode.upper()}.", status_code=200)
    else:
        if blob.exists():
            data = blob.download_blob().readall().decode("utf-8")
            return func.HttpResponse(f"Read via {mode.upper()}: {data}", status_code=200)
        else:
            return func.HttpResponse("Blob not found.", status_code=404)
```

`HttpToBlob/function.json`

```json
{
  "bindings": [
    {
      "type": "httpTrigger",
      "authLevel": "function",
      "direction": "in",
      "methods": ["get", "post"],
      "name": "req",
      "route": "blob"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "$return"
    }
  ]
}
```

> Test locally:
>
> - Connection string:
>   `curl -X POST "http://localhost:7071/api/blob?mode=conn"`
>
> - Managed Identity (locally uses your dev identity via `DefaultAzureCredential`):
>   `curl -X POST "http://localhost:7071/api/blob?mode=mi"`

---

## üîê Enable Managed Identity + Grant RBAC

### 1) Turn on System-assigned Managed Identity

```bash
az functionapp identity assign -g <RG> -n <FUNC_APP_NAME>
```

Grab the principal/object ID if you need it:

```bash
az functionapp identity show -g <RG> -n <FUNC_APP_NAME> -o tsv --query principalId
```

### 2) Grant least-privilege role on Storage

- For **read/write blobs** use **Storage Blob Data Contributor**.

```bash
# On the storage account scope (recommended)
STG_ID=$(az storage account show -g <RG> -n <STORAGE_NAME> --query id -o tsv)
PRINCIPAL_ID=$(az functionapp identity show -g <RG> -n <FUNC_APP_NAME> --query principalId -o tsv)

az role assignment create \
  --assignee-object-id $PRINCIPAL_ID \
  --assignee-principal-type ServicePrincipal \
  --role "Storage Blob Data Contributor" \
  --scope $STG_ID
```

> For **read-only**, use **Storage Blob Data Reader** instead.

---

## üß™ Quick Smoke Tests (after deploy)

- **C# (Function name `BlobDemo-ConnStr`)**
  `POST https://<app>.azurewebsites.net/api/blob/conn?code=<function_key>`

- **C# (Function name `BlobDemo-MI`)**
  `POST https://<app>.azurewebsites.net/api/blob/mi?code=<function_key>`

- **Python**
  `POST https://<app>.azurewebsites.net/api/blob?mode=mi&code=<function_key>`
  or
  `POST https://<app>.azurewebsites.net/api/blob?mode=conn&code=<function_key>`

---

## ‚úÖ When to use which

- **Managed Identity** ‚Üí default choice (no secrets, RBAC, rotation-free).
- **Connection strings** ‚Üí use only if the binding/service **does not support MI** or you need special options; store in **Key Vault** + reference in App Settings.
