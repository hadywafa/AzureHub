# ‚öôÔ∏è Azure API Management Policies ‚Äì **With Examples**

I‚Äôll take a **sample backend API** (say `https://httpbin.org` which just echoes requests), wrap it with APIM, then apply **one policy per example** and show:

1. **Client request** (what you send to APIM).
2. **Policy config** (the XML rule).
3. **Response** (what client receives).

---

## 1Ô∏è‚É£ Security ‚Äì Subscription Key Enforcement

**Policy**:

```xml
<check-header name="Ocp-Apim-Subscription-Key"
              failed-check-httpcode="401"
              failed-check-error-message="Missing subscription key" />
```

**Request** (without key):

```bash
curl -X GET "https://myapi.azure-api.net/echo"
```

**Response**:

```json
{
  "statusCode": 401,
  "message": "Missing subscription key"
}
```

**Request** (with key):

```bash
curl -H "Ocp-Apim-Subscription-Key: 1234567890" \
     "https://myapi.azure-api.net/echo"
```

‚úÖ Response passes through.

---

## 2Ô∏è‚É£ Security ‚Äì JWT Validation

**Policy**:

```xml
<validate-jwt header-name="Authorization" require-scheme="Bearer">
  <openid-config url="https://login.microsoftonline.com/<tenant>/v2.0/.well-known/openid-configuration" />
  <required-claims>
    <claim name="aud"><value>api://my-api-app-id</value></claim>
  </required-claims>
</validate-jwt>
```

**Request** (no token):

```bash
curl "https://myapi.azure-api.net/echo"
```

**Response**:

```json
{
  "statusCode": 401,
  "message": "Authorization header missing or invalid"
}
```

**Request** (with valid token):

```bash
curl -H "Authorization: Bearer eyJhbGciOi..." \
     "https://myapi.azure-api.net/echo"
```

‚úÖ Response goes to backend.

---

## 3Ô∏è‚É£ Traffic ‚Äì Rate Limit

**Policy**:

```xml
<rate-limit calls="2" renewal-period="30" />
```

**Requests**:

```bash
curl "https://myapi.azure-api.net/echo" # 1st ‚úÖ
curl "https://myapi.azure-api.net/echo" # 2nd ‚úÖ
curl "https://myapi.azure-api.net/echo" # 3rd ‚ùå
```

**3rd Response**:

```json
{
  "statusCode": 429,
  "message": "Rate limit exceeded. Try again in 30 seconds."
}
```

---

## 4Ô∏è‚É£ Traffic ‚Äì Quota

**Policy**:

```xml
<quota calls="5" renewal-period="86400" /> <!-- daily -->
```

After **6th call in 24h** ‚Üí

**Response**:

```json
{
  "statusCode": 403,
  "message": "Quota exceeded"
}
```

---

## 5Ô∏è‚É£ Transformation ‚Äì Rewrite URL

Backend = `https://httpbin.org/get`

**Policy**:

```xml
<rewrite-uri template="/get?version=2" />
```

**Request**:

```bash
curl "https://myapi.azure-api.net/echo"
```

**APIM forwards to backend**:
`https://httpbin.org/get?version=2`

**Response**:

```json
{
  "args": { "version": "2" }
}
```

---

## 6Ô∏è‚É£ Transformation ‚Äì Add Header

**Policy**:

```xml
<set-header name="x-api-version" exists-action="override">
  <value>2.0</value>
</set-header>
```

**Request**:

```bash
curl "https://myapi.azure-api.net/echo"
```

**Backend sees headers**:

```json
{
  "headers": {
    "x-api-version": "2.0",
    ...
  }
}
```

---

## 7Ô∏è‚É£ Transformation ‚Äì XML ‚Üí JSON

Backend returns XML.

**Policy**:

```xml
<xml-to-json apply="always" />
```

**Request**:

```bash
curl "https://myapi.azure-api.net/xml"
```

**Backend raw response**:

```xml
<note><to>Tony</to><from>Steve</from></note>
```

**APIM transformed response**:

```json
{ "note": { "to": "Tony", "from": "Steve" } }
```

---

## 8Ô∏è‚É£ Integration ‚Äì Call Another API

**Policy**:

```xml
<send-request mode="new" response-variable-name="extra">
  <set-url>https://httpbin.org/ip</set-url>
  <set-method>GET</set-method>
</send-request>

<set-body>@{
  return new JObject{
    {"original", context.Response.Body.As<JObject>()},
    {"extra", context.Variables["extra"].Body.As<JObject>()}
  }.ToString();
}</set-body>
```

**Response**:

```json
{
  "original": { "url": "https://httpbin.org/get" },
  "extra": { "origin": "52.168.x.x" }
}
```

---

## 9Ô∏è‚É£ Error Handling ‚Äì Custom Response

**Policy**:

```xml
<on-error>
  <return-response>
    <set-status code="503" reason="Service Down" />
    <set-body>{"error": "Backend unavailable, try later"}</set-body>
  </return-response>
</on-error>
```

**When backend crashes** ‚Üí

**Response**:

```json
{
  "error": "Backend unavailable, try later"
}
```

---

## üßæ Summary

- **Security** ‚Üí keys, JWT, IP rules.
- **Traffic** ‚Üí rate limit, quota, caching.
- **Transformation** ‚Üí rewrite URL, headers, body, XML‚ÜíJSON.
- **Integration** ‚Üí call other APIs, Key Vault injection.
- **Error handling** ‚Üí graceful responses.
