# üîê Securing APIs Using Certificates in Azure API Management

## 1Ô∏è‚É£ Concept: What is mTLS?

Normally, TLS (HTTPS) ensures:

- ‚úÖ Server identity is verified (the API gateway proves who it is).
- ‚ùå Client identity is not verified (anyone can hit your API if they know the endpoint).

**mTLS (Mutual TLS)** fixes this:

- Both **server** and **client** present certificates.
- The client must present a **valid client certificate** trusted by APIM.
- Strong cryptographic identity ‚Üí can‚Äôt be brute-forced like API keys.

---

## 2Ô∏è‚É£ Where Certificates are Used in APIM

There are **two levels** where certificates come into play:

1. **Inbound to APIM (Client ‚Üí APIM)**

   - Client must present a cert when calling APIM gateway.
   - APIM validates against a configured CA root or uploaded cert.

2. **Outbound from APIM to Backend (APIM ‚Üí API backend)**

   - APIM itself presents a cert to authenticate with backend service (e.g., App Service requiring client certs).

---

## 3Ô∏è‚É£ Hands-On: Client Certificate Authentication in APIM

### Step 1: Generate a Client Certificate

Use PowerShell or OpenSSL to create one:

```bash
# Generate private key
openssl genrsa -out client.key 2048

# Generate CSR (Certificate Signing Request)
openssl req -new -key client.key -out client.csr -subj "/CN=apim-client"

# Self-sign cert for testing
openssl x509 -req -days 365 -in client.csr -signkey client.key -out client.crt

# Convert to PFX (for Azure Portal upload)
openssl pkcs12 -export -out client.pfx -inkey client.key -in client.crt
```

---

### Step 2: Upload Client Certificate to APIM

1. Go to your **APIM instance** ‚Üí **Certificates** ‚Üí **+ Add**.
2. Upload `client.pfx` and set a name (e.g., `client-auth-cert`).
3. Save it.

---

### Step 3: Configure API to Require Client Certificate

In the **API inbound policy**:

```xml
<policies>
  <inbound>
    <check-header name="X-Client-Cert" failed-check-httpcode="401" failed-check-error-message="Client cert required." />
    <validate-client-certificate>
      <thumbprints>
        <thumbprint>‚Äé2B9F5C4D23A5...F91A5</thumbprint>
      </thumbprints>
    </validate-client-certificate>
    <base />
  </inbound>
  <backend>
    <base />
  </backend>
  <outbound>
    <base />
  </outbound>
</policies>
```

- `validate-client-certificate` ensures only specific certs are allowed.
- You can also validate cert **issuer** or **subject**.

---

### Step 4: Call API with Certificate

Using **curl**:

```bash
curl -v https://<apim-name>.azure-api.net/myapi/endpoint \
  --cert client.crt \
  --key client.key
```

If cert matches APIM validation ‚Üí ‚úÖ success.
If cert missing/invalid ‚Üí ‚ùå `401 Unauthorized`.

---

## 4Ô∏è‚É£ Outbound Client Certificates (APIM ‚Üí Backend)

If your **backend API requires a cert**, configure APIM to present one:

1. Upload the outbound certificate in APIM (Certificates blade).
2. In **API ‚Üí Settings ‚Üí Backend**, select the certificate to present.
3. APIM will send it during TLS handshake with backend.

---

## 5Ô∏è‚É£ Use Cases

| Use Case                 | Why Certs?                                                               |
| ------------------------ | ------------------------------------------------------------------------ |
| **B2B APIs**             | High-trust environments where partners must authenticate strongly.       |
| **Banking / Healthcare** | Compliance (e.g., PSD2, HIPAA) often mandates mTLS.                      |
| **Internal APIs**        | Private APIs inside VNets requiring strict trust, beyond keys or tokens. |
| **Machine-to-Machine**   | No human login; certs provide non-repudiation.                           |

---

## 6Ô∏è‚É£ Pros & Cons

‚úÖ **Pros**

- Strongest authentication (cryptographic).
- No passwords/secrets to rotate frequently.
- Resistant to replay or brute-force attacks.

‚ö†Ô∏è **Cons**

- Certificate lifecycle management (expiration, renewal).
- Distribution complexity (clients must securely store certs).
- Harder for broad developer onboarding (compared to keys).

---

## 7Ô∏è‚É£ Comparison with Other Security Methods

| Method                        | Identity Tied?         | Rotation | Best For           |
| ----------------------------- | ---------------------- | -------- | ------------------ |
| **Subscription Key**          | ‚ùå No                  | Easy     | Quotas & metering  |
| **OAuth 2.0 / JWT**           | ‚úÖ Yes                 | Medium   | User/partner APIs  |
| **Client Certificate (mTLS)** | ‚úÖ Yes (cryptographic) | Harder   | High-security APIs |

---

‚úÖ **Summary**

- Use **subscription keys** for billing & quotas.
- Use **OAuth 2.0** for user identity & access control.
- Use **Certificates (mTLS)** when you need **strong machine identity** and **compliance-grade security**.

---

üëâ Do you want me to prepare a **full end-to-end lab** (generate certs, upload to APIM, enforce policy, test with curl/Postman, plus outbound to backend) so you can actually try certificate-based API security hands-on?
