# üí∞ Monetizing APIs with Azure API Management ‚Äî Hands-On

## üß± What you‚Äôll build

- **Products**: `Free` (low quota) and `Premium` (high quota)
- **Subscriptions**: auto-approved keys for developers
- **Policies**: `rate-limit-by-key` and `quota-by-key`
- **Developer Portal**: self-service signup & key retrieval
- **Usage Analytics**: APIM ‚Üí Log Analytics + KQL
- **(Optional) CI/CD**: GitHub Action to onboard paid users on ‚Äúpayment success‚Äù (mock)

---

## 0) Prereqs

```bash
# Login
az login

# Variables
RG=rg-apim-monetize
LOC=eastus
APIM_NAME=apim-monetize-$RANDOM   # must be unique
BACKEND=https://httpbin.org       # demo backend
```

Create resource group + APIM (Developer tier):

```bash
az group create -n $RG -l $LOC

az apim create -g $RG -n $APIM_NAME \
  --publisher-name "Contoso" --publisher-email "owner@contoso.com" \
  --sku-name Developer
```

> Provisioning APIM can take a while. You can continue once it‚Äôs ‚ÄúSucceeded‚Äù.

---

## 1) Create a sample API (echo)

Create a basic HTTP API that forwards to `httpbin.org`:

```bash
API_ID=echo
API_PATH=echo

az apim api create \
  -g $RG --service-name $APIM_NAME \
  --api-id $API_ID \
  --path $API_PATH \
  --display-name "Echo API" \
  --service-url $BACKEND \
  --protocols https
```

Add a GET operation `/get`:

```bash
az apim api operation create \
  -g $RG --service-name $APIM_NAME \
  --api-id $API_ID --operation-id get \
  --display-name "GET" --method GET --url-template "/get"
```

---

## 2) Create Products: Free & Premium

### Free product (auto-approve, published)

```bash
az apim product create \
  -g $RG --service-name $APIM_NAME \
  --product-id free \
  --display-name "Free" \
  --approval-required false \
  --subscriptions-limit 1 \
  --state published
```

### Premium product (requires approval? choose false to auto-issue)

```bash
az apim product create \
  -g $RG --service-name $APIM_NAME \
  --product-id premium \
  --display-name "Premium" \
  --approval-required false \
  --subscriptions-limit 5 \
  --state published
```

Attach the API to both products:

```bash
az apim product api add -g $RG --service-name $APIM_NAME --product-id free --api-id $API_ID
az apim product api add -g $RG --service-name $APIM_NAME --product-id premium --api-id $API_ID
```

---

## 3) Enforce Quotas & Rate Limits (Policies)

### Free (small quota, conservative rate)

Policy (inbound) for **Free** product:

```xml
<policies>
  <inbound>
    <base />
    <!-- 60 calls/day per subscription -->
    <quota-by-key calls="60" renewal-period="86400" counter-key="@(context.Subscription.Key)" />
    <!-- 2 requests/sec burst control -->
    <rate-limit-by-key calls="2" renewal-period="1" counter-key="@(context.Subscription.Key)" />
  </inbound>
  <backend><base /></backend>
  <outbound><base /></outbound>
  <on-error><base /></on-error>
</policies>
```

Apply it:

```bash
cat > free-policy.xml <<'XML'
<policies>
  <inbound>
    <base />
    <quota-by-key calls="60" renewal-period="86400" counter-key="@(context.Subscription.Key)" />
    <rate-limit-by-key calls="2" renewal-period="1" counter-key="@(context.Subscription.Key)" />
  </inbound>
  <backend><base /></backend>
  <outbound><base /></outbound>
  <on-error><base /></on-error>
</policies>
XML

az apim product policy update \
  -g $RG --service-name $APIM_NAME --product-id free \
  --policy-file free-policy.xml
```

### Premium (large quota, generous rate)

```bash
cat > premium-policy.xml <<'XML'
<policies>
  <inbound>
    <base />
    <quota-by-key calls="100000" renewal-period="2592000" counter-key="@(context.Subscription.Key)" />
    <rate-limit-by-key calls="50" renewal-period="1" counter-key="@(context.Subscription.Key)" />
  </inbound>
  <backend><base /></backend>
  <outbound><base /></outbound>
  <on-error><base /></on-error>
</policies>
XML

az apim product policy update \
  -g $RG --service-name $APIM_NAME --product-id premium \
  --policy-file premium-policy.xml
```

---

## 4) Create Subscriptions (issue keys)

Create two subscriptions (one for each product):

```bash
SUB_FREE=sub-free-dev1
SUB_PREM=sub-prem-dev1

az apim subscription create \
  -g $RG --service-name $APIM_NAME \
  --name "$SUB_FREE" \
  --display-name "Dev1 Free" \
  --scope "/products/free"

az apim subscription create \
  -g $RG --service-name $APIM_NAME \
  --name "$SUB_PREM" \
  --display-name "Dev1 Premium" \
  --scope "/products/premium"
```

Fetch keys:

```bash
KEY_FREE=$(az apim subscription show -g $RG --service-name $APIM_NAME --sid "$SUB_FREE" --query primaryKey -o tsv)
KEY_PREM=$(az apim subscription show -g $RG --service-name $APIM_NAME --sid "$SUB_PREM" --query primaryKey -o tsv)

APIM_GATEWAY=$(az apim show -g $RG -n $APIM_NAME --query gatewayUrl -o tsv)
echo "Gateway: $APIM_GATEWAY"
```

---

## 5) Test calls (and see policies kick in)

**Success (Free):**

```bash
curl -s -H "Ocp-Apim-Subscription-Key: $KEY_FREE" "$APIM_GATEWAY/echo/get" | jq '.headers.Host'
```

**Hit the rate limit (Free):**

```bash
for i in {1..3}; do
  curl -i -H "Ocp-Apim-Subscription-Key: $KEY_FREE" "$APIM_GATEWAY/echo/get" >/dev/null
done
# Expect one call to return 429 Too Many Requests
```

**Premium is faster/looser limits:**

```bash
for i in {1..60}; do
  curl -s -o /dev/null -w "%{http_code}\n" \
    -H "Ocp-Apim-Subscription-Key: $KEY_PREM" "$APIM_GATEWAY/echo/get"
done
```

**Missing key ‚Üí 401:**

```bash
curl -i "$APIM_GATEWAY/echo/get"
```

---

## 6) Developer Portal (self-serve)

- In APIM ‚Üí **Developer portal** ‚Üí Publish.
- Invite external developers or allow self-signup.
- They **subscribe** to products and see **primary/secondary keys**.
- You can put **Free** public; **Premium** behind **manual approval** if you prefer.

> Tip: Under **Products ‚Üí Settings**, toggle ‚ÄúRequires subscription‚Äù and ‚ÄúRequires approval‚Äù.

---

## 7) Usage Analytics (Log Analytics + KQL)

Enable logs (Portal ‚Üí APIM ‚Üí **Diagnostics logs** ‚Üí send to **Log Analytics Workspace**).
Query usage:

**Sample KQL (Requests by subscription in last 24h):**

```kql
AzureDiagnostics
| where ResourceProvider == "MICROSOFT.APIMANAGEMENT"
| where TimeGenerated > ago(24h)
| summarize Count = count() by SubscriptionId_s
| order by Count desc
```

**429 rate-limit hits by product:**

```kql
AzureDiagnostics
| where httpStatus_d == 429
| summarize RateLimitHits = count() by ProductName_s
```

Use this data to **bill** (for PAYG) or **enforce upgrades** when users approach quota.

---

## 8) (Optional) CI/CD ‚Äî Auto-provision on ‚Äúpayment success‚Äù

Create a GitHub repo secret `AZURE_CREDENTIALS` (SPN JSON). Sample workflow:

```yaml
name: Onboard Paying Customer
on:
  workflow_dispatch:
    inputs:
      customerName:
        required: true
      product:
        required: true
        default: premium

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create subscription & output keys
        run: |
          RG="${{ env.RG }}"
          APIM_NAME="${{ env.APIM_NAME }}"
          CUSTOMER="${{ github.event.inputs.customerName }}"
          PRODUCT="${{ github.event.inputs.product }}"

          SID="sub-${PRODUCT}-${CUSTOMER}"
          az apim subscription create \
            -g $RG --service-name $APIM_NAME \
            --name "$SID" \
            --display-name "${CUSTOMER} ${PRODUCT}" \
            --scope "/products/${PRODUCT}"

          KEY=$(az apim subscription show -g $RG --service-name $APIM_NAME --sid "$SID" --query primaryKey -o tsv)
          echo "PRIMARY_KEY=$KEY" >> $GITHUB_OUTPUT
```

> Hook this workflow to your **payment provider webhook** (Stripe, Paddle, Azure Marketplace event) to provision keys automatically after payment.

---

## 9) Key Management & Rotation

- Each subscription has **Primary** and **Secondary** keys.
- Rotate safely:

  1. Generate new **secondary**, notify customer.
  2. They switch to secondary.
  3. Regenerate **primary**.

- CLI:

```bash
az apim subscription regenerate-key \
  -g $RG --service-name $APIM_NAME \
  --sid "$SUB_PREM" --key-type primary
```

---

## 10) Cleanup

```bash
az group delete -n $RG -y
```

---

## ‚úÖ What you achieved

- Built **monetizable tiers** with **Products**
- Enforced **rate limits** & **quotas** via **Policies**
- Issued **subscription keys** (auto approval)
- Exposed **Developer Portal** for self-service onboarding
- Wired **usage analytics** ‚Üí basis for billing
- Automated **paid onboarding** via **GitHub Actions**

If you want, I can extend this with:

- **Azure Marketplace** listing flow (Microsoft handles billing üí≥)
- **JWT + subscription key** combo for stronger authZ
- **Per-API** vs **per-Product** subscriptions (granular pricing)
