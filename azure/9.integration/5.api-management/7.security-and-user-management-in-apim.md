# 🔐 Security & User Management in Azure API Management (APIM)

Azure API Management (APIM) is not just about exposing APIs — it’s about **controlling access, securing traffic, and managing developer subscriptions**. In production, these two areas go hand-in-hand:

1. **🔒 API Security** → who *can* call your APIs and how they authenticate.
2. **👥 Subscription & User Management** → how you onboard, manage, and monetize API consumers.

---

## 1️⃣ Securing APIs in APIM

### 1. **Subscription Keys**

* **What**: A static key (primary & secondary) issued per subscription.
* **How it works**: Key is sent in `Ocp-Apim-Subscription-Key` header or query string.
* **Use case**: Metering, billing, rate-limiting.
* **Weakness**: Not tied to identity; if leaked, anyone can use it.

🔹 Example Policy in APIM:

```xml
<inbound>
   <base />
   <check-header name="Ocp-Apim-Subscription-Key" failed-check-httpcode="401" failed-check-error-message="Missing subscription key" />
</inbound>
```

---

### 2. **OAuth 2.0 / OpenID Connect (JWT tokens)**

* **What**: Short-lived tokens from an Identity Provider (Azure AD, B2C, Okta).
* **How it works**: Client authenticates with IdP → gets token → APIM validates token.
* **Use case**: Enforcing **user identity**, roles, scopes.
* **Strength**: Industry-standard, strong authentication.

🔹 Example Policy:

```xml
<validate-jwt header-name="Authorization" failed-validation-httpcode="401">
  <openid-config url="https://login.microsoftonline.com/{tenant}/v2.0/.well-known/openid-configuration" />
  <audiences>
    <audience>api://your-app-id</audience>
  </audiences>
</validate-jwt>
```

---

### 3. **Client Certificates (mTLS)**

* **What**: API clients authenticate with **X.509 certificates**.
* **How it works**: Client presents certificate during TLS handshake → APIM validates.
* **Use case**: **B2B integrations** (banks, partners).
* **Strength**: Strong machine-to-machine trust.

---

### 4. **IP Restrictions & Network Security**

* **What**: Restrict access by IP ranges or private networking (VNet, Private Endpoint).
* **Use case**: Limit to trusted networks, internal APIs.
* **Strength**: Network-level protection (extra layer).

---

## 2️⃣ Managing Subscriptions & Users

### 📦 **Products**

* Bundle of APIs, policies, quotas, and subscription rules.
* Developers subscribe to a **product** to access APIs.
* Example:

  * Free Product → 1000 calls/month
  * Premium Product → unlimited calls + advanced APIs

---

### 👥 **Users**

* **What**: Represent API consumers (devs, partners, teams).
* Can self-register in the **Developer Portal**.
* Assigned to groups & products.

---

### 👪 **Groups**

* Control API visibility by grouping users.
* Built-in groups:

  * `Administrators` (full control)
  * `Developers` (normal API consumers)
  * `Guests` (limited view, onboarding stage)
* You can create **custom groups** (e.g., "Partners", "Gold Customers").

---

### 🔑 **Subscriptions**

* Each subscription = link between a **user** and a **product**.
* Generates **primary and secondary keys**.
* Keys can be **rotated** manually or via automation.
* Can be **revoked**, **expired**, or **limited** (quota).

---

## 3️⃣ How Security & User Management Work Together

| Layer        | Mechanism               | Purpose                            | Example Use Case                  |
| ------------ | ----------------------- | ---------------------------------- | --------------------------------- |
| Identity 🔐  | OAuth2.0, JWT, Certs    | Who are you?                       | Internal apps with AAD            |
| Access 🔑    | Subscription Keys       | Can you call? (metering & billing) | Free vs Paid tiers                |
| Network 🌐   | IP Restrictions, VNets  | Where are you calling from?        | Restrict to partners              |
| User Mgmt 👥 | Users, Groups, Products | Organize and control devs/partners | Separate internal & external APIs |

---

## 4️⃣ Real-World Example

Imagine you run a **Weather API** 🌦️:

* You create **two products**:

  * Free Tier → 500 requests/month → secured by subscription key.
  * Premium Tier → unlimited requests → requires **OAuth2 token + subscription key**.

* You add **IP restriction** so only traffic from `US/EU` regions is allowed.

* For your **partner airline**, you require **client certificate authentication**.

👉 Now you’ve combined **billing (subscription keys)**, **security (OAuth2, certs, IP)**, and **user management (groups & products)**.

---

# 📝 Summary

* **Subscription Keys** → good for metering & monetization.
* **OAuth2 / JWT** → strong identity & authorization.
* **Client Certificates** → secure B2B machine-to-machine.
* **IP Restrictions / VNets** → extra network security.
* **Users, Groups, Products** → manage API consumers at scale.

⚡ By mixing these layers, APIM gives you **flexibility**: you can run public APIs with keys, enterprise APIs with JWTs, or partner APIs with certificates — all from one unified platform.

---

👉 Do you want me to now prepare a **step-by-step hands-on** where we secure one API in APIM using **all four methods (key, OAuth2, cert, IP restriction)**, so you see them in practice?
