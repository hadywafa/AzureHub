# âš™ï¸ **Azure API Management**

**Azure API Management (APIM)** is not just about exposing APIs, itâ€™s about **controlling access, securing traffic, and managing developer subscriptions**. In production, these two areas go hand-in-hand:

1. **ğŸ”’ API Security** â†’ who _can_ call your APIs and how they authenticate.
2. **ğŸ‘¥ Subscription & User Management** â†’ how you onboard, manage, and monetize API consumers.

---

## ğŸ° **Mental Model: Three Layers**

| Goal                      | What you use                                                                                | Why it matters                                                               |
| ------------------------- | ------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| **ğŸ’¸ Monetize / Meter**   | **Products + Subscriptions + Keys**                                                         | Track usage per customer, apply quotas/rate limits, offer free/premium plans |
| **ğŸ” Secure / Authorize** | **OAuth2/JWT**, **Client Certificates (mTLS)**, **IP Restrictions**, **Private Networking** | Prove identity (who), restrict access (where), add strong machine trust      |
| **ğŸ‘©ğŸ»â€ğŸ’» Manage Developers**  | **Users**, **Groups**, **Developer Portal**, **Approvals**                                  | Onboard/approve users, issue keys, revoke, support self-service              |

> **âœ… Best practice:**
>
> 1. **Keys = monetization**,
> 2. **JWT/cert = identity & security**,
> 3. **IP/VNet = network guard**.

---

## ğŸ’¸ **Monetization & Access Control** with Products + Subscriptions

### ğŸ“¦ Products

- A **bundle of APIs** with shared **policies/quotas/rate limits**.
- Visibility controlled by **Groups**.
- Developers **subscribe** to products to get **keys**.

### ğŸ”‘ Subscriptions (and Keys)

- Each subscription has **Primary** and **Secondary** **subscription keys**.
- Keys identify **which subscription** â†’ used for **metering**, **quotas**, **rate limits**.
- Keys can have **start/expiration dates**, be **revoked**, and **rotated**.

**CLI: create a product & subscription with expiry:**

```bash
# Create product
az apim product create -g $RG --service-name $APIM \
  --product-id premium --display-name "Premium" \
  --approval-required true --subscriptions-limit 1 --state published

# Create subscription (link userâ†”product) with expiration
az apim subscription create -g $RG --service-name $APIM \
  --name sub-prem-01 \
  --display-name "Customer A Premium" \
  --scope "/products/premium" \
  --expiration-date "2026-01-01T00:00:00Z"
```

**Rotate keys (zero downtime):**

```bash
# Renew primary OR secondary
az apim subscription key renew \
  -g $RG --service-name $APIM \
  --sid sub-prem-01 --key-type primary
```

**Inbound enforcement (subscription key check):**

```xml
<policies>
  <inbound>
    <base />
    <!-- Reject if key missing -->
    <check-header name="Ocp-Apim-Subscription-Key"
      failed-check-httpcode="401"
      failed-check-error-message="Missing subscription key" />
  </inbound>
  <backend><base /></backend>
  <outbound><base /></outbound>
</policies>
```

> ğŸ” You can **turn off** â€œSubscription requiredâ€ at **API** or **Product** level if you donâ€™t need keys (e.g., internal APIs using JWT only).

---

## ğŸ” **Security:** Identity & Transport

### ğŸªª OAuth 2.0 / OpenID Connect (JWT)

- **What**: Short-lived tokens from an Identity Provider (Azure AD, B2C, Okta).
- **How it works**: Client authenticates with IdP â†’ gets token â†’ APIM validates token.
- **Use case**: Enforcing **user identity**, roles, scopes.
- **Strength**: Industry-standard, strong authentication.

**Inbound policy - validate JWT:**

```xml
<inbound>
  <base />
  <validate-jwt header-name="Authorization" failed-validation-httpcode="401">
    <openid-config url="https://login.microsoftonline.com/<tenant-id>/v2.0/.well-known/openid-configuration" />
    <audiences>
      <audience>api://your-api-app-id</audience>
    </audiences>
    <required-claims>
      <claim name="roles" match="any">
        <value>PremiumUser</value>
      </claim>
    </required-claims>
  </validate-jwt>
</inbound>
```

**Combine JWT + subscription key** (recommended for paid APIs):

```xml
<inbound>
  <base />
  <validate-jwt header-name="Authorization" failed-validation-httpcode="401"> ... </validate-jwt>
  <check-header name="Ocp-Apim-Subscription-Key" failed-check-httpcode="401" />
</inbound>
```

> If you **donâ€™t** need metering, **disable subscription requirement** and keep JWT only.

---

### ğŸ“ Client Certificates (Mutual TLS)

- **What**: API clients authenticate with **X.509 certificates**.
- **How it works**: Client presents certificate during TLS handshake â†’ APIM validates.
- **Use case**: **B2B integrations** (banks, partners).
- **Strength**: Strong machine-to-machine trust.

**Steps:**

1. Upload partner client certificate (or trusted CA) in **APIM â†’ Certificates**.
2. Enable **client cert** on your **custom domain** / gateway as needed.
3. Enforce in policy:

```xml
<inbound>
  <base />
  <choose>
    <when condition="@(context.Request.Certificate == null)">
      <return-response>
        <set-status code="403" reason="Client certificate required" />
      </return-response>
    </when>
  </choose>
  <!-- Optionally assert thumbprint or subject -->
  <choose>
    <when condition="@(!context.Request.Certificate.Thumbprint.Equals("ABCD1234...", StringComparison.OrdinalIgnoreCase))">
      <return-response>
        <set-status code="403" reason="Unrecognized client certificate" />
      </return-response>
    </when>
  </choose>
</inbound>
```

> Can be combined with keys/JWT for **defense-in-depth**.

---

### ğŸš« IP Allow/Deny + Private Networking

- **What**: Restrict access by IP ranges or private networking (VNet, Private Endpoint).
- **Use case**: Limit to trusted networks, internal APIs.
- **Strength**: Network-level protection (extra layer).

**Policy IP filter (simple allow-list):**

```xml
<inbound>
  <base />
  <ip-filter action="allow">
    <address>203.0.113.25</address>
    <address-range from="10.0.0.1" to="10.0.0.255" />
  </ip-filter>
</inbound>
```

**Stronger network controls:**

- **Private Endpoint / VNet integration**: expose APIM privately.
- Pair with **NSGs**, **firewalls**, **WAF**.

---

## âš ï¸ **Quotas, Throttling, and Abuse Protection**

Apply at **API** or **Product** (usually productâ€”per subscription).

```xml
<inbound>
  <base />
  <!-- Burst protection -->
  <rate-limit calls="100" renewal-period="60" />       <!-- 100 calls/min -->

  <!-- Rolling quota -->
  <quota calls="100000" renewal-period="2592000" />     <!-- 100k/month -->
</inbound>
```

> Use **different products** (Free/Pro/Enterprise) to tier these limits.

---

## ğŸ‘©ğŸ»â€ğŸ’» **Users, Groups, and Developer Portal**

- **Users**: human or app identities in APIM.
- **Groups**: control visibility of **Products**.

  - Built-in: `Administrators`, `Developers`, `Guests`.
  - Create **custom groups** (e.g., Partners, Gold).

- **Developer Portal**: self-service **sign-up**, **subscribe**, **test**, view docs.

**Typical flows:**

- Public APIs: **self-sign-up** â†’ request subscription â†’ admin approval â†’ keys issued.
- Enterprise/internal: disable self-signup; manage users via **Azure AD** & JWT.

---

## ğŸ¯ **Layering Strategies** (Decision Matrix)

| Scenario                | Subscription Key | OAuth2/JWT | Client Cert (mTLS) | IP/VNet      |
| ----------------------- | ---------------- | ---------- | ------------------ | ------------ |
| **Public Free API**     | âœ… (to meter)    | âŒ         | âŒ                 | Optional     |
| **Public Paid API**     | âœ…               | âœ…         | âŒ                 | Optional     |
| **Partner B2B**         | Optional         | âœ…         | âœ…                 | âœ…           |
| **Internal Enterprise** | âŒ               | âœ… (AAD)   | Optional           | âœ… (Private) |

---

## ğŸ” **Hardening Subscription Keys**

- **Combine with JWT** (identity) for paid APIs.
- **Rotate Primary/Secondary** keys regularly.
- **Set Expiration** for trials/short-term access.
- **Use quotas/rate limits** to limit damage from leaks.
- **IP/VNet restrictions** to trusted networks only.
- Require **admin approval** for high-value products.

---

## âœğŸ» **Hands-on End-to-End â€œPremium Productâ€** Example (Portal + Policies)

**Goal**:

- Premium product requires **Subscription Key** (billing) **AND** **JWT** (security).
- 1k requests/min throttle; 1M/month quota.
- Only users in **â€œPremiumCustomersâ€ group** see/subscribe.

**Steps:**

1. **Create group** â€œPremiumCustomersâ€ and add users.
2. **Create product** â€œPremiumâ€ â†’ visible to **PremiumCustomers**, require subscription.
3. **Add APIs** to product.
4. **Policies (product level)**:

   ```xml
   <policies>
   <inbound>
       <base />
       <!-- JWT required -->
       <validate-jwt header-name="Authorization" failed-validation-httpcode="401">
       <openid-config url="https://login.microsoftonline.com/<tenant-id>/v2.0/.well-known/openid-configuration" />
       <audiences><audience>api://weather-premium</audience></audiences>
       <required-claims>
           <claim name="roles" match="any"><value>PremiumUser</value></claim>
       </required-claims>
       </validate-jwt>

       <!-- Subscription key still required (metering) -->
       <check-header name="Ocp-Apim-Subscription-Key" failed-check-httpcode="401" />

       <!-- Throttle + Quota -->
       <rate-limit calls="1000" renewal-period="60" />
       <quota calls="1000000" renewal-period="2592000" />
   </inbound>
   <backend><base /></backend>
   <outbound><base /></outbound>
   </policies>
   ```

5. **Create subscription** for a customer with **expiration date**.
6. Provide docs in **Developer Portal**: â€œSend `Authorization: Bearer <token>` + `Ocp-Apim-Subscription-Key`.â€

---

## ğŸ“Œ **Security â€œPower-Upsâ€**

- **mTLS** for sensitive B2B endpoints (add cert check + IP allow list).
- **Mask or strip sensitive headers**:

  ```xml
  <outbound>
  <base />
  <set-header name="Server" exists-action="override">
      <value>none</value>
  </set-header>
  <remove-header name="x-powered-by" />
  </outbound>
  ```

- **Validate schema** on inbound:

  ```xml
  <validate-content unspecified-content-type-action="prevent">
  <content type="application/json" validate-as="json" />
  </validate-content>
  ```

---

## ğŸ“ƒ **Ops & Observability**

- **Application Insights** for latency, failures, dependencies.
- **APIM Analytics** for per-API/operation usage, top callers.
- **Defender for APIs** for anomaly detection & threat intel.
- **Automation**: rotate keys, export analytics, enforce policies via IaC (Bicep/ARM/Terraform).

---

## â‰ï¸ **Quick FAQs**

- **Is a subscription key mandatory?**
  No. Disable â€œSubscription requiredâ€ at API/product if you use **OAuth2 only**.
- **Can a subscription expire?**
  Yes. Set **expirationDate**; after that, calls fail (403).
- **How do I bill customers?**
  Use product-level quotas/throttles + analytics; integrate usage into your billing system.
- **Can I mix mechanisms?**
  Absolutely. The strongest setups **layer** JWT + key + IP/VNet + (optionally) mTLS.

---

## âœ… **TL;DR**

- Use **Products + Subscriptions** to **meter/monetize**.
- Use **JWT** (and optionally **mTLS**) to **secure** and **authorize**.
- Use **Groups + Developer Portal** to **manage users** at scale.
- Add **IP/VNet** and **quotas/throttles** for **defense-in-depth**.
- Rotate keys, set expirations, and monitor with App Insights/Analytics.
