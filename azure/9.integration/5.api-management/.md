Great questions üëç Let‚Äôs dig in ‚Äî because **subscription expiry** and **JWT-based access control** are two of the most important levers in **Azure API Management (APIM)** when you want to balance monetization with secure access.

---

# ‚è≥ Do Subscriptions Have Expiry Dates?

Yes ‚Äî **subscriptions in APIM can have an expiration date**.

When you create or update a subscription, you can provide:

* `startDate` ‚Üí when the subscription becomes active
* `expirationDate` ‚Üí when it will **automatically expire**

üëâ Example (CLI):

```bash
az apim subscription create \
  -g $RG --service-name $APIM_NAME \
  --name sub-prem-demo \
  --display-name "Premium Trial Customer" \
  --scope "/products/premium" \
  --expiration-date 2025-12-31T23:59:59Z
```

* After that date, any request with that key returns **403 Forbidden**.
* You can use this to:

  * Offer **free trials**
  * Enforce **renewals**
  * Align with **subscription billing cycles**

‚úÖ Best practice: Rotate `primary`/`secondary` keys before expiration if you‚Äôre extending the contract, so customers never hit downtime.

---

# üîë Managing Access with JWT in APIM

So far, we‚Äôve talked about **subscription keys** (good for monetization & quota enforcement). But **subscription keys alone** are ‚Äúshared secrets‚Äù ‚Äî they don‚Äôt identify **who the user really is**.

That‚Äôs where **JWT (JSON Web Tokens)** comes in.

## üìå How it works in APIM

1. **Identity Provider issues JWT**

   * Could be **Azure AD**, **Auth0**, **GitHub**, or your **own STS**.
   * JWT contains claims like `sub`, `roles`, `exp`, `aud`, etc.

2. **Client calls APIM with JWT**

   * Usually in the `Authorization: Bearer <token>` header.
   * Optionally, they also send `Ocp-Apim-Subscription-Key` if you still want monetization tied to a product.

3. **APIM Policy validates JWT**

   * You configure `validate-jwt` in the inbound policy.
   * It checks **issuer (iss)**, **audience (aud)**, **signing keys**, and optionally **claims**.

   Example:

   ```xml
   <policies>
     <inbound>
       <base />
       <validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized">
         <openid-config url="https://login.microsoftonline.com/<tenant-id>/v2.0/.well-known/openid-configuration" />
         <audiences>
           <audience>api://myapi-id</audience>
         </audiences>
         <required-claims>
           <claim name="roles" match="any">
             <value>PremiumUser</value>
           </claim>
         </required-claims>
       </validate-jwt>
     </inbound>
     <backend><base /></backend>
     <outbound><base /></outbound>
   </policies>
   ```

   üîç What this does:

   * Validates token signature against Azure AD public keys
   * Ensures token audience = `api://myapi-id`
   * Ensures the user has a `roles=PremiumUser` claim

4. **APIM enforces fine-grained access**

   * You can combine **subscription key + JWT**:

     * Subscription key = monetization / quota
     * JWT = user identity / role-based access

   Example:

   * `Free product`: Only requires subscription key
   * `Premium product`: Requires subscription key **and** JWT with `PremiumUser` role

---

# ‚öñÔ∏è Subscription Keys vs JWT ‚Äî When to Use

| Feature                  | Subscription Key            | JWT                                     |
| ------------------------ | --------------------------- | --------------------------------------- |
| **Identifies Customer?** | No (just subscription ID)   | Yes (user identity & claims)            |
| **Monetization**         | ‚úÖ Perfect (quotas, billing) | ‚ùå Not designed for billing              |
| **Security**             | Medium (shared secret)      | High (short-lived, signed, claim-based) |
| **Rotation**             | Manual, dual key            | Automatic (token refresh)               |
| **Use Case**             | API product monetization    | Fine-grained access control             |

üí° **Best Practice:**

* Use **subscription key** for **billing/quotas**.
* Use **JWT** for **identity & authorization**.
* Combine both in premium scenarios.

---

üëâ Now, do you want me to prepare a **hands-on example** where:

* Free users just use **subscription keys**,
* Premium users must send **JWT + subscription key**,
  so you see how to enforce **tiered access with real policies**?
