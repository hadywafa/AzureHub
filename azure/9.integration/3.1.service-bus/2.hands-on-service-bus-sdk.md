# ✍🏻 Setting Up Azure Service Bus Queue & Code Walkthrough

Azure Service Bus queues are the **bread and butter** of messaging in distributed systems. They’re **FIFO** (first-in, first-out), support **guaranteed delivery**, and decouple producers from consumers. Let’s go step by step.

---

## ☁️ Step 1: Create Service Bus Namespace & Queue (Portal)

1. Go to **Azure Portal** → Search **Service Bus** → Click **Create**.

2. Fill in details:

   - Namespace name: `myservicebusns`
   - Pricing tier: **Standard** (to support Topics, Scheduled delivery, Sessions).
   - Region: your nearest.
   - Resource group: choose or create new.

3. After namespace is created → Open it → Under **Entities**, click **Queues** → **+ Queue**.

   - Name: `ordersqueue`.
   - Configure options (default works for demo).

Now we have:

- Namespace: `myservicebusns.servicebus.windows.net`
- Queue: `ordersqueue`

---

## 🔑 Step 2: Get Connection String

1. In the Service Bus namespace → **Shared Access Policies**.
2. Click `RootManageSharedAccessKey` (or create new).
3. Copy the **Primary Connection String**.

---

## 💻 Step 3: Install SDK

In your .NET app (console app works fine):

```bash
dotnet add package Azure.Messaging.ServiceBus
```

---

## ✍️ Step 4: Producer (Send Messages)

```csharp
using Azure.Messaging.ServiceBus;
using System;
using System.Threading.Tasks;

class Program
{
    private const string connectionString = "<YOUR_CONNECTION_STRING>";
    private const string queueName = "ordersqueue";

    static async Task Main()
    {
        // Create client
        await using var client = new ServiceBusClient(connectionString);

        // Create a sender
        ServiceBusSender sender = client.CreateSender(queueName);

        // Send single message
        ServiceBusMessage singleMessage = new ServiceBusMessage("Hello, Service Bus!");
        await sender.SendMessageAsync(singleMessage);
        Console.WriteLine("✅ Sent one message");

        // Send batch of messages
        using ServiceBusMessageBatch messageBatch = await sender.CreateMessageBatchAsync();
        messageBatch.TryAddMessage(new ServiceBusMessage("Order #1"));
        messageBatch.TryAddMessage(new ServiceBusMessage("Order #2"));
        messageBatch.TryAddMessage(new ServiceBusMessage("Order #3"));

        await sender.SendMessagesAsync(messageBatch);
        Console.WriteLine("✅ Sent batch of messages");
    }
}
```

👉 Notes:

- **Batching** avoids multiple round trips.
- Messages can have custom properties (`ApplicationProperties["OrderId"] = 123`).

---

## 🖥 Step 5: Consumer (Receive Messages)

```csharp
using Azure.Messaging.ServiceBus;
using System;
using System.Threading.Tasks;

class Consumer
{
    private const string connectionString = "<YOUR_CONNECTION_STRING>";
    private const string queueName = "ordersqueue";

    static async Task Main()
    {
        await using var client = new ServiceBusClient(connectionString);

        // Create a processor (recommended for auto message pump)
        ServiceBusProcessor processor = client.CreateProcessor(queueName, new ServiceBusProcessorOptions
        {
            AutoCompleteMessages = false // gives us control when to mark complete
        });

        // Define message handler
        processor.ProcessMessageAsync += async args =>
        {
            string body = args.Message.Body.ToString();
            Console.WriteLine($"📩 Received: {body}");

            // Do some processing...
            await Task.Delay(500);

            // Complete message to remove it from the queue
            await args.CompleteMessageAsync(args.Message);
        };

        // Define error handler
        processor.ProcessErrorAsync += async args =>
        {
            Console.WriteLine($"❌ Error: {args.Exception.Message}");
            await Task.CompletedTask;
        };

        // Start processor
        await processor.StartProcessingAsync();

        Console.WriteLine("👂 Listening... Press any key to exit");
        Console.ReadKey();

        // Stop gracefully
        await processor.StopProcessingAsync();
    }
}
```

👉 Notes:

- **Message pump** keeps listening.
- `CompleteMessageAsync` ensures once-only processing.
- If app crashes before completion → message goes back to queue (retry).

---

## ⚡ Advanced Enhancements

- **Dead-letter queue**: Messages that can’t be delivered after retries are stored separately.
- **Scheduled messages**: You can send messages to be delivered later.
- **Session-enabled queues**: For ordered message processing across partitions.

---

## 🎯 Key Takeaways

- Setup involves **Namespace → Queue → SAS Policy → Connection String**.
- Producer sends via `ServiceBusSender`.
- Consumer receives via `ServiceBusProcessor` (recommended) or `ServiceBusReceiver`.
- Once-only processing + retries are **built-in**.
