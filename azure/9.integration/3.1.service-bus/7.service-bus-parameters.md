# ‚öôÔ∏è Azure Service Bus ‚Äì Message & Configuration Parameters

Azure Service Bus has **two main places where parameters live**:

1. **Message-level properties** (metadata that travels with each message)
2. **Receiver-level & system parameters** (lock, timeouts, delivery counts, etc.)

---

## üì¶ 1. Message-Level Properties

These are part of the **`ServiceBusMessage`** (in SDKs) or the AMQP protocol.

| Property                    | Type          | Meaning / Usage                                                                                                                                           |
| --------------------------- | ------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **MessageId**               | string        | Unique ID for de-duplication. If `RequiresDuplicateDetection` is enabled, Service Bus ignores duplicate `MessageId`s within the **dup-detection window**. |
| **SessionId**               | string        | Groups related messages into ordered **sessions**. Enables FIFO across sessions.                                                                          |
| **PartitionKey**            | string        | Ensures all related messages go to the same partition (useful for ordering when sessions are not used).                                                   |
| **ReplyTo**                 | string        | Queue/topic name for replies (RPC style).                                                                                                                 |
| **ReplyToSessionId**        | string        | Session binding for the reply.                                                                                                                            |
| **CorrelationId**           | string        | Used to correlate request-response workflows.                                                                                                             |
| **ContentType**             | string        | MIME type (e.g., `application/json`).                                                                                                                     |
| **Label / Subject**         | string        | Short description of the message (was `Label`, now called `Subject` in SDK).                                                                              |
| **To**                      | string        | Destination (rarely used).                                                                                                                                |
| **ApplicationProperties**   | dictionary    | Arbitrary key-value pairs set by sender, read by receivers. Example: `OrderType=VIP`.                                                                     |
| **ScheduledEnqueueTimeUtc** | DateTime      | Time when the broker makes the message available. ‚Üí Enables **delayed delivery**.                                                                         |
| **TimeToLive (TTL)**        | TimeSpan      | Message expiry. If TTL expires before processing, it‚Äôs moved to **DLQ**.                                                                                  |
| **MessageBody**             | binary/string | The actual payload.                                                                                                                                       |

---

## ‚è≥ 2. Broker/Delivery Parameters

These control **how messages are delivered/processed**.

| Parameter                                  | Applies To                | Description                                                               |
| ------------------------------------------ | ------------------------- | ------------------------------------------------------------------------- |
| **LockDuration**                           | Queue/subscription config | How long a message stays locked in Peek-Lock (default 30s).               |
| **AutoDeleteOnIdle**                       | Queue/subscription        | Deletes entity after idle time (useful for temp subscriptions).           |
| **DefaultMessageTimeToLive**               | Queue/subscription        | TTL applied if not set per-message.                                       |
| **DuplicateDetectionHistoryTimeWindow**    | Queue/topic               | Time window for ignoring duplicate `MessageId`s.                          |
| **EnableDeadLetteringOnMessageExpiration** | Subscription              | Whether expired messages go to DLQ.                                       |
| **EnableBatchedOperations**                | Entity                    | Whether multiple ops are batched in one AMQP frame.                       |
| **MaxDeliveryCount**                       | Queue/subscription        | Number of delivery attempts before message is dead-lettered. Default: 10. |
| **PrefetchCount**                          | Receiver                  | How many messages to fetch in advance for throughput.                     |
| **ReceiveMode**                            | Receiver                  | `PeekLock` (safe, default) or `ReceiveAndDelete` (fast, at-most-once).    |
| **OperationTimeout**                       | Client                    | Max time for Service Bus SDK call to complete.                            |
| **TransportType**                          | Client                    | AMQP over TCP (default) or WebSockets (fallback for firewalls).           |

---

## üî¢ 3. Runtime Properties (System-assigned per message)

These are **set by Service Bus**, not by you:

| Property             | Description                                                                                       |
| -------------------- | ------------------------------------------------------------------------------------------------- |
| **SequenceNumber**   | Auto-incremented unique ID within the entity (queue/subscription). Used for ordering.             |
| **LockedUntilUtc**   | Timestamp until which the message is locked (Peek-Lock mode).                                     |
| **EnqueuedTimeUtc**  | When the message was enqueued.                                                                    |
| **ExpiresAtUtc**     | When the message expires (based on TTL).                                                          |
| **DeliveryCount**    | How many times the message was delivered. Important for DLQ logic.                                |
| **LockToken**        | GUID associated with a locked message ‚Üí required to `Complete()`, `Abandon()`, or `DeadLetter()`. |
| **DeadLetterSource** | When reading from a DLQ, indicates the original source.                                           |

---

## üìä Example ‚Äì Sending with Parameters (C#)

```csharp
var client = new ServiceBusClient(connString);
var sender = client.CreateSender("orders");

var message = new ServiceBusMessage(BinaryData.FromString("{\"id\":123}"))
{
    MessageId = Guid.NewGuid().ToString(),
    Subject = "OrderCreated",
    ContentType = "application/json",
    CorrelationId = "workflow-789",
    SessionId = "Customer-42",
    TimeToLive = TimeSpan.FromMinutes(30),
    ScheduledEnqueueTime = DateTimeOffset.UtcNow.AddMinutes(10) // delay
};

// Custom properties
message.ApplicationProperties["Priority"] = "High";

await sender.SendMessageAsync(message);
```

---

## üìä Example ‚Äì Inspecting Runtime Props (C#)

```csharp
var receiver = client.CreateReceiver("orders", new ServiceBusReceiverOptions
{
    ReceiveMode = ServiceBusReceiveMode.PeekLock
});

ServiceBusReceivedMessage msg = await receiver.ReceiveMessageAsync();

Console.WriteLine($"Seq #: {msg.SequenceNumber}");
Console.WriteLine($"DeliveryCount: {msg.DeliveryCount}");
Console.WriteLine($"LockedUntil: {msg.LockedUntil}");
Console.WriteLine($"ExpiresAt: {msg.ExpiresAt}");
```

---

## üß† Developer Insights

- **Use `ScheduledEnqueueTimeUtc`** for delayed jobs, retries, or reminders.
- **Lock & LockToken** only matter in **Peek-Lock** mode.
- **SequenceNumber** is super useful for **ordered replay** or DLQ analysis.
- **Timeouts & Prefetch** tuning are key for **throughput-sensitive** apps.
- Always track **DeliveryCount** ‚Üí decide whether to retry or dead-letter manually.

---

‚úÖ In short:

- **Message properties** = you control (identity, routing, TTL, scheduling).
- **System/runtime properties** = Service Bus controls (lock, sequence, delivery count).
- **Entity config** = queue/subscription-level knobs (max delivery, lock duration, dup detection).
