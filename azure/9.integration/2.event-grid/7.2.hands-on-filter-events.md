# 🎯 Hands-On: Filtering Events in Azure Event Grid

We’ll use a **Blob Storage → Event Grid → Webhook** example, but you can apply the same steps to any publisher/subscriber combo.

---

## 🖥️ 1. Using Azure Portal

### Step 1: Go to Event Grid Subscription

1. Open **Azure Portal**.
2. Navigate to your **Storage Account** (publisher).
3. Under **Events**, click **+ Event Subscription**.

---

### Step 2: Configure Basic Settings

- **Name:** `blob-created-filtered-sub`
- **Event Schema:** Event Grid Schema
- **Endpoint Type:** Webhook (or Azure Function/Logic App if you prefer).
- **Endpoint URL:** `https://myapp.com/events`

---

### Step 3: Apply Filters

1. **Event Types**:

   - Select only `BlobCreated`.

2. **Subject Filtering**:

   - **Prefix filter:** `/blobServices/default/containers/photos/`
   - **Suffix filter:** `.jpg`
     👉 Only `.jpg` files in the `photos` container.

3. **Advanced Filters**:

   - Add filter: `data.api` = `PutBlob`
     👉 Only events triggered by uploads (not copy/delete).

---

### Step 4: Save and Test

- Save subscription.
- Upload a `.jpg` file to the `photos` container.
- Check your subscriber (webhook or Function) → you’ll see only the filtered event.

---

## 💻 2. Using Azure CLI

Let’s create the same subscription via CLI.

### Step 1: Define Variables

```bash
rg="my-resource-group"
storage="mystorageaccount"
topicScope="/subscriptions/<sub-id>/resourceGroups/$rg/providers/Microsoft.Storage/storageAccounts/$storage"
endpoint="https://myapp.com/events"
subName="blob-created-filtered-sub"
```

---

### Step 2: Create Event Subscription with Filters

```bash
az eventgrid event-subscription create \
  --name $subName \
  --source-resource-id $topicScope \
  --endpoint $endpoint \
  --included-event-types Microsoft.Storage.BlobCreated \
  --subject-begins-with "/blobServices/default/containers/photos/" \
  --subject-ends-with ".jpg" \
  --advanced-filter data.api StringEquals PutBlob
```

---

### Step 3: Verify Subscription

```bash
az eventgrid event-subscription show \
  --name $subName \
  --source-resource-id $topicScope
```

Check that:

- `includedEventTypes = BlobCreated`
- `subjectBeginsWith = /blobServices/default/containers/photos/`
- `subjectEndsWith = .jpg`
- `advancedFilters` include `data.api = PutBlob`.

---

## ✅ Testing

- Upload a **JPG** → Event delivered.
- Upload a **PNG** → Ignored.
- Upload a **JPG outside photos container** → Ignored.
- Delete a blob → Ignored.

👉 This proves filtering is working.

---

## 🏆 Summary

- **Portal**: Easy to configure filters (event type, prefix, suffix, advanced).
- **CLI**: Gives you automation & scripting power.
- **Filtering ensures** your subscriber gets **only relevant events** (saves cost & complexity).
