# ğŸŒ **Webhooks in Azure Event Grid**

A **Webhook** is simply an **HTTP endpoint** (a URL) that Event Grid calls via `POST` whenever an event occurs.
Think of it like Event Grid â€œknocking on your appâ€™s doorâ€ and saying:

> â€œHey ğŸ‘‹, hereâ€™s a new event for you â€” process it!â€

---

## ğŸ”‘ **How Webhook Delivery Works**

1. **ğŸ“ Subscription Creation**

   - You tell Event Grid: â€œSend me all `BlobCreated` events to `https://myapp.com/events`â€.

2. **ğŸ¤ Handshake Validation**

   - Event Grid checks if your webhook endpoint is **alive and trustworthy**.
   - This is done via a **validation event**.
   - Handshake happens only once, when you create the subscription (or update it with a new endpoint).

3. **âœ… Subscription Verified**

   - If your webhook responds correctly â†’ subscription becomes **Active**.

4. **ğŸš€ Real Event Delivery**

   - Event Grid starts delivering **actual events** (e.g., BlobCreated, VMDeleted).

5. **ğŸ”„ Durability & Retry**

   - If your webhook fails, Event Grid retries and can send events to **dead-letter storage**.

---

## ğŸ¤ **The Handshake Types**

When Event Grid sends the **validation event**, there are two possible handshake styles:

### 1. **Synchronous Handshake** (Immediate Response)

- Event Grid sends a **`SubscriptionValidationEvent`**.
- Your webhook must **immediately respond** with the `validationResponse`.
- Example payload:

  ```json
  {
    "id": "111",
    "eventType": "Microsoft.EventGrid.SubscriptionValidationEvent",
    "data": {
      "validationCode": "12345"
    }
  }
  ```

ğŸ‘‰ Your webhook should reply with:

```json
{ "validationResponse": "12345" }
```

âœ… If successful â†’ Event Grid marks the subscription as verified instantly.

---

### 2. **Asynchronous Handshake** (Delayed Response)

- Sometimes, your endpoint canâ€™t respond right away (maybe youâ€™re warming up or need to process things).
- In this case, Event Grid allows **delayed validation**.
- Your webhook still receives the validation event, but you can confirm later by calling Event Grid with the validation code.

âœ… Useful for services that need extra time before going â€œonline.â€

---

## ğŸ“Š **Workflow**

<div align="center" style="background-color: #1c2529ff ;border-radius: 10px;border: 2px solid white">

```mermaid
sequenceDiagram
    participant EG as Event Grid
    participant WH as Webhook Endpoint

    EG->>WH: SubscriptionValidationEvent (handshake)
    alt Synchronous
        WH->>EG: validationResponse immediately
    else Asynchronous
        WH->>EG: validationResponse later (via API call)
    end
    EG->>WH: Real events (BlobCreated, VMDeleted, etc.)
    WH->>EG: 200 OK (acknowledge)
```

</div>

---

## âš¡ **Hands-On Example (Webhook in .NET Minimal API)**

```csharp
app.MapPost("/events", async (HttpContext context) =>
{
    using var reader = new StreamReader(context.Request.Body);
    var body = await reader.ReadToEndAsync();
    var events = JsonSerializer.Deserialize<JsonElement[]>(body);

    foreach (var ev in events)
    {
        var eventType = ev.GetProperty("eventType").GetString();

        if (eventType == "Microsoft.EventGrid.SubscriptionValidationEvent")
        {
            // Synchronous handshake
            var validationCode = ev.GetProperty("data").GetProperty("validationCode").GetString();
            return Results.Json(new { validationResponse = validationCode });
        }
        else
        {
            Console.WriteLine($"Event received: {eventType}");
        }
    }

    return Results.Ok();
});
```

---

## ğŸ”’ **Securing Webhooks**

- **Authentication:** Use Azure AD, OAuth, or shared keys.
- **Firewall:** Restrict to Event Grid IP ranges.
- **Validation:** Always check schema & headers.

---

## âœ… **Summary**

- **Webhook = HTTP POST endpoint**, most flexible delivery method.
- Requires **handshake validation** before real events flow.
- **Two handshake types**:

  - **Synchronous** â†’ immediate validation response.
  - **Asynchronous** â†’ delayed validation if needed.

- Durable delivery with retries & dead-lettering.
- Best for **custom apps** that need fine control.
