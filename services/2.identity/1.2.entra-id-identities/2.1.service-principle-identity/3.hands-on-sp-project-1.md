# üß™ Step-by-step lab: **App Registration ‚Üí Service Principal ‚Üí use in Azure DevOps pipeline**

Below is a clean, hands-on path. Follow it top-to-bottom; copy/paste CLI and YAML where shown.

---

<div align="center">
  <img src="https://tse4.mm.bing.net/th?id=OIP.JHjAutTxeR-RUBRMmYzsBAHaFh&pid=Api" alt="How to register an app in Microsoft Entra ID - Microsoft identity ..." style="width: 60%; border-radius: 10px; border: 2px solid">
</div>

---

## ‚úÖ Prereqs

- **Azure**: You‚Äôre an **Application Administrator** (to register apps) and have **Owner/Contributor** on a target subscription (to assign RBAC).
- **Azure DevOps**: Project created + permission to create **Service connections**.

---

## 1Ô∏è‚É£ Create an **App Registration** (Portal) ‚Üí generates the **Application (client) ID**

1. Azure Portal ‚Üí **Microsoft Entra ID** ‚Üí **App registrations** ‚Üí **New registration**.

   - Name: `spn-demo-app`
   - Accounts: ‚ÄúThis organization only‚Äù (single tenant)
   - (Redirect URI is optional for daemon/automation)
   - **Register**.

2. Copy values from **Overview**:

   - **Application (client) ID**
   - **Directory (tenant) ID**.

**CLI (alternative):**

```bash
# Log in
az login
SUB_ID=$(az account show --query id -o tsv)

# Create app + SP (service principal) in one shot
az ad sp create-for-rbac \
  --name spn-demo-app \
  --role Contributor \
  --scopes /subscriptions/$SUB_ID \
  --sdk-auth
```

> Output contains **clientId**, **clientSecret**, **tenantId**, etc. (Store safely.)

---

## 2Ô∏è‚É£ Add a **credential** (secret or certificate)

1. Portal ‚Üí your App Registration ‚Üí **Certificates & secrets**
2. **New client secret** ‚Üí copy the **secret value** (you won‚Äôt see it again).

> _(Prefer a certificate for production.)_

---

## 3Ô∏è‚É£ Know what got created: **Enterprise Application + Service Principal**

- Creating an App Registration automatically creates a **Service Principal** (identity) in your tenant, visible under **Enterprise applications** (admin view).
- You‚Äôll assign **RBAC** to this SP at the subscription/resource scope so it can deploy/use Azure resources.

**Assign RBAC (CLI):**

```bash
APP_ID="<client-id-from-app-reg>"
SUB_ID=$(az account show --query id -o tsv)

# Optionally find SP objectId (sometimes useful)
SP_OBJECT_ID=$(az ad sp show --id $APP_ID --query id -o tsv)

# Give the SP Contributor at subscription (adjust scope/role as needed)
az role assignment create \
  --assignee $APP_ID \
  --role Contributor \
  --scope /subscriptions/$SUB_ID
```

---

## 4Ô∏è‚É£ Create an **Azure Resource Manager (ARM) service connection** in Azure DevOps

This lets pipelines use the SP **without** hardcoding creds in YAML.

1. Azure DevOps ‚Üí your project ‚Üí **Project settings** ‚Üí **Service connections** ‚Üí **New service connection** ‚Üí **Azure Resource Manager**.
2. Choose **Service principal (manual)** (or ‚Äúautomatic‚Äù if you want DevOps to create one).
3. Fill in:
   - Connection name (e.g., `sc-azure`),
   - **Subscription ID/Name**,
   - **Tenant ID**,
   - **Service principal client ID**,
   - **Service principal secret**,
   - Scope level = **Subscription**
   - **Verify** ‚Üí **OK**.

> _(If the simple dialog doesn‚Äôt show your sub, click **‚Äúuse the full version of the service connection dialog‚Äù** and paste the IDs manually.)_

---

## 5Ô∏è‚É£ Test it in a **pipeline (YAML)**

Create `azure-pipelines.yml` in your repo:

```yaml
trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  azureServiceConnection: "sc-azure" # the service connection you just made
  rgName: "rg-spn-demo"
  location: "eastus"

stages:
  - stage: Smoke
    displayName: "Validate SPN can call Azure"
    jobs:
      - job: azcli
        displayName: "Create RG and list resources"
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: "Login via service connection & create RG"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az group create -n "$(rgName)" -l "$(location)"
                echo "Listing groups in subscription:"
                az group list --query "[].name" -o tsv
```

> If the job succeeds, your **Service Principal** authenticated via the **service connection** and called ARM to create/read resource groups. üéâ

---

## 6Ô∏è‚É£ (Optional) Tiny ARM/Bicep deploy to prove permissions

Swap the script with a quick **what-if** or deploy task if you prefer:

```yaml
- task: AzureCLI@2
  displayName: "What-if deploy (group)"
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az deployment group what-if \
        --resource-group "$(rgName)" \
        --template-file infra/main.bicep
```

---

## üß≠ What you just did (mental model)

- **App Registration** = global **blueprint** of your app (gives you Client ID).
- **Enterprise Application** = local **instance** of that app in your tenant (admin surface).
- **Service Principal** = the **identity** behind that Enterprise App; you assigned Azure **RBAC** to it so it can act in your subscription.
- **Service connection** = Azure DevOps wrapper that safely stores SP creds and logs in on behalf of your pipeline.

---

## üß∞ Troubleshooting quick hits

- **Cannot see subscription in DevOps dialog** ‚Üí switch to **full version** and paste IDs manually.
- **RBAC denied** ‚Üí ensure role assignment scope is correct (sub/RG) and give it a few minutes to propagate.
- **Secret expired** ‚Üí rotate in App Registration ‚Üí update the service connection.
- **Prefer secretless** ‚Üí if your workload runs in Azure, consider **Managed Identity** instead of SP for that workload.
