# üé¨ Scenario 1: On-Prem App ‚Üí Azure SQL Using App Identity

## üîê (No user ‚Äî just the app logging in with Client Credentials)

üß† **Goal:** Your **on-premises backend service** (e.g., a Node.js or .NET app) uses **its own identity** (App Registration) to connect to Azure SQL securely.

---

## ‚úÖ Step-by-Step

### 1Ô∏è‚É£ Create an App Registration

- Go to **Entra ID ‚Üí App registrations ‚Üí New registration**
- Note down:

  - `Application (client) ID`
  - `Directory (tenant) ID`

### 2Ô∏è‚É£ Create a **Client Secret**

- Certificates & Secrets ‚Üí New client secret

### 3Ô∏è‚É£ Assign Permissions

- Give access to **Azure SQL**

  - Either via:

    - **SQL-level user** (External Provider login), or
    - Azure role (Reader at resource scope if using Managed Identity ‚Äî not in this case)

### 4Ô∏è‚É£ Create the SQL User

```sql
-- Once, run this in Azure SQL (via SSMS):
CREATE USER [your-app-name] FROM EXTERNAL PROVIDER;
ALTER ROLE db_datareader ADD MEMBER [your-app-name];
```

---

## üíª Code Example (C# w/ Client Credentials Flow)

```csharp
var confidentialClient = ConfidentialClientApplicationBuilder.Create("client-id")
    .WithClientSecret("your-secret")
    .WithAuthority("https://login.microsoftonline.com/your-tenant-id")
    .Build();

var token = await confidentialClient.AcquireTokenForClient(new[] {
    "https://database.windows.net/.default"
}).ExecuteAsync();

var sqlConnection = new SqlConnection("Server=tcp:<your-sql>.database.windows.net; Authentication=Active Directory AccessToken;");
sqlConnection.AccessToken = token.AccessToken;
sqlConnection.Open();

var command = new SqlCommand("SELECT * FROM Companies", sqlConnection);
var reader = await command.ExecuteReaderAsync();
```

- ‚úÖ Uses **App Registration** (client credentials)
- ‚úÖ Gets token scoped to **Azure SQL (`aud=database.windows.net`)**
- ‚úÖ Token used for direct service-to-service auth
- ‚úÖ No user context

---

## üé¨ Scenario 2: App Controls Access Based on User Roles (App RBAC)

### üßç App + Entra ID + Roles in Token

üß† **Goal:** The app is self-hosted (on-prem or in VM), but users log in via **Microsoft Entra ID**. Only users with the `Admin` role can access `/companies`.

---

## ‚úÖ Step-by-Step

### 1Ô∏è‚É£ App Registration

- Register your app
- Set **Redirect URI** to your on-prem app (e.g. `https://mycompany.com/signin-oidc`)
- Under **Manifest**, define app roles:

```json
"appRoles": [
  {
    "allowedMemberTypes": [ "User" ],
    "displayName": "Admin",
    "id": "a-uuid",
    "isEnabled": true,
    "description": "Admins only",
    "value": "Admin"
  }
]
```

### 2Ô∏è‚É£ Enterprise App ‚Üí Assign Users

- Go to **Enterprise applications ‚Üí Your App**
- Assign users or groups the **Admin** role

### 3Ô∏è‚É£ App Integration (OIDC / OAuth2)

- Use a library like MSAL or OpenID Connect middleware (ASP.NET, Node.js, etc.)

---

## üõÇ Token Sample (Decoded)

```json
{
  "aud": "api://your-app-id",
  "upn": "user@company.com",
  "roles": ["Admin"]
}
```

---

## üíª Backend Code (e.g. Node.js)

```js
app.get("/companies", (req, res) => {
  const userRoles = req.user.roles;

  if (!userRoles.includes("Admin")) {
    return res.status(403).send("Forbidden: Admins only!");
  }

  res.send(fetchCompanyData());
});
```

---

## üß† Recap

| Scenario               | Purpose                             | Token Type                   | User Involved? | Token Used For   |
| ---------------------- | ----------------------------------- | ---------------------------- | -------------- | ---------------- |
| App ‚Üí Azure SQL        | App gets data from Azure SQL DB     | `client_credentials` token   | ‚ùå             | SQL connection   |
| App ‚Üí Protect Endpoint | Enforce role-based access for users | `id_token` or `access_token` | ‚úÖ             | Custom app logic |

---

## üîÅ AWS Comparison

| Azure App Registration         | AWS Equivalent                       |
| ------------------------------ | ------------------------------------ |
| App Registration (with secret) | IAM Role + IAM policy                |
| App RBAC                       | Cognito App Client + User Pool roles |
| Enterprise App Assignment      | Cognito Group membership             |
| Token Role Claim               | Token scopes or custom claims        |

---

## ‚úÖ Summary

- Your **on-prem app** can:

  - Authenticate **itself** to Azure services using **Client Credentials Flow**
  - Authenticate **users** with Entra ID and enforce App RBAC

- Use **App Registration** for both machine-to-machine auth and frontend user login
- Use **Enterprise App** to assign app roles to users
- You can build full **SaaS-style authorization** on-prem using **App Identity**
