# üîê Azure Network Security Group (NSG)

> An **Azure Network Security Group (NSG)** is a **stateful Layer 3‚Äì4 firewall** that filters **inbound and outbound** traffic to/from Azure resources. It‚Äôs like **AWS Security Groups**, but Azure offers **more granular control** through dual scope: **Subnet and/or NIC**.

---

<div align="center">
  <img src="images/az-nsg.png" alt="Azure NSG Overview" style="width: 80%; border-radius: 10px; border: 2px solid white;">
</div>

---

## üß± Core Capabilities of NSG

| üîß Feature                           | ‚úÖ Description                                                              |
| ------------------------------------ | --------------------------------------------------------------------------- |
| üîÑ **Stateful Rules**                | Return traffic is automatically allowed (no need to define both directions) |
| üß© **Attach to Subnet or NIC**       | Apply NSG at subnet, NIC, or both ‚Äî for layered defense                     |
| üî¢ **Priority Evaluation**           | Rules processed in order of ascending priority (lower = higher precedence)  |
| üö´ **NSGs use a whitelisting model** | Allow or Deny ‚Äî **last rule always denies** (like default deny-all)         |
| üß† **Destination Flexibility**       | Use **IPs**, **Service Tags**, or **Application Security Groups** (ASGs)    |

---

## üß≠ Rule Evaluation Logic

### üîÅ Rule Matching (Inside One NSG)

- Evaluated **top-down by priority**
- **First match wins**
- Once a rule matches (Allow or Deny), **no further rules are processed**

### üß± Scope Evaluation Order (Multiple NSGs)

| Direction    | Evaluation Order     | Notes                                        |
| ------------ | -------------------- | -------------------------------------------- |
| **Inbound**  | Subnet NSG ‚ûú NIC NSG | Traffic must be allowed by **both** NSGs     |
| **Outbound** | NIC NSG ‚ûú Subnet NSG | Both NSGs must allow it ‚Äî any deny = dropped |

üß† Final Rule Logic:

> ‚úÖ If both NSGs allow the packet ‚Üí traffic passes
> ‚ùå If **any NSG denies** ‚Üí traffic is blocked immediately

---

## üß¨ NSG Rule Anatomy (With Destination Types)

| Field                    | Description                                                       |
| ------------------------ | ----------------------------------------------------------------- |
| `name`                   | Unique rule name per NSG                                          |
| `priority`               | Range: `100` (highest) to `4096` (lowest)                         |
| `direction`              | `Inbound` or `Outbound`                                           |
| `access`                 | `Allow` or `Deny`                                                 |
| `protocol`               | `TCP`, `UDP`, `ICMP`, or `*` (any)                                |
| `source`                 | IP/CIDR, **Service Tag**, or **Application Security Group (ASG)** |
| `source_port_range`      | Usually `*`, unless port-specific filtering needed                |
| `destination`            | Same options as `source` (IP, Service Tag, ASG)                   |
| `destination_port_range` | `22`, `80`, `443`, `3389`, or range like `1024-65535`             |

---

## üéØ Destination Type Examples

| Destination Type                     | Value Example                                                | When to Use It                                |
| ------------------------------------ | ------------------------------------------------------------ | --------------------------------------------- |
| **IP Address / CIDR**                | `10.0.1.5`, `192.168.0.0/24`                                 | Directly filter to/from static IPs or subnets |
| **Service Tag**                      | `Internet`, `VirtualNetwork`, `AzureLoadBalancer`, `Storage` | Access to common Azure services or ranges     |
| **Application Security Group (ASG)** | `asg-app`, `asg-backend`                                     | Logical grouping of VMs within a VNet         |

### ‚úÖ Sample Rules with Destination Types

```json
// Allow VM access to Azure Storage
{
  "direction": "Outbound",
  "priority": 100,
  "access": "Allow",
  "destination": "Storage",               // Service Tag
  "destinationPortRange": "*",
  "source": "VirtualNetwork",
  "protocol": "*"
}

// Allow Web VMs (in asg-web) to access Backend ASG (asg-backend) on port 1433
{
  "direction": "Outbound",
  "priority": 200,
  "access": "Allow",
  "source": "asg-web",
  "destination": "asg-backend",           // ASG ‚ûú ASG
  "destinationPortRange": "1433",
  "protocol": "TCP"
}
```

---

## üîí Default NSG Rules

Azure injects 3 default rules per direction (inbound/outbound), which **can be overridden** by custom rules with higher priority.

<div align="center">
  <img src="images/az-nsg-default-security-rules.png" alt="NSG Default Rules" style="width: 80%; border-radius: 10px; border: 2px solid white;">
</div>

### ‚úÖ Inbound Defaults

| Priority | Rule Name                | Description                       |
| -------- | ------------------------ | --------------------------------- |
| 65000    | AllowVnetInbound         | Allow all traffic from same VNet  |
| 65001    | AllowAzureLoadBalancerIn | Allow from Azure LB health probes |
| 65500    | DenyAllInbound           | Deny everything else              |

### ‚úÖ Outbound Defaults

| Priority | Rule Name             | Description                            |
| -------- | --------------------- | -------------------------------------- |
| 65000    | AllowVnetOutbound     | Allow all traffic to same VNet         |
| 65001    | AllowInternetOutbound | Allow any outbound traffic to internet |
| 65500    | DenyAllOutbound       | Deny everything else                   |

---

## üåç NSG Behavior with Public IPs

### ‚úÖ Standard Public IP (Mandatory)

| Feature                         | Behavior                                         |
| ------------------------------- | ------------------------------------------------ |
| Default secure posture          | Inbound denied unless explicitly allowed via NSG |
| Works with Load Balancer or NIC | Must be paired with NSG rules                    |
| Supports zones and SLA          | ‚úÖ Recommended and required for production       |

> ‚ö†Ô∏è **Basic SKU is deprecated** ‚Äì do not use.

---

## üõ†Ô∏è How to Deploy NSGs

| Tool         | Usage Type             | Command / Resource                        |
| ------------ | ---------------------- | ----------------------------------------- |
| Azure Portal | Manual GUI             | NSG Wizard + Rule Editor                  |
| Azure CLI    | Scripting              | `az network nsg`, `az network nsg rule`   |
| PowerShell   | Admin automation       | `New-AzNetworkSecurityGroup`              |
| ARM / Bicep  | Infrastructure-as-Code | `Microsoft.Network/networkSecurityGroups` |
| Terraform    | DevOps / CI/CD         | `azurerm_network_security_group`          |

---

## üîê NSG Use Cases

| Scenario                           | Recommended NSG Strategy                                |
| ---------------------------------- | ------------------------------------------------------- |
| üß± Public Web Server               | NSG on NIC ‚Äî Allow port `80/443`, deny all others       |
| üîÅ Internal-only Backend           | NSG on subnet ‚Äî Allow traffic only from specific ASG/IP |
| üö´ Block all internet outbound     | Deny `0.0.0.0/0` in outbound rules                      |
| ‚òÅÔ∏è PaaS Integration (Storage, SQL) | Use **Service Tags** like `Storage`, `AzureSQL`         |
| üîê Tiered App Access               | Use **ASG ‚Üí ASG** rules to restrict lateral movement    |

---

## üìä Best Practices for NSGs

| üß† Best Practice                         | ‚úÖ Why It Matters                                           |
| ---------------------------------------- | ----------------------------------------------------------- |
| Use NSGs at both **subnet + NIC** levels | Enables **defense-in-depth** (macro and micro segmentation) |
| Prefer **ASGs** for internal VM control  | Scalable, tag-based, and human-readable rule definitions    |
| Use **Service Tags** for Azure services  | Prevents needing to hardcode IP ranges for PaaS endpoints   |
| Set clear **priority structure**         | Avoid overlapping rule logic ‚Äî 100 = top priority           |
| Monitor with **NSG Flow Logs**           | Troubleshoot and audit with diagnostics + Azure Monitor     |

---

## üî• NSG vs Azure Firewall

| Feature     | Network Security Group (NSG)         | Azure Firewall                          |
| ----------- | ------------------------------------ | --------------------------------------- |
| Layer       | L3 / L4 (IP, Port, Protocol)         | L3‚ÄìL7 (App rules, FQDN, TLS)            |
| Scope       | Subnet/NIC (distributed)             | Centralized (in a hub subnet)           |
| NAT Support | ‚ùå No                                | ‚úÖ Yes (SNAT/DNAT)                      |
| Logging     | Flow logs only                       | Full diagnostics, insights, threat logs |
| Best For    | Microsegmentation, traffic isolation | Deep inspection, egress control         |

> üß† **Use both together**:
>
> - NSGs = fast packet filtering
> - Azure Firewall = central control + app-layer intelligence

---

## ‚úÖ NSG Quick Recap

| üß© Topic             | üîë Key Point                                        |
| -------------------- | --------------------------------------------------- |
| Attach Scope         | Subnet, NIC, or both                                |
| Evaluation Order     | Inbound: Subnet ‚ûú NIC<br>Outbound: NIC ‚ûú Subnet     |
| Destination Types    | IP Address, Service Tag, or ASG                     |
| Rule Matching        | First match wins ‚Äî no implicit "next rule"          |
| Default Rules        | AllowVnet + DenyAll (both directions)               |
| Public IP Support    | Requires NSG if Standard SKU; secure by default     |
| Firewall Integration | Combine NSG + Azure Firewall for layered protection |
