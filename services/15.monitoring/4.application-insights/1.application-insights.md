# ğŸ“Š **Azure Application Insights (App Insights)**

> ğŸ“– **Application Insights** is Azureâ€™s **Application Performance Monitoring (APM)** tool, part of **Azure Monitor**.

Think of it as the **doctor ğŸ©º for your app**:

- Watches your appâ€™s health & performance
- Catches errors before your users do
- Helps you understand **users & usage**

---

## ğŸ“Œ **What App Insights Collects**

| Signal ğŸ“¡             | Examples                                  | Why itâ€™s useful âš¡                |
| --------------------- | ----------------------------------------- | --------------------------------- |
| **Requests**          | URLs, response time, status code          | Spot slow/failing endpoints       |
| **Dependencies**      | SQL, HTTP, Redis, queues                  | See which external calls slow you |
| **Exceptions**        | Crashes, stack traces                     | Debug failures quickly            |
| **Logs/Traces**       | `ILogger` messages, severity              | Correlate with requests           |
| **Metrics**           | CPU, memory, custom counters              | Watch capacity & SLIs             |
| **Availability**      | Global ping tests                         | Ensure uptime worldwide ğŸŒ        |
| **Usage Analytics**   | Users, sessions, retention, funnels       | Understand customer behavior      |
| **Distributed Trace** | End-to-end call flow (microservices/APIs) | Debug complex systems             |

---

## ğŸ” **Investigation Features**

These are your â€œworkbenchâ€ ğŸ›  for troubleshooting:

- **ğŸ“ Application Map** â†’ Visual graph of app + dependencies (SQL, APIs)
- **ğŸ’¥ Failures** â†’ Drill into failed requests + exceptions
- **â± Performance** â†’ P50/P95/P99 latency by endpoint
- **ğŸ“¡ Live Metrics** â†’ Real-time throughput, CPU, failure rates
- **ğŸ” Transaction Search** â†’ Search by URL, user, correlation ID
- **ğŸ“‘ Logs (KQL)** â†’ Write queries across telemetry tables
- **ğŸ¤– Smart Detection** â†’ Alerts on anomalies (sudden failure spike)

---

## ğŸ“ˆ **Usage Analytics Features**

- **ğŸ‘¤ Users/Sessions** â†’ active vs new users
- **ğŸ›’ Funnels** â†’ Track drop-offs (Login â†’ Cart â†’ Checkout)
- **ğŸ“† Retention** â†’ See who comes back after first use
- **ğŸ¯ Custom Events** â†’ e.g., `TrackEvent("OrderPlaced", {"plan":"Pro"})`

---

## âš™ï¸ **Architecture (How It Works)**

<div align="center">

```mermaid
flowchart TD
    A[Your App (.NET/Node/Java/Python)] --> B[App Insights SDK/Agent]
    B -->|Telemetry Data| C[App Insights Endpoint]
    C --> D[Azure Monitor Backend]
    D --> E[Application Insights Resource in Azure Portal]
    E --> F[Dashboards, Alerts, Logs (KQL Queries)]
```

</div>

---

## ğŸ— **Implementing in .NET MVC**

1. **Create an Application Insights resource** in Azure. Copy its **Connection String** (workspace-based is the current default).
2. **Add package**:

   ```bash
   dotnet add package Microsoft.ApplicationInsights.AspNetCore
   ```

3. **Wire up in `Program.cs`**:

   ```csharp
   var builder = WebApplication.CreateBuilder(args);

   // Option 1: from configuration (appsettings.json / env)
   builder.Services.AddApplicationInsightsTelemetry();

   // Option 2: set explicitly
   // builder.Services.AddApplicationInsightsTelemetry("InstrumentationKey=...;IngestionEndpoint=...");

   // optional: enrich logs with AI
   builder.Logging.AddApplicationInsights();

   var app = builder.Build();
   app.MapDefaultControllerRoute();
   app.Run();
   ```

4. **appsettings.json** (recommended):

   ```json
   {
     "ApplicationInsights": {
       "ConnectionString": "InstrumentationKey=xxxx;IngestionEndpoint=https://<region>.in.applicationinsights.azure.com/"
     },
     "Logging": { "LogLevel": { "Default": "Information" } }
   }
   ```

5. **Correlate your logs**  
   `ILogger` logs automatically flow as **trace** telemetry and are correlated to the current request.

6. **Track custom events** (anywhere in your code):

   ```csharp
   using Microsoft.ApplicationInsights;

   public class OrdersController : Controller
   {
       private readonly TelemetryClient _telemetry;
       public OrdersController(TelemetryClient telemetry) => _telemetry = telemetry;

       public IActionResult Checkout(string plan)
       {
           _telemetry.TrackEvent("CheckoutStarted", new() { ["plan"] = plan });
           // ... your logic
           return View();
       }
   }
   ```

7. **Capture SQL, HTTP dependencies**

   - Core SDK auto-collects outbound HTTP and EF Core SQL timings.
   - For **SqlClient**/EF6, ensure the proper diagnostic listeners are enabled (default in modern .NET).

---

---

## ğŸŒ **Availability Tests**

- Configure in **Azure Portal â†’ Availability**
- Runs **global pings** on your URLs
- Alerts on downtime/latency

---

## ğŸ•µï¸ **Distributed Tracing**

- App Insights uses **W3C Trace-Context** headers (`traceparent`, `tracestate`).
- Links **request â†’ dependency â†’ exception â†’ logs** into **1 correlated timeline**
- Works across **microservices & APIs**: youâ€™ll see a single correlated **operation id** and a timeline.

---

## âš–ï¸ **Sampling (Control Costs)**

- **Adaptive sampling** â†’ keeps representative data only
- Example config:

  ```json
  "ApplicationInsights": {
  "EnableAdaptiveSampling": true,
  "SamplingSettings": { "MaxTelemetryItemsPerSecond": 5 }
  }
  ```

---

## ğŸ›¡ **Data Filtering & Enrichment**

- **Telemetry Initializers** â†’ Add metadata to every item (e.g.,tenantId, region).
- **Telemetry Processors** â†’ Drop/modify sensitive data fields (e.g., cookie values, emails).

- Example (Core):

  ```csharp
  public class PiiFilter : ITelemetryProcessor
  {
      private ITelemetryProcessor _next;
      public PiiFilter(ITelemetryProcessor next) => _next = next;

      public void Process(ITelemetry item)
      {
          // Example: strip query strings
          if (item is RequestTelemetry r)
              r.Url = new Uri($"{r.Url.Scheme}://{r.Url.Host}{r.Url.AbsolutePath}");
          _next.Process(item);
      }
  }
  ```

  Register in DI:

  ```csharp
  builder.Services.AddApplicationInsightsTelemetryProcessor<PiiFilter>();
  ```

---

## ğŸš¨ **Alerts (Guardrails)**

### **Metric-based** (simple & fast):

- _Server response time p95 > 2s for 5 min_
- _Request failure rate > 2%_
- _Availability test failure > 0_

### **Log (KQL)-based** (precise):

- Spike in specific exception type:

  ```kusto
  exceptions
  | where type == "SqlException"
  | where timestamp > ago(5m)
  | summarize count()
  ```

Create **Alert rule** â†’ Action Group â†’ email/Teams/Webhook/PagerDuty.

---

## ğŸ“‘ **Logs (KQL) Youâ€™ll Use Often**

- **Slow endpoints (top offenders, last 24h):**

  ```kusto
  requests
  | where timestamp > ago(24h)
  | summarize p95=percentile(duration, 95ms) by name
  | top 10 by p95 desc
  ```

- **SQL calls slower than 500ms:**

  ```kusto
  dependencies
  | where type == "SQL"
  | where duration > 500ms
  | project timestamp, target, name, duration, success, resultCode, operation_Id
  | order by duration desc
  ```

- **Link request â†’ dependency â†’ exception by operation:**

  ```kusto
  let since = ago(1h);
  requests
  | where timestamp > since and success == false
  | join kind=leftouter (dependencies | where timestamp > since) on operation_Id
  | join kind=leftouter (exceptions  | where timestamp > since) on operation_Id
  | project timestamp, name, resultCode, duration, dependency=name1, depDuration=duration1, exceptionType=type, message
  | take 50
  ```

---

## ğŸ§© **Profiler & Snapshot Debugger**

- **Profiler** â†’ captures CPU hotspots on App Service
- **Snapshot Debugger** â†’ captures state when exception occurs

âš ï¸ Use carefully in Prod â†’ may expose sensitive data

---

## âœ… **Best Practices Checklist**

- âœ… Always use **Connection String** (not old keys)
- âœ… Enable **Adaptive Sampling**
- âœ… Filter out **PII** (query strings, emails)
- âœ… Add **Custom Dimensions** (tenant, environment)
- âœ… Set **Alerts** on SLA metrics (failure, p95 latency)
- âœ… Use **Workbooks** for dashboards
- âœ… Ensure **Distributed Tracing** is on
- âœ… Monitor **costs & retention**

---

## ğŸ **Summary**

- **Application Insights = full APM for your app**
- Monitors **requests, dependencies, exceptions, usage**
- Gives **real-time metrics, dashboards, and alerts**
- Easy to integrate into **.NET MVC apps** with a single SDK package
- Lets you **investigate deeply** with KQL + App Map + Failures tab
