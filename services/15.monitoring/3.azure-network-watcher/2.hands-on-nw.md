# ğŸ§ª **Lab Guide: Azure Network Watcher**

## ğŸ¯ **Lab Objectives**

By the end of this lab, you will:

1. Enable **Azure Network Watcher** in your region.
2. Use **Monitoring tools** (Topology, Connection Monitor).
3. Perform **Diagnostics** (IP Flow Verify, Effective Rules, Next Hop, Packet Capture, Connection Troubleshooting).
4. Collect and analyze **Logs** (NSG Flow Logs + Traffic Analytics).

---

## ğŸ”¹ **Step 1: Enable Network Watcher**

### ğŸ“Œ Portal

1. In Azure Portal â†’ Search **Network Watcher**.
2. Click **Enable** for your subscription/region (if not already enabled).

### ğŸ“Œ CLI

```bash
# Enable Network Watcher in East US
az network watcher configure --locations eastus --enabled true --resource-group NetworkWatcherRG
```

âœ… Now the service is ready.

---

## ğŸ‘ï¸ **Lab Part 1: Monitoring Features**

### ğŸŒ 1.1 Topology

**Scenario:** You want to see how your VMs, NICs, NSGs, and subnets are connected.

ğŸ“Œ Portal Steps:

1. Go to **Network Watcher â†’ Topology**.
2. Select your **Resource Group + VNet**.
3. Watch Azure build a live diagram ğŸ—ºï¸.

âœ… Youâ€™ll see which VM â†’ NIC â†’ Subnet â†’ NSG chain exists.

---

### ğŸ”„ 1.2 Connection Monitor

**Scenario:** Check connectivity from a Web VM â†’ SQL Database.

ğŸ“Œ Portal Steps:

1. Go to **Network Watcher â†’ Connection Monitor**.
2. Click **+ Add**.
3. **Source:** WebVM NIC, **Destination:** SQL Database (1433).
4. Start Monitoring.

ğŸ“Œ CLI:

```bash
az network watcher connection-monitor create \
  --name WebToSQLMonitor \
  --resource-group NetworkWatcherRG \
  --location eastus \
  --source-resource WebVM \
  --dest-address sqlserver123.database.windows.net \
  --dest-port 1433
```

âœ… Connection Monitor will show latency, packet loss, reachability.

---

## ğŸ” **Lab Part 2: Diagnostic Features**

### ğŸš¦ 2.1 IP Flow Verify

**Scenario:** VM canâ€™t reach SQL DB. Is NSG blocking it?

ğŸ“Œ Portal:

1. Go to **Network Watcher â†’ IP Flow Verify**.
2. Select VM NIC, Direction = Outbound, Destination = SQL DB, Port = 1433.
3. Click **Check**.

ğŸ“Œ CLI:

```bash
az network watcher test-ip-flow \
  --resource-group MyRG \
  --vm-name WebVM \
  --direction Outbound \
  --protocol TCP \
  --local 10.0.1.5:50000 \
  --remote 52.167.220.45:1433
```

âœ… Result will say `ALLOW` or `DENY` with the exact NSG rule.

---

### ğŸ” 2.2 Effective Security Rules

**Scenario:** Your NSGs are complicated, which rule actually applies?

ğŸ“Œ Portal:

1. Go to **Network Watcher â†’ Effective Security Rules**.
2. Select VM NIC.
3. Azure shows the **merged NSG rules**.

âœ… Helps you find conflicts like `DenyAll` shadowing `AllowHTTP`.

---

### ğŸ›£ï¸ 2.3 Next Hop

**Scenario:** VM traffic goes to the wrong place.

ğŸ“Œ Portal:

1. Go to **Network Watcher â†’ Next Hop**.
2. Enter Source = VM NIC, Destination = 8.8.8.8.
3. See Next Hop (Internet / NVA / Blackhole).

ğŸ“Œ CLI:

```bash
az network watcher show-next-hop \
  --resource-group MyRG \
  --vm-name WebVM \
  --source-ip 10.0.1.5 \
  --dest-ip 8.8.8.8
```

âœ… Reveals if UDR is misrouting traffic.

---

### ğŸ“¦ 2.4 Packet Capture

**Scenario:** You suspect slow TLS negotiation.

ğŸ“Œ Portal:

1. Go to **Network Watcher â†’ Packet Capture**.
2. Select VM â†’ NIC.
3. Choose filters (port 443 only).
4. Start Capture â†’ Download `.cap` â†’ Analyze in Wireshark.

ğŸ“Œ CLI:

```bash
az network watcher packet-capture create \
  --name TLSCapture \
  --resource-group MyRG \
  --vm WebVM \
  --storage-account mystorageacct \
  --time-limit 300
```

âœ… Gives raw packet-level details.

---

### ğŸ” 2.5 Connection Troubleshooting

**Scenario:** App VM canâ€™t reach Internet.

ğŸ“Œ Portal:

1. Go to **Network Watcher â†’ Connection Troubleshoot**.
2. Source = WebVM, Destination = [www.microsoft.com:443](http://www.microsoft.com:443).
3. Run test.

ğŸ“Œ CLI:

```bash
az network watcher test-connectivity \
  --source-resource WebVM \
  --dest-address www.microsoft.com \
  --dest-port 443
```

âœ… Returns details: Success/Fail + where it failed (NSG, Route, DNS).

---

### ğŸ”’ 2.6 VPN Troubleshooting

**Scenario:** Site-to-site VPN tunnel is down.

ğŸ“Œ Portal:

1. Go to **Network Watcher â†’ VPN Troubleshoot**.
2. Select VPN Gateway.
3. Run diagnostics.

âœ… Finds root cause: bad shared key, unreachable peer, etc.

---

## ğŸ“œ **Lab Part 3: Logging Features**

### ğŸ“Š 3.1 NSG Flow Logs

**Scenario:** You want to see _who_ has been trying to access your VMs.

ğŸ“Œ Portal:

1. Go to **Network Watcher â†’ NSG Flow Logs**.
2. Select your NSG â†’ Enable.
3. Choose **Storage Account / Log Analytics / Event Hub** as destination.

ğŸ“Œ CLI:

```bash
az network watcher flow-log configure \
  --resource-group MyRG \
  --nsg WebVM-NSG \
  --enabled true \
  --storage-account mystorageacct \
  --retention 7
```

âœ… Flow logs show Allowed/Deny flows with timestamps.

---

### ğŸ“ˆ 3.2 Traffic Analytics

**Scenario:** Whoâ€™s hogging all the bandwidth?

ğŸ“Œ Portal:

1. Go to **Network Watcher â†’ Traffic Analytics**.
2. Link it to your **NSG Flow Logs + Log Analytics Workspace**.
3. Open dashboard.

âœ… See top talkers, inbound/outbound trends, malicious IPs.
