# 📘 Kusto Query Language (KQL) — Mastery Guide for Azure Monitor Logs

## 🏗️ **1. What is KQL?**

- **Definition**:
  KQL = **read-only query language** for Azure Monitor Logs, Application Insights, Microsoft Sentinel, and more.
- It is NOT SQL. It’s:

  - Optimized for **time-series telemetry**.
  - Always **select-only** (no UPDATE/DELETE).
  - Pipeline-based: queries are built by chaining commands with `|` (like PowerShell / Linux pipes).

Think of it like Lego blocks 🧱: you take a table, filter it, summarize it, join it, visualize it.

---

## 🗃️ **2. KQL Data Basics**

Every query starts with a **table**. Examples in Azure Monitor:

- `Heartbeat` → VM heartbeat pings.
- `Perf` → performance counters (CPU, memory).
- `Event` → Windows event logs.
- `AzureActivity` → subscription activity logs.
- `SigninLogs` → user sign-ins (from Entra ID).

---

## 🔍 **3. The Basic Query Skeleton**

```kql
TableName
| where <filter_condition>
| project <columns_you_want>
| summarize <aggregations>
| order by <column> desc
```

### Example 1: Find all VMs reporting in last hour

```kql
Heartbeat
| where TimeGenerated > ago(1h)
| summarize LastSeen=max(TimeGenerated) by Computer
```

### Example 2: Top 5 processes by memory

```kql
Perf
| where ObjectName == "Process" and CounterName == "Working Set - Private"
| summarize AvgMemoryMB=avg(CounterValue/1024/1024) by InstanceName
| top 5 by AvgMemoryMB desc
```

---

## 🎯 **4. Operators You Must Know**

### 🔹 **Filtering**

```kql
where TimeGenerated > ago(1d) and Computer == "vm01"
```

### 🔹 **Projection**

```kql
project TimeGenerated, Computer, EventLevelName, RenderedDescription
```

### 🔹 **Aggregation**

```kql
summarize AvgCPU=avg(CounterValue) by bin(TimeGenerated, 5m), Computer
```

### 🔹 **Sorting**

```kql
order by TimeGenerated desc
```

### 🔹 **Top N**

```kql
top 10 by CounterValue desc
```

---

## 🧩 **5. Time Functions (must-have for monitoring)**

- `ago(1h)` → last 1 hour
- `bin(TimeGenerated, 5m)` → group logs into 5-minute buckets
- `datetime_add('hour', -3, now())` → 3 hours ago

Example: Average CPU in last 24h by 15-min chunks

```kql
Perf
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| summarize AvgCPU=avg(CounterValue) by bin(TimeGenerated, 15m), Computer
```

---

## 🔗 **6. Joins**

Sometimes you want to correlate different tables (like CPU metrics with Event Logs).

```kql
Heartbeat
| join kind=inner (
    Event | where EventLevelName == "Error"
) on Computer
```

---

## 📊 **7. Visualization Shortcuts**

KQL can directly produce charts:

- `render timechart`
- `render barchart`
- `render piechart`

Example:

```kql
SigninLogs
| summarize Count=count() by AppDisplayName
| render piechart
```

---

## 🛠️ **8. Advanced Goodies**

### 🔹 `extend` → create new calculated column

```kql
Perf
| extend MemoryGB = CounterValue / 1024 / 1024
```

### 🔹 `parse` → extract values from text

```kql
Event
| parse RenderedDescription with "User=" UserName " Action=" ActionName
```

### 🔹 `union` → combine tables

```kql
union Event, SecurityEvent
```

---

## 🎓 **9. Step-by-Step Lab to Practice**

### Lab 1: Check VM heartbeats

```kql
Heartbeat
| summarize LastSeen=max(TimeGenerated) by Computer
```

### Lab 2: CPU spike detection (>80%)

```kql
Perf
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| summarize AvgCPU=avg(CounterValue) by bin(TimeGenerated, 5m), Computer
| where AvgCPU > 80
```

### Lab 3: Failed logins (security logs)

```kql
SigninLogs
| where ResultType != "0"
| project UserPrincipalName, AppDisplayName, IPAddress, TimeGenerated
```

### Lab 4: Top 5 storage operations

```kql
StorageBlobLogs
| summarize Count=count() by OperationName
| top 5 by Count desc
```

---

## 🧭 **10. Learning Path**

1. Start with **`Heartbeat`, `Perf`, `Event`** tables.
2. Play with `where`, `project`, `summarize`.
3. Try time bucketing with `bin()`.
4. Move into **joins** and **parse()**.
5. Finally, practice building **dashboards with render**.

## 📚 Courses

1. [Ten Minute KQL](https://www.youtube.com/watch?v=8JqwHaIW_Zc&list=PLuIShsT8L3sCjndVr4iwT4Uyh6aquB3q2&index=15)
2. [John Savill's Technical](https://www.youtube.com/watch?v=Pl8n6GaWEo0)

---

> 💡 **Pro Tip:**
> If you ever forget syntax, in the Logs blade there’s a **Query Explorer** with sample KQL snippets for every table. That’s like your cheat sheet.
