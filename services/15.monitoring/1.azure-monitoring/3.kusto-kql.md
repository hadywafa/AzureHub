# ğŸ“˜ Kusto Query Language (KQL) â€” Mastery Guide for Azure Monitor Logs

## ğŸ—ï¸ **1. What is KQL?**

- **Definition**:
  KQL = **read-only query language** for Azure Monitor Logs, Application Insights, Microsoft Sentinel, and more.
- It is NOT SQL. Itâ€™s:

  - Optimized for **time-series telemetry**.
  - Always **select-only** (no UPDATE/DELETE).
  - Pipeline-based: queries are built by chaining commands with `|` (like PowerShell / Linux pipes).

Think of it like Lego blocks ğŸ§±: you take a table, filter it, summarize it, join it, visualize it.

---

## ğŸ—ƒï¸ **2. KQL Data Basics**

Every query starts with a **table**. Examples in Azure Monitor:

- `Heartbeat` â†’ VM heartbeat pings.
- `Perf` â†’ performance counters (CPU, memory).
- `Event` â†’ Windows event logs.
- `AzureActivity` â†’ subscription activity logs.
- `SigninLogs` â†’ user sign-ins (from Entra ID).

---

## ğŸ” **3. The Basic Query Skeleton**

```kql
TableName
| where <filter_condition>
| project <columns_you_want>
| summarize <aggregations>
| order by <column> desc
```

### Example 1: Find all VMs reporting in last hour

```kql
Heartbeat
| where TimeGenerated > ago(1h)
| summarize LastSeen=max(TimeGenerated) by Computer
```

### Example 2: Top 5 processes by memory

```kql
Perf
| where ObjectName == "Process" and CounterName == "Working Set - Private"
| summarize AvgMemoryMB=avg(CounterValue/1024/1024) by InstanceName
| top 5 by AvgMemoryMB desc
```

---

## ğŸ¯ **4. Operators You Must Know**

### ğŸ”¹ **Filtering**

```kql
where TimeGenerated > ago(1d) and Computer == "vm01"
```

### ğŸ”¹ **Projection**

```kql
project TimeGenerated, Computer, EventLevelName, RenderedDescription
```

### ğŸ”¹ **Aggregation**

```kql
summarize AvgCPU=avg(CounterValue) by bin(TimeGenerated, 5m), Computer
```

### ğŸ”¹ **Sorting**

```kql
order by TimeGenerated desc
```

### ğŸ”¹ **Top N**

```kql
top 10 by CounterValue desc
```

---

## ğŸ§© **5. Time Functions (must-have for monitoring)**

- `ago(1h)` â†’ last 1 hour
- `bin(TimeGenerated, 5m)` â†’ group logs into 5-minute buckets
- `datetime_add('hour', -3, now())` â†’ 3 hours ago

Example: Average CPU in last 24h by 15-min chunks

```kql
Perf
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| summarize AvgCPU=avg(CounterValue) by bin(TimeGenerated, 15m), Computer
```

---

## ğŸ”— **6. Joins**

Sometimes you want to correlate different tables (like CPU metrics with Event Logs).

```kql
Heartbeat
| join kind=inner (
    Event | where EventLevelName == "Error"
) on Computer
```

---

## ğŸ“Š **7. Visualization Shortcuts**

KQL can directly produce charts:

- `render timechart`
- `render barchart`
- `render piechart`

Example:

```kql
SigninLogs
| summarize Count=count() by AppDisplayName
| render piechart
```

---

## ğŸ› ï¸ **8. Advanced Goodies**

### ğŸ”¹ `extend` â†’ create new calculated column

```kql
Perf
| extend MemoryGB = CounterValue / 1024 / 1024
```

### ğŸ”¹ `parse` â†’ extract values from text

```kql
Event
| parse RenderedDescription with "User=" UserName " Action=" ActionName
```

### ğŸ”¹ `union` â†’ combine tables

```kql
union Event, SecurityEvent
```

---

## ğŸ“ **9. Step-by-Step Lab to Practice**

### Lab 1: Check VM heartbeats

```kql
Heartbeat
| summarize LastSeen=max(TimeGenerated) by Computer
```

### Lab 2: CPU spike detection (>80%)

```kql
Perf
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| summarize AvgCPU=avg(CounterValue) by bin(TimeGenerated, 5m), Computer
| where AvgCPU > 80
```

### Lab 3: Failed logins (security logs)

```kql
SigninLogs
| where ResultType != "0"
| project UserPrincipalName, AppDisplayName, IPAddress, TimeGenerated
```

### Lab 4: Top 5 storage operations

```kql
StorageBlobLogs
| summarize Count=count() by OperationName
| top 5 by Count desc
```

---

## ğŸ§­ **10. Learning Path**

1. Start with **`Heartbeat`, `Perf`, `Event`** tables.
2. Play with `where`, `project`, `summarize`.
3. Try time bucketing with `bin()`.
4. Move into **joins** and **parse()**.
5. Finally, practice building **dashboards with render**.

## ğŸ“š Courses

1. [Ten Minute KQL](https://www.youtube.com/watch?v=8JqwHaIW_Zc&list=PLuIShsT8L3sCjndVr4iwT4Uyh6aquB3q2&index=15)
2. [John Savill's Technical](https://www.youtube.com/watch?v=Pl8n6GaWEo0)

---

> ğŸ’¡ **Pro Tip:**
> If you ever forget syntax, in the Logs blade thereâ€™s a **Query Explorer** with sample KQL snippets for every table. Thatâ€™s like your cheat sheet.
