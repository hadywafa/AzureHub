# ðŸ§ª Lab Guide: Azure Monitor Alerts

## âš¡ Part 1: Metric Alerts Lab

ðŸ“Œ **Goal**: Alert when a VMâ€™s CPU goes above 80% for 5 minutes.

---

### ðŸ”¹ Step 1: Open Azure Monitor

1. Go to **Azure Portal** â†’ Search **Monitor** â†’ Select **Alerts**.
2. Click **+ Create â†’ Alert rule**.

---

### ðŸ”¹ Step 2: Select Scope

1. Under **Scope**, click **Select resource**.
2. Pick your **Virtual Machine** â†’ **Apply**.

---

### ðŸ”¹ Step 3: Define Condition

1. In **Condition**, click **Add condition**.
2. Choose **Signal type = Metrics**.
3. Pick **Percentage CPU** metric.
4. Configure:

   - **Threshold**: Static
   - **Operator**: Greater than
   - **Value**: 80
   - **Aggregation**: Average
   - **Over**: Last 5 minutes

---

### ðŸ”¹ Step 4: Create Action Group

1. Click **Add Action Groups â†’ + Create Action Group**.
2. Enter name: `Ops-CPU-Alert-AG`.
3. Notifications: Email = `ops-team@company.com`.
4. Actions: Optional â€” Add **Automation Runbook** (restart VM).
5. Save.

---

### ðŸ”¹ Step 5: Review & Create

Click **Review + Create** â†’ âœ… Done.

ðŸ’¡ Test it: Stress the VM (`CPU Stress tool` inside VM). The alert should fire within 5â€“10 min.

---

## ðŸ“œ Part 2: Log Alerts Lab

ðŸ“Œ **Goal**: Alert if more than 10 failed logins occur in 5 minutes.

---

### ðŸ”¹ Step 1: Pre-req

- Make sure VM is sending logs to a **Log Analytics Workspace** (via **Diagnostic Settings + AMA extension**).

---

### ðŸ”¹ Step 2: Create Query

1. Go to **Azure Monitor â†’ Logs**.
2. Select workspace â†’ Paste this **KQL query**:

```kql
SigninLogs
| where ResultType != "0"
| summarize FailedAttempts = count() by IPAddress, bin(TimeGenerated, 5m)
| where FailedAttempts > 10
```

ðŸ‘‰ This groups failed sign-ins by IP in 5-minute buckets.

---

### ðŸ”¹ Step 3: Save Query

- Click **Save â†’ Save as Function** or directly use in alert.

---

### ðŸ”¹ Step 4: Create Alert Rule

1. In **Logs blade**, click **+ New Alert Rule**.
2. Scope: your **Log Analytics Workspace**.
3. Condition: Paste KQL query.

   - **Evaluation frequency**: 5 min
   - **Lookback period**: 5 min
   - **Threshold**: > 0 results

---

### ðŸ”¹ Step 5: Action Group

1. Reuse `Ops-CPU-Alert-AG` or create new.
2. Optionally: Add a **Logic App** â†’ Block IP / Notify SOC.

---

### ðŸ”¹ Step 6: Review + Create

âœ… Alert created.

ðŸ’¡ Test it: Try **wrong password login attempts** on VM â†’ see if alert fires.

---

## ðŸ› ï¸ Part 3: Activity Log Alerts Lab

ðŸ“Œ **Goal**: Alert if someone **deletes a VM**.

---

### ðŸ”¹ Step 1: Create Alert

1. Azure Portal â†’ **Monitor â†’ Alerts â†’ + Create Alert Rule**.
2. Scope: **Subscription** (since Activity Logs are subscription-wide).

---

### ðŸ”¹ Step 2: Condition

1. Select **Signal type = Activity Log**.
2. Event Category = `Administrative`.
3. Operation Name = `Delete Virtual Machine`.

---

### ðŸ”¹ Step 3: Action Group

- Create Action Group â†’ Notify **Security team via Teams webhook**.

---

### ðŸ”¹ Step 4: Review + Create

âœ… Done.

ðŸ’¡ Test: Delete a test VM â†’ The alert should fire immediately (Activity Logs are near real-time).

---

## ðŸ”„ How Alerts Fit Together

```mermaid
flowchart TD
  A[Data Sources] --> B[Azure Monitor]
  B --> C{Alert Rules}
  C -->|Condition True| D[Action Group]
  D --> E[Email/SMS/Teams]
  D --> F[Automation Runbook]
  D --> G[Logic App / ITSM]
```

- Metrics â†’ Fast, numeric (CPU, Disk).
- Logs â†’ Rich, custom conditions (KQL).
- Activity â†’ Governance/security (resource changes).

---

## ðŸ’¡ Best Practices for Labs

- **Always test alerts** before production.
- Use **dynamic thresholds** for metrics when baselines fluctuate.
- Route **critical alerts â†’ PagerDuty/On-Call**, minor â†’ Email only.
- Use **Action Groups wisely** (donâ€™t spam same team with 100 alerts).

---

âœ… By completing this lab, you can now:

- Build **Metric Alerts** (performance thresholds).
- Build **Log Alerts** (KQL-based).
- Build **Activity Alerts** (governance/security).
