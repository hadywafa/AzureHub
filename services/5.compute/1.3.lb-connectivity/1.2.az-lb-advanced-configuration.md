# âš–ï¸ Azure Load Balancer â€” Advanced Configuration Considerations

> This section is about **fine-tuning your Azure Load Balancer** so it doesnâ€™t just _work_, but works **optimally, securely, and with the right feature set**.

---

## 1ï¸âƒ£ Sticky Sessions (Session Persistence) ğŸª

### ğŸ“Œ What It Is

A **sticky session** (also called _session affinity_) ensures that once a client connects to a backend VM, **all future requests from that same client go to the same VM** for the lifetime of the session.

---

### ğŸ” How It Works in Azure LB

- **Session persistence** is configured **per Load Balancing Rule**.
- Azure LB uses **Source IP Affinity** (a.k.a. _2-tuple_ or _3-tuple_ hashing) to make sure the same client IP hits the same backend.

| Mode                     | Description                                          | Example                                  |
| ------------------------ | ---------------------------------------------------- | ---------------------------------------- |
| **None**                 | No persistence, each request is routed independently | Good for stateless APIs                  |
| **Client IP**            | Maps based on clientâ€™s IP address                    | All requests from 203.0.113.25 â†’ same VM |
| **Client IP + Protocol** | Maps based on client IP + protocol (TCP/UDP)         | HTTP vs HTTPS connections separated      |

---

### ğŸ’¡ Use Case

- âœ… When backend VMs store **local session state** (e.g., ASP.NET in-process session state) rather than using Redis/AppFabric/SQL Session State.
- âš ï¸ Not recommended for truly stateless apps â€” it can create uneven load distribution.

---

## 2ï¸âƒ£ Matching SKUs (Public IP & Load Balancer) ğŸ¯

### ğŸ“Œ What It Is

Your **Public IP Address SKU** must match your **Load Balancer SKU** â€” otherwise, they wonâ€™t work together.

---

### ğŸ” Why It Matters

- **Basic Public IP** â†” **Basic Load Balancer**
- **Standard Public IP** â†” **Standard Load Balancer**
- A mismatch = failed frontend binding.

---

### ğŸ“Š Feature Differences

| Feature            | Basic SKU            | Standard SKU               |
| ------------------ | -------------------- | -------------------------- |
| Availability Zones | âŒ                   | âœ…                         |
| Cross-region LB    | âŒ                   | âœ…                         |
| Secure by default  | âŒ (Open by default) | âœ… (Closed unless allowed) |
| SLA                | None                 | 99.99%                     |

---

### ğŸ’¡ Best Practice

- Always check SKU match **before** associating IP with LB.
- For production â€” **always** use Standard SKU (better security + HA + SLA).

---

## 3ï¸âƒ£ Floating IPs (Direct Server Return) ğŸŒŠ

### ğŸ“Œ What It Is

Enables **Direct Server Return (DSR)** â€” where the **frontend IP + backend port are the same** for multiple backends, and backend VMs can reply directly to the client without going back through the LB.

---

### ğŸ” How It Works

- Enabled **per Load Balancing Rule**.
- Used for **HA configurations** (e.g., SQL Always On, NLB migration).

---

**Traffic Flow Example with Floating IP ON:**

```mermaid
sequenceDiagram
    Client->>Azure LB: TCP 1433
    Azure LB->>SQL Node 1: TCP 1433 (no SNAT)
    SQL Node 1->>Client: Direct TCP response
```

---

### ğŸ’¡ Use Case

- Database clustering (SQL Always On, MySQL HA)
- Failover scenarios where IP must remain constant

âš ï¸ **Not for web apps** â€” they usually require the LB to handle all responses.

---

## 4ï¸âƒ£ HA Ports (High Availability Ports) ğŸšª

### ğŸ“Œ What It Is

A **catch-all load balancing mode** â€” instead of defining individual LB rules for each port, you enable HA Ports so **all TCP/UDP ports** are load balanced.

---

### ğŸ” How It Works

- Applies to **internal load balancers** only (for backend workloads).
- Single LB rule â†’ matches **all ports, all protocols**.
- Health probes still required to check backend availability.

---

### ğŸ’¡ Use Case

- NVA (Network Virtual Appliances)
- Azure Firewall load balancing
- VPN gateways needing multi-port handling

---

## ğŸ“¦ Summary Table â€” Advanced LB Options

| Feature         | Purpose                      | Where to Use               | Caution                 |
| --------------- | ---------------------------- | -------------------------- | ----------------------- |
| Sticky Sessions | Keep same client on same VM  | Local session state apps   | Uneven load possible    |
| Matching SKUs   | Ensure IP & LB compatibility | All deployments            | Mismatch = broken LB    |
| Floating IPs    | Direct Server Return for HA  | DB clusters, NLB migration | Not for normal web apps |
| HA Ports        | LB all ports/protocols       | NVAs, Azure Firewall       | Internal LB only        |

---

## ğŸ’¡ Quick Best Practices

- âœ… Use **Standard SKU** for production
- âœ… Enable **HA Ports** for appliances needing full port handling
- âœ… Avoid Sticky Sessions for stateless apps
- âœ… Document **SKU match** in infra diagrams to avoid config issues
