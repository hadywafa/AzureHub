# ğŸ” Azure VM Disk Encryption

There are **3 main ways Azure encrypts your VM disks**, and **only one** of them works inside the VM (like a **client**) â€” thatâ€™s **ADE**.

| ğŸ’¡ Your Understanding        | âœ… Azure Name                    | ğŸ“ Where It Happens                    | ğŸ”’ What It Protects                                          |
| ---------------------------- | -------------------------------- | -------------------------------------- | ------------------------------------------------------------ |
| 1ï¸âƒ£ **OS-level encryption**   | **Azure Disk Encryption (ADE)**  | _Inside the VM_ (BitLocker / dm-crypt) | Volumes (C: / D:), encrypted by the **VM itself**            |
| 2ï¸âƒ£ **Disk-level encryption** | **Server-Side Encryption (SSE)** | _Azure Storage layer_                  | Data on **managed disks** (OS & data disks)                  |
| 3ï¸âƒ£ **Host-level encryption** | **Encryption at Host**           | _On the physical Azure host_           | **All disks**, **temp disks**, and **caches** before writing |

---

## ğŸ§  Think of It Like This:

### ğŸ”¹ 1. **ADE = Inside the Guest OS**

- Agent runs **inside the VM**
- Encrypts volumes using OS-native tools (BitLocker/Linux dm-crypt)
- Requires **Azure Key Vault**
- Needs **reboot**
- Like **client-side encryption**

### ğŸ”¹ 2. **SSE = On Disk in Azure Storage**

- **Default** for all managed disks
- Transparent, automatic encryption at-rest (like EBS with default KMS)
- You can optionally use **Customer-Managed Keys (CMK)**

### ğŸ”¹ 3. **Encryption at Host = Extra Layer**

- Ensures **temp disks + cache** are encrypted
- Happens **on Azure host**, before any data is persisted to disk
- Useful for **full data protection including ephemeral storage**

### ğŸ” Combined = Layered Security

When enabled together, this is how the layers apply:

```ini
[Inside VM: ADE] â”€> [Encryption at Host] â”€> [Azure Storage SSE]
```

ğŸ’ª You can **combine**:

- **ADE + SSE**
- **SSE + CMK**
- **Encryption at Host + SSE**
- Or even **all 3 together**

---

## 1ï¸âƒ£ Azure Disk Encryption (ADE) â€“ _Guest-OS Level Encryption_

**ğŸ’¡ What it is:**
Encrypts virtual disks **from inside the VM**, using the OSâ€™s native tools:

- ğŸªŸ Windows: **BitLocker**
- ğŸ§ Linux: **dm-crypt**

ADE runs as a **VM extension**, and integrates with **Azure Key Vault** to manage keys.

<div align="center">
  <img src="images/vm-disk-encypt-2.png" alt="Azure VM Disk Encryption Key Components" style="width: 40%; border-radius: 10px;">
</div>

### âš™ï¸ Key Features

| Feature            | Details                                                    |
| ------------------ | ---------------------------------------------------------- |
| ğŸ“ Scope           | OS & Data Disks (not temp disks)                           |
| ğŸ”‘ Key Store       | Azure Key Vault â€“ required - **Must be in same vm region** |
| ğŸ”„ Agent           | ADE extension runs inside the VM                           |
| ğŸ” Requires Reboot | Yes â€“ applies BitLocker or dm-crypt                        |
| ğŸš« Limitations     | Not supported on Ultra Disks, A-series, <2 GB RAM VMs      |
| ğŸ§© Encryption Type | Volume-level, like LUKS / BitLocker                        |
| ğŸ”“ Decryption      | Happens in-guest, keys fetched from Azure Key Vault        |

### ğŸ†š Compared to AWS:

| Concept in AWS              | Equivalent in Azure         |
| --------------------------- | --------------------------- |
| BitLocker or LUKS in EC2    | Azure Disk Encryption (ADE) |
| KMS-managed client-side key | Azure Key Vault-managed key |

---

## 2ï¸âƒ£ Server-Side Encryption (SSE) â€“ _Storage-Level_

**ğŸ’¡ What it is:**
This is **transparent encryption at rest** for all **Azure Managed Disks** (OS/Data). It happens **before** data is written to Azure Storage.

### ğŸ” Always On by Default

- Uses **AES-256**
- Encrypts at the storage service layer
- **No performance hit** or agent needed

### 1ï¸âƒ£ **Server-Side Encryption (SSE) with Platform-Managed Keys (PMK)**

**ğŸ”§ Default for all disks!**

| Feature          | Description                                       |
| ---------------- | ------------------------------------------------- |
| ğŸ”’ Key Ownership | Microsoft-managed                                 |
| âœ… Automatic     | Enabled by default on all new disks               |
| ğŸ“¦ Key Rotation  | Managed by Azure                                  |
| ğŸ› ï¸ Use Case      | Low-risk workloads, where Microsoft controls keys |

ğŸ’¡ _AWS Equivalent_: **EBS default encryption with AWS-managed key (aws/ebs)**

---

### 2ï¸âƒ£ **Server-Side Encryption with Customer-Managed Keys (CMK)**

**ğŸ” For sensitive workloads needing key control!**

| Feature          | Description                               |
| ---------------- | ----------------------------------------- |
| ğŸ”‘ Key Ownership | You (stored in Azure Key Vault)           |
| ğŸ”„ Key Rotation  | Manual or automatic                       |
| ğŸ“˜ Prerequisites | Azure Key Vault + Access Policies or RBAC |
| âœ… Supported On  | OS + data disks, snapshots, images        |

ğŸ’¡ _AWS Equivalent_: **EBS encryption with KMS CMK (user-managed)**

ğŸ› ï¸ Example Scenarios:

- Financial, healthcare workloads needing compliance (HIPAA, PCI)
- Audit and control requirements
- Key revocation capabilities

---

### 3ï¸âƒ£ **Double Encryption (Optional)**

**ğŸ¯ Add a second layer of protection!**

| Feature        | Description                                          |
| -------------- | ---------------------------------------------------- |
| ğŸ” Layers      | Disk encrypted with **CMK**, then again with **PMK** |
| ğŸ›¡ï¸ Security    | Extra defense-in-depth                               |
| âš™ï¸ Requirement | Disk must be encrypted with CMK                      |

ğŸ’¡ _AWS Equivalent_: âŒ _Not natively supported_

---

### ğŸ†š Compared to AWS:

| AWS Concept                      | Azure Equivalent                     |
| -------------------------------- | ------------------------------------ |
| EBS default KMS-based encryption | SSE with Platform-Managed Keys (PMK) |
| EBS with CMK                     | SSE with Customer-Managed Key (CMK)  |

---

## 3ï¸âƒ£ Encryption at Host â€“ _Physical Host Level Encryption_

**ğŸ’¡ What it is:**
Encrypts **all disk I/O** on the **Azure compute host** **before data ever reaches Azure Storage**. This includes:

- Temp disk (`D:` on Windows, `/dev/sdb1` on Linux)
- Host-level disk cache
- Writes from OS/Data disks (in addition to SSE)

### ğŸ§© Scope

| Encrypted        | Notes                                          |
| ---------------- | ---------------------------------------------- |
| OS Disk writes   | Yes â€“ before writing to storage                |
| Data Disk writes | Yes â€“ before writing to storage                |
| Temp Disk        | âœ… Yes â€“ encrypted, even though not persistent |
| Host Cache       | âœ… Yes                                         |
| Boot Diagnostics | âœ… Yes                                         |

### âš™ï¸ Important Notes

- Must be **enabled at VM creation**
- **Not available** on all VM sizes (check support)
- Cannot be disabled after creation

### ğŸ†š Compared to AWS:

| AWS Concept                           | Azure Equivalent   |
| ------------------------------------- | ------------------ |
| Nitro-based ephemeral disk encryption | Encryption at Host |

---

## ğŸ” How They Work Together

### ğŸ’¡ Example: ADE + SSE + Host Encryption

1. ğŸ§  **Guest OS (ADE)** encrypts disk volumes using BitLocker or dm-crypt
2. ğŸ§Š **Encryption at Host** encrypts everything (even temp disks) before itâ€™s persisted
3. ğŸ” **SSE** encrypts managed disk data at rest in Azure Storage

---

## âœ… Summary Table

| Layer              | Azure Feature                | Required?   | Covers                        | Notes                          |
| ------------------ | ---------------------------- | ----------- | ----------------------------- | ------------------------------ |
| VM OS Encryption   | Azure Disk Encryption (ADE)  | âŒ Optional | OS + data volumes (inside VM) | Needs agent + reboot           |
| Storage Encryption | Server-Side Encryption (SSE) | âœ… Default  | Disks at rest in Azure        | Transparent + supports CMK     |
| Host Encryption    | Encryption at Host           | âŒ Optional | Temp disk, cache, all writes  | Must be enabled at VM creation |

---

## ğŸ¤” What to Choose?

| Use Case                                  | Recommended Encryption Layers           |
| ----------------------------------------- | --------------------------------------- |
| âœ… Basic protection (default)             | SSE with Microsoft-managed keys         |
| ğŸ›¡ï¸ BYOK or strict compliance needed       | SSE with Customer-managed keys (CMK)    |
| ğŸ” In-guest encryption required by policy | ADE (in addition to SSE)                |
| ğŸ§¯ Temp disk & cache must be encrypted    | Enable Encryption at Host               |
| ğŸ” Maximum protection                     | Combine: ADE + SSE + Encryption at Host |

---

## ğŸ’¡ Tips for AWS Users

| AWS Concept            | Azure Equivalent              |
| ---------------------- | ----------------------------- |
| EC2 Nitro + KMS        | Host Encryption + SSE         |
| BitLocker + KMS on EC2 | ADE with Azure Key Vault      |
| EBS default encryption | SSE with MMK                  |
| EBS with KMS CMK       | SSE with Customer-managed key |

---

## ğŸ›‘ Important Notes

- **ADE** introduces **VM reboot** and needs **manual key management**
- **SSE** is **always-on** and safest for most workloads
- **Encryption at Host** only applies if enabled at **VM creation**
- Combining all 3 adds **maximum protection**, but also **operational complexity**
