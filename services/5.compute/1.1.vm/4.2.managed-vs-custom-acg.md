# 💾 Azure Managed Images vs Custom Images (Azure Compute Gallery)

## 📌 1. Overview

In Azure, **VM images** are templates used to deploy new VMs with pre-configured OS, settings, and applications.
They can be stored as **standalone Managed Images** or as **Custom Images in Azure Compute Gallery (ACG)**.

Think of this like **AWS AMIs**:

- **Managed Image** = Basic AMI stored in one region
- **Custom Image in ACG** = Versioned, globally replicable AMI

---

## 🗂 2. Image Types in Context

| Type                   | Best For                            | AWS Equivalent                               |
| ---------------------- | ----------------------------------- | -------------------------------------------- |
| **Managed Image**      | Simple, single-region deployments   | AMI without cross-region copy                |
| **Custom Image (ACG)** | Multi-region, versioned deployments | AMI with cross-region copy & version control |

---

## 🔍 3. Detailed Comparison

| Feature                  | Managed Image               | Custom Image (Azure Compute Gallery)      |
| ------------------------ | --------------------------- | ----------------------------------------- |
| **Versioning**           | ❌                          | ✅ Multiple versions (e.g., 1.0.0, 1.1.0) |
| **Regional Replication** | ❌                          | ✅ To selected regions                    |
| **Scope**                | Single region               | Global (if replicated)                    |
| **Storage**              | Managed disk resource       | Gallery-managed storage                   |
| **OS State**             | Generalized or Specialized  | Generalized or Specialized                |
| **Use Case**             | Small scale, no replication | Enterprise, HA, DR, compliance            |
| **Replication Modes**    | N/A                         | Shallow (metadata only) or full           |

---

## 🧰 4. OS State Types

- **Generalized**:
  Cleans machine-specific info (hostname, SID, SSH keys). Requires customization on first boot.

  - Windows:

    ```powershell
    sysprep.exe /oobe /generalize /mode:vm /shutdown
    ```

  - Linux:

    ```bash
    sudo waagent -deprovision+user
    ```

- **Specialized**:
  Keeps machine-specific info, ready to boot as-is. Good for cloning.

---

## 🏗 5. Creation Flows

### **A. Managed Image Creation**

1. **Prepare VM** — Install OS updates, apps, configs.
2. **Generalize or Specialize** — Run `sysprep` or `waagent`.
3. **Deallocate VM** — Stop from portal.
4. **Capture Image** —

   - Portal → VM → **Capture**
   - **Share to ACG?** → **No**
   - Name, region, resource group

5. **Verify & Deploy** —
   Portal → **Images** → Select → **Create VM**.

---

### **B. Custom Image (Azure Compute Gallery) Creation**

1. **Prepare VM** — Same as Managed Image.
2. **Generalize/Specialize** — Run OS prep command.
3. **Deallocate VM**.
4. **Create Azure Compute Gallery** — Name, region, resource group.
5. **Capture Image** —

   - **Target Gallery**: Select or create
   - **OS State**: Generalized/Specialized
   - **Image Definition**: OS type, SKU, publisher
   - **Version Number**: e.g., `1.0.0`
   - **Replication**: Choose target regions, shallow/full replication

6. **Verify & Deploy** —
   Azure Compute Gallery → Select version → **Create VM**.

---

## 🌍 6. Replication in Azure Compute Gallery

- **Full Replication**: Copies image bits to all regions immediately.
- **Shallow Replication**: Copies metadata only; bits are replicated on first deployment in that region (saves storage costs).

---

## 🔐 7. Best Practices

- ✅ Always **generalize** production images unless you need exact clones
- ✅ Use **ACG** for version control & DR
- ✅ Tag images with metadata (`Environment=Prod`, `Version=1.2.0`)
- ✅ Lock resource groups with golden images to prevent deletion
- ✅ Test image in each replicated region before production rollout

---

## 🧠 8. AZ-104 Exam Notes

- Managed Images are **regional** and have **no versioning**.
- Azure Compute Gallery supports **multi-region replication** and **version history**.
- **Generalized** images require customization on first boot.
- You **cannot edit** an image; you must create a **new version**.

---

## 🔄 9. AWS Mapping Table

| Azure Feature         | AWS Equivalent                          | Key Difference                                    |
| --------------------- | --------------------------------------- | ------------------------------------------------- |
| Managed Image         | AMI                                     | AMI by default is regional, same as Managed Image |
| Azure Compute Gallery | AMI cross-region copy + version tagging | Azure offers built-in version control             |
| Replication           | AMI copy                                | Azure has shallow replication to save cost        |
