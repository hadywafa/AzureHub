# ðŸ›ï¸ **ARM Templates**

> ðŸ“– **ARM template**:  
> **ARM template** is a **declarative JSON file** that defines the **infrastructure and configuration** for Azure resources. Instead of clicking around in the Azure Portal, you describe **what you want**, and Azure Resource Manager takes care of **provisioning and configuring** it.

Think of it as **Infrastructure as Code (IaC)** for Azure.

---

<div align="center">
<img src="images/arm-templates-2.png" alt="ARM Templates" style="border-radius: 10px; border: 2px solid">
</div>

---

## ðŸ—ï¸ **Key Characteristics**

- **Declarative** â†’ You define _what_ to deploy, not _how_.
- **Idempotent** â†’ Running the same template multiple times results in the same state (safe for re-deployments).
- **Repeatable** â†’ Use the same template across dev, test, and prod environments.
- **Composable** â†’ You can break down templates into smaller reusable files.
- **Integrated** â†’ Works with CI/CD pipelines (Azure DevOps, GitHub Actions, etc.).

---

## ðŸ§© **ARM Template Structure**

An ARM template is a JSON file with five main sections:

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {},
  "variables": {},
  "resources": [],
  "outputs": {}
}
```

### 1. `$schema` & `contentVersion`

- **\$schema** â†’ URL that defines template syntax.
- **contentVersion** â†’ Version of your template (helps with version control).

### 2. `parameters`

- Input values provided during deployment (e.g., VM name, location).
- Example:

  ```json
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "eastus",
      "allowedValues": ["eastus", "westus", "westeurope"],
      "metadata": {
        "description": "Location for the resources."
      }
    }
  }
  ```

### 3. `variables`

- Values reused within the template (like constants).
- Example:

  ```json
  "variables": {
    "storageSKU": "Standard_LRS"
  }
  ```

### 4. `resources`

- Defines the actual Azure resources to create.
- Example (Storage Account):

  ```json
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[concat('storage', uniqueString(resourceGroup().id))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[variables('storageSKU')]"
      },
      "kind": "StorageV2",
      "properties": {}
    }
  ]
  ```

### 5. `outputs`

- Return values after deployment (e.g., connection strings, IDs).
- Example:

  ```json
  "outputs": {
    "storageAccountId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Storage/storageAccounts', concat('storage', uniqueString(resourceGroup().id)))]"
    }
  }
  ```

---

## âš™ï¸ **Deployment Options**

You can deploy ARM templates using:

1. **Azure Portal** â†’ Upload JSON file.
2. **Azure CLI**

   ```bash
   az deployment group create \
     --resource-group myRG \
     --template-file azuredeploy.json \
     --parameters location=eastus
   ```

3. **PowerShell**

   ```powershell
   New-AzResourceGroupDeployment `
     -ResourceGroupName myRG `
     -TemplateFile azuredeploy.json `
     -location eastus
   ```

4. **CI/CD Pipelines** â†’ GitHub Actions, Azure DevOps.

---

## ðŸ” **Authentication & Authorization**

- Deployment requires permissions on the **Resource Group** or **Subscription**.
- Controlled by **Azure RBAC** via **Entra ID identities** (users, service principals, or managed identities).

---

## ðŸ› ï¸ **Advanced Features**

- **Linked Templates** â†’ Reference other templates for modular deployments.
- **Nested Templates** â†’ Embed smaller templates inside one main template.
- **Conditions** â†’ Deploy resources only if conditions are met.
- **Loops** â†’ Deploy multiple resources in a loop.
- **Template Specs** â†’ Store and version templates inside Azure for reuse.

---

## âœ… **Benefits of ARM Templates**

- Consistency â†’ Same template for multiple environments.
- Automation â†’ Easy integration with CI/CD.
- Version Control â†’ Templates stored in Git repos.
- Compliance â†’ Templates act as documentation + governance.

---

## âœðŸ» **Hands-on - Deploying a Virtual Machine**

Letâ€™s create a simple ARM Template to deploy a virtual machine (VM) in Azure.

### 1ï¸âƒ£ **Step 1:** Create the Template File

Create a file named `azuredeploy.json` with the following content:

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vmName": {
      "type": "string",
      "defaultValue": "MyVM",
      "metadata": {
        "description": "Name of the virtual machine."
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Username for the virtual machine."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the virtual machine."
      }
    }
  },
  "variables": {
    "location": "[resourceGroup().location]"
  },
  "resources": [
    {
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[parameters('vmName')]",
      "apiVersion": "2021-07-01",
      "location": "[variables('location')]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "Standard_DS1_v2"
        },
        "osProfile": {
          "computerName": "[parameters('vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "MicrosoftWindowsServer",
            "offer": "WindowsServer",
            "sku": "2019-Datacenter",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('vmName'), 'NIC'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(parameters('vmName'), 'NIC')]",
      "apiVersion": "2021-02-01",
      "location": "[variables('location')]",
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[variables('subnetRef')]"
              },
              "privateIPAllocationMethod": "Dynamic"
            }
          }
        ]
      }
    }
  ],
  "outputs": {
    "vmId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
    }
  }
}
```

### 2ï¸âƒ£ **Step 2:** Deploy the Template

You can deploy the template using Azure Portal, Azure CLI, or Azure PowerShell. Here, weâ€™ll use Azure CLI.

1. **Open Azure CLI:**

   - You can use the [Azure Cloud Shell](https://shell.azure.com/) in your browser or install Azure CLI locally.

2. **Log In to Azure:**

   ```bash
   az login
   ```

3. **Create a Resource Group (if not already created):**

   ```bash
   az group create --name MyResourceGroup --location eastus
   ```

4. **Deploy the Template:**

   ```bash
   az deployment group create \
     --resource-group MyResourceGroup \
     --template-file azuredeploy.json \
     --parameters vmName=MyTestVM adminUsername=azureuser adminPassword=YourPassword123!
   ```

5. **Verify Deployment:**
   - Check the Azure Portal under **Resource Groups > MyResourceGroup** to see your deployed VM and network interface.

### 3ï¸âƒ£ **Step 3**: Access the Virtual Machine

Once deployed, you can connect to your VM using Remote Desktop Protocol (RDP) with the credentials you provided.

---

## ðŸ“Œ Common Tasks Using PowerShell and Azure CLI

Managing ARM Templates efficiently often involves automating common tasks such as deployment, review, exporting/downloading templates, and accepting Marketplace terms. Both PowerShell and Azure CLI offer robust commands to facilitate these operations. Below are the common tasks with corresponding commands and examples for each tool.

### 1ï¸âƒ£ **Deploy ARM Templates**

Deploying ARM Templates automates the provisioning of Azure resources, ensuring consistency and repeatability.

**Azure CLI:**

Use the `az deployment group create` command to deploy an ARM Template to a specific resource group.

**Example with Inline Parameters:**

```bash
az deployment group create \
  --resource-group MyResourceGroup \
  --template-file azuredeploy.json \
  --parameters vmName=MyTestVM adminUsername=azureuser adminPassword=YourPassword123!
```

**Example with Parameter File:**

```bash
az deployment group create \
  --resource-group MyResourceGroup \
  --template-file azuredeploy.json \
  --parameters @azuredeploy.parameters.json
```

**PowerShell:**

Use the `New-AzResourceGroupDeployment` cmdlet to deploy an ARM Template.

**Example with Inline Parameters:**

```powershell
New-AzResourceGroupDeployment `
  -ResourceGroupName "MyResourceGroup" `
  -TemplateFile "azuredeploy.json" `
  -vmName "MyTestVM" `
  -adminUsername "azureuser" `
  -adminPassword (ConvertTo-SecureString "YourPassword123!" -AsPlainText -Force)
```

**Example with Parameter File:**

```powershell
New-AzResourceGroupDeployment `
  -ResourceGroupName "MyResourceGroup" `
  -TemplateFile "azuredeploy.json" `
  -TemplateParameterFile "azuredeploy.parameters.json"
```

---

### 2ï¸âƒ£ **Review Deployment Status**

Monitoring deployment status ensures that resources are provisioned correctly and helps in troubleshooting any issues.

**Azure CLI:**

**Show Details of a Specific Deployment:**

```bash
az deployment group show \
  --resource-group MyResourceGroup \
  --name MyDeploymentName
```

**List All Deployments in a Resource Group:**

```bash
az deployment group list --resource-group MyResourceGroup
```

**PowerShell:**

**Get Details of a Specific Deployment:**

```powershell
Get-AzResourceGroupDeployment `
  -ResourceGroupName "MyResourceGroup" `
  -Name "MyDeploymentName"
```

**List All Deployments in a Resource Group:**

```powershell
Get-AzResourceGroupDeployment -ResourceGroupName "MyResourceGroup"
```

---

### 3ï¸âƒ£ **Export/Download ARM Templates**

Exporting ARM Templates allows you to capture the current state of your Azure resources, facilitating backup, replication, or modification.

**Azure CLI:**

**Export an ARM Template from a Resource Group:**

```bash
az group export --name MyResourceGroup --output json > exported-template.json
```

**Note:** Some resources may not be exportable, and manual adjustments might be necessary.

**PowerShell:**

**Export an ARM Template from a Resource Group:**

```powershell
Export-AzResourceGroup `
  -ResourceGroupName "MyResourceGroup" `
  -Path "exported-template.json"
```

**Note:** Similar to Azure CLI, some resources may require manual editing after export.

---

### 4ï¸âƒ£ **Accept Marketplace Terms**

Before deploying certain Marketplace offerings, you must accept their terms and conditions. This step is crucial for automated deployments.

**Azure CLI:**

Use the `az vm image terms accept` command to accept the terms for a specific Marketplace image.

**Example: Accept Terms for a Windows Server Image:**

```bash
az vm image terms accept \
  --publisher MicrosoftWindowsServer \
  --offer WindowsServer \
  --sku 2019-Datacenter
```

**PowerShell:**

Use the `Set-AzMarketplaceTerms` cmdlet to accept the terms for a specific Marketplace offer.

**Example: Accept Terms Using PowerShell:**

```powershell
Set-AzMarketplaceTerms `
  -Publisher "MicrosoftWindowsServer" `
  -Product "WindowsServer" `
  -Name "2019-Datacenter" `
  -Accept
```

**Parameters Explained:**

- `-Publisher`: The publisher of the Marketplace offer.
- `-Product`: The product name of the Marketplace offer.
- `-Name`: The SKU name of the Marketplace offer.
- `-Accept`: A switch parameter that accepts the terms.

**Note:** Ensure you have the necessary permissions and have the correct publisher, offer, and SKU details.

## ðŸŒŸ ARM Templates vs Bicep

- **ARM Templates** â†’ JSON (verbose, harder to read).
- **Bicep** â†’ A domain-specific language (DSL) that simplifies ARM templates (easier syntax, compiles into ARM JSON).

> ðŸ‘‰ For modern projects, Microsoft recommends **Bicep** over raw ARM templates, but both are supported.
