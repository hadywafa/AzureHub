# 🏛️ Azure Policy — Complete Guide

Azure Policy is **Azure’s governance and compliance engine**.
It enforces rules at scale across your subscriptions, resource groups, or management groups, making sure your cloud follows your **organization’s standards and regulatory requirements**.

Think of it as the **“rules of the house”** for your Azure environment:

- _“All VMs must be in West Europe.”_
- _“Tag everything with ‘CostCenter’.”_
- _“Only Premium SSDs allowed for production workloads.”_

---

## 🔑 Key Concepts

| Term                      | Definition                                                                         | Example                                                 |
| ------------------------- | ---------------------------------------------------------------------------------- | ------------------------------------------------------- |
| **Policy Definition**     | A rule written in JSON that describes what is allowed or denied                    | `"location": "East US"`                                 |
| **Initiative Definition** | A collection of policies grouped for a broader goal                                | “Enable ISO 27001 compliance” initiative (20+ policies) |
| **Assignment**            | Applying a policy/initiative to a scope                                            | Apply tagging policy to subscription `Prod-Sub`         |
| **Scope**                 | The target resources → Management Group, Subscription, Resource Group, or Resource | `MG1 → SubA → RG1 → VM1`                                |
| **Parameters**            | Variables inside a policy to make it reusable                                      | `"allowedLocations": ["EastUS", "WestEurope"]`          |
| **Effects**               | Action Azure takes when evaluating a policy                                        | Deny, Audit, Append, Modify, DeployIfNotExists          |

---

## ⚙️ Policy Effects (the heart of enforcement)

1. **Deny** ❌

   - Blocks the request.
   - Example: Disallow public IPs on VMs.

2. **Audit** 🔍

   - Doesn’t block, but logs non-compliance.
   - Example: Audit untagged resources.

3. **Append** ➕

   - Adds extra fields during deployment.
   - Example: Automatically append `tag: environment=Prod`.

4. **Modify** ✏️

   - Updates resource properties to become compliant.
   - Example: If `allowedSKU` is wrong, replace with the correct SKU.

5. **DeployIfNotExists (DINE)** 🚀

   - Deploys another resource if missing.
   - Example: If a VM doesn’t have diagnostic settings, deploy them automatically.

---

## 🏗️ Azure Policy Architecture

```mermaid
flowchart TD
    A[Management Group] --> B[Subscription]
    B --> C[Resource Group]
    C --> D[Resources]

    X[Policy Definition] --> Y[Initiative Definition]
    Y --> Z[Assignment]

    Z -->|Scope Applied| A
    Z -->|Scope Applied| B
    Z -->|Scope Applied| C

    Z -->|Evaluated by| D
```

- **Policy Definitions** (atomic rules) are grouped into **Initiatives** (policy sets).
- **Assignments** bind them to **Scopes**.
- **Evaluation** happens continuously and at resource creation/update.

---

## 🔍 How Azure Policy Works (Evaluation Lifecycle)

1. **Policy Assigned** → to scope (e.g., subscription).
2. **Policy Engine evaluates**:

   - When a resource is **created/updated** (control plane).
   - Periodic background scans.

3. **Effect applied** → Deny, Audit, Modify, etc.
4. **Compliance Report generated** → visible in Azure Portal & API.

---

## 🖥️ Practical Examples

### 1. **Allowed Locations Policy**

```json
{
  "properties": {
    "displayName": "Allowed locations",
    "policyType": "BuiltIn",
    "mode": "Indexed",
    "parameters": {
      "listOfAllowedLocations": {
        "type": "Array",
        "metadata": {
          "description": "The list of locations that can be specified when deploying resources.",
          "displayName": "Allowed locations"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "location",
        "notIn": "[parameters('listOfAllowedLocations')]"
      },
      "then": {
        "effect": "Deny"
      }
    }
  }
}
```

👉 Blocks deployments outside allowed regions.

---

### 2. **Tag Enforcement Policy**

- Effect = `Append`
- Ensures every resource gets a `CostCenter` tag, even if user forgets.

---

### 3. **DeployIfNotExists**

- Enforce **Diagnostic Settings** on all Key Vaults.
- If missing → automatically deploy logging config.

---

## 📊 Compliance Dashboard

Azure Policy integrates with **Azure Resource Graph** and shows:

- % compliant vs non-compliant resources
- Which policies are failing
- Drill-down into specific resource non-compliance

👉 Helps auditors & security teams prove compliance for standards like **ISO, CIS, NIST, HIPAA**.

---

## 🛡️ Use Cases

- **Security**:

  - Deny public storage accounts
  - Require encryption at rest

- **Cost Control**:

  - Enforce specific VM SKUs
  - Require CostCenter tags

- **Compliance**:

  - Apply initiatives for ISO/NIST standards
  - Audit missing vulnerability assessments

- **Operational Consistency**:

  - Require monitoring agents on all VMs
  - Ensure resource naming standards

---

## 🚨 Important Considerations

1. **Scope Inheritance** → Assign at management group → applies everywhere below.
2. **Data Plane Exclusion** → Policies affect _control plane_ (create/update/delete), not inside resource data.
3. **Permissions** → Need `Resource Policy Contributor` to assign.
4. **Conflicts** → If two policies conflict, **Deny always wins**.
5. **Large Scale** → Use **Initiatives** instead of assigning 100s of policies individually.

---

## 🏆 Best Practices

1. **Start with Audit** → Test policies before going `Deny`.
2. **Use Initiatives** → Easier management and reporting.
3. **Parameterize Policies** → Make reusable (e.g., allowed locations).
4. **Tag Consistency** → Enforce tags to help with **Cost Management**.
5. **Combine with Blueprints** → Package policies + RBAC + ARM templates for governance at scale.
6. **Monitor Compliance** → Regularly check dashboard and automate remediation.
7. **Integrate with CI/CD** → Validate IaC deployments against Azure Policy (shift-left governance).

---

## ✅ Summary

Azure Policy is the **enforcer of governance** in Azure:

- Ensures compliance with security, cost, and operational standards.
- Uses **policies + initiatives + assignments** to define and apply rules.
- Supports multiple **effects** (Deny, Audit, Modify, DeployIfNotExists).
- Provides **compliance dashboards** to track adherence.
- Critical for **enterprise governance, regulatory compliance, and cost control**.
