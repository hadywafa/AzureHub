# üî¨ Hands-on: Practical labs (Portal + CLI + Bicep)

## ‚úçüèª Lab 1 ‚Äî **Allowed Locations (Deny outside EU)**

**Goal:** Only allow deployments in `westeurope` / `northeurope`.

### Portal (fast path)

1. Portal ‚Üí **Policy** ‚Üí **Definitions** ‚Üí search ‚ÄúAllowed locations‚Äù (built-in).
2. **Assign** ‚Üí Scope = your subscription (or MG).
3. **Parameters** ‚Üí pick `westeurope`, `northeurope`.
4. **Enforcement mode** = `DoNotEnforce` (trial), then flip to `Default` later.
5. Try to deploy in `eastus` ‚Üí see **Deny** (once enforced).

### CLI

```bash
# Assign built-in definition
az policy assignment create `
  --name "allowed-eu-only" `
  --scope "/subscriptions/<subId>" `
  --enforcement-mode "Default" `
  --policy "$(az policy definition list --query "[?displayName=='Allowed locations'].name | [0]" -o tsv)" `
  --params '{ "listOfAllowedLocations": { "value": ["westeurope","northeurope"] } }' \
```

### Bicep (assignment)

```ts
param defId string // built-in Allowed locations definitionId
resource pa 'Microsoft.Authorization/policyAssignments@2022-06-01' = {
  name: 'allowed-eu-only'
  properties: {
    displayName: 'EU-only locations'
    policyDefinitionId: defId
    enforcementMode: 'Default'
    parameters: {
      listOfAllowedLocations: { value: [ 'westeurope', 'northeurope' ] }
    }
  }
}
```

---

## ‚úçüèª Lab 2 ‚Äî **Require a Tag** (two ways)

### A - **Hard block (Deny)**: must have `costCenter`

**When to use:** strict environments.

**Definition (built-in exists; here‚Äôs the idea):**

```json
{
  "properties": {
    "displayName": "Require tag",
    "mode": "Indexed",
    "parameters": {
      "tagName": { "type": "String" }
    },
    "policyRule": {
      "if": { "field": "[concat('tags[', parameters('tagName'), ']')]", "exists": "false" },
      "then": { "effect": "deny" }
    }
  }
}
```

**Try:** Create a resource **without** `costCenter` ‚Üí request is **denied**.

### B - **Auto-fix (Modify)**: add/normalize tag on the fly

**When to use:** developer-friendly, enforce standards with less friction.

**Snippet (Modify effect):**

```json
"then": {
  "effect": "modify",
  "details": {
    "operations": [
      { "operation": "addOrReplace", "field": "tags.costCenter", "value": "[parameters('ccValue')]" }
    ],
    "roleDefinitionIds": [
      "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c" // Contributor
    ]
  }
}
```

**Assignment requirements:**

- Turn on **system-assigned identity** at assignment.
- Identity needs **Contributor** (or narrower) on target scope.

**CLI (assignment with identity):**

```bash
az policy assignment create `
  --name "auto-tag-cc" `
  --scope "/subscriptions/<subId>" `
  --policy "/subscriptions/<subId>/providers/Microsoft.Authorization/policyDefinitions/<modifyDefId>" `
  --params '{ "tagName": { "value": "costCenter" }, "ccValue": { "value": "FIN-001" } }' `
  --assign-identity
```

---

## ‚úçüèª Lab 3 ‚Äî **Auto-enable Diagnostics on Key Vaults** (DINE)

**Goal:** If a Key Vault is missing diagnostic settings ‚Üí **auto-deploy** them to a Log Analytics workspace.

**Key points:**

- Effect = **DeployIfNotExists**
- **assignment identity** needs permissions (e.g., **Monitor Contributor**)
- A small ARM/Bicep template is embedded in the policy to create `Microsoft.Insights/diagnosticSettings`.

**After assigning:**

- Run a **Remediation Task** to bring **existing** vaults into compliance.

**CLI (start remediation):**

```bash
az policy remediation create `
  --name "kv-diag-remediate" `
  --policy-assignment "<assignmentName>" `
  --scope "/subscriptions/<subId>"
```

---

## ‚úçüèª Lab 4 ‚Äî **Exemptions for a migration RG**

**Scenario:** One RG (legacy migration) needs temporary exceptions.

**Steps (Portal):**

1. **Policy ‚Üí Compliance ‚Üí** pick the assignment.
2. **Create Exemption** ‚Üí Scope = that RG ‚Üí **Category = Waiver** ‚Üí Reason & **Expiry** (e.g., 30 days).
3. Exempted resources show as **Exempt** and don‚Äôt hurt your compliance score.
