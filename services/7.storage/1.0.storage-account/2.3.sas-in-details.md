# ğŸ” Azure Shared Access Signature (SAS) â€” Your Temporary Digital Pass

Think of **SAS** as a **concert backstage pass** â€” but for Azure Storage.
Itâ€™s **time-limited**, **permission-controlled**, and **revocable**.

Without SAS, youâ€™d have to give someone your **Access Keys** (basically the keys to your storage kingdom ğŸ°), which is a big **NO** in security best practices.

---

## ğŸ¯ **Layer 1 â€“ The Purpose of SAS**

SAS defines:

1. **ğŸ¯ What you can access** â€” Scope of the resource (container, blob, file share, queue, or table).
2. **ğŸ›  What you can do** â€” Read, Write, Delete, etc.
3. **â³ For how long** â€” Start and expiry date/time.
4. **ğŸŒ From where** â€” Restrict by IP and protocol (HTTPS recommended).

**Why it matters:**
This means you can give someone just enough access for just enough time â€” without giving them the master keys.

---

## ğŸ§© **Layer 2 â€“ Types of SAS & Their Scope**

| ğŸš¦ SAS Type             | ğŸ“¦ Scope                                                                                     | ğŸ”‘ Signing Method                      | ğŸ’¡ Best For                         |
| ----------------------- | -------------------------------------------------------------------------------------------- | -------------------------------------- | ----------------------------------- |
| **Service SAS**         | One **service** only (Blob, File, Queue, or Table) and its resources (container, blob, etc.) | Account Key **or** User Delegation Key | Fine-grained, single-service access |
| **Account SAS**         | Multiple **services** in the same storage account                                            | Account Key                            | Cross-service automation            |
| **User Delegation SAS** | Blob service only, scoped to **Azure AD identity**                                           | User Delegation Key from Azure AD      | Identity-based, secure scenarios    |

ğŸ“Œ **How they relate:**

- **Service SAS** â†’ Precise access, one service.
- **Account SAS** â†’ Multiple services, one signature.
- **User Delegation SAS** â†’ Service SAS powered by Azure AD identity.

---

## ğŸ— **Layer 3 â€“ SAS Building Blocks**

Every SAS token (no matter the type) contains these components:

1. **ğŸ“ Resource scope** â€” Which container, blob, share, queue, or table.
2. **ğŸ”’ Permissions** â€” R (Read), W (Write), D (Delete), L (List), A (Add), U (Update), C (Create), P (Process).
3. **â³ Validity window** â€” Start + expiry time.
4. **ğŸ” Protocol** â€” HTTPS only (recommended) or HTTPS+HTTP.
5. **ğŸŒ IP restrictions** â€” Optional range limits.
6. **ğŸ–Š Signature** â€” Cryptographic proof itâ€™s valid.

---

## âœ **Layer 4 â€“ Signing & Access Policies**

### **Signing Methods**

- **ğŸ”‘ Account Key** â€” Directly signs the SAS with a **storage account key** (simple, but leaks are dangerous).
- **ğŸ‘¤ User Delegation Key** â€” Issued by Azure AD for **Blob only**. Tied to identity and permissions.

---

### ğŸ“œ **Stored Access Policies**

Instead of defining expiry and permissions in each SAS manually:

- Create a **policy** once at the container/share/table/queue level.
- Reference the **policy name** in SAS tokens.
- Update/revoke the policy â†’ **all linked SAS become updated instantly**.

---

<div align="center">
<img src="images/service-sas.png" alt="service-sas" style="border-radius:10px;width:60%; border: 2px solid white;">
</div>

---

> ğŸ’¡ **Pro Tip:** Great for revoking multiple SAS tokens at once without hunting them down.

---

## ğŸ” **SAS Token Anatomy** â€“ Dissecting the Beast

When you generate a SAS, you actually get **two parts**:

```ini
https://<account>.blob.core.windows.net/<resource-path>?<SAS-token>
```

- **Base URL** â†’ Points to the actual Azure resource (container/blob/etc.).
- **Query String (SAS Token)** â†’ The â€œmagic passâ€ with all the rules encoded.

---

## ğŸ§© **SAS Query Parameters**

Hereâ€™s what you might see in a **Service SAS** for Blob:

```ini
?sv=2023-11-03&ss=b&srt=o&sp=rwdl&st=2025-08-13T07:00Z&se=2025-08-13T09:00Z&sip=192.168.1.0-192.168.1.255&spr=https&sig=<signature>
```

| Param             | Meaning                           | Example Value                                           | Applies To          |
| ----------------- | --------------------------------- | ------------------------------------------------------- | ------------------- |
| **sv**            | Storage Service Version           | `2023-11-03`                                            | All SAS types       |
| **ss**            | Service(s) allowed                | `b` (Blob), `f` (File), `q` (Queue), `t` (Table)        | Account SAS         |
| **srt**           | Resource Types                    | `o` (Object), `c` (Container), `s` (Service)            | Account SAS         |
| **sr**            | Resource                          | `b` (Blob), `c` (Container)                             | Service SAS         |
| **sp**            | Permissions                       | `r` (Read), `w` (Write), `d` (Delete), `l` (List), etc. | All SAS types       |
| **st**            | Start Time                        | `2025-08-13T07:00Z`                                     | All SAS types       |
| **se**            | Expiry Time                       | `2025-08-13T09:00Z`                                     | All SAS types       |
| **sip**           | Allowed IP Range                  | `192.168.1.0-192.168.1.255`                             | Optional            |
| **spr**           | Protocol                          | `https` or `https,http`                                 | Optional            |
| **skoid**         | Object ID (Azure AD user)         | GUID                                                    | User Delegation SAS |
| **sktid**         | Tenant ID (Azure AD tenant)       | GUID                                                    | User Delegation SAS |
| **skt** / **ske** | Start & Expiry for delegation key | ISO timestamp                                           | User Delegation SAS |
| **sig**           | Signature                         | Long Base64 hash                                        | All SAS types       |

---

## ğŸ— **Relationship Between SAS Type & Parameters**

| SAS Type            | Unique Params                  | Why?                                               |
| ------------------- | ------------------------------ | -------------------------------------------------- |
| **Service SAS**     | `sr` only                      | Youâ€™re targeting a single resource.                |
| **Account SAS**     | `ss`, `srt`                    | Grants multiple services/resource types in one go. |
| **User Delegation** | `skoid`, `sktid`, `skt`, `ske` | Ties token to Azure AD-issued delegation key.      |

---

## ğŸ“œ **Stored Access Policy in URL**

When you use a **Stored Access Policy**, instead of `st` and `se` in the SAS, you may see:

```ini
?si=PolicyName
```

Where `si` = **Signed Identifier** (name of the policy).
The expiry and permissions are **looked up** in Azure instead of being embedded in the SAS.

---

## ğŸ”„ **How SAS Gets Generated** (End-to-End)

```mermaid
sequenceDiagram
    participant Admin as Admin/Service
    participant Azure as Azure Storage
    participant Client as Client/App

    Admin->>Azure: Request SAS (specify type, scope, perms, expiry, IP, protocol)
    Azure-->>Admin: Returns SAS token with signature
    Admin->>Client: Send full URL (Base + Token)
    Client->>Azure: Makes request with SAS URL
    Azure-->>Client: Grants access if SAS valid
```

---

## âœğŸ» **Example** â€“ Breaking Down a SAS

**URL**:

```ini
https://myaccount.blob.core.windows.net/mycontainer/myfile.txt?sv=2023-11-03&sr=b&sp=rw&st=2025-08-13T07:00Z&se=2025-08-13T09:00Z&spr=https&sig=abcdef123456...
```

- `sv=2023-11-03` â†’ API version.
- `sr=b` â†’ Resource = Blob.
- `sp=rw` â†’ Read + Write permissions.
- `st` / `se` â†’ 2-hour validity window.
- `spr=https` â†’ HTTPS only.
- `sig=...` â†’ Signed with account key or user delegation key.

---

## ğŸ“š **Example Scenarios**

1. **ğŸ¥ Temporary Media Upload Portal**

   - **Type:** Service SAS (Blob)
   - **Permission:** Write only
   - **Expiry:** 1 hour
   - **Use:** Client uploads directly, server never sees your keys.

2. **ğŸ“¦ Multi-Service Data Pipeline**

   - **Type:** Account SAS
   - **Permission:** Read + List
   - **Expiry:** 24 hours
   - **Use:** ETL job fetches from Blob & Queue in one go.

3. **ğŸ” Employee Access to Private Files**

   - **Type:** User Delegation SAS
   - **Permission:** Read
   - **Expiry:** Until end of shift
   - **Use:** Scoped to employeeâ€™s Azure AD identity.

---
