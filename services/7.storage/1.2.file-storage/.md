# üóÇÔ∏è Azure Files ‚Äî the Cloud File Server

## üí° What is it?

**Azure Files** gives you **fully managed** SMB/NFS file shares in Azure.
Mount it like a network drive from Windows/Linux/macOS, or hit it via REST/SDKs. No servers, no patches, no RAID tears.

---

## ‚ú® Core Features

- **Protocols:** It is Support **SMB 2.1/3.x** (Win/Linux/macOS) & **NFS 4.1** (Linux; premium FileStorage shares).
- **Mountable:** Map as a drive on VMs or on-prem devices.
- **Scale:** Shares up to **100 TiB**, millions of files.
- **Performance tiers:**

  - **Premium (SSD / FileStorage)** ‚Üí low latency, high IOPS (AVD/FSLogix, databases, CAD).
  - **Standard**:

    - **Transaction Optimized** (balanced)
    - **Hot** (read/write often)
    - **Cool** (cheap + infrequent access)

---

## üîí Security (defense in depth)

- **At rest:** Server-Side Encryption (PMK by default; CMK optional).
- **In transit:** SMB 3.x encryption + TLS for REST.
- **Private access:** **Private Endpoints** to keep traffic on your VNet.
- **Identity & auth (SMB):**

  - **AD DS (on-prem or in Azure)** ‚Äî classic Kerberos/NTLM + **NTFS ACLs**.
  - **Azure AD DS** ‚Äî managed domain.
  - **Microsoft Entra ID Kerberos** ‚Äî identity-based SMB without running DCs (great for AVD/modern).
  - (Legacy) **Storage keys** ‚Äî avoid for users; OK for automations.

- **Threat detection:** Microsoft Defender for Storage (ransomware/anomaly alerts).

---

## üßØ Backup, DR & Snapshots

- **Share snapshots** (point-in-time restore).
- **Azure Backup for Azure Files** (policy-based backups, item-level restore).
- **Redundancy:** LRS / ZRS / (RA-)GRS ‚Äî pick per RTO/RPO.

---

## üîó Hybrid Superpower ‚Äî Azure File Sync

Keep your **Windows Server** shares on-prem _and_ in Azure:

- **Cloud tiering:** hot files cached locally; cold files live in Azure.
- Same path + NTFS permissions; use your backup tools; DR by re-hydrating from Azure.
- Perfect for branch offices & file server consolidation.

---

## üë• Auth & Permissions (SMB quick map)

- **Who are you?**
  AD DS / Azure AD DS / Entra ID Kerberos / (automation: key or SAS).
- **What can you do?**

  - **Share-level RBAC** (e.g., _Storage File Data SMB Share Contributor_).
  - **File/folder NTFS ACLs** (fine-grained control).

> ‚ö†Ô∏è Tip: Users typically need **both** a share role (RBAC) **and** the right **NTFS ACLs**.

---

## üß∞ Typical Use Cases

- **Lift-and-shift**: Replace aging NAS/Windows file servers.
- **AVD / FSLogix**: Premium shares for user profiles.
- **Shared app data**: Config, reports, media libraries.
- **Branch offices**: Azure File Sync + cloud tiering.
- **Linux engineering workloads**: NFS 4.1 premium shares.

---

## üß™ Hands-On Examples

### ü™ü Mount on Windows (SMB)

```powershell
# Map Z: drive using a storage key (automation-friendly)
$acct   = "mystorageacct"
$share  = "teamshare"
$key    = "<STORAGE-ACCOUNT-KEY>"

cmd /c "net use Z: \\$acct.file.core.windows.net\$share /u:$acct $key /persistent:yes"
```

### üêß Mount on Linux (SMB)

```bash
sudo mkdir -p /mnt/teamshare
sudo mount -t cifs //mystorageacct.file.core.windows.net/teamshare /mnt/teamshare \
  -o vers=3.0,username=mystorageacct,password='<STORAGE-ACCOUNT-KEY>',serverino,dir_mode=0770,file_mode=0660
```

### üêß Mount on Linux (NFS 4.1, Premium FileStorage)

```bash
sudo mkdir -p /mnt/premium-nfs
sudo mount -t nfs -o rw,soft,timeo=600,retrans=2 \
  mystorageacct.privatelink.file.core.windows.net:/mystorageacct/mynfsshare /mnt/premium-nfs
```

### üõ†Ô∏è Create a Share (CLI)

```bash
# Standard account
az storage share-rm create \
  --resource-group rg1 --storage-account mystorageacct \
  --name teamshare --quota 1024  # GiB

# Premium (FileStorage) - provision capacity drives IOPS/throughput
az storage share-rm create \
  --resource-group rg1 --storage-account mystoragepremium \
  --name avdprofiles --access-tier Premium --quota 5120
```

---

## ‚öñÔ∏è Azure Files vs. Blob Storage (when to choose what)

| Capability      | **Azure Files** üóÇÔ∏è                     | **Blob Storage** ü´ô                        |
| --------------- | -------------------------------------- | ----------------------------------------- |
| Protocols       | SMB / NFS / REST                       | REST (Blobfuse for POSIX-like)            |
| Mount as drive  | ‚úÖ Native                              | ‚ö†Ô∏è Blobfuse only (user-mode)              |
| Directory model | Real folders + NTFS ACLs               | Flat namespace (ADLS Gen2 adds hierarchy) |
| Best for        | Lift-and-shift shares, AVD, app shares | Cloud-native apps, data lake, backups     |

---

## üß≠ Architecture at a Glance

```mermaid
flowchart LR
    subgraph On-prem / Branch
      U1[Windows PC]:::win
      S1[(Windows Server </br> with File Sync)]:::srv
    end
    subgraph Azure
      PE[Private Endpoint]:::net
      FS[(Azure Files </br> Share: SMB / NFS)]:::azure
      AD[(AD DS / Azure AD DS / </br> Entra ID Kerberos)]:::id
      B[Azure Backup]:::azure
    end

    U1 -- SMB --> FS
    S1 <---> FS
    FS -- Private Link --> PE
    FS -- AuthZ/AuthN --> AD
    FS --> B

    classDef azure fill:#0ea5e9,stroke:#0369a1,stroke-width:1,color:#fff;
    classDef win fill:#93c5fd,stroke:#1d4ed8,color:#111;
    classDef srv fill:#60a5fa,stroke:#1d4ed8,color:#111;
    classDef id fill:#22c55e,stroke:#166534,color:#111;
    classDef net fill:#a78bfa,stroke:#6d28d9,color:#111;
```

---

## üßæ Sizing & Tiers (rules of thumb)

- **Premium (FileStorage)** ‚Üí provision capacity = **guaranteed IOPS/throughput** (scales linearly).
- **Standard** ‚Üí performance scales with used capacity & tier; **Transaction Optimized** for general use, **Cool** to save money on rarely accessed data.

---

## üõ°Ô∏è Best Practices Checklist

- Enforce **SMB encryption** + **minimum SMB version**.
- Use **Private Endpoints**; disable public network access if possible.
- Prefer **AD-based auth** + NTFS ACLs over storage keys for users.
- Enable **Defender for Storage** + **Azure Backup**.
- For hybrid, deploy **Azure File Sync** with **cloud tiering**.
- For AVD/FSLogix, go **Premium** (SSD) and keep an eye on IOPS.

---

## üß† Quick Troubleshooting Cues

- **Access denied:** Check both **share RBAC** _and_ **NTFS ACLs**.
- **Slow performance:** Wrong tier? SMB vs NFS? Premium sizing too small? Network path using Internet instead of **Private Link**?
- **Mount fails on Linux (SMB):** Ensure `cifs-utils`, `vers=3.0`, and DNS/PE routing are correct.
