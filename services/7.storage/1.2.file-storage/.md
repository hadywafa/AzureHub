# üìÅ Azure Files ‚Äî Connectivity & Access Control (The Complete Guide)

Azure Files gives you **fully managed SMB/NFS file shares** you can mount from Windows, Linux, and macOS‚Äîon Azure or on-prem. How you **connect** and **authorize** depends on protocol, network path, and identity source. Here‚Äôs the whole story.

---

## üß≠ Big Picture

<div align="center">

```mermaid
flowchart LR
  subgraph On-prem / Internet
    U[Users & Apps]
  end
  subgraph Azure VNet
    VM[Azure VMs]
    PE[(Private Endpoint<br/>privatelink.file.core.windows.net)]
  end

  SA[(Storage Account\nfile.core.windows.net)]

  U -- SMB 445 / NFS 2049 / HTTPS 443 --> SA
  U -- via VPN/ER --> PE
  VM -- vNet route --> PE
  SA -. public endpoint ACLs .- U
  SA -. RBAC/SAS/Keys/AD DS/AAD-Kerberos .- U
```

</div>

You decide:

- **Protocol**: **SMB 3.1.1** (Windows/macOS/Linux) or **NFS 4.1** (Linux, Premium only).
- **Network path**: **Public endpoint**, **Private Endpoint (recommended)**, or **through VPN/ExpressRoute**.
- **AuthN/AuthZ**: **Keys / SAS**, **Azure AD-based**, **Active Directory (AD DS)**, or **POSIX (NFS)**.

---

## üîå Connectivity Options (Network)

### 1) üåç Public Endpoint (simple, but lock it down)

- DNS: `\\<account>.file.core.windows.net\<share>` (SMB)
- Ports: **SMB 445**, **HTTPS 443** (REST)
- Control with **‚ÄúFirewalls and virtual networks‚Äù** ‚Üí allow specific IPs / VNets.
- ‚ö†Ô∏è Some ISPs block **445** outbound; if so, use **Private Endpoint** or **VPN/ER**.

### 2) üõ°Ô∏è Private Endpoint (best practice for production)

- Creates a NIC in your VNet for **`privatelink.file.core.windows.net`**.
- Access stays on your private network (Azure, VPN, ExpressRoute).
- Requires private DNS zone: `privatelink.file.core.windows.net` ‚Üí A record to the PE IP.

### 3) üßµ NFS Shares (Premium only)

- **NFS 4.1** on TCP **2049**.
- **Private networking only** (Private Endpoint / VNet); **no public Internet access**.
- POSIX permissions (UID/GID/mode bits). No SMB/NTLM/Kerberos here.

> Bonus: **Service endpoints** work for Storage, but for Azure Files, **Private Endpoints** are the safer, recommended approach‚Äîespecially for SMB and required effectively for NFS.

---

## üîë Authentication & Authorization (Data Plane)

### SMB (3.1.1) ‚Äî Identity Options

| Use case                           | How you sign in                                           | Typical scenario                                                                            |
| ---------------------------------- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------- |
| **Shared Key** (account keys)      | Username = `Azure\<account>`, Password = **account key**  | Admin automation, test mounts, lift & shift where identity isn‚Äôt required                   |
| **SAS** (share-level)              | Username = `Azure\<account>`, Password = **SAS token**    | Time-limited delegated access (read-only portal for auditors, vendor uploads)               |
| **AD DS (Kerberos/NTLM)**          | Domain identity (user/machine)                            | Enterprise SMB with **NTFS ACLs** & **Access-Based Enumeration**, on-prem AD or Azure AD DS |
| **Azure AD Kerberos** (cloud-only) | Entra ID (Azure AD) users, Kerberos tickets minted by AAD | Cloud-only identity, no AD DS. Great with AAD-joined Windows 11/Server 2022+                |

> Encryption in transit: **SMB 3.1.1** with AES-GCM. You can enforce secure transfer at the storage account.

### NFS (4.1) ‚Äî Identity & AuthZ

- Uses **AUTH_SYS** (client-supplied UID/GID).
- Control with **export policies** + **POSIX mode bits/ACLs**.
- Restrict by **network** (Private Endpoint/VNet, firewall).
- No SMB roles, no NTLM/Kerberos.

---

## üß© Two-Layer Authorization for SMB (Important!)

**SMB access uses two layers**:

1. **Share-level permission** (Azure RBAC roles on the _share_):

   - **Storage File Data SMB Share Reader/Contributor/Elevated Contributor/Privileged Contributor**
     (Reader ‚Üí read only; Contributor ‚Üí read/write; Elevated ‚Üí manage permissions; Privileged ‚Üí full control)

2. **NTFS ACLs** on folders/files inside the share (ICACLS/Explorer):

   - Your AD identity must be allowed by both **the share role** _and_ **the NTFS ACL**.

> Think: **RBAC opens the building, NTFS opens specific rooms**.

---

## üß™ Mount Examples

### A) Windows (SMB) ‚Äî with Account Key

```powershell
$acct="mystorageacct"
$share="projects"
$key=(az storage account keys list -n $acct -g rg --query "[0].value" -o tsv)
net use Z: \\$acct.file.core.windows.net\$share /user:Azure\$acct $key /persistent:yes
```

### B) Windows (SMB) ‚Äî with AD DS (identity-based)

1. Join storage account to **AD DS** (or Azure AD DS) in **Azure Files AD settings**.
2. Grant user **share-level RBAC** (e.g., _SMB Share Contributor_).
3. Set NTFS ACLs (Explorer or `icacls`).
4. Mount:

```powershell
net use Z: \\filesacct.file.core.windows.net\dept /persistent:yes
```

### C) Linux (SMB) ‚Äî with SAS token

```bash
sudo mount -t cifs //mystorageacct.file.core.windows.net/reports /mnt/reports \
  -o vers=3.1.1,username=Azure/mystorageacct,password='<SAS_TOKEN>',serverino,dir_mode=0770,file_mode=0660
```

### D) Linux (NFS 4.1) ‚Äî Premium, Private Endpoint

```bash
sudo mount -t nfs -o vers=4.1 <acct>.privatelink.file.core.windows.net:/<share> /mnt/nfsshare
# Set POSIX perms
sudo chown 1001:1001 /mnt/nfsshare
sudo chmod 770 /mnt/nfsshare
```

---

## üß± Network Security Controls

- **Firewalls & VNets**: Restrict public access to selected IPs/VNets (or disable public access).
- **Private Endpoints**: Put SMB/NFS behind **private IP**; use private DNS (`privatelink.file.core.windows.net`).
- **VPN/ExpressRoute**: Extend on-prem to Azure for secure SMB/NFS without Internet.
- **NSGs/UDRs**: Usually not applied directly to Private Endpoint NIC, but control traffic in your subnets.
- **Secure transfer required**: Enforce HTTPS/SMB encryption in transit.

---

## üß∞ Admin & App Access (non-SMB)

- **REST API/SDKs**: Use **SAS** or **Azure AD (OAuth) + RBAC** for file service operations (create share, list directory, upload, etc.).
- **Key Vault**: Store SAS/keys; use **Managed Identity** to fetch secrets.

---

## üëÆ‚Äç‚ôÄÔ∏è Azure File Sync (Hybrid sprinkle)

- Install the **File Sync agent** on your on-prem Windows file server.
- Your server exposes SMB to users locally; **cloud tiering** caches hot files on-prem, full content in Azure Files.
- Sync service talks **443** outbound to Azure (no inbound ports to open).
- Great when **port 445 is blocked** or you need branch-office performance.

---

## üß™ Quick Role Cheatsheet (SMB share-level RBAC)

| Role                                                 | What it allows        |
| ---------------------------------------------------- | --------------------- |
| **Storage File Data SMB Share Reader**               | Read/list, no write   |
| **Storage File Data SMB Share Contributor**          | Read/write/modify     |
| **Storage File Data SMB Share Elevated Contributor** | Modify permissions    |
| **Storage File Data Privileged Contributor**         | Full control on share |

> You still need NTFS permissions inside the share. Assign roles at **share scope** for least privilege.

---

## ‚úÖ Best-Practice Checklist

- **Use Private Endpoints** for production.
- For SMB, prefer **identity-based** access (AD DS or Azure AD Kerberos) + **NTFS ACLs**.
- Grant **share-level RBAC** + **NTFS** (both!) to the right groups.
- Use **SAS** for short-lived delegated access; **never** hardcode account keys.
- For NFS, enforce **private networking** and **POSIX perms**; keep UID/GID mapping consistent.
- If 445 is blocked, consider **Azure File Sync** or a private path (VPN/ER).
- Turn on **secure transfer required**; keep **encryption at rest** on (default).
- Monitor with **Azure Monitor / Storage logs**; alert on failed auth and denied connections.

---

## üß† Mini Decision Helper

- **Windows clients, enterprise auth + granular perms** ‚Üí SMB + **AD DS** (or Azure AD Kerberos).
- **Linux HPC or app servers, POSIX** ‚Üí **NFS 4.1** (Premium + Private Endpoint).
- **Public share for contractors (time-boxed)** ‚Üí SMB + **SAS**.
- **Branch offices, ISP blocks 445** ‚Üí **Azure File Sync** on local server.
