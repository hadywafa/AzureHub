# üß¨ **Connectivity & Access Control**

Azure Files is a **fully managed, cloud-native file service** that lets you mount **file shares** in the cloud, just like on-premises file servers. It supports **SMB, NFS, REST APIs**, and **hybrid sync**, while integrating tightly with **Microsoft Entra ID** for secure access control.

To use Azure Files effectively, you must understand:

- **Connectivity** ‚Üí how clients connect.
- **Access control** ‚Üí who can get in and what they can do.

---

## üåê **Connectivity Options**

Azure Files supports multiple ways to connect, making it flexible for both **cloud-first** and **hybrid** organizations.

<div align="center">
  <img src="images/az-files-client-conn.png" alt="Azure Files Client Connectivity" style="border-radius: 10px; width: 100%; border: 2px solid white;">
</div>

---

### 1Ô∏è‚É£ SMB (Server Message Block)

- **Default protocol** for Azure Files.
- Supported by **Windows, Linux, macOS**.
- Versions:

  - **SMB 2.1** (legacy).
  - **SMB 3.0** (encryption + performance).

- **Port**: TCP **445**.
- **Use Cases**:

  - General-purpose file shares.
  - Lift-and-shift Windows workloads.
  - User home directories.

‚ö†Ô∏è **Important**: Some ISPs block **TCP 445**. If so ‚Üí use **VPN, ExpressRoute, or Private Endpoints**.

---

### 2Ô∏è‚É£ NFS (Network File System)

- Targeted for **Linux/Unix workloads**.
- Versions:

  - **NFS v3** (basic).
  - **NFS v4.1** (POSIX ACLs, better performance).

- **Port**: TCP **2049**.
- **Restrictions**:

  - ‚ùå Not available over unrestricted public Internet.
  - ‚úÖ Only supported with **Private/Restricted Endpoints**.

- **Use Cases**:

  - Linux workloads (databases, HPC).
  - Kubernetes persistent volumes.

---

### 3Ô∏è‚É£ REST API

- Access Azure Files over HTTPS/HTTP.
- **Ports**: 443 (HTTPS), 80 (HTTP).
- **Capabilities**:

  - Upload/download files programmatically.
  - Modify metadata, ACLs, and properties.

- **Use Cases**:

  - Application integration.
  - Automation scripts, DevOps pipelines.

---

## üì° **Connectivity + Ports Table**

| Protocol     | Public Endpoint | Restricted Endpoint | Private Endpoint | Port(s)        |
| ------------ | --------------- | ------------------- | ---------------- | -------------- |
| **SMB**      | ‚úÖ              | ‚úÖ                  | ‚úÖ               | TCP **445**    |
| **NFS**      | ‚ùå              | ‚úÖ                  | ‚úÖ               | TCP **2049**   |
| **REST API** | ‚úÖ              | ‚úÖ                  | ‚úÖ               | TCP **443/80** |

üí° Quick Memory Trick:

- **SMB ‚Üí 445**, **NFS ‚Üí 2049**, **REST ‚Üí 443/80**.
- NFS is **private only**, SMB works on Internet (if 445 open).

---

## üîë **Authentication vs Authorization**

üëâ Two often-confused but distinct concepts:

### üü¢ Authentication = "Who are you?"

- Verifies **identity** of the user/device.
- In Azure Files:

  - **Storage account key**
  - **SAS token**
  - **Microsoft Entra ID authentication** (Kerberos, AD DS, etc.)

### üîµ Authorization = "What can you do?"

- Determines **permissions** after identity is confirmed.
- In Azure Files:

  - **RBAC roles** (portal-level access).
  - **NTFS-style ACLs** (file/folder permissions).

‚öñÔ∏è **Example**:

- You authenticate with Entra ID as `Alice@company.com`.
- You are authorized to **read** from `\\storage\finance`, but **not write**.

---

## üîê Access Control Options with Microsoft Entra ID

Azure Files integrates with **Microsoft Entra ID** for identity-based access control.

### 1Ô∏è‚É£ Entra ID DS (On-Premises Domain Services)

<div align="center">
  <img src="images/az-files-acl-1.png" alt="Authenticate with Entra ID Domain Services" style="margin: 0 20px; border-radius: 10px; width: 100%; border: 2px solid white;">
</div>

- **Overview**:
  Authenticate Azure File Shares against **on-premises domain controllers**.

- **How It Works**:

  - User identities are managed in **on-prem Entra ID DS (classic AD DS)**.
  - Synced to **Microsoft Entra ID** using **Entra Connect**.
  - Authentication is routed back to **on-prem Entra ID DS**.

- **Use Cases**:

  - Hybrid enterprises with existing **legacy AD DS**.
  - Workloads needing **Kerberos/NTLM auth** from on-prem clients.

---

### 2Ô∏è‚É£ Microsoft Entra ID Domain Services (Managed AD DS in Azure)

<div align="center">
    <img src="images/az-files-acl-2.png" alt="Authenticate with Entra ID Domain Services" style="margin: 0 20px;border-radius: 10px; width: 100%; border: 2px solid white;">
</div>

- **Overview**:
  Managed domain controllers hosted inside Azure.

- **How It Works**:

  - Supports **cloud-only identities** in Entra ID.
  - Also works with **hybrid-synced identities**.
  - Provides **Kerberos/NTLM** authentication without deploying domain controllers manually.

- **Use Cases**:

  - Cloud-first organizations that don‚Äôt want to manage on-prem AD DS.
  - Scenarios requiring **domain-join capability in Azure VMs**.

---

### 3Ô∏è‚É£ Microsoft Entra ID Kerberos (Cloud-Native)

<div align="center">
    <img src="images/az-files-acl-3.png" alt="Authenticate with Entra ID Kerberos" style="margin: 0 20px;border-radius: 10px; width: 100%; border: 2px solid white;">
</div>

- **Overview**:
  Azure Files supports **direct authentication via Entra ID Kerberos** (no AD DS required).

- **How It Works**:

  - Devices must be **Entra ID-joined** or **Hybrid Entra ID-joined**.
  - Uses **Kerberos tickets** issued directly by Microsoft Entra ID.

- **Use Cases**:

  - Cloud-native environments (no legacy AD).
  - Hybrid orgs moving fully to Entra ID.
  - Scenarios requiring **SSO from Azure AD-joined devices**.

---

## üé≠ Role-Based Access Control (RBAC) in Azure Files

Access in Azure Files is a **two-layer system**:

### 1Ô∏è‚É£ Control Plane (Management via RBAC)

- Managed via Azure RBAC at **storage account** or **file share** scope.
- Roles:

  - **Storage File Data SMB Share Reader** ‚Üí Read only.
  - **Storage File Data SMB Share Contributor** ‚Üí Read + Write.
  - **Storage File Data SMB Share Elevated Contributor** ‚Üí Full access, including setting ACLs.

### 2Ô∏è‚É£ Data Plane (File/Folder ACLs)

- NTFS-style **Access Control Lists (ACLs)** on files/folders.
- Enforced once user authenticated via Entra ID.
- Works similar to on-prem Windows File Servers.

‚ö†Ô∏è Both RBAC **and** ACLs must allow access for a user to succeed.

---

## ‚öôÔ∏è Implementation Steps

1. **Create Storage Account** ‚Üí GPv2 or Premium Files.
2. **Enable Protocol** ‚Üí SMB or NFS.
3. **Configure Networking** ‚Üí open ports (445 for SMB, 2049 for NFS, 443 for REST).
4. **Choose Identity Integration**:

   - Entra ID DS (on-prem).
   - Entra ID Domain Services.
   - Entra ID Kerberos.

5. **Assign RBAC Roles** (e.g., **Storage File Data SMB Share Contributor/Reader**).
6. **Mount File Share** from client (Windows/Linux).

---

<div align="center">
    <img src="images/azure-files-connectivity-steps.png" alt="Connectivity Steps for Azure Files" style="margin: 0 20px;border-radius: 10px; width: 100%; border: 2px solid white;">
</div>

---

## üõ°Ô∏è Best Practices

- **Prefer Entra ID authentication** over storage account keys.
- Use **RBAC + NTFS ACLs** for fine-grained control.
- Enable **Private Endpoints** ‚Üí don‚Äôt expose over Internet.
- For hybrid, use **Azure File Sync**.
- Use **Azure Backup & Soft Delete** to protect against accidental deletion.
- Rotate **account keys** if you must use them (but avoid in production).
- Monitor **Azure Monitor logs** for access auditing.

---

## üìä Decision Matrix

| Scenario                 | Recommended Protocol | Authentication Method        | Authorization Method |
| ------------------------ | -------------------- | ---------------------------- | -------------------- |
| Windows enterprise apps  | **SMB (445)**        | Entra ID DS / Entra Kerberos | RBAC + NTFS ACLs     |
| Linux workloads          | **NFS (2049)**       | POSIX UID/GID                | POSIX ACLs           |
| App integration          | **REST API (443)**   | SAS / Entra ID               | RBAC (storage roles) |
| Hybrid branch offices    | **File Sync (SMB)**  | Entra ID / Keys              | RBAC + ACLs          |
| Cloud-native org (no AD) | **SMB (445)**        | Entra ID Kerberos            | RBAC + NTFS ACLs     |

---

## üåç Visual Architecture

```mermaid
flowchart TD
    Client["üë©‚Äçüíª Client VM (Win/Linux/macOS)"] --> Conn[üåê Connectivity Layer]
    Conn --> SMB["üìÅ SMB (445)"]
    Conn --> NFS["üìÅ NFS (2049)"]
    Conn --> REST["üìÅ REST API (443/80)"]

    SMB --> Auth[üîê Authentication Layer]
    NFS --> Auth
    REST --> Auth

    Auth --> EntraID[üåê Microsoft Entra ID]
    EntraID --> ADDS["üè¢ Entra ID Domain Services (Cloud/On-Prem)"]
    EntraID --> Kerb[üéüÔ∏è Entra ID Kerberos Authentication]

    Auth --> RBAC["‚öñÔ∏è Authorization (RBAC + ACLs)"]
```

---

## ‚úÖ Final Recap

- **Connectivity**: SMB (445), NFS (2049), REST (443/80), File Sync.
- **Authentication**: Verify identity ‚Üí Entra ID, keys, SAS.
- **Authorization**: Define permissions ‚Üí RBAC + ACLs.
- **Identity Integration**:

  - Entra ID DS (on-prem).
  - Entra ID Domain Services (Azure).
  - Entra ID Kerberos (cloud-native).

- **Best Practices**: Use Entra ID + RBAC + Private Endpoints.

‚ú® Azure Files = **secure, enterprise-ready file service** combining **cloud flexibility** + **Entra ID identity control** + **protocol diversity**.
