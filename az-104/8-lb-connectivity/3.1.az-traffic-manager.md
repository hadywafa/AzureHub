# ğŸŒ Azure Traffic Manager (ATM)

## ğŸ§  What Is Azure Traffic Manager?

> **Official Definition**:
> Azure Traffic Manager is a **DNS-based traffic load balancer** that distributes incoming client requests across multiple Azure (or external) endpoints globally, based on **routing methods** like latency, priority, or geographic location.

- Traffic Manager is **not** a reverse proxy â€” it just responds with the **IP address of the best endpoint**, and the user connects directly.
- It doesnâ€™t handle traffic **after DNS resolution**.

---

## ğŸ—ºï¸ Visual: How Azure Traffic Manager Works

```mermaid
sequenceDiagram
    participant User
    participant TrafficManager as TrafficManager (DNS)
    participant Endpoint1 as Endpoint1 (East US)
    participant Endpoint2 as Endpoint2 (West Europe)

    User->>TrafficManager: DNS Query (www.contoso.com)
    TrafficManager->>User: CNAME or A record (best endpoint IP)
    User->>Endpoint1: Connects to selected endpoint
```

---

## ğŸ§ª Key Use Cases

| Use Case                        | Description                                                                       |
| ------------------------------- | --------------------------------------------------------------------------------- |
| ğŸŒ **Global High Availability** | Route users to **healthy** regional endpoints (VMs, web apps, external websites). |
| ğŸš€ **Performance Optimization** | Route users to the **lowest latency** endpoint.                                   |
| ğŸ¢ **Geo-Specific Content**     | Route based on user's geographic location.                                        |
| âš™ï¸ **Blue-Green Deployment**    | Use **priority routing** to failover between versions.                            |
| ğŸ§ª **Test in Production**       | Use **weighted routing** to split traffic for `A/B testing`.                      |

---

## ğŸ§­ Routing Methods (Policies)

| Method             | What It Does                                                             | Ideal For                                        |
| ------------------ | ------------------------------------------------------------------------ | ------------------------------------------------ |
| âš¡ **Performance** | Routes to closest/fastest endpoint by **network latency**.               | Performance-hungry apps                          |
| ğŸ”¢ **Priority**    | Routes all traffic to primary. Fails over to backups if primary is down. | HA & DR setups                                   |
| âš–ï¸ **Weighted**    | Distributes traffic based on assigned **weights**.                       | Gradual rollout, A/B testing                     |
| ğŸŒ **Geographic**  | Routes users from specific countries/regions to specific endpoints.      | Legal/data residency compliance                  |
| ğŸŒ€ **Multivalue**  | Returns multiple healthy endpoints in DNS response (with TTL).           | Multi-IP apps, client retries                    |
| ğŸ’” **Subnet**      | Routes based on client **IP subnet ranges**.                             | Enterprise-specific logic or migration scenarios |

---

## ğŸ“¦ What Can Traffic Manager Route To?

| Endpoint Type           | Example                                             |
| ----------------------- | --------------------------------------------------- |
| ğŸŸ¦ Azure App Services   | Web apps in different regions                       |
| â˜ï¸ Azure Cloud Services | Classic or modern                                   |
| ğŸ–¥ï¸ Azure VMs            | VM in a load balancer                               |
| ğŸŒ External endpoints   | On-prem servers, other clouds                       |
| ğŸ§ª Nested Profiles      | Chain Traffic Manager profiles for advanced routing |

---

## ğŸ› ï¸ Config Example: Weighted A/B Test

Imagine you have:

- WebApp v1 in East US
- WebApp v2 in West US (new version)

You want:

- 90% traffic to v1
- 10% traffic to v2 for testing

```json
{
  "routingMethod": "Weighted",
  "endpoints": [
    {
      "name": "EastUS-v1",
      "target": "app1.azurewebsites.net",
      "weight": 90
    },
    {
      "name": "WestUS-v2",
      "target": "app2.azurewebsites.net",
      "weight": 10
    }
  ]
}
```

ğŸ”„ You can change weights over time to slowly shift traffic to v2.

---

## ğŸš¨ Health Probes (Heartbeat Monitor)

> Traffic Manager continuously checks the **health of each endpoint**, If one endpoint fails, it automatically routes users to the next best available one (based on the routing method)

- Protocols: HTTP, HTTPS, TCP
- Frequency: Every 30 seconds (default)
- Custom probe path: `/healthcheck` or similar
- If the probe fails: endpoint is **removed** from routing until it's healthy again.

Example check:

```json
{
  "Protocol": "HTTPS",
  "Port": 443,
  "Path": "/health"
}
```

---

## ğŸ”’ Is Traffic Manager Secure?

- âœ… Doesnâ€™t serve traffic directly â€” avoids being a chokepoint
- âŒ Doesnâ€™t encrypt traffic â€” it's DNS-level
- ğŸ” Use it **with Azure Front Door** or **Application Gateway** if you need:

  - SSL offloading
  - Web Application Firewall (WAF)
  - Layer 7 routing

---

## âš–ï¸ Traffic Manager vs Other Azure Load Balancers

| Service                 | Level     | Purpose                                  |
| ----------------------- | --------- | ---------------------------------------- |
| **Traffic Manager**     | DNS-based | Global routing across regions            |
| **Front Door**          | Layer 7   | Global HTTP(S) routing with acceleration |
| **Application Gateway** | Layer 7   | App-level (regional) routing, WAF        |
| **Load Balancer**       | Layer 4   | Internal or external TCP/UDP balancing   |

---

## ğŸ§  Pro Tips

- â±ï¸ Keep TTL low (default: 30sâ€“300s) for faster failover.
- ğŸ§ª Use **nested profiles** to mix routing methods (e.g., Geographic â†’ Weighted).
- ğŸ§  Use **custom health endpoints** (`/ping`, `/status`) to avoid false positives.
- ğŸ“Š Monitor using Azure Monitor logs and Traffic Manager metrics.
- ğŸ’° Billing is based on:

  - Number of DNS queries
  - Health checks performed

---

## ğŸ”„ CLI & Portal

```bash
az network traffic-manager profile create \
  --name myprofile \
  --resource-group myrg \
  --routing-method Performance \
  --unique-dns-name contosoglobal \
  --ttl 30 \
  --monitor-path "/health"
```

---

## ğŸ’¬ Domain Integration

You can use:

- `myapp.trafficmanager.net` (default DNS)
- Or set up a **custom domain** like `app.contoso.com` with a CNAME to Traffic Manager

---

## ğŸ“Œ Real-Life Scenarios

### ğŸŒ Global Website

Use **Performance Routing** to serve users from the closest region

### ğŸ” Disaster Recovery / Failover

Use **Priority Routing** to fail over from primary to backup region

### ğŸ§ª A/B Testing

Use **Weighted Routing** to send 30% of users to new version and monitor impact

### ğŸŒ GDPR Compliance

Use **Geographic Routing** to keep EU user traffic within the EU

---

## ğŸ§  Summary

| Feature          | Value                                   |
| ---------------- | --------------------------------------- |
| ğŸ’¡ Type          | DNS-based load balancer                 |
| ğŸ¯ Routing Logic | Performance, Weighted, Geographic, etc. |
| âœ… Good For      | Global HA, testing, low-latency routing |
| ğŸš« Not For       | SSL offloading, direct traffic proxy    |
| ğŸ¤ Combine With  | Azure Front Door / App Gateway          |
| ğŸ”§ Configuration | Azure Portal, CLI, Bicep, ARM           |

---

## ğŸ§© Real-World Example

Letâ€™s say you run a global e-commerce site ğŸŒ:

- Users from **Europe** go to West Europe App Service
- Users from **US** go to East US
- **Asia-Pacific** traffic goes to Japan
- During a big launch, you want to **slowly release** new version (A/B)

ğŸ”§ Use:

- **Geographic routing** to separate traffic by region
- **Weighted routing** in one region to test new version
- Health probes to auto-failover if one region crashes
