# SP and ARM Connection and Variable Groups

- **Service Principal (SP)**
- **Azure Resource Manager (ARM) Connection** in Azure DevOps
- **Variable Groups** (normal + linked to Key Vault)

Weâ€™ll go step by step in your preferred structured, â€œfrom scratchâ€ style.

---

## ğŸ”‘ **1. Service Principal (SP)**

### ğŸ“Œ What it is

A **Service Principal** is like a **service account** in Azure AD (Entra ID).

- It represents an **app, script, or pipeline** that needs to authenticate to Azure.
- Instead of a human username/password, it has:

  - **Client ID** (like username)
  - **Client Secret / Certificate** (like password)
  - **Tenant ID** (which Azure AD it belongs to)

ğŸ‘‰ Think of it as:
_"Robot identity that Azure DevOps uses to log into Azure."_

---

### ğŸ“Œ Example

If you want your pipeline to deploy a VM:

1. You create a **Service Principal** in Azure with `Contributor` role on your subscription.
2. Azure DevOps uses this SP (ID + Secret) to log in and create resources.

```bash
az ad sp create-for-rbac \
  --name my-devops-sp \
  --role Contributor \
  --scopes /subscriptions/<subId>
```

Output:

```json
{
  "appId": "1111-2222-3333",   # Client ID
  "password": "xyz-secret",    # Client Secret
  "tenant": "abcd-efgh-ijkl"   # Tenant ID
}
```

---

## ğŸŒ‰ **2. Azure Resource Manager Connection (ARM Connection)**

### ğŸ“Œ What it is

- In Azure DevOps â†’ **Service Connections**.
- An **ARM connection** is simply a **wrapper** around a Service Principal (SP).
- It stores the SP credentials securely and gives pipelines a shortcut name.

ğŸ‘‰ Instead of putting SP credentials in YAML, you just say:

```yaml
azureSubscription: "my-azure-connection"
```

---

### ğŸ“Œ Example

- In DevOps Project â†’ Project Settings â†’ Service Connections â†’ New connection â†’ **Azure Resource Manager**.
- You pick **Automatic (Service Principal)** or **Manual**.
- DevOps creates an SP for you (or you paste one manually).

Now in YAML:

```yaml
- task: AzureCLI@2
  inputs:
    azureSubscription: "sc-azure-prod" # This is the ARM connection
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: az group list
```

âœ… Behind the scenes â†’ DevOps uses the SP credentials stored in that connection.

---

## ğŸ“¦ **3. Variable Groups in Azure Pipelines**

Variables are like **global config values**. Variable groups let you **manage them in one place** and share across pipelines.

---

### ğŸ”¹ Normal Variable Group

- You define key-value pairs directly in DevOps UI.
- Example:

  - `dbServer = mydbserver`
  - `dbUser = admin`

Then in YAML:

```yaml
variables:
  - group: my-variable-group
```

And you can use:

```yaml
- script: echo $(dbServer)
```

---

### ğŸ”¹ Variable Group Linked to Key Vault

- Instead of storing values manually in DevOps, you **link to an Azure Key Vault**.
- DevOps fetches secrets automatically at runtime.
- Example:

  - AKV contains `dbPassword`
  - Linked Variable Group pulls it into pipelines

YAML:

```yaml
variables:
  - group: kv-linked-group # Linked to Key Vault

steps:
  - script: echo "Password is $(dbPassword)"
```

ğŸ‘‰ Benefits:

- Centralized secret storage in **Key Vault**.
- Rotation-friendly (update secret in AKV, pipelines auto-get new value).
- More secure than hardcoding secrets in DevOps UI.

---

## ğŸ§© **How They All Connect**

<div align="center">

```mermaid
flowchart TD
    A[Service Principal (robot account in Entra)] --> B[ARM Connection in DevOps]
    B -->|Used in tasks| C[Pipeline tasks (AzureCLI, Deploy ARM, etc.)]

    D[Key Vault] --> E[Variable Group (linked)]
    E -->|Injected into| C
```

</div>

- **SP** â†’ Azure identity for automation
- **ARM Connection** â†’ Friendly name in DevOps wrapping SP creds
- **Variable Group** â†’ Global config, can pull secrets from Key Vault

---

## âœ… **TL;DR**

- **Service Principal** = robot identity in Azure AD (Client ID + Secret)
- **ARM Connection** = wrapper in Azure DevOps that stores SP creds & exposes them to pipelines securely
- **Variable Group** = global variables in DevOps, can be:

  - Normal (manual values in UI)
  - Linked (auto-fetch secrets from Key Vault)
