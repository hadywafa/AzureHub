# ğŸ¦† Black Duck + Azure DevOps Pipelines (Full Guide)

## ğŸŒ 0. Prereqs (One-time Setup)

Before wiring into CI/CD:

- ğŸ”‘ **Credentials**:

  - `BLACKDUCK_URL` â†’ `https://your.blackduck.server`
  - `BLACKDUCK_TOKEN` â†’ API token (**secret**)

- ğŸ“¦ **Pipeline Variables / Library**:

  - Optional: `BLACKDUCK_PROJECT`, `BLACKDUCK_VERSION`

- ğŸ”’ **Branch Policy Setup** (Repos â†’ Branches â†’ `main`):

  - Add build validation â†’ require scan to pass before merge

ğŸ‘‰ This ensures every **PR must pass Black Duck scan** before entering `main`.

---

## ğŸ§ 1. Minimal Linux YAML (Quick Start)

```yaml
# azure-pipelines.yml
trigger:
  - main
pr:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  BLACKDUCK_URL: $(BLACKDUCK_URL)
  BLACKDUCK_TOKEN: $(BLACKDUCK_TOKEN)
  BLACKDUCK_PROJECT: "ecommerce-web"
  BLACKDUCK_VERSION: "$(Build.SourceBranchName)-$(Build.BuildId)"

stages:
  - stage: build
    jobs:
      - job: build
        steps:
          - script: |
              echo "Build your app here..."
              # e.g., npm ci && npm run build
            displayName: Build

  - stage: blackduck_scan
    dependsOn: build
    jobs:
      - job: scan
        steps:
          - script: |
              curl -s -L https://detect.synopsys.com/detect.sh -o detect.sh
              chmod +x detect.sh
              ./detect.sh \
                --blackduck.url="$(BLACKDUCK_URL)" \
                --blackduck.api.token="$(BLACKDUCK_TOKEN)" \
                --detect.project.name="$(BLACKDUCK_PROJECT)" \
                --detect.project.version.name="$(BLACKDUCK_VERSION)" \
                --detect.policy.check=true \
                --detect.wait.for.results=true \
                --detect.risk.report.pdf=true \
                --detect.risk.report.pdf.path="bd-reports"
            displayName: ğŸ¦† Black Duck Scan

          - task: PublishBuildArtifacts@1
            displayName: ğŸ“‘ Publish Black Duck Reports
            inputs:
              PathtoPublish: bd-reports
              ArtifactName: blackduck-reports
```

âœ… What it does:

- Downloads `detect.sh`
- Scans dependencies & OSS libs
- **Fails pipeline** if policy violations exist
- Publishes **risk report PDF** as artifact

âš¡ Tip: remove `--detect.tools.excluded=SIGNATURE_SCAN` to enable deeper scanning (slower).

---

## ğŸªŸ 2. Windows Agent Variant

```yaml
pool:
  vmImage: windows-latest

steps:
  - powershell: |
      Invoke-WebRequest -Uri https://detect.synopsys.com/detect.ps1 -OutFile detect.ps1
      Set-ExecutionPolicy Bypass -Scope Process -Force
      .\detect.ps1 `
        --blackduck.url="$(BLACKDUCK_URL)" `
        --blackduck.api.token="$(BLACKDUCK_TOKEN)" `
        --detect.project.name="$(BLACKDUCK_PROJECT)" `
        --detect.project.version.name="$(BLACKDUCK_VERSION)" `
        --detect.policy.check=true `
        --detect.wait.for.results=true `
        --detect.risk.report.pdf=true `
        --detect.risk.report.pdf.path="bd-reports"
    displayName: ğŸ¦† Black Duck Scan (Windows)
```

---

## ğŸ³ 3. Container Image / Microservices

Scan **multiple services** in parallel using a matrix:

```yaml
jobs:
  - job: scan_services
    strategy:
      matrix:
        web:
          SERVICE: web
          IMAGE: myacr.azurecr.io/web:$(Build.BuildId)
        api:
          SERVICE: api
          IMAGE: myacr.azurecr.io/api:$(Build.BuildId)
    steps:
      - script: |
          docker pull $(IMAGE)
          curl -s -L https://detect.synopsys.com/detect.sh -o detect.sh
          chmod +x detect.sh
          ./detect.sh \
            --blackduck.url="$(BLACKDUCK_URL)" \
            --blackduck.api.token="$(BLACKDUCK_TOKEN)" \
            --detect.project.name="$(BLACKDUCK_PROJECT)-$(SERVICE)" \
            --detect.project.version.name="$(Build.SourceBranchName)-$(Build.BuildId)" \
            --detect.docker.image="$(IMAGE)" \
            --detect.policy.check=true \
            --detect.wait.for.results=true \
            --detect.risk.report.pdf=true \
            --detect.risk.report.pdf.path="bd-reports-$(SERVICE)"
        displayName: Scan container image
```

---

## ğŸ“œ 4. SBOM (CycloneDX) + Artifact Publishing

```yaml
- script: |
    ./detect.sh \
      --blackduck.url="$(BLACKDUCK_URL)" \
      --blackduck.api.token="$(BLACKDUCK_TOKEN)" \
      --detect.project.name="$(BLACKDUCK_PROJECT)" \
      --detect.project.version.name="$(BLACKDUCK_VERSION)" \
      --detect.policy.check=true \
      --detect.wait.for.results=true \
      --detect.generate.sbom=true \
      --detect.sbom.format=CYCLONEDX_JSON \
      --detect.sbom.output.path="bd-sbom"
  displayName: ğŸ¦† Black Duck scan + SBOM

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: bd-sbom
    ArtifactName: sbom
```

ğŸ‘‰ Produces a **Software Bill of Materials** (CycloneDX JSON) for audits/compliance.

---

## ğŸš¦ 5. PR Quality Gate

1. Repos â†’ **Branches â†’ `main` â†’ Branch Policies**
2. Add **Build Validation** â†’ point to pipeline
3. Require passing status before merge

ğŸ‘‰ Now risky PRs (critical CVE or license violation) **canâ€™t be merged**.

---

## ğŸ›ï¸ 6. Policy Tuning

- `--detect.policy.check=true` â†’ enforce Black Duck rules
- Exclude noisy paths:

  - `--detect.excluded.directories=tests,tools`

- Focus detectors:

  - `--detect.included.detectors=NPM,MAVEN,NUGET,PIP`

ğŸ‘‰ Keep **policy logic centralized** in Black Duck UI, not YAML.

---

## âš¡ 7. Speed & Reliability Tips

- Cache package managers (npm, Maven, NuGet) before scan.
- Run after build (so lockfiles exist).
- Pin Detect version: `--detect.version=x.y.z`
- Proxy networks â†’ export `HTTP_PROXY / HTTPS_PROXY`.

---

## ğŸ› ï¸ 8. Common Troubleshooting

- âŒ **401 Forbidden** â†’ wrong token/URL or network restrictions.
- âŒ **Exit code non-zero** â†’ violation found â†’ check PDF report.
- âŒ **No dependencies detected** â†’ missing lockfiles.
- âŒ **Slow scans** â†’ exclude `node_modules`, `dist`.

---

## ğŸ›’ 9. Marketplace Extension (Alternative)

If your org installed the **Synopsys Black Duck extension** in Azure DevOps:

- Use the **task UI** instead of raw `detect.sh`.
- Flags remain the same under the hood.

---

## ğŸ“Š Cheat Sheet

| Feature             | Purpose                             | Exam/Interview Key           |
| ------------------- | ----------------------------------- | ---------------------------- |
| **Policy Check**    | Block builds with CVE/license risks | Governance in CI/CD          |
| **SBOM**            | Inventory of OSS dependencies       | Compliance (CycloneDX, SPDX) |
| **Risk Reports**    | PDF/JSON outputs                    | Audit evidence               |
| **Branch Policy**   | Force PRs to pass scan              | Prevent unsafe merges        |
| **Container Scans** | Check Docker images                 | Cloud-native DevSecOps       |

---

## âœ… TL;DR

- ğŸ¦† Add Black Duck via `detect.sh` â†’ enforce `--detect.policy.check=true`.
- ğŸ”‘ Store secrets in variable groups.
- ğŸ“‘ Publish **risk report + SBOM** as artifacts.
- ğŸš¦ Use **branch policies** to block unsafe merges.
- ğŸ›ï¸ Tune rules in Black Duck UI, not YAML.
