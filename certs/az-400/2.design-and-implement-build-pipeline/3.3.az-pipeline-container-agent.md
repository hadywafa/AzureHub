# 🐳 Azure Pipeline Agents in Docker Containers

Yes, Azure Pipelines lets you run your jobs **inside Docker containers**, especially when you're using a **Microsoft-hosted agent** or a **self-hosted agent** that supports Docker.

---

## 🎯 Why Use a Docker Container as the Agent?

| Benefit 🟢                 | Description                                                           |
| -------------------------- | --------------------------------------------------------------------- |
| ✅ Custom environments     | Preload the container with SDKs, tools, dependencies                  |
| ✅ Isolation               | Keeps builds clean — no leftover files from previous jobs             |
| ✅ Portability             | "Build once, run anywhere" environment consistency                    |
| ✅ Faster setup            | No need to install tools in every pipeline run                        |
| ✅ Ideal for microservices | Each job can run in a different container tailored for its tech stack |

---

## 🧠 Two Ways to Use Docker with Azure Pipelines

| Use Case                       | Docker Role                         | Agent Type       |
| ------------------------------ | ----------------------------------- | ---------------- |
| Run job **inside a container** | Agent runs steps _inside_ container | Microsoft-hosted |
| Use Docker on the agent host   | Agent is VM with Docker CLI         | Self-hosted      |

---

## 📦 Use Docker Container as the Agent (Microsoft-hosted)

### 🧪 YAML Example

```yaml
pool:
  vmImage: "ubuntu-latest"

container:
  image: mcr.microsoft.com/dotnet/sdk:7.0

steps:
  - script: dotnet --version
    displayName: Check .NET version inside container

  - script: dotnet build MyApp.sln
    displayName: Build inside container
```

🧊 Here’s what happens:

- Azure spins up an **Ubuntu agent**
- The agent pulls the specified Docker image (`dotnet/sdk`)
- All steps run **inside the container**

---

## 🧰 Run Docker on a Self-Hosted Agent

If you control the host, you can:

- Run Docker CLI commands (`docker build`, `docker run`, etc.)
- Use volumes, networking, and custom images

```yaml
pool:
  name: "MySelfHostedPool"

steps:
  - script: |
      docker build -t myapp:latest .
      docker run myapp:latest
    displayName: Run inside self-hosted Docker host
```

---

## 🔐 Permissions & Notes

| Item                     | Note                                                            |
| ------------------------ | --------------------------------------------------------------- |
| `container:` keyword     | Only supported on **Microsoft-hosted agents**                   |
| Docker Daemon (`docker`) | Only available if **self-hosted agent VM** has Docker installed |
| Volumes & caching        | Volumes must be managed manually on self-hosted agents          |
| Nested containers        | Not allowed: cannot use `container:` inside a container agent   |

---

## 🎭 Diagram – What Happens Internally

```mermaid
flowchart LR
  A[YAML Pipeline]
  B[Microsoft-hosted Agent (Ubuntu VM)]
  C[Pull Docker Image]
  D[Run Job Inside Container]
  E[Execute Steps]

  A --> B --> C --> D --> E
```

---

## 🔨 Use Case Examples

### 🧪 CI for Python inside Python container

```yaml
pool:
  vmImage: "ubuntu-latest"
container: python:3.11

steps:
  - script: |
      pip install -r requirements.txt
      pytest
```

### 🧪 NodeJS app build

```yaml
container: node:18-alpine
steps:
  - script: |
      npm install
      npm run test
```

---

## 🧠 Pro Tips

| Tip 💡                        | How it helps                               |
| ----------------------------- | ------------------------------------------ |
| Use `container:` at job level | Makes it easier to isolate jobs            |
| Use `containerResources:`     | Set memory/CPU limits for container agents |
| Use `docker-compose` task     | For multi-container orchestration in jobs  |
| Use caching                   | Speed up builds by caching tool outputs    |

---

## ✅ Summary

| Concept                     | Explanation                                                                |
| --------------------------- | -------------------------------------------------------------------------- |
| Docker Agent (`container:`) | Runs all job steps inside a specified Docker container                     |
| Use Case                    | Custom environments, quick builds, reproducibility                         |
| Agent Types                 | Works on Microsoft-hosted (for `container:`), or self-hosted with Docker   |
| Customization               | Full control over image setup, preinstalled tools, secrets, and volume use |
| Limitations                 | No nested containers, some network limitations inside Microsoft agents     |
