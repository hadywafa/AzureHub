# 🧪 **Project: Unit Testing in Azure Pipelines**

## 📌 **1. Project Structure**

```plaintext
MySolution/
 ├── src/
 │    └── MyApi/
 │         ├── MyApi.csproj
 │         └── Calculator.cs   # business logic
 ├── tests/
 │    └── MyApi.UnitTests/
 │         ├── MyApi.UnitTests.csproj
 │         └── CalculatorTests.cs
 └── azure-pipelines.yml       # CI pipeline
```

---

## 📌 **2. The Application Code (Example)**

`src/MyApi/Calculator.cs`

```csharp
namespace MyApi
{
    public class Calculator
    {
        public int Add(int a, int b) => a + b;
        public int Divide(int a, int b)
        {
            if (b == 0) throw new DivideByZeroException();
            return a / b;
        }
    }
}
```

---

## 📌 **3. Unit Test Project**

`tests/MyApi.UnitTests/CalculatorTests.cs`

```csharp
using Xunit;
using MyApi;

namespace MyApi.UnitTests
{
    public class CalculatorTests
    {
        private readonly Calculator _calc = new();

        [Fact]
        public void Add_ShouldReturnCorrectSum()
        {
            var result = _calc.Add(2, 3);
            Assert.Equal(5, result);
        }

        [Fact]
        public void Divide_ByZero_ShouldThrow()
        {
            Assert.Throws<DivideByZeroException>(() => _calc.Divide(10, 0));
        }
    }
}
```

✅ If any `Assert` fails → test fails → pipeline fails.

---

## 📌 **4. Azure Pipeline (CI)**

`azure-pipelines.yml`

```yaml
trigger:
  - main # Run on commits to main branch

pool:
  vmImage: "windows-latest"

stages:
  - stage: BuildAndTest
    jobs:
      - job: RunUnitTests
        steps:
          - task: UseDotNet@2
            inputs:
              packageType: "sdk"
              version: "8.0.x"

          - script: dotnet restore MySolution.sln
            displayName: "Restore"

          - script: dotnet build MySolution.sln --configuration Release --no-restore
            displayName: "Build"

          - script: >
              dotnet test tests/MyApi.UnitTests/MyApi.UnitTests.csproj
              --configuration Release
              --no-build
              --logger "trx;LogFileName=unit.trx"
              --results-directory $(Common.TestResultsDirectory)
            displayName: "Run unit tests"

          # (no need to set continueOnError: false — default is already fail on non-zero)
          - task: PublishTestResults@2
            displayName: "Publish test results"
            condition: always()
            inputs:
              testResultsFiles: "$(Common.TestResultsDirectory)/**/*.trx"
              testRunTitle: "Unit Tests"
```

---

## 📌 **5. How it Works**

1. **Pipeline runs on commit** → installs .NET SDK.
2. **dotnet restore & build** → compile code.
3. **dotnet test** runs unit tests:

   - If any test fails → exit code ≠ 0 → job fails → pipeline **fails immediately** 🚨.
   - No need for special config — `dotnet test` failure is enough.

4. **PublishTestResults** uploads test reports → visible in **Azure DevOps “Tests” tab**.

> 💡 By default, every task runs under the condition `succeeded()`.  
> If the test step failed, the next task **won’t run** unless you override the condition.
>
> - `condition: always()` → runs even if the previous step failed.

---

## 📌 **6. Example Failing Pipeline**

- Code bug:

  ```csharp
  public int Add(int a, int b) => a - b;  // wrong
  ```

- Test `Add_ShouldReturnCorrectSum` fails.
- Pipeline output:

  ```ini
  X Add_ShouldReturnCorrectSum [123 ms]
    Expected: 5
    Actual: -1
  ```

- **Pipeline job = failed 🔴**.

---

## 📌 **7. Best Practices**

- ✅ Keep **unit tests fast & isolated** (no DB, no HTTP).
- ✅ Always run unit tests in **CI pipeline**.
- ✅ Block merges if tests fail (branch policies).
- ✅ Use **coverage tools** (e.g., `coverlet`) for metrics.
- ✅ Publish results so team can see failures in Azure DevOps UI.

---

## 🏁 **TL;DR**

- **Unit tests** = smallest building block, testing functions/classes in isolation.
- In **Azure Pipelines**, just add a `dotnet test` step.
- If **tests fail → pipeline fails automatically**.
- Add **PublishTestResults\@2** for visibility in Azure DevOps.
