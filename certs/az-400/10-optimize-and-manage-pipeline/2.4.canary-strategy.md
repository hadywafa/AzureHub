# ğŸ¤ Azure DevOps Deployment Strategy: `canary`

The **Canary Strategy** is designed for **progressive exposure** â€” releasing your application to a **small subset of users or targets first**, and then expanding gradually once the deployment is verified.

Itâ€™s great for **low-risk production deployments**.

---

## ğŸ“˜ Official Definition

> The `canary` strategy rolls out the deployment in **phases (increments)** to different target groups or traffic slices. If initial phases succeed, the rollout continues; if failure is detected early, rollback can be triggered without impacting the majority of users.

---

## ğŸ’¡ Why â€œCanaryâ€?

Itâ€™s named after **"canary in a coal mine"** â€” a small test subject (canary) is exposed to danger first. If it's okay, others follow.

---

## ğŸ§  Core YAML Structure

```yaml
jobs:
  - deployment: CanaryWebDeploy
    environment: "prod-env"
    strategy:
      canary:
        increments: [10, 30, 60] # Percentages of traffic or targets
        preDeploy:
          steps:
            - script: echo "ğŸ” Pre-deploy check"
        deploy:
          steps:
            - script: echo "ğŸš€ Deploying to $(deployment.targetName)"
        postDeploy:
          steps:
            - script: echo "âœ… Validated $(deployment.targetName)"
        on:
          failure:
            steps:
              - script: echo "ğŸ§¯ Rolling back $(deployment.targetName)"
```

---

## ğŸ§© Diagram â€“ Canary Strategy

```mermaid
sequenceDiagram
    participant DevOps
    participant Target10
    participant Target30
    participant Target60

    DevOps->>Target10: Deploy 10% (Increment 1)
    Note right of Target10: Validate this slice
    DevOps->>Target30: Deploy next 30%
    DevOps->>Target60: Deploy final 60%
```

---

## ğŸ“¦ Breakdown of `canary` Properties

| Property     | Description                                             |
| ------------ | ------------------------------------------------------- |
| `increments` | Array of percentages (e.g., `[5, 25, 70]`) â€” each phase |
| `preDeploy`  | Runs before each increment                              |
| `deploy`     | Core deployment steps                                   |
| `postDeploy` | Validates each phase                                    |
| `on.failure` | Optional rollback logic per phase                       |

---

## ğŸ§ª Real-World Canary Deployment Example

Letâ€™s say you have 100 production App Service instances behind a load balancer, and want to deploy to:

- 10% of them first
- Then 30%
- Then the remaining 60%

```yaml
jobs:
  - deployment: CanaryDeploy
    displayName: "ğŸ¤ Canary Deployment to App Services"
    environment:
      name: prod-env
      resourceType: VirtualMachine
    strategy:
      canary:
        increments: [10, 30, 60]
        preDeploy:
          steps:
            - script: echo "ğŸ” Pre-check before increment"
        deploy:
          steps:
            - task: AzureCLI@2
              displayName: "Deploy to $(deployment.targetName)"
              inputs:
                azureSubscription: "MyAzureSub"
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  az webapp deployment source config-zip \
                    --name myapp \
                    --resource-group myrg \
                    --src $(Pipeline.Workspace)/myapp.zip
        postDeploy:
          steps:
            - script: echo "ğŸ§ª Testing increment $(deployment.targetName)"
        on:
          failure:
            steps:
              - script: echo "âŒ Rollback triggered on $(deployment.targetName)"
```

---

## ğŸ”§ Where Does `targetName` Come From?

Like `rolling`, you need **multiple deployment targets** defined in the environment (e.g., VMs, slots, or App Service deployments using traffic routing).

---

## ğŸ§ª Canary with Traffic Routing (App Service Slots)

If you're using **App Service slots**, you can use `az webapp traffic-routing` to implement real canary logic:

```bash
az webapp traffic-routing set \
  --name myapp \
  --resource-group myrg \
  --distribution staging=10 production=90
```

As increments progress, shift more traffic to `staging`.

---

## âœ… Use Cases

| Use Case                             | Why Canary Works                       |
| ------------------------------------ | -------------------------------------- |
| Production rollout w/ traffic slices | âœ… Validate early phases               |
| Large-scale web services             | âœ… Minimize blast radius               |
| Progressive exposure for feedback    | âœ… Early monitoring                    |
| Safety-critical deployments          | âœ… Easier rollback if errors hit early |

---

## âš–ï¸ Canary vs. Rolling vs. RunOnce

| Feature            | Canary           | Rolling        | RunOnce     |
| ------------------ | ---------------- | -------------- | ----------- |
| Deploys in phases? | âœ… Yes           | âœ… Yes         | âŒ One shot |
| Traffic-based?     | âœ… (slots, LB)   | âŒ             | âŒ          |
| Multiple targets?  | âœ…               | âœ…             | âŒ          |
| Rollback support   | âœ… per increment | âœ… per target  | âœ… global   |
| Zero downtime?     | âœ… With slots    | âœ… w/ planning | âŒ          |

---

## ğŸ§¯ Add Approvals & Environment Variables

You can combine `canary` strategy with:

- **Approvals** via `environment: prod-env` (set in UI)
- **Scoped Variables** via environment-level vars
- **Manual Intervention** (via gates and checks)
