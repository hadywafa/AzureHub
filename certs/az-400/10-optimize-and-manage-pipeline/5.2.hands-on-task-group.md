# ğŸ”„ Azure DevOps **Task Groups** â€“ Hands-On Project

## ğŸ— Scenario â€“ Blue/Green App Service Deployment

Your company has **multiple web apps** hosted in **Azure App Service**.
Every deployment must:

1. Deploy to a **staging slot**
2. Run a **smoke test**
3. Swap to **production slot**
4. Add a **release annotation**

ğŸ‘‰ Instead of repeating these tasks in every pipeline, youâ€™ll create a **Task Group** (Classic pipelines feature) so all teams use the same deployment standard.

---

## âš™ï¸ Prerequisites

- Azure DevOps Project with **Classic Release Pipelines enabled**
- A **build artifact** (e.g., `drop/**/*.zip`)
- Azure Service Connection (ARM)
- App Service with **staging** slot
- Application Insights (optional)

---

## ğŸ§© Step 1: Build the initial Classic Release stage

Go to **Pipelines â†’ Releases â†’ New pipeline**

1. Add **Artifact** â†’ your build output
2. Add a stage: **BlueGreen Deploy**
3. Inside the stage, add tasks:

### Task 1: Azure App Service Deploy

- App type: Web App
- Slot: `staging`
- Package: `$(System.DefaultWorkingDirectory)/drop/*.zip`

### Task 2: PowerShell Smoke Test

```powershell
$url = "$(SMOKE_URL)"   # e.g., https://myapp-staging.azurewebsites.net/health
$timeout = [int]"$(SMOKE_TIMEOUT_SEC)"
$end = (Get-Date).AddSeconds($timeout)

do {
  try { $code = (Invoke-WebRequest -UseBasicParsing $url -TimeoutSec 10).StatusCode }
  catch { $code = 0 }
  if ($code -eq 200) { Write-Host "Healthy"; exit 0 }
  Start-Sleep -Seconds 5
} while ((Get-Date) -lt $end)

Write-Error "Smoke test failed"
exit 1
```

### Task 3: Azure App Service Manage â€“ Swap Slots

- Source slot: `staging` â†’ Target slot: `production`

### Task 4: Release Annotation (optional)

- Writes deployment version + notes into Application Insights.

---

## ğŸ§© Step 2: Convert to a Task Group

- Select all four tasks
- **Right click â†’ Create Task Group**
- Name: `AppService-BlueGreen-Deploy`
- Promote inputs to **parameters**:

  - `azureSubscription`
  - `webAppName`
  - `packagePath`
  - `stagingSlotName` (default: `staging`)
  - `prodSlotName` (default: `production`)
  - `smokeUrl`
  - `smokeTimeoutSec`

ğŸ’¡ Azure DevOps saves this under **Library â†’ Task Groups** as version **v1**.

---

## ğŸ§© Step 3: Replace with Task Group in pipeline

- Delete the original 4 tasks
- Add **Task Group â†’ AppService-BlueGreen-Deploy**
- Fill parameter values with variables or hard-coded strings
- Run a release â†’ logs expand the Task Group back into the original steps âœ…

---

## ğŸ§© Step 4: Reuse across projects

- Other teams just **add the Task Group** instead of repeating all tasks
- Pass app-specific parameters
- Secrets? Store in **Variable Groups** or **Key Vault**

---

## ğŸ§© Step 5: Centralize updates (versioning)

- Go to **Library â†’ Task Groups â†’ AppService-BlueGreen-Deploy**
- Edit â†’ Add improvements (ex: rollback on failure)
- Save as **v2**
- Pipelines can either:

  - Pin to v1 for stability
  - Always use **latest** for updates org-wide

---

## ğŸ§© Step 6: Bonus â€“ Rollback Automation

Add one more **App Service Manage (Swap)** task:

- Action: Swap Slots
- Source: `production` â†’ Target: `staging`
- Condition: `failed()`

ğŸ‘‰ If smoke test fails, swap back automatically.

---

## ğŸ” Visual Flow

```mermaid
flowchart TD
    A[Build Artifact] --> B[Deploy to Staging Slot]
    B --> C[Smoke Test PowerShell]
    C -->|Success| D[Swap Staging â†’ Production]
    C -->|Fail| E[Rollback: Swap Back]
    D --> F[Release Annotation in App Insights]
```

---

## âœ… Why Task Groups?

- â™»ï¸ **Reuse** across pipelines/projects
- ğŸ›  **Centralized updates** (version control)
- ğŸ” **Parameters & variable groups** keep secrets secure
- ğŸš¦ **Governance**: restrict who can edit Task Groups vs. use them

---

## ğŸ†š YAML Templates vs Task Groups

- **Task Groups** â†’ Classic pipelines only
- **YAML Templates** â†’ Modern YAML pipelines
  ğŸ‘‰ Same goal (reuse), different technology.

---

## âš ï¸ Common Pitfalls

- Donâ€™t hard-code secrets
- Make **service connection** a parameter
- Check permissions: teams need **Use** rights, not **Manage**
