# âœ… Manual Approval Before Prod in Multi-Stage Pipeline (Using Server Job)

## ğŸ§© Scenario

Your pipeline has:

1. **Build stage** â€“ compiles the app
2. **Test stage** â€“ runs tests
3. **Approval stage** â€“ waits for manual approval
4. **Deploy stage** â€“ deploys to production only after approval

---

## ğŸ“˜ How This Works

- The `Approval` stage runs a **server job** with `pool: server`.
- Inside it, you use the `ManualValidation@0` task.
- The job **doesnâ€™t consume an agent** or parallel job slot.
- If the approval is rejected or times out, the pipeline halts.

---

## ğŸ§± Full YAML Example

```yaml
trigger:
  - main

stages:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - stage: Build
    jobs:
      - job: BuildApp
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - script: echo "ğŸ”§ Building the app..."
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - stage: Test
    dependsOn: Build
    jobs:
      - job: RunTests
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - script: echo "ğŸ§ª Running tests..."
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - stage: Approval
    displayName: "ğŸ›‘ Await Manual Approval"
    dependsOn: Test
    jobs:
      - job: WaitForApproval
        displayName: "ğŸ”’ Wait for human approval"
        pool: server
        steps:
          - task: ManualValidation@0
            inputs:
              instructions: "Approve to deploy to PRODUCTION"
              onTimeout: "reject"
              timeout: "1d" # Maximum wait time
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - stage: Deploy
    dependsOn: Approval
    condition: succeeded()
    jobs:
      - job: DeployToProd
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - script: echo "ğŸš€ Deploying to production..."
```

---

## ğŸ§  Behavior Explained

| Stage    | Behavior                                                  |
| -------- | --------------------------------------------------------- |
| Build    | Normal agent job                                          |
| Test     | Normal agent job                                          |
| Approval | **Server job**, waits for approval in DevOps UI           |
| Deploy   | Only runs if approval was accepted and pipeline succeeded |

---

## ğŸ” Tips for Approvers

- Go to **Pipelines > Runs > Your Pipeline**
- Youâ€™ll see **â€œManual Interventionâ€** prompt
- Click **Approve** or **Reject**

---

## ğŸ§¯ What if approval is rejected?

- The pipeline stops.
- The `Deploy` stage is **skipped**.
- The result is marked as **`Canceled` or `Failed`**.

---

## âœ… Summary

| Feature                         | Supported                     |
| ------------------------------- | ----------------------------- |
| Approval before deploy          | âœ… Yes                        |
| Uses agent?                     | âŒ No (server job)            |
| Script or deployment logic?     | âŒ Not inside approval stage  |
| Can pause up to?                | ğŸ•“ 60 days                    |
| Triggers deploy after approval? | âœ… Yes (via stage dependency) |
