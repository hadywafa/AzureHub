# ğŸ§¹ Azure Pipelines Retention Policies

Retention policies determine **how long** Azure DevOps keeps:

- Pipeline **runs**
- Build **artifacts**
- Test **results**
- Logs
- Symbols
- Intermediate files

Once the retention period is over, Azure DevOps **automatically deletes** the data to save space.

---

## ğŸ“¦ Types of Retention

Azure DevOps applies retention at **3 levels**:

| Level              | Applies To            | Scope                             |
| ------------------ | --------------------- | --------------------------------- |
| **Project-level**  | All pipelines         | Default policy across the project |
| **Pipeline-level** | Individual pipelines  | Overrides project setting         |
| **Run-level**      | Specific pipeline run | Pin/unpin to keep forever         |

---

## ğŸ§  Why Is Retention Important?

Without proper retention:

- Artifacts/logs consume **GBs** over time
- You risk hitting **storage quotas**
- CI/CD becomes **slower and more expensive**

---

## ğŸ”§ 1. Project-Level Retention Policy

> ğŸ“ Location: **Project Settings â†’ Pipelines â†’ Settings**

### ğŸ”¹ What You Can Control:

- **Days to retain runs** (default: 30 days)
- **Minimum runs to retain per pipeline**
- **Retention for pull request builds**
- Delete **artifacts**, **logs**, **test results**
- Retain X **most recent runs** regardless of age
- Delete even **if the run failed or partially succeeded**

<div align="center">
  <img src="https://learn.microsoft.com/en-us/azure/devops/pipelines/media/policies/project-retention-settings.png" alt="Project Retention Settings" style="width: 100%; border-radius: 10px;">
</div>

---

## ğŸ› ï¸ 2. Pipeline-Level Retention Policy (UI)

> ğŸ“ Edit Pipeline â†’ âš™ï¸ Settings â†’ Retention

### ğŸ”¹ What You Can Override:

- **Number of days** to retain
- **Number of runs** to keep
- Apply to **branch filters**
- Choose whether to delete:

  - Artifacts
  - Logs
  - Test results

This allows different retention per **environment** or **pipeline**.

---

## ğŸ§¾ 3. Run-Level Retention (Pinning)

> ğŸ“ Pipeline Run â†’ ... â†’ **Retain run**

### ğŸ”¹ Pinning a Run:

- Prevents deletion by any retention policy
- Useful for:

  - **Stable releases**
  - **Auditing requirements**
  - **Historic deployments**

You can unpin at any time.

```yaml
# YAML - Pin a pipeline run
retention:
  days: 60
  minimumToKeep: 3
  artifacts: true
  logs: true
```

---

## ğŸ§° 4. YAML Retention Block (Per-Run)

```yaml
jobs:
  - job: build
    pool:
      vmImage: "ubuntu-latest"
    steps:
      - script: echo "Build stuff"

    retention:
      days: 10 # Override default retention for this run
      minimumToKeep: 1 # Keep at least 1
      artifacts: true # Clean up artifacts
      logs: true # Clean up logs
```

> ğŸ¯ This helps if you want to **reduce retention** for nightly builds or **increase** it for important ones.

---

## ğŸ“¤ 5. Release Pipeline Retention

> ğŸ“ Pipelines â†’ Releases â†’ âš™ï¸ â†’ Retention

- Retention is defined **per release definition**
- You can control:

  - **Retention for releases**
  - **Retain releases based on environment success**
  - **Retain X number of latest releases**
  - Delete older releases and their artifacts

---

## ğŸš¦ 6. Artifact Retention with Feeds

If you publish artifacts to an **Azure Artifacts feed**, retention is managed **independently** by the feedâ€™s settings.

- Go to **Artifacts â†’ Feed â†’ Settings â†’ Retention**
- Configure cleanup rules for **packages and versions**

---

## â›³ Special Behavior and Gotchas

| Feature                   | Behavior                                           |
| ------------------------- | -------------------------------------------------- |
| **Manually deleted run**  | Overrides pinning                                  |
| **Retained run**          | Ignored by global policy                           |
| **Parallel jobs**         | Not affected by retention                          |
| **Long-running PRs**      | May get cleaned up early if not retained           |
| **YAML + UI conflicts**   | YAML setting takes priority for that run           |
| **Multi-stage pipelines** | Each stageâ€™s output is retained or purged together |

---

## ğŸ” How to Monitor Retention Impact

1. Go to **Pipelines â†’ Builds**
2. Use the filter: `Retained = false` to see what will be cleaned
3. Use `az devops` CLI to list retention policies and pinned runs

```bash
az pipelines runs list --project MyProject
```

---

## ğŸ’¡ Best Practices

âœ… Retain only **essential releases**
âœ… Set short retention for **nightly builds**
âœ… Use **minimumToKeep** to avoid losing last N builds
âœ… Enable deletion of **test results** to reduce clutter
âœ… Pin **prod/stable** builds manually or with tags
âœ… Review retention usage every **2-3 months**

---

## ğŸ“Œ Summary Table

| Type      | Scope           | Configurable From    | Supports Pinning? |
| --------- | --------------- | -------------------- | ----------------- |
| Project   | All Pipelines   | Project Settings     | âœ…                |
| Pipeline  | Per Pipeline    | Pipeline Settings UI | âœ…                |
| Run-Level | Individual Run  | Pipeline Run View    | âœ…                |
| YAML      | Per-Run         | YAML File            | âœ…                |
| Release   | Classic Release | Release Settings     | âœ…                |
