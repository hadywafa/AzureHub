# 📦 The Complete Guide to **NuGet** (Basics → Advanced)

## 🌍 **What is NuGet?**

NuGet is the **official package manager for .NET**.

- It delivers **reusable libraries** in the form of **`.nupkg` files**.
- A `.nupkg` is zip file that contains:

  - DLLs (compiled assemblies)
  - Metadata (id, version, authors, dependencies)
  - Optional: docs, symbol files, license, source link

> 👉 NuGet solves **dependency management**: instead of copying DLLs manually, you declare them and let NuGet fetch, cache, and update.

---

## 📂 **How NuGet Packages Flow into Your App**

### Step 1: Declare dependency

- In CLI:

  ```bash
  dotnet add package Newtonsoft.Json --version 13.0.3
  ```

- In `.csproj`:

  ```xml
  <ItemGroup>
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
  </ItemGroup>
  ```

### Step 2: Restore

```bash
dotnet restore
```

- NuGet looks at sources defined in `NuGet.config`.
- It fetches `.nupkg` files → extracts them → places into **global cache**.

### Step 3: Build

- Compiler links the cached DLL into your app.
- No need to check packages into Git.

---

## 🎯 **Where Do Packages Live?**

### Global Package Cache

- Default location (per user):

  - Windows: `%UserProfile%\.nuget\packages`
  - Linux/macOS: `~/.nuget/packages`

- Inside, structured by package:

  ```ini
  ~/.nuget/packages/
    newtonsoft.json/
      13.0.3/
        lib/netstandard2.0/Newtonsoft.Json.dll
        newtonsoft.json.nuspec
  ```

### HTTP Cache

- Temporary cache for package index JSON & metadata.
- Windows: `%LocalAppData%\NuGet\v3-cache`

### Fallback Folders

- Pre-installed .NET SDK ships with common packages to speed up restore.
- Location:

  - Windows: `%ProgramFiles%\dotnet\sdk\NuGetFallbackFolder`
  - Linux: `/usr/share/dotnet/sdk/NuGetFallbackFolder`

> 🔑 Restores will look here **before hitting the internet**.

---

## 🗂 **NuGet Configuration Hierarchy (Scopes)**

NuGet settings come from **NuGet.config** files.  
They can exist at multiple scopes:

1. **Machine-wide** (lowest priority)

   - e.g., `C:\Program Files (x86)\NuGet\Config`
   - Affects all users & all projects on the machine.

2. **User-wide**

   - Windows: `%AppData%\NuGet\NuGet.Config`
   - Linux/macOS: `~/.nuget/NuGet/NuGet.Config`
   - Applies to all projects for the current user.

3. **Project-level**

   - Any `NuGet.config` in your repo (solution root or subfolder).
   - Highest priority — overrides user & machine configs.

> 👉 NuGet merges configs in this order:  
> **Machine → User → Project → Command line options**

---

## 🌐 **Multi-Source Feeds (NuGet.org + Private Feeds)**

### Define Multiple Sources

Example `NuGet.config`:

```xml
<configuration>
  <packageSources>
    <add key="nuget.org" value="https://api.nuget.org/v3/index.json" />
    <add key="company-feed" value="https://pkgs.dev.azure.com/ORG/PROJECT/_packaging/myfeed/nuget/v3/index.json" />
  </packageSources>
</configuration>
```

### How Restore Works

- NuGet queries **all enabled sources in parallel**.
- First match wins.
- If same package exists in multiple feeds, NuGet uses **first one that responds** (no strict priority unless you map).

### Controlling Sources → `packageSourceMapping`

```xml
<packageSourceMapping>
  <packageSource key="company-feed">
    <package pattern="Company.*" />
  </packageSource>
  <packageSource key="nuget.org">
    <package pattern="*" />
  </packageSource>
</packageSourceMapping>
```

👉 Guarantees that `Company.*` packages always come from **company-feed**.

---

## 🧑‍💻 **Package Management Commands** (CLI Cheatsheet)

- **Install**:

  ```bash
  dotnet add package Serilog --version 3.1.0
  ```

- **Remove**:

  ```bash
  dotnet remove package Serilog
  ```

- **Update** (re-add with new version):

  ```bash
  dotnet add package Serilog --version 3.2.0
  ```

- **List packages**:

  ```bash
  dotnet list package
  dotnet list package --outdated
  ```

- **Restore**:

  ```bash
  dotnet restore
  ```

- **Create package (your own)**:

  ```bash
  dotnet pack -c Release
  ```

---

## 🔁 **Versioning (NuGet & SemVer)**

NuGet follows **Semantic Versioning (SemVer)**:

- `1.0.0` → initial stable
- `1.0.1` → patch (bugfixes)
- `1.1.0` → minor feature, no breaking changes
- `2.0.0` → major, breaking changes

In `.csproj`:

```xml
<PackageReference Include="Serilog" Version="3.1.0" />           <!-- exact -->
<PackageReference Include="Serilog" Version="3.1.*" />           <!-- floating -->
<PackageReference Include="Serilog" Version="[3.1.0,4.0.0)" />   <!-- range -->
```

---

## 🔒 **Advanced: Reproducible Builds**

### Package Lock File

Enable in `.csproj`:

```xml
<RestorePackagesWithLockFile>true</RestorePackagesWithLockFile>
```

This creates a `packages.lock.json` → **pins exact transitive dependencies**.

- CI/CD can restore deterministically.
- Prevents “works on my machine” bugs.

---

## 🏢 **Enterprise NuGet with Azure Artifacts**

### 🔗 Private Feeds

- Store internal shared libraries.
- Controlled via permissions:

  - **Owners**: manage feed & permissions
  - **Contributors**: publish packages
  - **Readers**: consume packages

### 🔁 Upstream Sources

- Configure feed to pull from **nuget.org**.
- First request: fetch & cache.
- Next requests: served from feed.
- Eliminates direct internet restores.

### 👀 Views

- `@local` → packages pushed by devs
- `@prerelease` → test versions
- `@release` → stable, approved packages

Consumers point to `@release` for safety.

### 🧹 Retention Policies

- Automatically clean old versions (e.g., keep 3 latest).
- Saves storage, keeps feed tidy.

---

## ⚔️ **Security & Governance**

- **Package Signing**: NuGet supports signed packages for authenticity.
- **Auditing**: Azure Artifacts logs who published what.
- **Isolation**: With upstream + views, you prevent builds from pulling unapproved packages.
- **DevSecOps**: Combine with SBOM (Software Bill of Materials) to track vulnerabilities.

---

## 🧠 Exam / Interview Critical Points (AZ-400)

- NuGet is **the package manager for .NET**
- Packages live in the **global cache**, not in repo
- **NuGet.config hierarchy** defines sources (machine, user, project)
- **Multi-source resolution** happens in parallel unless controlled via **packageSourceMapping**
- **Azure Artifacts** provides:

  - Private feeds
  - Upstream caching
  - Views for package promotion
  - Retention & permissions

- **Lock files** ensure reproducible builds

---

## 🏁 **Summary**

NuGet is **the backbone of .NET dependency management**.

- **Basics**: install, restore, update, remove.
- **Storage**: global cache, fallback folder.
- **Config**: NuGet.config hierarchy (machine, user, project).
- **Multi-source**: parallel fetch, controlled via mappings.
- **Advanced**: lock files, SemVer, package promotion.
- **Enterprise**: Azure Artifacts feeds, upstream caching, views, retention, security.
