# ğŸš¦ **Azure DevOps Gates**

## ğŸŒ **What are Gates?**

- **Gates** = automated checks that run **before or after deployment** in a release pipeline.
- They decide whether the pipeline can **continue** or must **wait/stop**.
- Think of them as **traffic lights** ğŸš¦ in your release process:

  - ğŸŸ¢ Green â†’ deployment moves forward.
  - ğŸ”´ Red â†’ deployment is blocked until conditions are fixed.
  - ğŸŸ¡ Yellow â†’ waiting for the check to finish.

---

## â‰ï¸ **Why use Gates?**

- To **reduce risk** before pushing to production.
- To make sure **systems** (not just humans) confirm itâ€™s safe.
- To enforce **business rules** automatically.

---

## ğŸŒ¨ï¸ **Examples of Gates**

Azure DevOps provides built-in gate types:

1. **Invoke REST API** â†’ Call an external system.
   Example: Ask a Change Management system (like ServiceNow) if the release is approved.

2. **Query Azure Monitor alerts** â†’ Block deployment if active alerts exist.
   Example: Stop rollout if CPU usage is too high.

3. **Query Azure Monitor logs** â†’ Run KQL queries against Log Analytics.
   Example: Stop deployment if recent error logs exceed a threshold.

4. **Query work items (Azure Boards)** â†’ Check for open bugs/tasks.
   Example: Prevent release if high-severity bugs are still unresolved.

5. **Business hours** â†’ Restrict deployments to certain times.
   Example: Only allow deployment Monâ€“Fri, 9 AMâ€“6 PM.

---

## âš™ï¸ **How Gates Work**

- Gates donâ€™t just run once. They **re-evaluate periodically** until:

  - âœ… All checks pass, OR
  - â³ Timeout is reached (then release fails).

Example:

- You configure a gate with â€œCheck every 5 minutes for up to 1 hour.â€
- If conditions turn green anytime in that window â†’ pipeline continues.
- If not â†’ pipeline fails.

---

## ğŸ“ **Where can Gates be used?**

- **Pre-deployment** (before deployment starts).
- **Post-deployment** (after deployment finishes).

ğŸ‘‰ Usually, pre-deployment gates protect **prod/staging** environments.

---

## ğŸ­ **Gates vs Approvals**

- **ğŸ‘©â€ğŸ’» Approvals** = human clicks â€œOK.â€
- **ğŸ¤– Gates** = system automatically checks.

ğŸ‘‰ Best practice: use **both together**. Example:

- Gate = â€œNo Sev-1 incidents in ServiceNow.â€
- Approval = â€œRelease Manager gives final signoff.â€

---

## ğŸ¤” **Where Gates Live**

- Gates are **not defined in YAML** (like pipeline tasks).
- They live inside **Environments** or **Classic Release stages** under **â€œApprovals and checks.â€**
- This means you attach them to a stage or environment, not inside your task list.

---

## ğŸªœ **Steps to Add a Gate (UI)**

Hereâ€™s how you do it in Azure DevOps:

1. Go to **Pipelines â†’ Environments**.
   (or open a **Classic Release pipeline stage** â†’ select Pre/Post-deployment conditions).

2. Select the **environment** (e.g., `staging` or `prod`) where you want the gate.

3. Click **Approvals and checks â†’ +Add check**.

4. From the list, choose a **Gate type** (examples: REST API, Azure Monitor alerts, Work item query, Business hours).

5. Configure the details:

   - **Invoke REST API** â†’ enter endpoint URL, method (GET/POST), authentication, success criteria (like response contains `"approved": true`).
   - **Azure Monitor Alerts** â†’ select subscription, resource group, alert rules.
   - **Work Item Query** â†’ pick a saved query in Azure Boards (like â€œNo active Sev-1 bugsâ€).
   - **Business Hours** â†’ choose allowed deployment time windows.

6. Save. âœ…

Now your stage will **pause** until the gate condition is met.

---

## âš™ï¸ **Gate Settings**

Each gate has extra settings to control how it behaves:

- **Sampling interval** (how often to check, e.g., every 5 min).
- **Timeout** (how long to keep waiting, e.g., 1 hour).
- **Success criteria** (e.g., no active alerts, REST API returns OK).

ğŸ‘‰ If the timeout expires without success â†’ the deployment **fails**.

---

## âœğŸ» Example â€” Query Azure Monitor Alerts

Say you want to **block production deployment** if there are active alerts.

- Add **Query Azure Monitor Alerts** gate.
- Configure:

  - Subscription: `my-subscription`
  - Resource group: `prod-rg`
  - Alerts: `High CPU`, `App Crash Rate`
  - Sampling interval: 5 minutes
  - Timeout: 1 hour

ğŸ‘‰ Result: Pipeline will **wait up to 1 hour**, re-checking every 5 minutes. If alerts clear â†’ deploy continues. If not â†’ release fails.

---

## âœğŸ» Example â€” REST API Gate

Say you use ServiceNow for Change Management. You want to **block deployment until the change request is approved**.

- Add **Invoke REST API** gate.
- Configure:

  - URL: `https://servicenow/api/changeRequests/12345`
  - Method: GET
  - Auth: Service connection
  - Success criteria: `"status": "approved"`

ğŸ‘‰ Result: Deployment wonâ€™t continue until ServiceNow returns an â€œapprovedâ€ status.

---

## âœ… **Using Gates with Approvals**

Best practice:

- **Pre-deployment gates**: ensure external systems are green (alerts, bugs, API approvals).
- **Pre-deployment approvals**: human release manager clicks OK after gates pass.
- **Post-deployment gates**: run smoke tests, monitoring checks.
- **Post-deployment approvals**: ops team confirms production looks good.

---

## ğŸ **Summary**

- Gates = **automated checks** before/after deployment.
- Configured in **Environments â†’ Approvals and checks** (not YAML).
- Types include REST API, Monitor Alerts, Logs, Work Item Queries, Business Hours.
- You can set **intervals, timeouts, success conditions**.
- They keep the pipeline safe by waiting until external systems say **all clear**.
- [Docs](https://learn.microsoft.com/en-us/azure/devops/pipelines/release/approvals/gates?view=azure-devops)
