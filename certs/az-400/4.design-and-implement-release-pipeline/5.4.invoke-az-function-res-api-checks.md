# ğŸŒ Invoke Azure Function / REST API Checks in Azure DevOps

## ğŸ”‘ What is it?

- A **check** you can add to an **Environment, Service Connection, or Pipeline Resource**.
- It **calls an external endpoint (REST API or Azure Function)** before (or after) a deployment stage runs.
- Based on the **response**, the pipeline either:

  - âœ… continues,
  - â³ keeps waiting and retries, or
  - âŒ fails.

ğŸ‘‰ Think of it as asking an external system:
**â€œHey, is it safe for me to deploy now?â€**

---

## ğŸ› ï¸ Where can you use it?

- On **Environments** (e.g., before deploying to Prod).
- On **Service Connections** (e.g., before using a connection to Azure).
- On **Pipeline Resources** (e.g., before consuming artifacts).

---

## âš¡ How It Works

When you add the **Invoke REST API or Azure Function check**, Azure DevOps will:

1. **Send an HTTP call** to your configured endpoint.

   - Can be `GET`, `POST`, etc.
   - Can include headers and body (e.g., JSON payload with release info).

2. **Wait for response** (synchronous or asynchronous).

3. **Evaluate success criteria**:

   - Example: response contains `"status": "approved"`
   - Example: HTTP status code `200`

4. If success = âœ… â†’ pipeline continues.
   If not = âŒ pipeline fails (or retries until timeout).

---

## ğŸ§© Types of Invoke Checks

1. **Invoke REST API**

   - Call any external REST API endpoint.
   - Example:

     - Call ServiceNow Change Management system.
     - Check if current change request is approved.

2. **Invoke Azure Function**

   - Same concept, but targeted at your own **serverless Azure Function**.
   - Example:

     - Write a custom function that queries multiple systems (ServiceNow + PagerDuty + Config API).
     - Function returns pass/fail JSON to DevOps.

---

## âš™ï¸ Configuration Steps

1. **Go to Environments â†’ Approvals and Checks â†’ + Add check**
2. Choose **Invoke REST API** or **Invoke Azure Function**
3. Configure:

   - **Connection type**: service connection or anonymous
   - **Method**: GET / POST / PUT / DELETE
   - **Headers** (optional)
   - **Body** (optional JSON you want to send, like `{ "releaseId": "$(Release.ReleaseId)" }`)
   - **Success criteria**: JSON path condition or status code (example: `eq(root['status'], 'approved')`)
   - **Retry interval** (e.g., 5 min)
   - **Timeout** (e.g., 1 hour)

---

## ğŸ“– Example â€” REST API Check (ServiceNow)

- Add **Invoke REST API** check on the **Prod environment**.
- Configure:

  - Method: GET
  - URL: `https://servicenow/api/changeRequests/CR-12345`
  - Auth: OAuth Service Connection
  - Success Criteria: `eq(root['status'], 'approved')`

- Result: Deployment wonâ€™t start until ServiceNow says â€œapproved.â€

---

## ğŸ“– Example â€” Azure Function Check

Imagine you have a function that checks:

- No Sev-1 incidents in monitoring.
- Current release window is allowed.

Your Azure Function returns:

```json
{ "status": "approved" }
```

In the check:

- Method: POST
- URL: `https://myfunction.azurewebsites.net/api/checkRelease`
- Headers: `{ "x-functions-key": "mySecretKey" }`
- Success criteria: `eq(root['status'], 'approved')`

ğŸ‘‰ If Function says â€œapprovedâ€ â†’ release continues.

---

## âœ… Why Use This?

- Enforce **enterprise change management** (ServiceNow, Jira, Remedy).
- Custom **business rules** (deploy only if sales are low, no incidents open, etc.).
- Integrate with **custom compliance/security APIs**.
- Adds an **automated â€œgatekeeperâ€** to your release process.

---

## ğŸ†š REST API vs Azure Function Check

| Feature                           | REST API Check               | Azure Function Check |
| --------------------------------- | ---------------------------- | -------------------- |
| External API calls                | âœ…                           | âœ…                   |
| Built for serverless in Azure     | âŒ                           | âœ…                   |
| Custom business logic flexibility | Medium (depends on API)      | High (your code)     |
| Authentication                    | Service connections, headers | Function key / AAD   |

---

## ğŸ¯ Summary

- **Invoke REST API/Azure Function checks** = automated calls to external endpoints before allowing deployments.
- They run inside **Approvals & Checks** on Environments or Service Connections.
- You configure endpoint, method, headers/body, and success criteria.
- Use them to integrate with **change management systems, monitoring tools, or your own custom functions**.
