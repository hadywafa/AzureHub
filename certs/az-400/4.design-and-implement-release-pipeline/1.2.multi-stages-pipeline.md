# ğŸš€ Azure Pipelines: Multi-Stage

Multi-stage pipelines break your CI/CD process into **independent but connected blocks** called `stages`.  
Each stage has its own jobs, agents, steps, and purpose â€” like Build, Test, Deploy.

---

## ğŸ“Š Visual Overview

<div align="center">
  <img src="images/az-multi-stages.png" alt="Multi stages" style="width: 100%; border-radius: 10px;">
</div>

---

## ğŸ§± Anatomy of Multi-Stage Pipeline

| Part           | Description                                                            |
| -------------- | ---------------------------------------------------------------------- |
| `stage:`       | Top-level group for a logical unit (Build, Test, Deploy, etc.)         |
| `jobs:`        | A stage contains one or more jobs, each with its own steps             |
| `steps:`       | A job runs multiple tasks/commands                                     |
| `dependsOn:`   | Controls flow between stages (default is sequential unless overridden) |
| `environment:` | Used for deployment stages to define approval gates, logs, audits      |

---

## ğŸ’¡ Use Case Example: Dev â†’ Staging â†’ Prod

You build once, publish the artifact, and then promote the same build through environments:

```yaml
stages:
  - stage: Build
    jobs:
      - job: BuildJob
        steps:
          - script: echo "Build App"

  - stage: DeployDev
    dependsOn: Build
    jobs:
      - job: DevJob
        environment: dev
        steps:
          - script: echo "Deploy to Dev"

  - stage: DeployStaging
    dependsOn: DeployDev
    jobs:
      - job: StagingJob
        environment: staging
        steps:
          - script: echo "Deploy to Staging"

  - stage: DeployProd
    dependsOn: DeployStaging
    jobs:
      - deployment: ProdDeployment
        environment: production
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "Deploy to Production"
```

---

## ğŸ§  Multi-Stage Features

| Feature                   | YAML Pipeline (âœ… Full Support)           | Classic Release Pipeline (âš ï¸ Partial)       |
| ------------------------- | ----------------------------------------- | ------------------------------------------- |
| Define build + deploy     | âœ… Inline in same YAML                    | âŒ Separate build + release UI              |
| Environments              | âœ… Uses `environment:` block              | âœ… Uses `Environment` tiles                 |
| Approval Gates            | âœ… On `environment:` w/ deployments       | âœ… Manual + pre/post-deployment approvals   |
| Artifact Sharing          | âœ… Use `Publish/DownloadPipelineArtifact` | âœ… Built-in between build/release           |
| Triggers (CI/PR/schedule) | âœ… On each stage or full pipeline         | âŒ Trigger only on build; release is manual |

---

## ğŸ“ Notes

> âš ï¸ **Classic pipelines** support multiple stages only in **Release Pipelines**, not in classic build pipelines.  
> âœ… **YAML pipelines** support **true multi-stage workflows** â€” CI + CD together, versioned in source control.

---

## ğŸ§ª Real-World Tip

Use multi-stage pipelines when:

- You want clear separation (Build, Dev Deploy, QA, Prod)
- You need approvals (e.g. manager approves promotion to Prod)
- Youâ€™re targeting multiple environments with **one unified pipeline**

---

## ğŸ§­ Mermaid Flow Example

```mermaid
flowchart LR
    A[CI Trigger - Push to Main] --> B[Stage: Build]
    B --> C[Stage: Dev Deploy]
    C --> D[Stage: Staging Deploy]
    D --> E[Stage: Production Deploy]
    E --> F[Environment: Prod with Approvals]
```
